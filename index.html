<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagirio Analytics Pro - GeliÅŸmiÅŸ Veri Analizi</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230d3028'/><text x='50' y='68' font-size='60' font-family='sans-serif' font-weight='bold' fill='white' text-anchor='middle'>L</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Identity Services + API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <script>
        // Tailwind config
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lagirio': {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            950: '#052e16',
                            beige: '#f5e6d3',
                            green: '#004d40',
                            orange: '#ff9800',
                            'orange-dark': '#f57c00',
                        }
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        }
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #16a34a, #22c55e);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #15803d, #16a34a);
        }
        
        /* Glass effect */
        .glass {
            background: rgba(255, 253, 251, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(250, 246, 240, 0.5);
        }
        
        .glass-dark {
            background: rgba(0, 77, 64, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Chart container heights */
        .chart-container {
            height: 320px;
        }
        
        .chart-container-lg {
            height: 420px;
        }
        
        .chart-container-sm {
            height: 250px;
        }
        
        /* Tab transitions */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Gradient backgrounds */
        .gradient-mesh {
            background-image: radial-gradient(at 47% 33%, hsl(35, 45%, 92%) 0, transparent 59%),
                            radial-gradient(at 82% 65%, hsl(44, 40%, 88%) 0, transparent 55%);
            filter: blur(40px);
            opacity: 0.3;
        }
        
        /* Loading animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tooltip styles */
        .custom-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .custom-tooltip.show {
            opacity: 1;
        }

        /* ========= LOGIN SCREEN ========= */
        .login-screen {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #052e16 0%, #14532d 30%, #15803d 60%, #16a34a 100%);
            position: relative; overflow: hidden;
        }
        .login-screen::before {
            content: ''; position: absolute; top: -50%; right: -30%; width: 80%; height: 200%;
            background: radial-gradient(ellipse, rgba(255,156,0,0.1) 0%, transparent 70%);
            pointer-events: none; animation: loginFloat 8s ease-in-out infinite;
        }
        .login-screen::after {
            content: ''; position: absolute; bottom: -30%; left: -20%; width: 60%; height: 120%;
            background: radial-gradient(ellipse, rgba(34,197,94,0.08) 0%, transparent 60%);
            pointer-events: none; animation: loginFloat 10s ease-in-out infinite reverse;
        }
        .login-screen.hidden { display: none; }
        .login-error { color: #ef4444; font-size: 13px; margin-top: 12px; display: none; text-align: center; }
        @keyframes loginFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }

        /* ========= APP WRAPPER ========= */
        .app-wrapper { display: none; }
        .app-wrapper.active { display: block; animation: fadeIn 0.4s ease-out; }

        /* ========= UPLOAD PANELS ========= */
        .upload-panel.hidden { display: none; }
        .upload-tab.active { background: linear-gradient(135deg, #16a34a, #15803d) !important; color: white !important; border-color: transparent !important; box-shadow: 0 4px 12px rgba(22,163,74,0.3) !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-[#faf6f0] via-[#fdfcfa] to-[#faf6f0] font-inter min-h-screen">
    
    <!-- ========= LOGIN SCREEN ========= -->
    <div class="login-screen" id="loginScreen">
        <div class="absolute inset-0 overflow-hidden pointer-events-none z-0">
            <div class="absolute top-[10%] left-[15%] w-32 h-32 bg-white/[0.03] rounded-full" style="animation: loginFloat 6s ease-in-out infinite;"></div>
            <div class="absolute top-[60%] right-[10%] w-20 h-20 bg-white/[0.04] rounded-full" style="animation: loginFloat 8s ease-in-out 1s infinite;"></div>
            <div class="absolute bottom-[20%] left-[8%] w-16 h-16 bg-emerald-400/[0.05] rounded-full" style="animation: loginFloat 7s ease-in-out 2s infinite;"></div>
        </div>

        <div class="bg-white/[0.97] backdrop-blur-2xl rounded-3xl p-12 w-[440px] max-w-[90vw] shadow-[0_32px_64px_rgba(0,0,0,0.2)] text-center relative z-10 border border-white/20">
            <div class="w-[80px] h-[80px] bg-gradient-to-br from-emerald-900 via-emerald-700 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-6 text-[30px] font-extrabold text-white tracking-tight shadow-[0_8px_24px_rgba(22,101,52,0.3)] rotate-3 hover:rotate-0 transition-transform">L</div>
            <h1 class="text-[26px] font-extrabold bg-gradient-to-r from-emerald-900 to-emerald-600 bg-clip-text text-transparent mb-1.5">Lagirio Analytics</h1>
            <p class="text-sm text-gray-400 mb-8 font-medium">GeliÅŸmiÅŸ Veri Analiz Paneli</p>

            <div class="mb-5 text-left">
                <label class="block text-[12px] font-bold text-gray-400 mb-2 uppercase tracking-wider">KullanÄ±cÄ± AdÄ±</label>
                <div class="relative">
                    <input type="text" id="loginUser" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" autocomplete="username"
                           class="w-full px-4 py-3.5 border-2 border-gray-100 rounded-xl text-[15px] font-inter bg-[#faf8f4] transition-all duration-300 focus:outline-none focus:border-emerald-500 focus:bg-white focus:ring-[4px] focus:ring-emerald-500/10 focus:shadow-lg pl-11">
                    <i data-lucide="user" class="w-4 h-4 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>
            <div class="mb-5 text-left">
                <label class="block text-[12px] font-bold text-gray-400 mb-2 uppercase tracking-wider">Åžifre</label>
                <div class="relative">
                    <input type="password" id="loginPass" placeholder="Åžifreniz" autocomplete="current-password"
                           class="w-full px-4 py-3.5 border-2 border-gray-100 rounded-xl text-[15px] font-inter bg-[#faf8f4] transition-all duration-300 focus:outline-none focus:border-emerald-500 focus:bg-white focus:ring-[4px] focus:ring-emerald-500/10 focus:shadow-lg pl-11"
                           onkeydown="if(event.key==='Enter')Auth.login()">
                    <i data-lucide="lock" class="w-4 h-4 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>

            <button id="loginBtn" onclick="Auth.login()"
                    class="w-full py-4 bg-gradient-to-r from-emerald-800 via-emerald-700 to-emerald-600 text-white border-none rounded-xl text-[15px] font-bold font-inter cursor-pointer transition-all duration-300 mt-3 hover:-translate-y-0.5 hover:shadow-[0_8px_24px_rgba(13,48,40,0.35)] active:translate-y-0 active:shadow-md flex items-center justify-center gap-2">
                <i data-lucide="log-in" class="w-4 h-4"></i>
                GiriÅŸ Yap
            </button>
            <p id="loginError" class="login-error"></p>

            <div class="mt-8 pt-6 border-t border-gray-100 flex items-center justify-center gap-6 text-[11px] text-gray-400 font-medium">
                <span class="flex items-center gap-1"><i data-lucide="shield-check" class="w-3 h-3"></i> GÃ¼venli</span>
                <span class="flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> HÄ±zlÄ±</span>
                <span class="flex items-center gap-1"><i data-lucide="bar-chart-2" class="w-3 h-3"></i> DetaylÄ±</span>
            </div>
        </div>
    </div>

    <!-- ========= MAIN APP WRAPPER (hidden until login) ========= -->
    <div class="app-wrapper" id="appWrapper">

    <!-- Gradient Mesh Background -->
    <div class="fixed inset-0 gradient-mesh pointer-events-none"></div>

    <!-- Header -->
    <header class="glass-dark shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-br from-lagirio-orange to-lagirio-orange-dark text-white font-bold text-xl px-4 py-2 rounded-lg shadow-lg">
                        <span class="flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            lagirio.
                        </span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Analytics Pro</h1>
                        <p class="text-emerald-200 text-xs">GeliÅŸmiÅŸ Veri Analizi Platformu</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Quick Stats -->
                    <div class="hidden lg:flex items-center space-x-6 mr-6">
                        <div class="text-center">
                            <p class="text-emerald-200 text-xs">PortfÃ¶y DeÄŸeri</p>
                            <p class="text-white font-bold text-lg" id="headerPortfolioValue">â‚¬0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-emerald-200 text-xs">Bu Ay</p>
                            <p class="text-white font-bold text-lg" id="headerMonthlyValue">â‚¬0</p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <button onclick="Analytics.showNotifications()" class="relative bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" id="notificationCount">0</span>
                    </button>
                    
                    <button onclick="Analytics.exportPDF()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">PDF</span>
                    </button>
                    
                    <button onclick="Analytics.exportExcel()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <i data-lucide="table" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Excel</span>
                    </button>
                    
                    <button onclick="GoogleDrive.accessToken ? GoogleDrive.saveToDrive() : UploadUI.switchTab('drive')" id="headerDriveBtn" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition" title="Google Drive'a Kaydet">
                        <i data-lucide="hard-drive" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Drive</span>
                    </button>

                    <button onclick="Analytics.showSettings()" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>

                    <div class="w-px h-8 bg-white/10"></div>

                    <button onclick="Auth.logout()" class="bg-red-500/10 hover:bg-red-500/20 text-red-300 px-3 py-2 rounded-lg flex items-center space-x-2 transition text-sm">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Ã‡Ä±kÄ±ÅŸ</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Upload Section -->
    <div id="uploadSection" class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">

            <!-- Section Title -->
            <div class="text-center mb-8 animate-fade-in">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full mb-4 shadow-lg">
                    <i data-lucide="upload-cloud" class="w-10 h-10 text-white"></i>
                </div>
                <h2 class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-800 bg-clip-text text-transparent mb-2">
                    Veri YÃ¼kleme Merkezi
                </h2>
                <p class="text-gray-500">Verilerinizi yÃ¼kleyerek gÃ¼Ã§lÃ¼ analizlere baÅŸlayÄ±n</p>
            </div>

            <!-- Upload Tabs -->
            <div class="flex justify-center gap-2 mb-6">
                <button onclick="UploadUI.switchTab('json')" id="uploadTab-json" class="upload-tab active px-5 py-2.5 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 bg-emerald-600 text-white shadow-lg">
                    <i data-lucide="file-json" class="w-4 h-4"></i> JSON Dosya
                </button>
                <button onclick="UploadUI.switchTab('drive')" id="uploadTab-drive" class="upload-tab px-5 py-2.5 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 bg-white text-gray-600 border border-gray-200 hover:border-emerald-300 hover:text-emerald-600">
                    <i data-lucide="hard-drive" class="w-4 h-4"></i> Google Drive
                </button>
                <button onclick="UploadUI.switchTab('html')" id="uploadTab-html" class="upload-tab px-5 py-2.5 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 bg-white text-gray-600 border border-gray-200 hover:border-emerald-300 hover:text-emerald-600">
                    <i data-lucide="table" class="w-4 h-4"></i> PMS Rezervasyon
                </button>
            </div>

            <!-- ===== JSON Upload Panel ===== -->
            <div id="uploadPanel-json" class="upload-panel glass rounded-2xl shadow-2xl p-8 animate-fade-in">
                <div id="uploadArea" class="border-2 border-dashed border-emerald-300 rounded-xl py-12 px-6 hover:border-emerald-500 hover:bg-emerald-50/50 transition-all cursor-pointer group">
                    <div class="text-center">
                        <i data-lucide="folder-open" class="w-12 h-12 text-emerald-400 mx-auto mb-4 group-hover:scale-110 transition-transform"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">JSON Dosya SeÃ§in veya SÃ¼rÃ¼kleyin</h3>
                        <p class="text-sm text-gray-500 mb-4">Daire, rezervasyon ve gider verilerini iÃ§eren JSON dosyasÄ±</p>
                        <input type="file" id="fileInput" accept=".json" class="hidden">

                        <div class="flex items-center justify-center space-x-4 mt-6">
                            <button class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg flex items-center space-x-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span>Dosya SeÃ§</span>
                            </button>
                            <button onclick="Analytics.loadSampleData()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-lg hover:from-orange-600 hover:to-orange-700 transition shadow-lg flex items-center space-x-2">
                                <i data-lucide="database" class="w-4 h-4"></i>
                                <span>Ã–rnek Veri</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Google Drive Panel ===== -->
            <div id="uploadPanel-drive" class="upload-panel glass rounded-2xl shadow-2xl p-8 hidden">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                        <i data-lucide="hard-drive" class="w-8 h-8 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Google Drive BaÄŸlantÄ±sÄ±</h3>
                    <p class="text-sm text-gray-500">Bir dosyaya baÄŸlanÄ±n, sonraki giriÅŸlerde otomatik yÃ¼klensin</p>
                </div>

                <!-- Step indicator -->
                <div id="driveSteps" class="flex items-center justify-center gap-2 mb-6 text-xs font-semibold">
                    <div id="driveStep1" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-100 text-blue-700">
                        <span class="w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px]">1</span>
                        Client ID
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    <div id="driveStep2" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-gray-400">
                        <span class="w-5 h-5 rounded-full bg-gray-300 text-white flex items-center justify-center text-[10px]">2</span>
                        BaÄŸlan
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    <div id="driveStep3" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-gray-400">
                        <span class="w-5 h-5 rounded-full bg-gray-300 text-white flex items-center justify-center text-[10px]">3</span>
                        Dosya SeÃ§
                    </div>
                </div>

                <!-- Status Banner (dynamic) -->
                <div id="driveStatus" class="mb-6"></div>

                <!-- Phase 1: Client ID Input (only if not saved) -->
                <div id="drivePhase1" class="space-y-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase tracking-wider">Google Cloud Client ID</label>
                        <input type="text" id="driveClientId" placeholder="xxxx.apps.googleusercontent.com"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-[11px] text-gray-400 mt-1.5">Google Cloud Console &gt; APIs &gt; Credentials &gt; OAuth 2.0 Client ID</p>
                    </div>
                </div>

                <!-- Phase 2: Connect Button -->
                <div id="drivePhase2" class="mb-6 text-center">
                    <button onclick="GoogleDrive.connect()" id="driveConnectBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-3 rounded-xl flex items-center gap-2 hover:shadow-lg transition font-semibold mx-auto">
                        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12.545 10.239v3.821h5.445c-.712 2.315-2.647 3.972-5.445 3.972a6.033 6.033 0 110-12.064c1.498 0 2.866.549 3.921 1.453l2.814-2.814A9.969 9.969 0 0012.545 2C7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-.013z"/></svg>
                        Google ile GiriÅŸ Yap
                    </button>
                </div>

                <!-- Phase 3: File Selection / Linked File -->
                <div id="drivePhase3" class="hidden mb-6">
                    <!-- Linked file info (shown when already linked) -->
                    <div id="driveLinkedFile" class="hidden bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i data-lucide="file-check" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-sm text-emerald-800" id="driveFileName">lagirio-analiz-data.json</p>
                                    <p class="text-[11px] text-emerald-600" id="driveFileInfo">BaÄŸlÄ± dosya</p>
                                </div>
                            </div>
                            <button onclick="GoogleDrive.unlinkFile()" class="text-xs text-red-400 hover:text-red-600 underline">BaÄŸlantÄ±yÄ± Kes</button>
                        </div>
                    </div>

                    <!-- New file / existing file selection -->
                    <div id="driveFileSelect" class="hidden space-y-3">
                        <p class="text-sm text-gray-600 font-medium text-center mb-3">Hangi dosyayÄ± kullanmak istersiniz?</p>
                        <button onclick="GoogleDrive.createNewFile()" class="w-full bg-white border-2 border-dashed border-blue-300 rounded-xl p-4 text-left hover:border-blue-500 hover:bg-blue-50/50 transition group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center group-hover:bg-blue-200 transition">
                                    <i data-lucide="file-plus" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-sm text-gray-800">Yeni Dosya OluÅŸtur</p>
                                    <p class="text-[11px] text-gray-400">Drive'da yeni bir JSON dosyasÄ± oluÅŸturulur</p>
                                </div>
                            </div>
                        </button>
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                            <div class="relative flex justify-center text-xs"><span class="bg-white px-3 text-gray-400">veya</span></div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-xl p-4">
                            <p class="font-semibold text-sm text-gray-800 mb-2">Mevcut Dosya ID Gir</p>
                            <div class="flex gap-2">
                                <input type="text" id="driveFileId" placeholder="Drive dosya ID'si yapÄ±ÅŸtÄ±rÄ±n"
                                       class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="GoogleDrive.linkExistingFile()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                                    BaÄŸla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons (shown when connected + linked) -->
                <div id="driveActions" class="hidden">
                    <div class="flex gap-3 justify-center mb-3">
                        <button onclick="GoogleDrive.loadFromDrive()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl flex items-center justify-center gap-2 hover:shadow-lg transition font-semibold">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Drive'dan Veri Ã‡ek
                        </button>
                        <button onclick="GoogleDrive.saveToDrive()" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white py-3 rounded-xl flex items-center justify-center gap-2 hover:shadow-lg transition font-semibold">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Drive'a Kaydet
                        </button>
                    </div>

                    <!-- Auto-load toggle -->
                    <label class="flex items-center justify-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="driveAutoLoad" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked onchange="GoogleDrive.saveConfig()">
                        <span class="text-xs text-gray-500 group-hover:text-gray-700">GiriÅŸ yapÄ±ldÄ±ÄŸÄ±nda otomatik Drive'dan Ã§ek</span>
                    </label>
                </div>

                <!-- Message area -->
                <p id="driveMessage" class="text-center text-sm mt-4 hidden"></p>

                <!-- Connected user info -->
                <div id="driveUserInfo" class="hidden mt-4 pt-4 border-t border-gray-100 text-center">
                    <p class="text-xs text-gray-400">BaÄŸlÄ± hesap: <span id="driveUserEmail" class="font-semibold text-gray-600"></span></p>
                </div>
            </div>

            <!-- ===== PMS HTML Reservation Panel ===== -->
            <div id="uploadPanel-html" class="upload-panel glass rounded-2xl shadow-2xl p-8 hidden">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
                        <i data-lucide="calendar-plus" class="w-8 h-8 text-purple-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">PMS Rezervasyon YÃ¼kleme</h3>
                    <p class="text-sm text-gray-500">Zirkon veya PMS sisteminden dÄ±ÅŸa aktarÄ±lan HTML dosyalarÄ±nÄ± yÃ¼kleyin</p>
                </div>

                <div id="htmlUploadArea" class="border-2 border-dashed border-purple-300 rounded-xl py-10 px-6 hover:border-purple-500 hover:bg-purple-50/50 transition-all cursor-pointer group mb-4"
                     onclick="document.getElementById('htmlFileInput').click()">
                    <div class="text-center">
                        <i data-lucide="file-code" class="w-10 h-10 text-purple-400 mx-auto mb-3 group-hover:scale-110 transition-transform"></i>
                        <h3 class="text-base font-semibold text-gray-700 mb-1">HTML Dosya SÃ¼rÃ¼kleyin veya SeÃ§in</h3>
                        <p class="text-xs text-gray-500">.html / .htm formatÄ±nda PMS tablo dÄ±ÅŸa aktarmasÄ±</p>
                    </div>
                </div>
                <input type="file" id="htmlFileInput" accept=".html,.htm" class="hidden" multiple onchange="HTMLReservations.handleFiles(event)">

                <!-- Import Status -->
                <div id="htmlImportStatus" class="hidden mb-4"></div>

                <!-- Loaded Files List -->
                <div id="htmlFilesList" class="hidden mb-4">
                    <h4 class="text-sm font-bold text-gray-600 mb-2 flex items-center gap-2">
                        <i data-lucide="files" class="w-4 h-4"></i> YÃ¼klenen Dosyalar
                    </h4>
                    <div id="htmlFilesListContent" class="space-y-2"></div>
                </div>

                <!-- Reservation Stats (shown after import) -->
                <div id="htmlResStats" class="hidden">
                    <!-- Tabs: Future / Past -->
                    <div class="flex gap-2 mb-4">
                        <button onclick="HTMLReservations.switchTab('future')" id="resTab-future" class="flex-1 py-2.5 rounded-xl text-sm font-semibold bg-emerald-600 text-white transition-all">
                            ðŸ“… Gelecek Rezervasyonlar <span id="resFutureCount" class="ml-1 text-xs">(0)</span>
                        </button>
                        <button onclick="HTMLReservations.switchTab('past')" id="resTab-past" class="flex-1 py-2.5 rounded-xl text-sm font-semibold bg-white text-gray-600 border border-gray-200 transition-all">
                            ðŸ“œ GeÃ§miÅŸ Rezervasyonlar <span id="resPastCount" class="ml-1 text-xs">(0)</span>
                        </button>
                    </div>

                    <!-- Reservation List -->
                    <div id="htmlResList" class="max-h-[400px] overflow-y-auto space-y-2"></div>
                </div>

                <!-- Merge to Analytics Button -->
                <div id="htmlMergeSection" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <button onclick="HTMLReservations.mergeToAnalytics()" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:shadow-lg transition">
                        <i data-lucide="merge" class="w-4 h-4"></i>
                        Analize Aktar ve Dashboard'a Git
                    </button>
                </div>
            </div>

            <!-- Bottom Feature Icons -->
            <div class="mt-6 grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-full mb-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <p class="text-xs text-gray-600">GÃ¼venli Ä°ÅŸlem</p>
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-full mb-2">
                        <i data-lucide="zap" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <p class="text-xs text-gray-600">HÄ±zlÄ± Analiz</p>
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-full mb-2">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <p class="text-xs text-gray-600">DetaylÄ± Raporlar</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Dashboard (Hidden initially) -->
    <div id="mainDashboard" class="container mx-auto px-4 py-6 hidden">
        
        <!-- Top Controls Bar -->
        <div class="glass rounded-xl shadow-lg p-4 mb-6 animate-slide-up">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Date Range Selector -->
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="calendar-days" class="w-5 h-5 text-emerald-600"></i>
                        <select id="datePreset" class="px-4 py-2 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                            <option value="this-month">Bu Ay</option>
                            <option value="last-month">GeÃ§en Ay</option>
                            <option value="last-3-months">Son 3 Ay</option>
                            <option value="last-6-months">Son 6 Ay</option>
                            <option value="this-year">Bu YÄ±l</option>
                            <option value="last-year">GeÃ§en YÄ±l</option>
                            <option value="all" selected>TÃ¼m Zamanlar</option>
                            <option value="custom">Ã–zel SeÃ§im</option>
                        </select>
                    </div>
                    
                    <div id="customDateRange" class="hidden flex items-center space-x-2 animate-fade-in">
                        <input type="date" id="startDate" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm">
                        <span class="text-gray-400">â†’</span>
                        <input type="date" id="endDate" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm">
                        <button onclick="Analytics.applyDateFilter()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition flex items-center space-x-1">
                            <i data-lucide="check" class="w-4 h-4"></i>
                            <span>Uygula</span>
                        </button>
                    </div>
                </div>
                
                <!-- Currency Settings -->
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2 bg-white/50 px-3 py-2 rounded-lg">
                        <span class="text-sm text-gray-600">â‚¬/â‚º</span>
                        <input type="number" id="exchangeRateTL" value="48.5" step="0.1" class="w-16 px-2 py-1 bg-white border border-gray-200 rounded text-sm">
                    </div>
                    <div class="flex items-center space-x-2 bg-white/50 px-3 py-2 rounded-lg">
                        <span class="text-sm text-gray-600">â‚¬/$</span>
                        <input type="number" id="exchangeRateUSD" value="0.86" step="0.01" class="w-16 px-2 py-1 bg-white border border-gray-200 rounded text-sm">
                    </div>
                    <button onclick="Analytics.refreshData()" class="bg-emerald-100 text-emerald-700 p-2 rounded-lg hover:bg-emerald-200 transition" title="Verileri Yenile">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <!-- Portfolio Value Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.1s">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-emerald-600/10 group-hover:from-emerald-500/20 group-hover:to-emerald-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-emerald-100 rounded-lg">
                            <i data-lucide="trending-up" class="w-5 h-5 text-emerald-600"></i>
                        </div>
                        <span class="text-xs text-emerald-600 font-semibold" id="portfolioTrend">+0%</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Toplam PortfÃ¶y</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalPortfolioValue">â‚¬0</p>
                    <div class="mt-2 h-1 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-500" id="portfolioProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Revenue Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.2s">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-blue-600/10 group-hover:from-blue-500/20 group-hover:to-blue-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i data-lucide="euro" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <span class="text-xs text-blue-600 font-semibold" id="monthlyTrend">â†’</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1" id="revenueLabel">Bu Ay KazanÃ§</p>
                    <p class="text-2xl font-bold text-gray-800" id="monthlyRevenue">â‚¬0</p>
                    <p class="text-xs text-gray-400 mt-2" id="monthlyChange">vs geÃ§en dÃ¶nem</p>
                </div>
            </div>
            
            <!-- Active Properties Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.3s">
                <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-purple-600/10 group-hover:from-purple-500/20 group-hover:to-purple-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <i data-lucide="home" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full" id="activePercentage">0%</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Aktif Daireler</p>
                    <p class="text-2xl font-bold text-gray-800" id="activeProperties">0/0</p>
                    <p class="text-xs text-gray-400 mt-2">Rezervasyonlu</p>
                </div>
            </div>
            
            <!-- Average Occupancy Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.4s">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-500/10 to-orange-600/10 group-hover:from-orange-500/20 group-hover:to-orange-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-orange-100 rounded-lg">
                            <i data-lucide="calendar-check" class="w-5 h-5 text-orange-600"></i>
                        </div>
                        <span class="text-xs text-orange-600" id="occupancyIndicator">â†’</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Ortalama Doluluk</p>
                    <p class="text-2xl font-bold text-gray-800" id="avgOccupancy">0%</p>
                    <div class="mt-2 flex space-x-1">
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                    </div>
                </div>
            </div>
            
            <!-- Best System Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.5s">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-teal-600/10 group-hover:from-emerald-500/20 group-hover:to-teal-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-emerald-100 rounded-lg">
                            <i data-lucide="award" class="w-5 h-5 text-emerald-600"></i>
                        </div>
                        <i data-lucide="crown" class="w-4 h-4 text-yellow-500"></i>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">En KarlÄ± Sistem</p>
                    <p class="text-xl font-bold text-gray-800" id="bestSystem">-</p>
                    <p class="text-xs text-emerald-600 font-semibold mt-2" id="systemProfit">â‚¬0</p>
                </div>
            </div>
        </div>
        
        <!-- Main Navigation Tabs -->
        <div class="glass rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 p-1">
                <nav class="flex flex-wrap">
                    <button onclick="Analytics.switchMainTab('overview')" class="main-tab active flex-1 px-4 py-3 text-sm font-semibold text-white bg-white/20 rounded-t-lg transition hover:bg-white/30 flex items-center justify-center space-x-2" data-tab="overview">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                        <span>Genel BakÄ±ÅŸ</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('analysis')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="analysis">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i>
                        <span>DetaylÄ± Analiz</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('comparison')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="comparison">
                        <i data-lucide="git-compare" class="w-4 h-4"></i>
                        <span>KarÅŸÄ±laÅŸtÄ±rma</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('trends')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="trends">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        <span>Trendler</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('efficiency')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="efficiency">
                        <i data-lucide="gauge" class="w-4 h-4"></i>
                        <span>Verimlilik</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('reports')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="reports">
                        <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                        <span>Raporlar</span>
                    </button>
                </nav>
            </div>
            
            <!-- Overview Tab Content -->
            <div id="overview-content" class="tab-content active bg-white/95 p-6">
                <!-- Performance Metrics Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Revenue Trend Chart -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                                <i data-lucide="line-chart" class="w-5 h-5 text-emerald-600"></i>
                                <span>Gelir Trendi</span>
                            </h3>
                            <select id="trendPeriod" class="text-sm px-3 py-1 border border-gray-200 rounded-lg">
                                <option value="daily">GÃ¼nlÃ¼k</option>
                                <option value="weekly">HaftalÄ±k</option>
                                <option value="monthly" selected>AylÄ±k</option>
                                <option value="yearly">YÄ±llÄ±k</option>
                            </select>
                        </div>
                        <div class="chart-container" id="revenueTrendChart"></div>
                    </div>
                    
                    <!-- Top Performers -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>
                            <span>En Ä°yi Performans</span>
                        </h3>
                        <div class="space-y-3" id="topPerformers">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
                
                <!-- System Performance Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- System cards will be dynamically generated -->
                    <div id="systemPerformanceCards"></div>
                </div>
                
                <!-- Platform Distribution -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="globe" class="w-5 h-5 text-blue-600"></i>
                            <span>Platform DaÄŸÄ±lÄ±mÄ±</span>
                        </h3>
                        <div class="chart-container-sm" id="platformDistChart"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="credit-card" class="w-5 h-5 text-green-600"></i>
                            <span>Ã–deme YÃ¶ntemi DaÄŸÄ±lÄ±mÄ±</span>
                        </h3>
                        <div class="chart-container-sm" id="paymentMethodChart"></div>
                    </div>
                </div>
                
                <!-- Recent Activity & Alerts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="activity" class="w-5 h-5 text-purple-600"></i>
                            <span>Son Aktiviteler</span>
                        </h3>
                        <div class="space-y-3" id="recentActivity">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600"></i>
                            <span>Ã–nemli UyarÄ±lar</span>
                        </h3>
                        <div class="space-y-3" id="importantAlerts">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tab Content -->
            <div id="analysis-content" class="tab-content hidden bg-white/95 p-6">
                <!-- Analysis Sub-tabs -->
                <div class="bg-gray-50 rounded-lg p-1 mb-6">
                    <nav class="flex flex-wrap">
                        <button onclick="Analytics.switchAnalysisTab('system')" class="analysis-tab active flex-1 px-4 py-2 text-sm font-medium bg-white rounded-lg shadow-sm" data-analysis="system">
                            Sistem Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('apartment')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="apartment">
                            Daire Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('platform')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="platform">
                            Platform Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('expense')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="expense">
                            Gider Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('owner')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="owner">
                            Sahip Analizi
                        </button>
                    </nav>
                </div>
                
                <!-- Analysis Content Areas -->
                <div id="system-analysis" class="analysis-content active">
                    <!-- System analysis content -->
                </div>
                <div id="apartment-analysis" class="analysis-content hidden">
                    <!-- Apartment analysis content -->
                </div>
                <div id="platform-analysis" class="analysis-content hidden">
                    <!-- Platform analysis content -->
                </div>
                <div id="expense-analysis" class="analysis-content hidden">
                    <!-- Expense analysis content -->
                </div>
                <div id="owner-analysis" class="analysis-content hidden">
                    <!-- Owner analysis content -->
                </div>
            </div>
            
            <!-- Comparison Tab Content -->
            <div id="comparison-content" class="tab-content hidden bg-white/95 p-6">
                <!-- Advanced Comparison Controls -->
                <!-- Advanced Comparison Controls -->
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">KarÅŸÄ±laÅŸtÄ±rma Parametreleri</h3>
                    
                    <!-- Comparison Mode Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">KarÅŸÄ±laÅŸtÄ±rma Modu</label>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            <button onclick="Analytics.setComparisonMode('apartment-apartment')" 
                                    class="comparison-mode-btn active px-4 py-3 bg-white border-2 border-emerald-500 rounded-lg hover:bg-emerald-50 transition text-left">
                                <div class="font-semibold text-emerald-700">Daire vs Daire</div>
                                <div class="text-xs text-gray-500 mt-1">AynÄ± dÃ¶nemde</div>
                            </button>
                            
                            <button onclick="Analytics.setComparisonMode('apartment-period')" 
                                    class="comparison-mode-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 transition text-left">
                                <div class="font-semibold text-gray-700">Daire vs DÃ¶nem</div>
                                <div class="text-xs text-gray-500 mt-1">Bir daire, farklÄ± aylar</div>
                            </button>
                            
                            <button onclick="Analytics.setComparisonMode('group-group')" 
                                    class="comparison-mode-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-purple-50 hover:border-purple-500 transition text-left">
                                <div class="font-semibold text-gray-700">Grup vs Grup</div>
                                <div class="text-xs text-gray-500 mt-1">Ã‡oklu daire karÅŸÄ±laÅŸtÄ±r</div>
                            </button>
                            
                            <button onclick="Analytics.setComparisonMode('system-system')" 
                                    class="comparison-mode-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-orange-50 hover:border-orange-500 transition text-left">
                                <div class="font-semibold text-gray-700">Sistem vs Sistem</div>
                                <div class="text-xs text-gray-500 mt-1">Sistem karÅŸÄ±laÅŸtÄ±r</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dynamic Comparison Panels -->
                    <div id="comparisonPanels">
                        <!-- Will be filled dynamically -->
                    </div>
                    
                    <button onclick="Analytics.runAdvancedComparison()" 
                            class="mt-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg flex items-center space-x-2 mx-auto">
                        <i data-lucide="git-compare" class="w-5 h-5"></i>
                        <span>KarÅŸÄ±laÅŸtÄ±r</span>
                    </button>
                </div>

                        
                        <!-- First Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Birinci SeÃ§im</label>
                            <div id="firstComparisonSelect">
                                <select id="firstApartments" class="w-full px-3 py-2 border border-gray-200 rounded-lg" multiple>
                                    <!-- Dynamic options -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Second Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ä°kinci SeÃ§im</label>
                            <div id="secondComparisonSelect">
                                <select id="secondApartments" class="w-full px-3 py-2 border border-gray-200 rounded-lg" multiple>
                                    <!-- Dynamic options -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Period Selection for Period Comparison -->
                    <div id="periodComparisonControls" class="hidden mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Birinci DÃ¶nem</label>
                            <div class="flex space-x-2">
                                <input type="month" id="firstPeriodStart" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                                <span class="self-center">â†’</span>
                                <input type="month" id="firstPeriodEnd" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ä°kinci DÃ¶nem</label>
                            <div class="flex space-x-2">
                                <input type="month" id="secondPeriodStart" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                                <span class="self-center">â†’</span>
                                <input type="month" id="secondPeriodEnd" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                
                <!-- Comparison Results -->
                <div id="comparisonResults" class="hidden">
                    <!-- Dynamic comparison results -->
                </div>
            </div>
            
            <!-- Trends Tab Content -->
            <div id="trends-content" class="tab-content hidden bg-white/95 p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Revenue Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="trending-up" class="w-5 h-5 text-emerald-600"></i>
                            <span>Gelir Trend Analizi</span>
                        </h3>
                        <div class="chart-container" id="revenueTrendAnalysisChart"></div>
                    </div>
                    
                    <!-- Occupancy Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="calendar-range" class="w-5 h-5 text-blue-600"></i>
                            <span>Doluluk Trend Analizi</span>
                        </h3>
                        <div class="chart-container" id="occupancyTrendChart"></div>
                    </div>
                    
                    <!-- Seasonal Analysis -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="sun" class="w-5 h-5 text-orange-600"></i>
                            <span>Mevsimsel Analiz</span>
                        </h3>
                        <div class="chart-container" id="seasonalAnalysisChart"></div>
                    </div>
                    
                    <!-- Growth Analysis -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-purple-600"></i>
                            <span>BÃ¼yÃ¼me Analizi</span>
                        </h3>
                        <div class="chart-container" id="growthAnalysisChart"></div>
                    </div>
                </div>
                
                <!-- Forecast Section -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                        <i data-lucide="crystal-ball" class="w-5 h-5 text-indigo-600"></i>
                        <span>Tahminler ve Projeksiyonlar</span>
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-indigo-50 rounded-lg p-4">
                            <h4 class="font-medium text-indigo-900 mb-2">Sonraki Ay Tahmini</h4>
                            <p class="text-2xl font-bold text-indigo-600" id="nextMonthForecast">â‚¬0</p>
                            <p class="text-sm text-indigo-700 mt-1">GeÃ§miÅŸ verilere dayalÄ±</p>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-4">
                            <h4 class="font-medium text-emerald-900 mb-2">3 AylÄ±k Projeksiyon</h4>
                            <p class="text-2xl font-bold text-emerald-600" id="quarterForecast">â‚¬0</p>
                            <p class="text-sm text-emerald-700 mt-1">Trend analizi bazlÄ±</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h4 class="font-medium text-purple-900 mb-2">YÄ±llÄ±k Hedef</h4>
                            <p class="text-2xl font-bold text-purple-600" id="yearlyTarget">â‚¬0</p>
                            <p class="text-sm text-purple-700 mt-1">Mevcut performansa gÃ¶re</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Efficiency Tab Content -->
            <div id="efficiency-content" class="tab-content hidden bg-white/95 p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Cost Efficiency -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="coins" class="w-5 h-5 text-yellow-600"></i>
                            <span>Maliyet VerimliliÄŸi</span>
                        </h3>
                        <div class="chart-container" id="costEfficiencyChart"></div>
                    </div>
                    
                    <!-- System Efficiency -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="gauge" class="w-5 h-5 text-red-600"></i>
                            <span>Sistem VerimliliÄŸi</span>
                        </h3>
                        <div class="chart-container" id="systemEfficiencyChart"></div>
                    </div>
                </div>
                
                <!-- Efficiency Metrics Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="table" class="w-5 h-5 text-gray-600"></i>
                            <span>DetaylÄ± Verimlilik Metrikleri</span>
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Daire</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gider/Gelir</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Kar MarjÄ±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">â‚¬/Gece</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BoÅŸ GÃ¼n Maliyeti</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verimlilik Skoru</th>
                                </tr>
                            </thead>
                            <tbody id="efficiencyMetricsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab Content -->
            <div id="reports-content" class="tab-content hidden bg-white/95 p-6">
                <!-- Report Type Selection -->
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Rapor OluÅŸtur</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onclick="Analytics.generateReport('summary')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="file-text" class="w-8 h-8 text-emerald-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Ã–zet Rapor</h4>
                            <p class="text-sm text-gray-600">Tek sayfalÄ±k yÃ¶netici Ã¶zeti</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('detailed')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="file-bar-chart" class="w-8 h-8 text-blue-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">DetaylÄ± Rapor</h4>
                            <p class="text-sm text-gray-600">KapsamlÄ± analiz raporu</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('comparison')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="git-compare" class="w-8 h-8 text-purple-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">KarÅŸÄ±laÅŸtÄ±rma Raporu</h4>
                            <p class="text-sm text-gray-600">DÃ¶nem/daire karÅŸÄ±laÅŸtÄ±rmasÄ±</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('financial')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="wallet" class="w-8 h-8 text-green-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Finansal Rapor</h4>
                            <p class="text-sm text-gray-600">Gelir-gider detaylarÄ±</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('performance')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="trending-up" class="w-8 h-8 text-orange-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Performans Raporu</h4>
                            <p class="text-sm text-gray-600">KPI ve metrik analizi</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('custom')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="settings" class="w-8 h-8 text-gray-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Ã–zel Rapor</h4>
                            <p class="text-sm text-gray-600">Kendi raporunuzu oluÅŸturun</p>
                        </button>
                    </div>
                </div>
                
                <!-- Report Preview Area -->
                <div id="reportPreview" class="hidden bg-white rounded-xl shadow-lg p-6">
                    <!-- Dynamic report content -->
                </div>
            </div>
        </div>
    </div>
    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span>Bildirimler</span>
                    </h2>
                    <button onclick="Analytics.closeModal('notificationModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="notificationList" class="space-y-3">
                    <!-- Dynamic notifications -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-gray-700 to-gray-800 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Ayarlar</span>
                    </h2>
                    <button onclick="Analytics.closeModal('settingsModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Display Settings -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">GÃ¶rÃ¼ntÃ¼leme AyarlarÄ±</h3>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="darkMode" class="w-4 h-4 text-emerald-600 rounded">
                                <span class="text-gray-600">KaranlÄ±k Tema</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="animations" checked class="w-4 h-4 text-emerald-600 rounded">
                                <span class="text-gray-600">AnimasyonlarÄ± EtkinleÅŸtir</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="compactView" class="w-4 h-4 text-emerald-600 rounded">
                                <span class="text-gray-600">Kompakt GÃ¶rÃ¼nÃ¼m</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Data Settings -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Veri AyarlarÄ±</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">VarsayÄ±lan Para Birimi</label>
                                <select id="defaultCurrency" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    <option value="EUR">EUR (â‚¬)</option>
                                    <option value="USD">USD ($)</option>
                                    <option value="TL">TL (â‚º)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Tarih FormatÄ±</label>
                                <select id="dateFormat" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    <option value="DD/MM/YYYY">GG/AA/YYYY</option>
                                    <option value="MM/DD/YYYY">AA/GG/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-AA-GG</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Settings -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">UyarÄ± AyarlarÄ±</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">DÃ¼ÅŸÃ¼k Doluluk UyarÄ±sÄ± (%)</label>
                                <input type="number" id="lowOccupancyThreshold" value="30" min="0" max="100" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">YÃ¼ksek Gider UyarÄ±sÄ± (â‚¬)</label>
                                <input type="number" id="highExpenseThreshold" value="500" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="Analytics.closeModal('settingsModal')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Ä°ptal
                    </button>
                    <button onclick="Analytics.saveSettings()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition">
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Report Modal -->
    <div id="customReportModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i data-lucide="file-plus" class="w-5 h-5"></i>
                        <span>Ã–zel Rapor OluÅŸtur</span>
                    </h2>
                    <button onclick="Analytics.closeModal('customReportModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="space-y-6">
                    <!-- Report Sections Selection -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Rapor BÃ¶lÃ¼mleri</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="summary" checked class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Ã–zet</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="revenue" checked class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Gelir Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="expenses" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Gider Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="occupancy" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Doluluk Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="systems" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Sistem KarÅŸÄ±laÅŸtÄ±rmasÄ±</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="platforms" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Platform Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="trends" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Trend Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="forecast" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Tahminler</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Apartment Selection -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Daire SeÃ§imi</h3>
                        <select id="reportApartments" class="w-full px-3 py-2 border border-gray-200 rounded-lg" multiple size="5">
                            <!-- Dynamic options -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd tuÅŸuna basÄ±lÄ± tutarak birden fazla seÃ§im yapabilirsiniz</p>
                    </div>
                    
                    <!-- Date Range -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Tarih AralÄ±ÄŸÄ±</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">BaÅŸlangÄ±Ã§</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">BitiÅŸ</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="Analytics.closeModal('customReportModal')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Ä°ptal
                    </button>
                    <button onclick="Analytics.generateCustomReport()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition flex items-center space-x-2">
                        <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                        <span>Rapor OluÅŸtur</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <div class="fixed bottom-6 right-6 z-40">
        <button onclick="Analytics.toggleQuickActions()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>
        
        <!-- Quick Actions Menu -->
        <div id="quickActionsMenu" class="absolute bottom-16 right-0 bg-white rounded-lg shadow-xl p-2 min-w-[200px] hidden animate-slide-up">
            <button onclick="Analytics.quickExport()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="download" class="w-4 h-4 text-gray-600"></i>
                <span>HÄ±zlÄ± Export</span>
            </button>
            <button onclick="Analytics.quickCompare()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="git-compare" class="w-4 h-4 text-gray-600"></i>
                <span>HÄ±zlÄ± KarÅŸÄ±laÅŸtÄ±rma</span>
            </button>
            <button onclick="Analytics.quickReport()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="file-text" class="w-4 h-4 text-gray-600"></i>
                <span>HÄ±zlÄ± Rapor</span>
            </button>
            <button onclick="Analytics.toggleFullscreen()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="maximize" class="w-4 h-4 text-gray-600"></i>
                <span>Tam Ekran</span>
            </button>
        </div>
    </div>
    
    </div><!-- /app-wrapper -->

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-6 left-6 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-10 shadow-[0_32px_64px_rgba(0,0,0,0.2)] text-center">
            <div class="loader mx-auto mb-5"></div>
            <p class="text-gray-600 font-medium">Ä°ÅŸleniyor...</p>
            <div class="mt-3 flex justify-center gap-1">
                <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0s;"></span>
                <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0.15s;"></span>
                <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0.3s;"></span>
            </div>
        </div>
    </div>
    
    <script>
    // Initialize Lucide icons
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

    // ============================================================
    // AUTH MODULE - KullanÄ±cÄ± Kimlik DoÄŸrulama
    // ============================================================
    const Auth = {
        currentUser: null,
        STORAGE_KEY: 'lagirioAnalytics_auth',

        users: [
            { username: 'admin', password: 'lagirio2025', role: 'admin' },
            { username: 'viewer', password: 'view2025', role: 'viewer' }
        ],

        login() {
            const username = document.getElementById('loginUser').value.trim();
            const password = document.getElementById('loginPass').value.trim();
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'LÃ¼tfen kullanÄ±cÄ± adÄ± ve ÅŸifre girin';
                errorEl.style.display = 'block';
                return;
            }

            const user = this.users.find(u => u.username === username && u.password === password);
            if (!user) {
                errorEl.textContent = 'GeÃ§ersiz kullanÄ±cÄ± adÄ± veya ÅŸifre';
                errorEl.style.display = 'block';
                document.getElementById('loginPass').value = '';
                return;
            }

            this.currentUser = { username: user.username, role: user.role };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.currentUser));
            errorEl.style.display = 'none';
            this.showApp();
        },

        logout() {
            this.currentUser = null;
            localStorage.removeItem(this.STORAGE_KEY);
            document.getElementById('appWrapper').classList.remove('active');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            document.getElementById('loginError').style.display = 'none';
        },

        checkSession() {
            try {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (saved) {
                    const session = JSON.parse(saved);
                    const valid = this.users.find(u => u.username === session.username);
                    if (valid) {
                        this.currentUser = session;
                        return true;
                    }
                }
            } catch(e) {}
            return false;
        },

        showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appWrapper').classList.add('active');
            lucide.createIcons();
            Analytics.init();
            HTMLReservations.init();

            // Google Drive: UI'Ä± gÃ¼ncelle ve otomatik baÄŸlanmayÄ± dene
            GoogleDrive.updateUI();
            // Google API yÃ¼klenmesini bekleyip otomatik baÄŸlan
            const tryAuto = () => {
                if (typeof google !== 'undefined' && google.accounts) {
                    GoogleDrive.tryAutoConnect();
                } else {
                    // API henÃ¼z yÃ¼klenmediyse kÄ±sa sÃ¼re sonra tekrar dene
                    setTimeout(tryAuto, 500);
                }
            };
            setTimeout(tryAuto, 300);
        }
    };

    // ============================================================
    // UPLOAD UI - Tab Switching
    // ============================================================
    const UploadUI = {
        switchTab(tab) {
            document.querySelectorAll('.upload-tab').forEach(t => {
                t.classList.remove('active');
                t.className = t.className.replace(/bg-emerald-600 text-white shadow-lg/g, 'bg-white text-gray-600 border border-gray-200');
            });
            document.querySelectorAll('.upload-panel').forEach(p => p.classList.add('hidden'));

            const btn = document.getElementById('uploadTab-' + tab);
            if (btn) {
                btn.classList.add('active');
            }
            const panel = document.getElementById('uploadPanel-' + tab);
            if (panel) {
                panel.classList.remove('hidden');
                panel.style.animation = 'fadeIn 0.3s ease-out';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    };

    // ============================================================
    // GOOGLE DRIVE - Otomatik BaÄŸlantÄ± & Veri Senkronizasyonu
    // ============================================================
    const GoogleDrive = {
        STORAGE_KEY: 'lagirioDriveConfig',
        accessToken: null,
        tokenClient: null,
        userEmail: null,

        // ---- Config Management ----
        getConfig() {
            try {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch(e) { return {}; }
        },

        saveConfig() {
            const clientEl = document.getElementById('driveClientId');
            const autoEl = document.getElementById('driveAutoLoad');
            const config = this.getConfig();
            if (clientEl && clientEl.value) config.clientId = clientEl.value.trim();
            if (autoEl) config.autoLoad = autoEl.checked;
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
        },

        saveFileLink(fileId, fileName) {
            const config = this.getConfig();
            config.fileId = fileId;
            config.fileName = fileName || 'lagirio-analiz-data.json';
            config.linkedAt = new Date().toISOString();
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
        },

        // ---- UI Helpers ----
        showMessage(text, type) {
            const el = document.getElementById('driveMessage');
            if (!el) return;
            el.innerHTML = text;
            el.className = 'text-center text-sm mt-4 font-medium ' +
                (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-emerald-600' : 'text-blue-600');
            el.classList.remove('hidden');
        },

        hideMessage() {
            const el = document.getElementById('driveMessage');
            if (el) el.classList.add('hidden');
        },

        setStep(step) {
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById('driveStep' + i);
                if (!el) continue;
                const numEl = el.querySelector('span');
                if (i < step) {
                    el.className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-100 text-emerald-700';
                    if (numEl) { numEl.className = 'w-5 h-5 rounded-full bg-emerald-600 text-white flex items-center justify-center text-[10px]'; numEl.textContent = '\u2713'; }
                } else if (i === step) {
                    el.className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-100 text-blue-700';
                    if (numEl) { numEl.className = 'w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px]'; numEl.textContent = i; }
                } else {
                    el.className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-gray-400';
                    if (numEl) { numEl.className = 'w-5 h-5 rounded-full bg-gray-300 text-white flex items-center justify-center text-[10px]'; numEl.textContent = i; }
                }
            }
        },

        showStatus(html) {
            const el = document.getElementById('driveStatus');
            if (el) el.innerHTML = html;
        },

        updateUI() {
            const config = this.getConfig();
            const hasClientId = !!config.clientId;
            const isConnected = !!this.accessToken;
            const hasFile = !!config.fileId;

            // Fill inputs
            const clientEl = document.getElementById('driveClientId');
            const autoEl = document.getElementById('driveAutoLoad');
            if (clientEl && config.clientId) clientEl.value = config.clientId;
            if (autoEl) autoEl.checked = config.autoLoad !== false;

            // Phase 1: Client ID
            const p1 = document.getElementById('drivePhase1');
            if (p1) p1.style.display = hasClientId && isConnected ? 'none' : '';

            // Phase 2: Connect button
            const p2 = document.getElementById('drivePhase2');
            if (p2) p2.style.display = isConnected ? 'none' : '';

            // Phase 3: File selection/linked
            const p3 = document.getElementById('drivePhase3');
            if (p3) p3.classList.toggle('hidden', !isConnected);

            const linkedEl = document.getElementById('driveLinkedFile');
            const selectEl = document.getElementById('driveFileSelect');
            if (hasFile && isConnected) {
                if (linkedEl) { linkedEl.classList.remove('hidden'); }
                if (selectEl) selectEl.classList.add('hidden');
                const nameEl = document.getElementById('driveFileName');
                const infoEl = document.getElementById('driveFileInfo');
                if (nameEl) nameEl.textContent = config.fileName || 'lagirio-analiz-data.json';
                if (infoEl) infoEl.textContent = 'ID: ' + config.fileId.substring(0, 16) + '...' + (config.linkedAt ? ' | BaÄŸlantÄ±: ' + new Date(config.linkedAt).toLocaleDateString('tr-TR') : '');
            } else if (isConnected) {
                if (linkedEl) linkedEl.classList.add('hidden');
                if (selectEl) selectEl.classList.remove('hidden');
            }

            // Actions
            const actionsEl = document.getElementById('driveActions');
            if (actionsEl) actionsEl.classList.toggle('hidden', !(isConnected && hasFile));

            // User info
            const userEl = document.getElementById('driveUserInfo');
            if (userEl && this.userEmail) {
                userEl.classList.remove('hidden');
                document.getElementById('driveUserEmail').textContent = this.userEmail;
            }

            // Steps
            if (!hasClientId) this.setStep(1);
            else if (!isConnected) this.setStep(2);
            else if (!hasFile) this.setStep(3);
            else { this.setStep(4); /* all done */ }

            // Status banner
            if (isConnected && hasFile) {
                this.showStatus('<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 flex items-center gap-2 text-sm text-emerald-700"><i data-lucide="check-circle-2" class="w-4 h-4 flex-shrink-0"></i> Drive baÄŸlantÄ±sÄ± aktif. Veriler otomatik bu dosyadan yÃ¼klenir.</div>');
            } else if (isConnected) {
                this.showStatus('<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-2 text-sm text-blue-700"><i data-lucide="info" class="w-4 h-4 flex-shrink-0"></i> BaÄŸlantÄ± kuruldu! Bir dosya seÃ§in veya yeni oluÅŸturun.</div>');
            } else if (hasClientId) {
                this.showStatus('<div class="bg-amber-50 border border-amber-200 rounded-xl p-3 flex items-center gap-2 text-sm text-amber-700"><i data-lucide="info" class="w-4 h-4 flex-shrink-0"></i> Client ID kayÄ±tlÄ±. Google ile giriÅŸ yaparak baÄŸlanÄ±n.</div>');
            } else {
                this.showStatus('<div class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm text-gray-600"><p class="font-semibold mb-1">NasÄ±l Kurulur?</p><ol class="list-decimal list-inside text-xs space-y-1 text-gray-500"><li><a href="https://console.cloud.google.com" target="_blank" class="text-blue-500 underline">Google Cloud Console</a>\'a gidin</li><li>APIs &amp; Services &gt; Credentials &gt; Create OAuth Client ID</li><li>Application type: <b>Web application</b></li><li>Authorized JavaScript origins: sitenizin URL\'ini ekleyin</li><li>OluÅŸan Client ID\'yi yukarÄ±ya yapÄ±ÅŸtÄ±rÄ±n</li></ol></div>');
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        // ---- Core Actions ----
        connect() {
            const clientEl = document.getElementById('driveClientId');
            const clientId = clientEl?.value?.trim() || this.getConfig().clientId;
            if (!clientId) {
                this.showMessage('LÃ¼tfen Google Client ID girin!', 'error');
                return;
            }

            // Save clientId
            const config = this.getConfig();
            config.clientId = clientId;
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));

            try {
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        if (response.error) {
                            this.showMessage('BaÄŸlantÄ± hatasÄ±: ' + response.error, 'error');
                            return;
                        }
                        this.accessToken = response.access_token;

                        // Fetch user email
                        try {
                            const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': 'Bearer ' + this.accessToken }
                            });
                            if (r.ok) {
                                const info = await r.json();
                                this.userEmail = info.email;
                            }
                        } catch(e) {}

                        this.hideMessage();
                        this.updateUI();

                        // If already linked to a file and autoLoad is on, load automatically
                        const cfg = this.getConfig();
                        if (cfg.fileId && cfg.autoLoad !== false) {
                            this.loadFromDrive(true);
                        }
                    }
                });
                this.tokenClient.requestAccessToken();
            } catch(e) {
                this.showMessage('Google API yÃ¼klenemedi. SayfayÄ± yenileyin ve tekrar deneyin.', 'error');
            }
        },

        // Auto-connect on page load (silent - uses prompt: 'none')
        tryAutoConnect() {
            const config = this.getConfig();
            if (!config.clientId || !config.fileId) return;

            // Show a loading hint on the drive panel
            this.showStatus('<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-2 text-sm text-blue-700"><i data-lucide="loader" class="w-4 h-4 animate-spin flex-shrink-0"></i> Otomatik baÄŸlanÄ±lÄ±yor...</div>');

            try {
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: config.clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        if (response.error) {
                            this.updateUI();
                            return;
                        }
                        this.accessToken = response.access_token;

                        try {
                            const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': 'Bearer ' + this.accessToken }
                            });
                            if (r.ok) this.userEmail = (await r.json()).email;
                        } catch(e) {}

                        this.updateUI();

                        // Auto-load if enabled
                        if (config.autoLoad !== false) {
                            this.loadFromDrive(true);
                        }
                    }
                });
                // Try silent first, falls back to prompt
                this.tokenClient.requestAccessToken({ prompt: '' });
            } catch(e) {
                this.updateUI();
            }
        },

        async createNewFile() {
            if (!this.accessToken) return;
            this.showMessage('Yeni dosya oluÅŸturuluyor...', 'info');

            const initialData = Analytics.data || { apartments: [], reservations: [], expenses: [], categories: [], capitalExpenses: [] };
            const metadata = { name: 'lagirio-analiz-data.json', mimeType: 'application/json' };
            const boundary = '-------314159265358979323846';
            const body = '--' + boundary + '\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) + '\r\n--' + boundary + '\r\nContent-Type: application/json\r\n\r\n' +
                JSON.stringify(initialData, null, 2) + '\r\n--' + boundary + '--';

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + this.accessToken,
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body
                });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const result = await response.json();

                this.saveFileLink(result.id, result.name);
                this.showMessage('Dosya oluÅŸturuldu ve baÄŸlandÄ±!', 'success');
                this.updateUI();
            } catch(e) {
                this.showMessage('Dosya oluÅŸturma hatasÄ±: ' + e.message, 'error');
            }
        },

        async linkExistingFile() {
            if (!this.accessToken) return;
            const fileId = document.getElementById('driveFileId')?.value?.trim();
            if (!fileId) {
                this.showMessage('LÃ¼tfen bir dosya ID girin!', 'error');
                return;
            }

            this.showMessage('Dosya kontrol ediliyor...', 'info');
            try {
                const r = await fetch('https://www.googleapis.com/drive/v3/files/' + fileId + '?fields=id,name,modifiedTime', {
                    headers: { 'Authorization': 'Bearer ' + this.accessToken }
                });
                if (!r.ok) throw new Error('Dosya bulunamadÄ± (HTTP ' + r.status + ')');
                const info = await r.json();
                this.saveFileLink(info.id, info.name);
                this.showMessage('Dosya baÄŸlandÄ±: ' + info.name, 'success');
                this.updateUI();
            } catch(e) {
                this.showMessage('Hata: ' + e.message, 'error');
            }
        },

        unlinkFile() {
            if (!confirm('Dosya baÄŸlantÄ±sÄ±nÄ± kesmek istediÄŸinizden emin misiniz? (Drive\'daki dosya silinmez)')) return;
            const config = this.getConfig();
            delete config.fileId;
            delete config.fileName;
            delete config.linkedAt;
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
            this.updateUI();
        },

        async saveToDrive() {
            if (!this.accessToken) { this.showMessage('Ã–nce Google ile baÄŸlanÄ±n!', 'error'); return; }
            if (!Analytics.data) { this.showMessage('Kaydedilecek veri yok. Ã–nce veri yÃ¼kleyin.', 'error'); return; }

            const config = this.getConfig();
            if (!config.fileId) { this.showMessage('Ã–nce bir dosya baÄŸlayÄ±n!', 'error'); return; }

            this.showMessage('<i data-lucide="loader" class="w-3 h-3 inline animate-spin"></i> Drive\'a kaydediliyor...', 'info');

            try {
                const fileContent = JSON.stringify(Analytics.data, null, 2);
                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files/' + config.fileId + '?uploadType=media',
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + this.accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    }
                );
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const now = new Date().toLocaleTimeString('tr-TR');
                this.showMessage('Drive\'a kaydedildi! (Son: ' + now + ')', 'success');
                if (typeof Analytics.showToast === 'function') Analytics.showToast('Drive\'a kaydedildi!', 'success');
            } catch(e) {
                this.showMessage('Kaydetme hatasÄ±: ' + e.message, 'error');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        async loadFromDrive(silent) {
            if (!this.accessToken) {
                if (!silent) this.showMessage('Ã–nce Google ile baÄŸlanÄ±n!', 'error');
                return;
            }

            const config = this.getConfig();
            if (!config.fileId) {
                if (!silent) this.showMessage('Ã–nce bir dosya baÄŸlayÄ±n!', 'error');
                return;
            }

            if (!silent) this.showMessage('<i data-lucide="loader" class="w-3 h-3 inline animate-spin"></i> Drive\'dan Ã§ekiliyor...', 'info');

            try {
                const response = await fetch(
                    'https://www.googleapis.com/drive/v3/files/' + config.fileId + '?alt=media',
                    { headers: { 'Authorization': 'Bearer ' + this.accessToken } }
                );
                if (!response.ok) throw new Error('HTTP ' + response.status);

                const data = await response.json();
                Analytics.data = data;
                Analytics.validateData();
                Analytics.filteredData = data;
                Analytics.processData();

                const now = new Date().toLocaleTimeString('tr-TR');
                this.showMessage('Drive\'dan yÃ¼klendi! (' + now + ')', 'success');
                if (typeof Analytics.showToast === 'function') Analytics.showToast('Drive\'dan veri yÃ¼klendi!', 'success');
            } catch(e) {
                if (!silent) this.showMessage('YÃ¼kleme hatasÄ±: ' + e.message, 'error');
                console.error('Drive load error:', e);
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    };

    // ============================================================
    // HTML RESERVATIONS - PMS HTML Import
    // ============================================================
    const HTMLReservations = {
        reservations: [],
        uploadedFiles: [],
        currentTab: 'future',

        init() {
            const saved = localStorage.getItem('pmsReservations');
            if (saved) {
                try { this.reservations = JSON.parse(saved); } catch(e) {}
            }
            const savedFiles = localStorage.getItem('pmsUploadedFiles');
            if (savedFiles) {
                try { this.uploadedFiles = JSON.parse(savedFiles); } catch(e) {}
            }
            this.renderUI();

            // Drag & drop
            const area = document.getElementById('htmlUploadArea');
            if (area) {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('border-purple-500', 'bg-purple-50/50');
                });
                area.addEventListener('dragleave', () => {
                    area.classList.remove('border-purple-500', 'bg-purple-50/50');
                });
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('border-purple-500', 'bg-purple-50/50');
                    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.html') || f.name.endsWith('.htm'));
                    if (files.length > 0) this.processFiles(files);
                });
            }
        },

        handleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) this.processFiles(files);
            event.target.value = '';
        },

        async processFiles(files) {
            const statusEl = document.getElementById('htmlImportStatus');
            statusEl.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-sm text-blue-700 flex items-center gap-2"><i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Ä°ÅŸleniyor...</div>';
            statusEl.classList.remove('hidden');

            let totalAdded = 0;
            let totalSkipped = 0;

            for (const file of files) {
                try {
                    const htmlContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });

                    const { reservations: parsed, skipped } = this.parseHTML(htmlContent);

                    // Remove old reservations from same file
                    this.reservations = this.reservations.filter(r => r.sourceFile !== file.name);
                    this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== file.name);

                    // Add new
                    const withSource = parsed.map(r => ({ ...r, sourceFile: file.name }));
                    this.reservations.push(...withSource);
                    this.uploadedFiles.push({
                        name: file.name,
                        uploadDate: new Date().toISOString(),
                        count: parsed.length,
                        skipped
                    });

                    totalAdded += parsed.length;
                    totalSkipped += skipped.noApartment + skipped.noPrice + skipped.invalidDate;
                } catch(e) {
                    console.error('HTML parse error:', e);
                }
            }

            this.save();
            this.renderUI();

            const msg = totalAdded > 0
                ? `<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 text-sm text-emerald-700">âœ… ${totalAdded} rezervasyon yÃ¼klendi!${totalSkipped > 0 ? ' (' + totalSkipped + ' atlanan)' : ''}</div>`
                : `<div class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-700">âš ï¸ GeÃ§erli rezervasyon bulunamadÄ±. (${totalSkipped} satÄ±r atlandÄ±)</div>`;
            statusEl.innerHTML = msg;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        parseHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const rows = doc.querySelectorAll('tr');
            const reservationsList = [];
            const skipped = { noPrice: 0, noApartment: 0, invalidDate: 0 };

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                let m = dateStr.match(/(\d{2})\.(\d{2})\.(\d{4})\s*(\d{2})?:?(\d{2})?/);
                if (m) return new Date(+m[3], +m[2]-1, +m[1], +(m[4]||12), +(m[5]||0));
                m = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (m) return new Date(+m[1], +m[2]-1, +m[3], 12, 0);
                m = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (m) return new Date(+m[3], +m[2]-1, +m[1], 12, 0);
                const d = new Date(dateStr);
                return isNaN(d.getTime()) ? null : d;
            };

            const parsePrice = (s) => {
                if (!s) return 0;
                return parseFloat(s.replace(/\./g, '').replace(',', '.')) || 0;
            };

            const convertToEUR = (amount, currency) => {
                const c = (currency || 'EUR').toUpperCase();
                if (c === 'EUR') return amount;
                if (c === 'TRY' || c === 'TL') return amount / 37.5;
                if (c === 'USD' || c === '$') return amount * 0.92;
                if (c === 'GBP' || c === '\u00a3') return amount * 1.17;
                return amount;
            };

            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return;

                let roomNo, agency, guestName, checkInStr, checkOutStr, adults, children, currency, totalPrice;

                if (cells.length >= 10) {
                    roomNo = cells[1]?.textContent?.trim();
                    agency = cells[2]?.textContent?.trim();
                    guestName = cells[3]?.textContent?.trim();
                    checkInStr = cells[4]?.textContent?.trim();
                    checkOutStr = cells[5]?.textContent?.trim();
                    adults = parseInt(cells[6]?.textContent?.trim()) || 0;
                    children = parseInt(cells[7]?.textContent?.trim()) || 0;
                    currency = cells[8]?.textContent?.trim() || 'EUR';
                    totalPrice = parsePrice(cells[9]?.textContent?.trim());
                } else {
                    roomNo = cells[1]?.textContent?.trim();
                    agency = cells[2]?.textContent?.trim();
                    guestName = cells[3]?.textContent?.trim();
                    checkInStr = cells[4]?.textContent?.trim();
                    checkOutStr = cells[5]?.textContent?.trim();
                    adults = parseInt(cells[6]?.textContent?.trim()) || 0;
                    children = parseInt(cells[7]?.textContent?.trim()) || 0;
                    currency = 'EUR';
                    totalPrice = 0;
                }

                if (!roomNo || !checkInStr || !agency) return;
                if (totalPrice <= 0) { skipped.noPrice++; return; }

                const checkIn = parseDate(checkInStr);
                const checkOut = parseDate(checkOutStr);
                if (!checkIn || !checkOut) { skipped.invalidDate++; return; }

                const nights = Math.max(1, Math.ceil((checkOut - checkIn) / 86400000));
                const priceInEUR = convertToEUR(totalPrice, currency);

                let platform = (agency || '').toUpperCase();
                if (platform.includes('AIRBNB')) platform = 'Airbnb';
                else if (platform.includes('BOOKING')) platform = 'Booking.com';
                else if (platform.includes('WALKIN') || platform.includes('WALK')) platform = 'Direkt';
                else if (platform.includes('ONLINE')) platform = 'Online';
                else platform = agency;

                reservationsList.push({
                    id: 'pms-' + Date.now() + '-' + index,
                    apartmentId: roomNo,
                    platform,
                    guestName: guestName || '',
                    checkIn: checkIn.toISOString(),
                    checkOut: checkOut.toISOString(),
                    nights,
                    adults,
                    children,
                    currency: 'EUR',
                    originalCurrency: currency,
                    originalPrice: totalPrice,
                    totalPrice: Math.round(priceInEUR * 100) / 100,
                    pricePerNight: Math.round((priceInEUR / nights) * 100) / 100
                });
            });

            return { reservations: reservationsList, skipped };
        },

        save() {
            localStorage.setItem('pmsReservations', JSON.stringify(this.reservations));
            localStorage.setItem('pmsUploadedFiles', JSON.stringify(this.uploadedFiles));
        },

        switchTab(tab) {
            this.currentTab = tab;
            document.getElementById('resTab-future').className = tab === 'future'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-emerald-600 text-white transition-all'
                : 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-white text-gray-600 border border-gray-200 transition-all';
            document.getElementById('resTab-past').className = tab === 'past'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-emerald-600 text-white transition-all'
                : 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-white text-gray-600 border border-gray-200 transition-all';
            this.renderReservationList();
        },

        renderUI() {
            // Files list
            const filesEl = document.getElementById('htmlFilesList');
            const filesContent = document.getElementById('htmlFilesListContent');
            if (this.uploadedFiles.length > 0 && filesEl && filesContent) {
                filesEl.classList.remove('hidden');
                filesContent.innerHTML = this.uploadedFiles.map(f => `
                    <div class="flex items-center justify-between bg-white rounded-lg px-3 py-2 text-sm border border-gray-100">
                        <div class="flex items-center gap-2">
                            <span class="text-purple-500">ðŸ“„</span>
                            <span class="font-medium">${f.name}</span>
                            <span class="text-xs text-gray-400">${f.count} rez.</span>
                        </div>
                        <button onclick="HTMLReservations.removeFile('${f.name}')" class="text-red-400 hover:text-red-600 text-xs">âœ•</button>
                    </div>
                `).join('');
            } else if (filesEl) {
                filesEl.classList.add('hidden');
            }

            // Stats & list
            const statsEl = document.getElementById('htmlResStats');
            const mergeEl = document.getElementById('htmlMergeSection');
            if (this.reservations.length > 0) {
                if (statsEl) statsEl.classList.remove('hidden');
                if (mergeEl) mergeEl.classList.remove('hidden');

                const today = new Date(); today.setHours(0,0,0,0);
                const future = this.reservations.filter(r => new Date(r.checkIn) >= today);
                const past = this.reservations.filter(r => new Date(r.checkIn) < today);
                document.getElementById('resFutureCount').textContent = '(' + future.length + ')';
                document.getElementById('resPastCount').textContent = '(' + past.length + ')';
                this.renderReservationList();
            } else {
                if (statsEl) statsEl.classList.add('hidden');
                if (mergeEl) mergeEl.classList.add('hidden');
            }
        },

        renderReservationList() {
            const el = document.getElementById('htmlResList');
            if (!el) return;
            const today = new Date(); today.setHours(0,0,0,0);

            const filtered = this.reservations.filter(r => {
                const d = new Date(r.checkIn); d.setHours(0,0,0,0);
                return this.currentTab === 'future' ? d >= today : d < today;
            }).sort((a, b) => {
                const da = new Date(a.checkIn), db = new Date(b.checkIn);
                return this.currentTab === 'future' ? da - db : db - da;
            });

            if (filtered.length === 0) {
                el.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">Rezervasyon bulunamadÄ±</div>';
                return;
            }

            // Group by month
            const groups = {};
            filtered.forEach(r => {
                const d = new Date(r.checkIn);
                const key = d.getFullYear() + '-' + (d.getMonth()+1);
                const monthNames = ['Ocak','Åžubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
                if (!groups[key]) groups[key] = { label: monthNames[d.getMonth()] + ' ' + d.getFullYear(), items: [], total: 0, nights: 0 };
                groups[key].items.push(r);
                groups[key].total += r.totalPrice || 0;
                groups[key].nights += r.nights || 0;
            });

            el.innerHTML = Object.entries(groups).map(([key, g]) => `
                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-100">
                        <span class="font-semibold text-sm text-gray-700">ðŸ“… ${g.label}</span>
                        <div class="flex gap-3 text-xs text-gray-500">
                            <span>${g.items.length} rez.</span>
                            <span>${g.nights} gece</span>
                            <span class="font-semibold text-emerald-600">â‚¬${Math.round(g.total).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-50">
                        ${g.items.map(r => {
                            const ci = new Date(r.checkIn);
                            const co = new Date(r.checkOut);
                            const fmt = d => d.getDate() + '.' + (d.getMonth()+1) + '.' + d.getFullYear();
                            return `<div class="flex items-center justify-between px-4 py-2.5 text-xs hover:bg-gray-50/50">
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold" style="background:${r.platform==='Airbnb'?'#fff0f0':r.platform==='Booking.com'?'#e8f0ff':'#f0fff0'};color:${r.platform==='Airbnb'?'#FF5A5F':r.platform==='Booking.com'?'#003580':'#16a34a'}">${r.platform}</span>
                                    <span class="font-medium text-gray-700">${r.apartmentId}</span>
                                    <span class="text-gray-400">${r.guestName || '-'}</span>
                                </div>
                                <div class="flex items-center gap-3 text-gray-500">
                                    <span>${fmt(ci)} â†’ ${fmt(co)}</span>
                                    <span>${r.nights}g</span>
                                    <span class="font-bold text-gray-700">â‚¬${Math.round(r.totalPrice)}</span>
                                    <span class="text-gray-400">â‚¬${r.pricePerNight}/g</span>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        },

        removeFile(fileName) {
            if (!confirm('"' + fileName + '" dosyasÄ±nÄ± ve rezervasyonlarÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;
            this.reservations = this.reservations.filter(r => r.sourceFile !== fileName);
            this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== fileName);
            this.save();
            this.renderUI();
        },

        mergeToAnalytics() {
            if (this.reservations.length === 0) return;

            // Convert PMS reservations to Analytics format
            const converted = this.reservations.map(r => ({
                id: r.id,
                apartmentId: r.apartmentId,
                guestName: r.guestName,
                checkIn: r.checkIn.split('T')[0],
                checkOut: r.checkOut.split('T')[0],
                platform: r.platform,
                totalAmount: r.totalPrice,
                platformCommission: r.platform === 'Direkt' ? 0 : r.totalPrice * 0.15,
                paymentMethod: 'Banka',
                currency: 'EUR'
            }));

            if (!Analytics.data) {
                // Create minimal data structure
                Analytics.data = {
                    apartments: [],
                    reservations: converted,
                    expenses: [],
                    categories: ['Temizlik', 'Elektrik', 'Su', 'Ä°nternet', 'YÃ¶netim', 'BakÄ±m'],
                    capitalExpenses: []
                };

                // Auto-create apartments from reservation apartmentIds
                const aptIds = [...new Set(converted.map(r => r.apartmentId))];
                Analytics.data.apartments = aptIds.map(id => ({
                    id, code: id, location: '', ownerName: '',
                    systemType: '3', lagirioCommission: 15, taxRate: 8,
                    incomeTaxRate: 0, stopajRate: 0
                }));
            } else {
                // Merge: add new reservations, avoid duplicates by ID
                const existingIds = new Set(Analytics.data.reservations.map(r => r.id));
                const newOnes = converted.filter(r => !existingIds.has(r.id));
                Analytics.data.reservations = [...Analytics.data.reservations, ...newOnes];

                // Auto-create missing apartments
                const existingAptIds = new Set(Analytics.data.apartments.map(a => a.id));
                const newAptIds = [...new Set(newOnes.map(r => r.apartmentId))].filter(id => !existingAptIds.has(id));
                for (const id of newAptIds) {
                    Analytics.data.apartments.push({
                        id, code: id, location: '', ownerName: '',
                        systemType: '3', lagirioCommission: 15, taxRate: 8,
                        incomeTaxRate: 0, stopajRate: 0
                    });
                }
            }

            Analytics.filteredData = Analytics.data;
            Analytics.processData();
            if (typeof Analytics.showToast === 'function') {
                Analytics.showToast(converted.length + ' rezervasyon analize aktarÄ±ldÄ±!', 'success');
            }
        }
    };

    // Main Analytics Application
    const Analytics = {
        // Data properties
        data: null,
        filteredData: null,
        charts: {},
        
        // State properties
        currentMainTab: 'overview',
        currentAnalysisTab: 'system',
        comparisonType: 'apartments',
        comparisonMode: 'apartment-apartment',
        comparisonSelections: {
            groupA: { apartments: [], period: null },
            groupB: { apartments: [], period: null }
        },
        notifications: [],
        settings: {
            darkMode: false,
            animations: true,
            compactView: false,
            defaultCurrency: 'EUR',
            dateFormat: 'DD/MM/YYYY',
            lowOccupancyThreshold: 30,
            highExpenseThreshold: 500
        },
        
        // Filter properties
        dateFilter: {
            start: null,
            end: null
        },
        
        // Cache for performance
        cache: {
            calculations: new Map(),
            lastUpdate: null
        },
        
        // Initialize the application
        init() {
            this.setupEventListeners();
            this.loadSettings();
            this.initializeTooltips();
            this.checkNotifications();
        },
        
        // Setup all event listeners
        setupEventListeners() {
            // File upload handlers
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-emerald-500', 'bg-emerald-50/50');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-emerald-500', 'bg-emerald-50/50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-emerald-500', 'bg-emerald-50/50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    this.handleFile(e.target.files[0]);
                }
            });
            
            // Date preset change handler
            document.getElementById('datePreset').addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    document.getElementById('customDateRange').classList.remove('hidden');
                } else {
                    document.getElementById('customDateRange').classList.add('hidden');
                    this.applyDatePreset(e.target.value);
                }
            });
            
            // Exchange rate change handlers
            document.getElementById('exchangeRateTL').addEventListener('change', () => {
                if (this.data) this.refreshData();
            });
            
            document.getElementById('exchangeRateUSD').addEventListener('change', () => {
                if (this.data) this.refreshData();
            });
            
            // Comparison type change handler
            const comparisonType = document.getElementById('comparisonType');
            if (comparisonType) {
                comparisonType.addEventListener('change', (e) => {
                    this.handleComparisonTypeChange(e.target.value);
                });
            }
            
            // Trend period change handler
            const trendPeriod = document.getElementById('trendPeriod');
            if (trendPeriod) {
                trendPeriod.addEventListener('change', () => {
                    this.updateRevenueTrendChart();
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + E: Export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    this.quickExport();
                }
                // Ctrl/Cmd + R: Refresh (without page reload)
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    this.refreshData();
                }
                // Ctrl/Cmd + F: Fullscreen
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    this.toggleFullscreen();
                }
                // ESC: Close modals
                if (e.key === 'Escape') {
                    this.closeAllModals();
                }
            });
            
            // Window resize handler for responsive charts
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    this.resizeAllCharts();
                }, 250);
            });
        },
        
        // File handling
        handleFile(file) {
            if (file.type !== 'application/json') {
                this.showToast('LÃ¼tfen geÃ§erli bir JSON dosyasÄ± seÃ§in!', 'error');
                return;
            }
            
            this.showLoading();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    this.data = JSON.parse(e.target.result);
                    this.validateData();
                    this.filteredData = this.data;
                    this.processData();
                    this.showToast('Veri baÅŸarÄ±yla yÃ¼klendi!', 'success');
                } catch (error) {
                    this.showToast('Dosya okuma hatasÄ±: ' + error.message, 'error');
                    console.error('File parsing error:', error);
                } finally {
                    this.hideLoading();
                }
            };
            
            reader.onerror = () => {
                this.hideLoading();
                this.showToast('Dosya okuma hatasÄ±!', 'error');
            };
            
            reader.readAsText(file);
        },
        
        // Data validation
        validateData() {
            if (!this.data) {
                throw new Error('Veri bulunamadÄ±');
            }
            
            const requiredFields = ['apartments', 'reservations'];
            for (const field of requiredFields) {
                if (!this.data[field]) {
                    throw new Error(`Gerekli alan eksik: ${field}`);
                }
            }
            
            // Set default empty arrays for optional fields
            this.data.expenses = this.data.expenses || [];
            this.data.categories = this.data.categories || [];
            this.data.capitalExpenses = this.data.capitalExpenses || [];
        },
        
        // Load sample data for testing
        loadSampleData() {
            this.showLoading();
            
            // GerÃ§ekÃ§i Ã¶rnek veri oluÅŸtur
            const sampleData = {
                apartments: [
                    { id: '1', code: '101-A', location: 'KadÄ±kÃ¶y', ownerName: 'Ahmet YÄ±lmaz', systemType: '3', lagirioCommission: 15, taxRate: 8, incomeTaxRate: 20, stopajRate: 0 },
                    { id: '2', code: '102-B', location: 'BeÅŸiktaÅŸ', ownerName: 'Mehmet Kaya', systemType: '2', lagirioCommission: 18, taxRate: 8, incomeTaxRate: 0, stopajRate: 0 },
                    { id: '3', code: '201-A', location: 'ÅžiÅŸli', ownerName: 'AyÅŸe Demir', systemType: '5', lagirioCommission: 12, taxRate: 8, incomeTaxRate: 0, stopajRate: 20 },
                    { id: '4', code: '201-B', location: 'KadÄ±kÃ¶y', ownerName: 'Fatma Ã–z', systemType: '1', lagirioCommission: 100, taxRate: 8, incomeTaxRate: 0, stopajRate: 0 },
                    { id: '5', code: '301-A', location: 'BeyoÄŸlu', ownerName: 'Ali Åžahin', systemType: '4', lagirioCommission: 16, taxRate: 8, incomeTaxRate: 20, stopajRate: 0 }
                ],
                reservations: [],
                expenses: [],
                categories: ['Temizlik', 'Elektrik', 'Su', 'Ä°nternet', 'YÃ¶netim', 'BakÄ±m', 'DiÄŸer'],
                capitalExpenses: []
            };
            
            // Generate realistic reservations for the past 6 months
            const platforms = ['Booking.com', 'Airbnb', 'Direkt'];
            const paymentMethods = ['Banka', 'Nakit'];
            const today = new Date();
            
            for (let monthOffset = 5; monthOffset >= 0; monthOffset--) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() - monthOffset, 1);
                
                sampleData.apartments.forEach(apartment => {
                    // Generate 3-8 reservations per apartment per month
                    const reservationCount = Math.floor(Math.random() * 6) + 3;
                    let currentDay = 1;
                    
                    for (let i = 0; i < reservationCount; i++) {
                        const checkInDay = currentDay + Math.floor(Math.random() * 3);
                        const stayLength = Math.floor(Math.random() * 5) + 2; // 2-7 nights
                        
                        const checkIn = new Date(monthDate.getFullYear(), monthDate.getMonth(), checkInDay);
                        const checkOut = new Date(monthDate.getFullYear(), monthDate.getMonth(), checkInDay + stayLength);
                        
                        const platform = platforms[Math.floor(Math.random() * platforms.length)];
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
                        const nightlyRate = 100 + Math.floor(Math.random() * 150); // â‚¬100-250 per night
                        const totalAmount = nightlyRate * stayLength;
                        const platformCommission = platform === 'Direkt' ? 0 : totalAmount * 0.15;
                        
                        sampleData.reservations.push({
                            id: `res_${apartment.id}_${monthOffset}_${i}`,
                            apartmentId: apartment.id,
                            guestName: `Guest ${Math.floor(Math.random() * 1000)}`,
                            checkIn: checkIn.toISOString().split('T')[0],
                            checkOut: checkOut.toISOString().split('T')[0],
                            platform: platform,
                            totalAmount: totalAmount,
                            platformCommission: platformCommission,
                            paymentMethod: paymentMethod,
                            currency: 'EUR'
                        });
                        
                        currentDay = checkInDay + stayLength + Math.floor(Math.random() * 3); // Gap between reservations
                        if (currentDay > 28) break; // Don't exceed month
                    }
                    
                    // Generate expenses for each apartment
                    const expenseCount = Math.floor(Math.random() * 4) + 2; // 2-5 expenses per month
                    for (let i = 0; i < expenseCount; i++) {
                        const category = sampleData.categories[Math.floor(Math.random() * sampleData.categories.length)];
                        const amount = 50 + Math.floor(Math.random() * 200); // 50-250 TL
                        
                        sampleData.expenses.push({
                            id: `exp_${apartment.id}_${monthOffset}_${i}`,
                            category: category,
                            amount: amount,
                            currency: 'TL',
                            date: new Date(monthDate.getFullYear(), monthDate.getMonth(), 15).toISOString().split('T')[0],
                            apartmentId: apartment.id
                        });
                    }
                });
            }
            
            setTimeout(() => {
                this.data = sampleData;
                this.filteredData = sampleData;
                this.processData();
                this.showToast('Ã–rnek veri yÃ¼klendi!', 'success');
                this.hideLoading();
            }, 500);
        },
        
        processData() {
            console.log('ðŸ“¦ processData baÅŸladÄ±');
            
            // Hide upload section
            document.getElementById('uploadSection').classList.add('hidden');
            
            // Show main dashboard
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            // Clear cache
            this.cache.calculations.clear();
            this.cache.lastUpdate = Date.now();
            
            // Initialize dashboard
            this.updateAllMetrics();
            this.populateSelectors();
            this.generateNotifications();
            
            // âœ… Grafikleri gecikmeyle Ã§iz
            setTimeout(() => {
                console.log('ðŸŽ¨ Grafikler Ã§iziliyor...');
                this.initializeCharts();
                
                // Grafikleri resize et
                setTimeout(() => {
                    Object.values(this.charts).forEach(chart => {
                        if (chart && chart.resize) {
                            chart.resize();
                        }
                    });
                    console.log('âœ… Toplam grafik:', Object.keys(this.charts).length);
                }, 200);
                
                lucide.createIcons();
            }, 300);
        },
                
        updateAllMetrics() {
            this.updateQuickStats();
            this.updateKPICards();
            this.updatePerformanceMetrics();
            // this.updateTopPerformers(); // â† YORUMA AL (performanceMetrics iÃ§inde zaten var)
            this.updateSystemCards();
            this.updateRecentActivity();
            this.updateAlerts();
            this.updateEfficiencyMetrics();
            
            // Grafikleri yeniden Ã§iz
            if (Object.keys(this.charts).length > 0) {
                this.resizeAllCharts();
            }
        },
        // Update trend indicators
        updateTrendIndicators(stats) {
            // Portfolio trend calculation
            const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
            const portfolioTrend = lastMonthRevenue > 0 ? 
                ((stats.totalPortfolio - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
            
            const trendElement = document.getElementById('portfolioTrend');
            if (trendElement) {
                trendElement.textContent = portfolioTrend > 0 ? `+${portfolioTrend}%` : 
                                        portfolioTrend < 0 ? `${portfolioTrend}%` : 'â†’';
                trendElement.className = portfolioTrend > 0 ? 'text-xs text-emerald-600 font-semibold' :
                                        portfolioTrend < 0 ? 'text-xs text-red-600 font-semibold' :
                                        'text-xs text-gray-600 font-semibold';
            }
            
            // Monthly trend
            const monthlyTrend = this.calculateMonthlyTrend();
            const monthlyTrendElement = document.getElementById('monthlyTrend');
            if (monthlyTrendElement) {
                monthlyTrendElement.textContent = monthlyTrend.icon;
                monthlyTrendElement.className = `text-xs font-semibold ${monthlyTrend.color}`;
            }
            
            // Occupancy indicator
            const occupancyIndicator = document.getElementById('occupancyIndicator');
            if (occupancyIndicator) {
                const lastMonthOccupancy = this.calculateAverageOccupancy(-1);
                const occupancyDiff = stats.avgOccupancy - lastMonthOccupancy;
                occupancyIndicator.textContent = occupancyDiff > 5 ? 'â†‘' :
                                                occupancyDiff < -5 ? 'â†“' : 'â†’';
                occupancyIndicator.className = occupancyDiff > 5 ? 'text-xs text-emerald-600' :
                                            occupancyDiff < -5 ? 'text-xs text-red-600' :
                                            'text-xs text-orange-600';
            }
        },
        
        // Update quick stats in header and cards
        // Update quick stats in header and cards
        updateQuickStats() {
            const stats = this.calculateQuickStats();
            
            // Header stats
            document.getElementById('headerPortfolioValue').textContent = `â‚¬${stats.totalPortfolio.toLocaleString()}`;
            document.getElementById('headerMonthlyValue').textContent = `â‚¬${stats.monthlyRevenue.toLocaleString()}`;
            
            // KPI Cards
            document.getElementById('totalPortfolioValue').textContent = `â‚¬${stats.totalPortfolio.toLocaleString()}`;
            document.getElementById('monthlyRevenue').textContent = `â‚¬${stats.monthlyRevenue.toLocaleString()}`;
            document.getElementById('activeProperties').textContent = `${stats.activeProperties}/${stats.totalProperties}`;
            document.getElementById('avgOccupancy').textContent = `${stats.avgOccupancy.toFixed(1)}%`;
            document.getElementById('bestSystem').textContent = `Sistem ${stats.bestSystem.id}`;
            document.getElementById('systemProfit').textContent = `â‚¬${stats.bestSystem.profit.toLocaleString()}`;
            
            // Update trends and indicators
            this.updateTrendIndicators(stats); // â† Ã‡aÄŸrÄ± burada
            
            // Update progress bars
            const portfolioProgress = document.getElementById('portfolioProgress');
            if (portfolioProgress) {
                const progressPercent = Math.min(100, (stats.monthlyRevenue / stats.monthlyTarget) * 100);
                portfolioProgress.style.width = `${progressPercent}%`;
            }
            
            // Active percentage badge
            const activePercentage = (stats.activeProperties / stats.totalProperties * 100).toFixed(0);
            document.getElementById('activePercentage').textContent = `${activePercentage}%`;
            
            // Notification count
            document.getElementById('notificationCount').textContent = this.notifications.length;
        },

        // âœ… BURAYA EKLE (updateQuickStats fonksiyonunun DIÅžINDA)
        updateTrendIndicators(stats) {
            // Portfolio trend
            const trendElement = document.getElementById('portfolioTrend');
            if (trendElement) {
                const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
                const portfolioTrend = lastMonthRevenue > 0 ? 
                    ((stats.totalPortfolio - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
                
                trendElement.textContent = portfolioTrend > 0 ? `+${portfolioTrend}%` : 
                                        portfolioTrend < 0 ? `${portfolioTrend}%` : 'â†’';
                trendElement.className = portfolioTrend > 0 ? 'text-xs text-emerald-600 font-semibold' :
                                        portfolioTrend < 0 ? 'text-xs text-red-600 font-semibold' :
                                        'text-xs text-gray-600 font-semibold';
            }
        },

        // Calculate quick statistics
        calculateQuickStats() {
            const cacheKey = 'quickStats';
            if (this.cache.calculations.has(cacheKey)) {
                return this.cache.calculations.get(cacheKey);
            }
            
            const stats = {
                totalPortfolio: 0,
                monthlyRevenue: 0,
                totalProperties: this.data.apartments?.length || 0,
                activeProperties: 0,
                avgOccupancy: 0,
                bestSystem: { id: '-', profit: 0 },
                monthlyTarget: 10000 // Default target
            };
            
            // Calculate total portfolio value
            this.data.apartments?.forEach(apartment => {
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                stats.totalPortfolio += revenue;
                
                if (reservations.length > 0) {
                    stats.activeProperties++;
                }
            });
            
            // Calculate monthly revenue
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            this.data.apartments?.forEach(apartment => {
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                           date.getMonth() === currentMonth &&
                           date.getFullYear() === currentYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                           date.getMonth() === currentMonth &&
                           date.getFullYear() === currentYear;
                }) || [];
                
                stats.monthlyRevenue += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            // Calculate average occupancy
            let totalOccupancy = 0;
            let occupancyCount = 0;
            
            this.data.apartments?.forEach(apartment => {
                const occupancy = this.calculateOccupancyRate(apartment.id);
                if (occupancy > 0) {
                    totalOccupancy += occupancy;
                    occupancyCount++;
                }
            });
            
            stats.avgOccupancy = occupancyCount > 0 ? totalOccupancy / occupancyCount : 0;
            
            // Find best performing system
            const systemRevenues = {};
            
            this.data.apartments?.forEach(apartment => {
                const systemType = apartment.systemType;
                if (!systemRevenues[systemType]) {
                    systemRevenues[systemType] = 0;
                }
                
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                systemRevenues[systemType] += this.calculateLagirioRevenue(apartment, reservations, expenses);
            });
            
            Object.entries(systemRevenues).forEach(([system, revenue]) => {
                if (revenue > stats.bestSystem.profit) {
                    stats.bestSystem = { id: system, profit: revenue };
                }
            });
            
            this.cache.calculations.set(cacheKey, stats);
            return stats;
        },
        // 1. Para birimi dÃ¶nÃ¼ÅŸtÃ¼rme
        convertToEUR(amount, currency) {
            const tlRate = parseFloat(document.getElementById('exchangeRateTL')?.value) || 48.5;
            const usdRate = parseFloat(document.getElementById('exchangeRateUSD')?.value) || 0.86;
            
            const rates = {
                EUR: 1,
                'â‚¬': 1,
                USD: usdRate,
                '$': usdRate,
                TL: 1 / tlRate,
                'â‚º': 1 / tlRate
            };
            
            return amount * (rates[currency] || 1);
        },

        // 2. Lagirio kazancÄ± hesaplama
        calculateLagirioRevenue(apartment, reservations, expenses = []) {
            // Banka/Nakit ayrÄ±mÄ±
            const bank = reservations.filter(r => r.paymentMethod !== 'Nakit');
            const cash = reservations.filter(r => r.paymentMethod === 'Nakit');

            // Gelir hesaplama
            const bankIncome = bank.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            const cashIncome = cash.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            const totalIncome = bankIncome + cashIncome;

            // Platform komisyonlarÄ±
            const bankCommission = bank.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
            const cashCommission = cash.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
            const totalPlatformCommission = bankCommission + cashCommission;

            // Giderler
            const totalExpenses = expenses.reduce((sum, exp) => 
                sum + this.convertToEUR(exp.amount, exp.currency), 0);

            // KDV hesaplamasÄ± - SÄ°STEM BAZLI
            let totalKDV = 0;
            switch(apartment.systemType) {
                case '1':
                case '3':
                case '4':
                case '5':
                    totalKDV = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    break;
                case '7':
                    const system7BookingDirect = reservations.filter(r => r.platform !== 'Airbnb');
                    const bookingDirectBank = system7BookingDirect.filter(r => r.paymentMethod !== 'Nakit');
                    const bookingBankIncome = bookingDirectBank.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    totalKDV = bookingBankIncome * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    break;
                default:
                    totalKDV = 0;
            }

            // Sistem bazlÄ± Lagirio kazancÄ± hesaplama
            let lagirioProfit = 0;

            switch(apartment.systemType) {
                case '1': // Sistem 1 - Net kar Lagirio'nun
                    lagirioProfit = totalIncome - bankCommission - cashCommission - totalExpenses - totalKDV;
                    break;

                case '2': // Sistem 2 - Komisyonlar Lagirio'nun
                    const bankLagirioComm2 = bankIncome * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform2 = cashIncome - cashCommission;
                    const cashLagirioComm2 = cashAfterPlatform2 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm2 + cashLagirioComm2;
                    break;

                case '3': // Sistem 3
                    const afterDeductions3 = bankIncome - totalExpenses - totalKDV - bankCommission;
                    const bankLagirioComm3 = afterDeductions3 * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform3 = cashIncome - cashCommission;
                    const cashLagirioComm3 = cashAfterPlatform3 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm3 + cashLagirioComm3;
                    break;

                case '4': // Sistem 4
                    const afterPlatform4 = bankIncome - bankCommission;
                    const bankLagirioComm4 = afterPlatform4 * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform4 = cashIncome - cashCommission;
                    const cashLagirioComm4 = cashAfterPlatform4 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm4 + cashLagirioComm4;
                    break;

                case '5': // Sistem 5 - StopajlÄ±
                    const afterPlatform5 = bankIncome - bankCommission;
                    const bankLagirioComm5 = afterPlatform5 * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform5 = cashIncome - cashCommission;
                    const cashLagirioComm5 = cashAfterPlatform5 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm5 + cashLagirioComm5;
                    break;

                case '6': // Sistem 6 - Platform AyrÄ±mlÄ±
                    const netIncome6 = totalIncome - totalPlatformCommission - totalExpenses;
                    lagirioProfit = netIncome6 * (apartment.lagirioCommission / 100);
                    break;

                case '7': // Sistem 7 - Karma Platform
                    const airbnbRes = reservations.filter(r => r.platform === 'Airbnb');
                    const otherRes = reservations.filter(r => r.platform !== 'Airbnb');
                    
                    // Airbnb hesaplamalarÄ±
                    const airbnbIncome = airbnbRes.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const airbnbComm = airbnbRes.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const airbnbAfterPlatform = airbnbIncome - airbnbComm;
                    const airbnbLagirioComm = airbnbAfterPlatform * (apartment.lagirioCommission / 100);
                    
                    // Booking/Direct - Banka
                    const bookingBank = otherRes.filter(r => r.paymentMethod !== 'Nakit');
                    const bookingBankIncome7 = bookingBank.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingBankComm = bookingBank.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingBankAfterPlatform = bookingBankIncome7 - bookingBankComm;
                    const bookingBankLagirioComm = bookingBankAfterPlatform * (apartment.lagirioCommission / 100);
                    
                    // Booking/Direct - Nakit
                    const bookingCash = otherRes.filter(r => r.paymentMethod === 'Nakit');
                    const bookingCashIncome = bookingCash.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingCashComm = bookingCash.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingCashAfterPlatform = bookingCashIncome - bookingCashComm;
                    const bookingCashLagirioComm = bookingCashAfterPlatform * (apartment.lagirioCommission / 100);
                    
                    lagirioProfit = airbnbLagirioComm + bookingBankLagirioComm + bookingCashLagirioComm;
                    break;

                case '8': // Sistem 8 - KÃ¢r bazlÄ± komisyon
                    const profit8 = bankIncome - totalExpenses - bankCommission;
                    const bankLagirioComm8 = profit8 > 0 ? profit8 * (apartment.lagirioCommission / 100) : 0;
                    const cashAfterPlatform8 = cashIncome - cashCommission;
                    const cashLagirioComm8 = cashAfterPlatform8 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm8 + cashLagirioComm8;
                    break;

                default:
                    lagirioProfit = 0;
            }

            return lagirioProfit;
        },

        // 3. Ev sahibi payÄ± hesaplama
        calculateOwnerShare(apartment, reservations, expenses = []) {
            // Banka/Nakit ayrÄ±mÄ±
            const bank = reservations.filter(r => r.paymentMethod !== 'Nakit');
            const cash = reservations.filter(r => r.paymentMethod === 'Nakit');

            // Gelir hesaplama
            const bankIncome = bank.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            const cashIncome = cash.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);

            // Platform komisyonlarÄ±
            const bankCommission = bank.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
            const cashCommission = cash.reduce((sum, res) => sum + (res.platformCommission || 0), 0);

            // Giderler
            const totalExpenses = expenses.reduce((sum, exp) => 
                sum + this.convertToEUR(exp.amount, exp.currency), 0);

            // Sistem bazlÄ± daire sahibi kazancÄ±
            let ownerShare = 0;

            switch(apartment.systemType) {
                case '1': // Sistem 1 - TÃ¼mÃ¼ Lagirio'nun
                    ownerShare = 0;
                    break;

                case '2': // Sistem 2
                    const lagirioComm2 = bankIncome * (apartment.lagirioCommission / 100);
                    const toBeReturned2 = totalExpenses + bankCommission + lagirioComm2;
                    const kdvOnReturn2 = toBeReturned2 * 0.20;
                    const bankOwner2 = bankIncome - toBeReturned2 - kdvOnReturn2;
                    
                    const cashAfter2 = cashIncome - cashCommission;
                    const cashLagirioComm2 = cashAfter2 * (apartment.lagirioCommission / 100);
                    const cashOwner2 = cashAfter2 - cashLagirioComm2;
                    
                    ownerShare = bankOwner2 + cashOwner2;
                    break;

                case '3': // Sistem 3
                    const kdv3 = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    const afterDeductions3 = bankIncome - totalExpenses - kdv3 - bankCommission;
                    const lagirioComm3 = afterDeductions3 * (apartment.lagirioCommission / 100);
                    const afterLagirio3 = afterDeductions3 - lagirioComm3;
                    const incomeTax3 = afterLagirio3 * (apartment.incomeTaxRate / 100);
                    const bankOwner3 = afterLagirio3 - incomeTax3;
                    
                    const cashAfter3 = cashIncome - cashCommission;
                    const cashLagirioComm3 = cashAfter3 * (apartment.lagirioCommission / 100);
                    const cashOwner3 = cashAfter3 - cashLagirioComm3;
                    
                    ownerShare = bankOwner3 + cashOwner3;
                    break;

                case '4': // Sistem 4
                    const kdv4 = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    const afterPlatform4 = bankIncome - bankCommission;
                    const lagirioComm4 = afterPlatform4 * (apartment.lagirioCommission / 100);
                    const afterLagirio4 = afterPlatform4 - lagirioComm4 - totalExpenses - kdv4;
                    const incomeTax4 = afterLagirio4 * (apartment.incomeTaxRate / 100);
                    const bankOwner4 = afterLagirio4 - incomeTax4;
                    
                    const cashAfter4 = cashIncome - cashCommission;
                    const cashLagirioComm4 = cashAfter4 * (apartment.lagirioCommission / 100);
                    const cashOwner4 = cashAfter4 - cashLagirioComm4;
                    
                    ownerShare = bankOwner4 + cashOwner4;
                    break;

                case '5': // Sistem 5 - StopajlÄ±
                    const afterPlatform5 = bankIncome - bankCommission;
                    const lagirioComm5 = afterPlatform5 * (apartment.lagirioCommission / 100);
                    const kdv5 = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    const afterAllDeductions5 = afterPlatform5 - lagirioComm5 - totalExpenses - kdv5;
                    const stopaj5 = afterAllDeductions5 * (apartment.stopajRate / 100);
                    const bankOwner5 = afterAllDeductions5 - stopaj5;
                    
                    const cashAfter5 = cashIncome - cashCommission;
                    const cashLagirioComm5 = cashAfter5 * (apartment.lagirioCommission / 100);
                    const cashOwner5 = cashAfter5 - cashLagirioComm5;
                    
                    ownerShare = bankOwner5 + cashOwner5;
                    break;

                case '6': // Sistem 6 - Platform ayrÄ±mlÄ±
                    const totalIncome6 = bankIncome + cashIncome;
                    const totalComm6 = bankCommission + cashCommission;
                    const netIncome6 = totalIncome6 - totalComm6 - totalExpenses;
                    const lagirioComm6 = netIncome6 * (apartment.lagirioCommission / 100);
                    ownerShare = netIncome6 - lagirioComm6;
                    break;

                case '7': // Sistem 7 - Karma platform
                    const airbnbRes7 = reservations.filter(r => r.platform === 'Airbnb');
                    const otherRes7 = reservations.filter(r => r.platform !== 'Airbnb');
                    
                    // Airbnb
                    const airbnbIncome7 = airbnbRes7.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const airbnbComm7 = airbnbRes7.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const airbnbAfter7 = airbnbIncome7 - airbnbComm7;
                    const airbnbLagirioComm7 = airbnbAfter7 * (apartment.lagirioCommission / 100);
                    const airbnbOwner7 = airbnbAfter7 - airbnbLagirioComm7;
                    
                    // Booking/Direct Banka
                    const bookingBank7 = otherRes7.filter(r => r.paymentMethod !== 'Nakit');
                    const bookingBankIncome7 = bookingBank7.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingBankComm7 = bookingBank7.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingKDV7 = bookingBankIncome7 * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    const bookingAfterPlatform7 = bookingBankIncome7 - bookingBankComm7;
                    const bookingLagirioComm7 = bookingAfterPlatform7 * (apartment.lagirioCommission / 100);
                    const afterLagirio7 = bookingAfterPlatform7 - bookingLagirioComm7;
                    const afterExpenses7 = afterLagirio7 - totalExpenses - bookingKDV7;
                    const bookingIncomeTax7 = afterExpenses7 * (apartment.incomeTaxRate / 100);
                    const bookingBankOwner7 = afterExpenses7 - bookingIncomeTax7;
                    
                    // Booking/Direct Nakit
                    const bookingCash7 = otherRes7.filter(r => r.paymentMethod === 'Nakit');
                    const bookingCashIncome7 = bookingCash7.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingCashComm7 = bookingCash7.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingCashAfter7 = bookingCashIncome7 - bookingCashComm7;
                    const bookingCashLagirioComm7 = bookingCashAfter7 * (apartment.lagirioCommission / 100);
                    const bookingCashOwner7 = bookingCashAfter7 - bookingCashLagirioComm7;
                    
                    ownerShare = airbnbOwner7 + bookingBankOwner7 + bookingCashOwner7;
                    break;

                case '8': // Sistem 8 - KÃ¢r bazlÄ±
                    const profit8 = bankIncome - totalExpenses - bankCommission;
                    const lagirioComm8 = profit8 > 0 ? profit8 * (apartment.lagirioCommission / 100) : 0;
                    const bankOwner8 = bankIncome - totalExpenses - bankCommission - lagirioComm8;
                    
                    const cashAfter8 = cashIncome - cashCommission;
                    const cashLagirioComm8 = cashAfter8 * (apartment.lagirioCommission / 100);
                    const cashOwner8 = cashAfter8 - cashLagirioComm8;
                    
                    ownerShare = bankOwner8 + cashOwner8;
                    break;

                default:
                    ownerShare = 0;
            }

            return ownerShare;
        },

        // 4. Doluluk oranÄ± hesaplama
        calculateOccupancyRate(apartmentId, startDate = null, endDate = null) {
            // Tarih aralÄ±ÄŸÄ± belirleme
            if (!startDate || !endDate) {
                if (this.dateFilter.start || this.dateFilter.end) {
                    // Filtre varsa, filtrenin ayÄ±nÄ± kullan
                    const filterDate = this.dateFilter.start || this.dateFilter.end;
                    startDate = new Date(filterDate.getFullYear(), filterDate.getMonth(), 1);
                    endDate = new Date(filterDate.getFullYear(), filterDate.getMonth() + 1, 0);
                } else {
                    // Filtre yoksa, tÃ¼m zamanlar
                    startDate = new Date(new Date().getFullYear(), 0, 1);
                    endDate = new Date();
                }
            }
            
            // HER ZAMAN this.data kullan - tarih filtresi burada uygulanÄ±r
            const reservations = this.data.reservations?.filter(r => r.apartmentId === apartmentId) || [];
            let bookedNights = 0;
            
            reservations.forEach(res => {
                const checkIn = new Date(res.checkIn);
                const checkOut = new Date(res.checkOut);
                
                const overlapStart = Math.max(checkIn.getTime(), startDate.getTime());
                const overlapEnd = Math.min(checkOut.getTime(), endDate.getTime());
                
                if (overlapStart < overlapEnd) {
                    const nights = Math.ceil((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24));
                    bookedNights += nights;
                }
            });
            
            const totalNights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            return totalNights > 0 ? (bookedNights / totalNights) * 100 : 0;
        },

        // 5. HÄ±zlÄ± istatistikleri hesaplama
        calculateQuickStats() {
            const cacheKey = 'quickStats';
            if (this.cache.calculations.has(cacheKey)) {
                return this.cache.calculations.get(cacheKey);
            }
            
            const stats = {
                totalPortfolio: 0,
                monthlyRevenue: 0,
                totalProperties: this.data.apartments?.length || 0,
                activeProperties: 0,
                avgOccupancy: 0,
                bestSystem: { id: '-', profit: 0 },
                monthlyTarget: 10000
            };
            
            // TÃ¼m zamanlar iÃ§in toplam portfÃ¶y deÄŸeri
            this.data.apartments?.forEach(apartment => {
                const reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                stats.totalPortfolio += revenue;
                
                if (reservations.length > 0) {
                    stats.activeProperties++;
                }
            });
            
            // AylÄ±k gelir - tarih filtresine gÃ¶re
            let targetMonth, targetYear;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
            } else {
                const now = new Date();
                targetMonth = now.getMonth();
                targetYear = now.getFullYear();
            }
            
            this.data.apartments?.forEach(apartment => {
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                stats.monthlyRevenue += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            // Ortalama doluluk - sadece aktif daireleri say
            let totalOccupancy = 0;
            let activeCount = 0;
            
            this.data.apartments?.forEach(apartment => {
                // Bu dÃ¶nemde rezervasyonu var mÄ± kontrol et
                const hasReservations = this.data.reservations?.some(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                });
                
                if (hasReservations) {
                    const occupancy = this.calculateOccupancyRate(apartment.id);
                    totalOccupancy += occupancy;
                    activeCount++;
                }
            });
            
            stats.avgOccupancy = activeCount > 0 ? totalOccupancy / activeCount : 0;
            
            // En iyi sistem
            const systemRevenues = {};
            
            this.data.apartments?.forEach(apartment => {
                const systemType = apartment.systemType;
                if (!systemRevenues[systemType]) {
                    systemRevenues[systemType] = 0;
                }
                
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                systemRevenues[systemType] += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            Object.entries(systemRevenues).forEach(([system, revenue]) => {
                if (revenue > stats.bestSystem.profit) {
                    stats.bestSystem = { id: system, profit: revenue };
                }
            });
            
            this.cache.calculations.set(cacheKey, stats);
            return stats;
        },

        // 6. Aktif daire sayÄ±sÄ± hesaplama
        calculateActiveApartments() {
            const activeApartments = new Set();
            
            // Tarih filtresine gÃ¶re hedef ay
            let targetMonth, targetYear;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
                
                // SeÃ§ili ayda rezervasyonu olanlar
                this.data.reservations?.forEach(res => {
                    const date = new Date(res.checkIn);
                    if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                        activeApartments.add(res.apartmentId);
                    }
                });
            } else {
                // TÃ¼m zamanlarda rezervasyonu olanlar
                this.data.reservations?.forEach(res => {
                    activeApartments.add(res.apartmentId);
                });
            }
            
            return activeApartments.size;
        },

        // 7. AylÄ±k gelir hesaplama
        calculateMonthlyRevenue(monthOffset = 0) {
            let totalRevenue = 0;
            
            const targetDate = new Date();
            
            if ((this.dateFilter.start || this.dateFilter.end) && monthOffset === 0) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetDate.setMonth(filterDate.getMonth());
                targetDate.setFullYear(filterDate.getFullYear());
            } else {
                targetDate.setMonth(targetDate.getMonth() + monthOffset);
            }
            
            const targetMonth = targetDate.getMonth();
            const targetYear = targetDate.getFullYear();
            
            // HER ZAMAN this.data kullan
            this.data.apartments?.forEach(apartment => {
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                totalRevenue += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            return totalRevenue;
        },

        // 8. Toplam Lagirio geliri hesaplama
        calculateTotalLagirioRevenue() {
            let total = 0;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                const targetMonth = filterDate.getMonth();
                const targetYear = filterDate.getFullYear();
                
                this.data.apartments?.forEach(apartment => {
                    const monthlyReservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    const monthlyExpenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    total += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
                });
            } else {
                this.data.apartments?.forEach(apartment => {
                    const reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                    const expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                    total += this.calculateLagirioRevenue(apartment, reservations, expenses);
                });
            }
            
            return total;
        },

        // 9. Ortalama doluluk oranÄ± hesaplama
        calculateAverageOccupancy(monthOffset = 0) {
            let totalOccupancy = 0;
            let activeApartmentCount = 0;
            
            let startDate, endDate;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                startDate = this.dateFilter.start || new Date(new Date().getFullYear(), 0, 1);
                endDate = this.dateFilter.end || new Date();
            } else {
                const targetDate = new Date();
                targetDate.setMonth(targetDate.getMonth() + monthOffset);
                startDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
                endDate = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);
            }
            
            this.data.apartments?.forEach(apartment => {
                // Bu dÃ¶nemde rezervasyonu var mÄ± kontrol et
                const hasReservations = this.data.reservations?.some(res => {
                    const checkIn = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        checkIn >= startDate && checkIn <= endDate;
                });
                
                // Sadece rezervasyonu olan daireleri hesaba kat
                if (hasReservations) {
                    const occupancy = this.calculateOccupancyRate(apartment.id, startDate, endDate);
                    totalOccupancy += occupancy;
                    activeApartmentCount++;
                }
            });
            
            return activeApartmentCount > 0 ? totalOccupancy / activeApartmentCount : 0;
        },

        // 10. AylÄ±k trend hesaplama
        calculateMonthlyTrend() {
            const currentRevenue = this.calculateMonthlyRevenue(0);
            const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
            
            if (lastMonthRevenue === 0) {
                return { icon: 'â†‘', color: 'text-blue-600', value: 100 };
            }
            
            const change = ((currentRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
            
            return {
                icon: change > 10 ? 'â†‘â†‘' : change > 0 ? 'â†‘' : change < -10 ? 'â†“â†“' : change < 0 ? 'â†“' : 'â†’',
                color: change > 0 ? 'text-emerald-600' : change < 0 ? 'text-red-600' : 'text-blue-600',
                value: change
            };
        },

        // 11. Performans metrikleri hesaplama
        calculatePerformanceMetrics() {
            const apartmentMetrics = [];
            
            // Tarih filtresine gÃ¶re hedef ay
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
            }
            
            this.data.apartments?.forEach(apartment => {
                let reservations, expenses;
                
                if (useMonthFilter) {
                    reservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    expenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                } else {
                    reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                    expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                }
                
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                const ownerShare = this.calculateOwnerShare(apartment, reservations, expenses);
                const occupancy = this.calculateOccupancyRate(apartment.id);
                
                const totalIncome = reservations.reduce((sum, res) => 
                    sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                
                const totalExpenses = expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                
                const expenseRatio = totalIncome > 0 ? (totalExpenses / totalIncome) * 100 : 0;
                const profitMargin = totalIncome > 0 ? ((revenue / totalIncome) * 100) : 0;
                
                apartmentMetrics.push({
                    ...apartment,
                    revenue,
                    ownerShare,
                    occupancy,
                    totalIncome,
                    totalExpenses,
                    expenseRatio,
                    profitMargin,
                    reservationCount: reservations.length,
                    avgNightlyRate: this.calculateAvgNightlyRate(reservations),
                    efficiency: this.calculateEfficiency(apartment.id, revenue)
                });
            });
            
            // Gelire gÃ¶re sÄ±rala
            apartmentMetrics.sort((a, b) => b.revenue - a.revenue);
            
            return {
                topApartments: apartmentMetrics,
                avgExpenseRatio: apartmentMetrics.reduce((sum, apt) => sum + apt.expenseRatio, 0) / apartmentMetrics.length || 0,
                avgProfitMargin: apartmentMetrics.reduce((sum, apt) => sum + apt.profitMargin, 0) / apartmentMetrics.length || 0,
                totalReservations: apartmentMetrics.reduce((sum, apt) => sum + apt.reservationCount, 0)
            };
        },

        // 12. Ortalama gecelik Ã¼cret hesaplama
        calculateAvgNightlyRate(reservations) {
            if (reservations.length === 0) return 0;
            
            let totalAmount = 0;
            let totalNights = 0;
            
            reservations.forEach(res => {
                const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                const nights = Math.ceil((new Date(res.checkOut) - new Date(res.checkIn)) / (1000 * 60 * 60 * 24));
                totalAmount += amount;
                totalNights += nights;
            });
            
            return totalNights > 0 ? totalAmount / totalNights : 0;
        },

        // 13. Verimlilik skoru hesaplama
        calculateEfficiency(apartmentId, revenue) {
            const occupancy = this.calculateOccupancyRate(apartmentId);
            
            // Tarih filtresine gÃ¶re rezervasyonlarÄ± al
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let reservations;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                const targetMonth = filterDate.getMonth();
                const targetYear = filterDate.getFullYear();
                
                reservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartmentId &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
            } else {
                reservations = this.data.reservations?.filter(r => r.apartmentId === apartmentId) || [];
            }
            
            const avgRate = this.calculateAvgNightlyRate(reservations);
            
            if (avgRate === 0 || occupancy === 0) return 0;
            
            // Verimlilik = (GerÃ§ek Gelir / Potansiyel Gelir) * 100
            const potentialRevenue = (occupancy / 100) * avgRate * 30; // AylÄ±k potansiyel
            return potentialRevenue > 0 ? (revenue / potentialRevenue) * 100 : 0;
        },
        
                // 14. Grafikleri baÅŸlatma
        initializeCharts() {
            // Dispose existing charts
            Object.values(this.charts).forEach(chart => {
                if (chart && chart.dispose) {
                    chart.dispose();
                }
            });
            this.charts = {};
            
            // Create new charts
            this.createRevenueTrendChart();
            this.createPlatformDistChart();
            this.createPaymentMethodChart();
            
            // DiÄŸer chart fonksiyonlarÄ±nÄ± kaldÄ±r (Ã§Ã¼nkÃ¼ boÅŸlar ve hata veriyor)
            // this.createSystemAnalysisCharts();
            this.createTrendAnalysisCharts();
            this.createEfficiencyCharts();
            
            // âœ… Grafikleri zorla resize/refresh et
            setTimeout(() => {
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.resize) {
                        chart.resize();
                    }
                });
            }, 100);
        },

        // 15. Gelir trend grafiÄŸi oluÅŸturma
        createRevenueTrendChart() {
            const container = document.getElementById('revenueTrendChart');
            if (!container) return;
            
            const period = document.getElementById('trendPeriod')?.value || 'monthly';
            const data = this.getRevenueTrendData(period);
            
            const chart = echarts.init(container);
            this.charts.revenueTrend = chart;
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' },
                    formatter: params => {
                        const value = params[0].value;
                        return `${params[0].name}<br/>
                                <span style="color:${params[0].color}">â—</span> KazanÃ§: â‚¬${value.toLocaleString()}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.labels,
                    axisLine: {
                        lineStyle: { color: '#e5e7eb' }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: { color: '#f3f4f6', type: 'dashed' }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        formatter: value => `â‚¬${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [{
                    name: 'KazanÃ§',
                    type: 'line',
                    data: data.values,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: {
                        width: 3,
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#10b981' },
                            { offset: 1, color: '#059669' }
                        ])
                    },
                    itemStyle: {
                        color: '#10b981',
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                            { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                        ])
                    },
                    emphasis: {
                        scale: 1.2,
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(16, 185, 129, 0.5)'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
        },

        // 16. Platform daÄŸÄ±lÄ±m grafiÄŸi oluÅŸturma
        createPlatformDistChart() {
            const container = document.getElementById('platformDistChart');
            if (!container) return;
            
            const data = this.getPlatformDistributionData();
            
            const chart = echarts.init(container);
            this.charts.platformDist = chart;
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' },
                    formatter: '{b}<br/>{c} rezervasyon ({d}%)'
                },
                legend: {
                    bottom: '0%',
                    left: 'center',
                    textStyle: { color: '#6b7280', fontSize: 11 }
                },
                series: [{
                    type: 'pie',
                    radius: ['45%', '75%'],
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    label: { show: false },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    },
                    data: data.platforms.map((platform, index) => ({
                        value: data.counts[index],
                        name: platform,
                        itemStyle: {
                            color: this.getPlatformColor(platform)
                        }
                    }))
                }]
            };
            
            chart.setOption(option);
        },

        // 17. Ã–deme yÃ¶ntemi grafiÄŸi oluÅŸturma
        createPaymentMethodChart() {
            const container = document.getElementById('paymentMethodChart');
            if (!container) return;
            
            const data = this.getPaymentMethodData();
            
            const chart = echarts.init(container);
            this.charts.paymentMethod = chart;
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' },
                    formatter: params => {
                        const percentage = params.percent;
                        const value = params.value;
                        return `${params.name}<br/>â‚¬${value.toLocaleString()} (${percentage}%)`;
                    }
                },
                series: [{
                    type: 'pie',
                    radius: '75%',
                    center: ['50%', '50%'],
                    data: [
                        {
                            value: data.bank,
                            name: 'Banka',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                    { offset: 0, color: '#3b82f6' },
                                    { offset: 1, color: '#1d4ed8' }
                                ])
                            }
                        },
                        {
                            value: data.cash,
                            name: 'Nakit',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                    { offset: 0, color: '#10b981' },
                                    { offset: 1, color: '#059669' }
                                ])
                            }
                        }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        },
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        }
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%',
                        fontSize: 12,
                        fontWeight: 'bold'
                    }
                }]
            };
            
            chart.setOption(option);
        },

        // 18. Sistem analiz grafikleri oluÅŸturma
        // System analysis charts
        createSystemAnalysisCharts() {
            try {
                this.createSystemComparisonChart();
                console.log('âœ… System comparison chart OK');
            } catch (e) {
                console.error('âŒ System comparison hatasÄ±:', e);
            }
            // DiÄŸerleri henÃ¼z tamamlanmadÄ±
            // this.createSystemEfficiencyChart();
            // this.createSystemRevenueChart();
        },

        // System analysis charts
        createSystemAnalysisCharts() {
            try {
                this.createSystemComparisonChart();
                console.log('âœ… System comparison chart OK');
            } catch (e) {
                console.error('âŒ System comparison hatasÄ±:', e);
            }
        },

        // Placeholder fonksiyonlar (sonra tamamlanacak)
        createSystemEfficiencyChart() {
            console.log('âš ï¸ System efficiency chart henÃ¼z tamamlanmadÄ±');
        },

        createSystemRevenueChart() {
            console.log('âš ï¸ System revenue chart henÃ¼z tamamlanmadÄ±');
        },

        createTrendAnalysisCharts() {
            console.log('âš ï¸ Trend analysis charts henÃ¼z tamamlanmadÄ±');
        },

        createEfficiencyCharts() {
            console.log('âš ï¸ Efficiency charts henÃ¼z tamamlanmadÄ±');
        },

        updateEfficiencyMetrics() {
            console.log('âš ï¸ Efficiency metrics henÃ¼z tamamlanmadÄ±');
        },

        // 19. Sistem karÅŸÄ±laÅŸtÄ±rma grafiÄŸi oluÅŸturma
        createSystemComparisonChart() {
            const container = document.getElementById('systemComparisonChart');
            if (!container) return;
            
            const data = this.getSystemComparisonData();
            
            const chart = echarts.init(container);
            this.charts.systemComparison = chart;
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: ['Toplam KazanÃ§', 'Ortalama Doluluk'],
                    top: '0%',
                    textStyle: { color: '#6b7280' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.systems,
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'KazanÃ§ (â‚¬)',
                        position: 'left',
                        axisLabel: {
                            formatter: value => `â‚¬${(value / 1000).toFixed(0)}k`
                        }
                    },
                    {
                        type: 'value',
                        name: 'Doluluk (%)',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%'
                        },
                        max: 100
                    }
                ],
                series: [
                    {
                        name: 'Toplam KazanÃ§',
                        type: 'bar',
                        data: data.revenues,
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#10b981' },
                                { offset: 1, color: '#059669' }
                            ]),
                            borderRadius: [4, 4, 0, 0]
                        }
                    },
                    {
                        name: 'Ortalama Doluluk',
                        type: 'line',
                        yAxisIndex: 1,
                        data: data.occupancies,
                        symbol: 'circle',
                        symbolSize: 8,
                        lineStyle: {
                            width: 2,
                            color: '#f59e0b'
                        },
                        itemStyle: {
                            color: '#f59e0b'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        },

        // 20. Gelir trend verisi hazÄ±rlama
        getRevenueTrendData(period = 'monthly') {
            const data = { labels: [], values: [] };
            const now = new Date();
            
            switch(period) {
                case 'daily':
                    // Son 30 gÃ¼n
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                        data.labels.push(dateStr);
                        
                        let dayRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const dayReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate.toDateString() === date.toDateString();
                            }) || [];
                            
                            const dayExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate.toDateString() === date.toDateString();
                            }) || [];
                            
                            dayRevenue += this.calculateLagirioRevenue(apartment, dayReservations, dayExpenses);
                        });
                        data.values.push(dayRevenue);
                    }
                    break;
                    
                case 'weekly':
                    // Son 12 hafta
                    for (let i = 11; i >= 0; i--) {
                        const weekStart = new Date(now);
                        weekStart.setDate(weekStart.getDate() - (i * 7) - weekStart.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        
                        data.labels.push(`H${12 - i}`);
                        
                        let weekRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const weekReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate >= weekStart && resDate <= weekEnd;
                            }) || [];
                            
                            const weekExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate >= weekStart && expDate <= weekEnd;
                            }) || [];
                            
                            weekRevenue += this.calculateLagirioRevenue(apartment, weekReservations, weekExpenses);
                        });
                        data.values.push(weekRevenue);
                    }
                    break;
                    
                case 'yearly':
                    // Son 3 yÄ±l
                    for (let i = 2; i >= 0; i--) {
                        const year = now.getFullYear() - i;
                        data.labels.push(year.toString());
                        
                        let yearRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const yearReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate.getFullYear() === year;
                            }) || [];
                            
                            const yearExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate.getFullYear() === year;
                            }) || [];
                            
                            yearRevenue += this.calculateLagirioRevenue(apartment, yearReservations, yearExpenses);
                        });
                        data.values.push(yearRevenue);
                    }
                    break;
                    
                default: // monthly
                    const months = ['Oca', 'Åžub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                    
                    for (let i = 5; i >= 0; i--) {
                        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const monthLabel = `${months[monthDate.getMonth()]} ${monthDate.getFullYear()}`;
                        data.labels.push(monthLabel);
                        
                        let monthRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const monthReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate.getMonth() === monthDate.getMonth() &&
                                    resDate.getFullYear() === monthDate.getFullYear();
                            }) || [];
                            
                            const monthExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate.getMonth() === monthDate.getMonth() &&
                                    expDate.getFullYear() === monthDate.getFullYear();
                            }) || [];
                            
                            monthRevenue += this.calculateLagirioRevenue(apartment, monthReservations, monthExpenses);
                        });
                        data.values.push(monthRevenue);
                    }
            }
            
            return data;
        },

        // 21. Platform daÄŸÄ±lÄ±m verisi hazÄ±rlama
        getPlatformDistributionData() {
            const platformCounts = {};
            const platformRevenues = {};
            
            // Tarih filtresine gÃ¶re
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
                
                this.data.reservations?.forEach(res => {
                    const date = new Date(res.checkIn);
                    if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                        const platform = res.platform || 'Direkt';
                        platformCounts[platform] = (platformCounts[platform] || 0) + 1;
                        platformRevenues[platform] = (platformRevenues[platform] || 0) + 
                            this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                    }
                });
            } else {
                this.data.reservations?.forEach(res => {
                    const platform = res.platform || 'Direkt';
                    platformCounts[platform] = (platformCounts[platform] || 0) + 1;
                    platformRevenues[platform] = (platformRevenues[platform] || 0) + 
                        this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                });
            }
            
            return {
                platforms: Object.keys(platformCounts),
                counts: Object.values(platformCounts),
                revenues: Object.values(platformRevenues)
            };
        },

        // 22. Ã–deme yÃ¶ntemi verisi hazÄ±rlama
        getPaymentMethodData() {
            let bankTotal = 0;
            let cashTotal = 0;
            
            // Tarih filtresine gÃ¶re
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
                
                this.data.reservations?.forEach(res => {
                    const date = new Date(res.checkIn);
                    if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                        const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        if (res.paymentMethod === 'Nakit') {
                            cashTotal += amount;
                        } else {
                            bankTotal += amount;
                        }
                    }
                });
            } else {
                this.data.reservations?.forEach(res => {
                    const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                    if (res.paymentMethod === 'Nakit') {
                        cashTotal += amount;
                    } else {
                        bankTotal += amount;
                    }
                });
            }
            
            return {
                bank: bankTotal,
                cash: cashTotal
            };
        },

        // 23. Sistem karÅŸÄ±laÅŸtÄ±rma verisi hazÄ±rlama
        getSystemComparisonData() {
            const systemData = {};
            const systemNames = {
                '1': 'Sistem 1 - Kira',
                '2': 'Sistem 2 - KiÅŸi Åžrkt',
                '3': 'Sistem 3 - Komisyon',
                '4': 'Sistem 4 - Kom. Ã–zel',
                '5': 'Sistem 5 - StopajlÄ±',
                '6': 'Sistem 6 - Platform',
                '7': 'Sistem 7 - Karma',
                '8': 'Sistem 8 - KÃ¢r BazlÄ±'
            };
            
            // Sistem verilerini baÅŸlat
            for (let i = 1; i <= 8; i++) {
                systemData[i] = {
                    name: systemNames[i],
                    revenue: 0,
                    occupancy: 0,
                    apartmentCount: 0,
                    activeApartmentCount: 0,
                    efficiency: 0,
                    avgCommission: 0,
                    commissions: []
                };
            }
            
            // Tarih filtresine gÃ¶re
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
            }
            
            // Sistem metriklerini hesapla
            this.data.apartments?.forEach(apartment => {
                const system = apartment.systemType;
                systemData[system].apartmentCount++;
                systemData[system].commissions.push(apartment.lagirioCommission);
                
                let reservations, expenses;
                
                if (useMonthFilter) {
                    reservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    expenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                } else {
                    reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                    expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                }
                
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                systemData[system].revenue += revenue;
                
                // Sadece rezervasyonu olan daireleri doluluk hesabÄ±na kat
                if (reservations.length > 0) {
                    systemData[system].activeApartmentCount++;
                    systemData[system].occupancy += this.calculateOccupancyRate(apartment.id);
                    
                    // Verimlilik hesaplama
                    const totalNights = reservations.reduce((sum, res) => {
                        const nights = Math.ceil((new Date(res.checkOut) - new Date(res.checkIn)) / (1000 * 60 * 60 * 24));
                        return sum + nights;
                    }, 0);
                    
                    if (totalNights > 0) {
                        systemData[system].efficiency += revenue / totalNights;
                    }
                }
            });
            
            // OrtalamalarÄ± hesapla
            Object.values(systemData).forEach(system => {
                if (system.activeApartmentCount > 0) {
                    system.occupancy = system.occupancy / system.activeApartmentCount;
                    system.efficiency = system.efficiency / system.activeApartmentCount;
                }
                if (system.commissions.length > 0) {
                    system.avgCommission = system.commissions.reduce((a, b) => a + b, 0) / system.commissions.length;
                }
            });
            
            // BoÅŸ olmayan sistemleri filtrele
            const activeSystems = Object.values(systemData).filter(s => s.apartmentCount > 0);
            
            return {
                systems: activeSystems.map(s => s.name),
                revenues: activeSystems.map(s => s.revenue),
                occupancies: activeSystems.map(s => s.occupancy),
                efficiencies: activeSystems.map(s => s.efficiency),
                avgCommissions: activeSystems.map(s => s.avgCommission)
            };
        },

        // 24. KPI kartlarÄ±nÄ± gÃ¼ncelleme
        updateKPICards() {
            const stats = this.calculateQuickStats();
            
            // Portfolio trend hesaplama
            const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
            const portfolioTrend = lastMonthRevenue > 0 ? 
                ((stats.totalPortfolio - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
            
            const trendElement = document.getElementById('portfolioTrend');
            if (trendElement) {
                trendElement.textContent = portfolioTrend > 0 ? `+${portfolioTrend}%` : 
                                        portfolioTrend < 0 ? `${portfolioTrend}%` : 'â†’';
                trendElement.className = portfolioTrend > 0 ? 'text-xs text-emerald-600 font-semibold' :
                                        portfolioTrend < 0 ? 'text-xs text-red-600 font-semibold' :
                                        'text-xs text-gray-600 font-semibold';
            }
            
            // AylÄ±k trend
            const monthlyTrend = this.calculateMonthlyTrend();
            const monthlyTrendElement = document.getElementById('monthlyTrend');
            if (monthlyTrendElement) {
                monthlyTrendElement.textContent = monthlyTrend.icon;
                monthlyTrendElement.className = `text-xs font-semibold ${monthlyTrend.color}`;
            }
            
            // Doluluk indikatÃ¶rÃ¼
            const occupancyIndicator = document.getElementById('occupancyIndicator');
            if (occupancyIndicator) {
                const lastMonthOccupancy = this.calculateAverageOccupancy(-1);
                const occupancyDiff = stats.avgOccupancy - lastMonthOccupancy;
                occupancyIndicator.textContent = occupancyDiff > 5 ? 'â†‘' :
                                                occupancyDiff < -5 ? 'â†“' : 'â†’';
                occupancyIndicator.className = occupancyDiff > 5 ? 'text-xs text-emerald-600' :
                                            occupancyDiff < -5 ? 'text-xs text-red-600' :
                                            'text-xs text-orange-600';
            }
            
            // Doluluk Ã§ubuklarÄ±nÄ± gÃ¼ncelle
            const occupancyBars = document.querySelectorAll('#avgOccupancy').forEach(element => {
                const parent = element.closest('.relative');
                if (parent) {
                    const bars = parent.querySelectorAll('.h-1');
                    bars.forEach((bar, index) => {
                        const threshold = (index + 1) * 20;
                        if (stats.avgOccupancy >= threshold) {
                            bar.classList.remove('bg-gray-200');
                            bar.classList.add('bg-orange-500');
                        } else {
                            bar.classList.remove('bg-orange-500');
                            bar.classList.add('bg-gray-200');
                        }
                    });
                }
            });
        },

        // 25. Performans metriklerini gÃ¼ncelleme
        updatePerformanceMetrics() {
            const metrics = this.calculatePerformanceMetrics();
            
            // En iyi performans gÃ¶steren daireler listesi
            const topPerformersContainer = document.getElementById('topPerformers');
            if (topPerformersContainer) {
                topPerformersContainer.innerHTML = metrics.topApartments.slice(0, 5).map((apt, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br ${this.getRankColor(index)} rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${index + 1}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${apt.code}</p>
                                <p class="text-xs text-gray-500">${apt.ownerName}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-emerald-600">â‚¬${apt.revenue.toLocaleString()}</p>
                            <p class="text-xs text-gray-500">${apt.occupancy.toFixed(1)}% doluluk</p>
                        </div>
                    </div>
                `).join('');
            }
        },
        // Update system performance cards
        updateSystemCards() {
            const container = document.getElementById('systemPerformanceCards');
            if (!container) return;
            
            const systemData = this.getSystemPerformanceData();
            
            container.innerHTML = systemData.map(system => `
                <div class="col-span-1 bg-gradient-to-br ${system.color} rounded-xl p-6 text-white relative overflow-hidden group hover:shadow-xl transition-all">
                    <div class="absolute top-0 right-0 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="${system.icon}" class="w-24 h-24"></i>
                    </div>
                    <div class="relative">
                        <h4 class="font-semibold mb-3">${system.name}</h4>
                        <p class="text-3xl font-bold mb-2">â‚¬${system.revenue.toLocaleString()}</p>
                        <div class="flex justify-between text-sm opacity-90">
                            <span>${system.apartmentCount} daire</span>
                            <span>${system.avgOccupancy.toFixed(1)}% doluluk</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-white/20">
                            <div class="flex justify-between text-xs">
                                <span>Ort. Komisyon</span>
                                <span class="font-semibold">${system.avgCommission.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Get system performance data
        getSystemPerformanceData() {
            const systemColors = [
                'from-blue-500 to-blue-600',
                'from-purple-500 to-purple-600',
                'from-emerald-500 to-emerald-600',
                'from-orange-500 to-orange-600',
                'from-red-500 to-red-600',
                'from-indigo-500 to-indigo-600',
                'from-pink-500 to-pink-600',
                'from-gray-500 to-gray-600'
            ];
            
            const systemIcons = [
                'home', 'building', 'percent', 'star',
                'shield', 'globe', 'layers', 'trending-up'
            ];
            
            const systemNames = {
                '1': 'Kira',
                '2': 'KiÅŸi Åžirketi',
                '3': 'Komisyon',
                '4': 'Ã–zel Komisyon',
                '5': 'StopajlÄ±',
                '6': 'Platform AyrÄ±mlÄ±',
                '7': 'Karma Platform',
                '8': 'KÃ¢r BazlÄ±'
            };
            
            const systems = [];
            
            for (let i = 1; i <= 8; i++) {
                const apartments = this.data.apartments?.filter(a => a.systemType === String(i)) || [];
                
                if (apartments.length > 0) {
                    let totalRevenue = 0;
                    let totalOccupancy = 0;
                    let commissions = [];
                    
                    apartments.forEach(apartment => {
                        const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                        const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                        
                        totalRevenue += this.calculateLagirioRevenue(apartment, reservations, expenses);
                        totalOccupancy += this.calculateOccupancyRate(apartment.id);
                        commissions.push(apartment.lagirioCommission);
                    });
                    
                    systems.push({
                        id: i,
                        name: systemNames[i],
                        color: systemColors[i - 1],
                        icon: systemIcons[i - 1],
                        revenue: totalRevenue,
                        apartmentCount: apartments.length,
                        avgOccupancy: totalOccupancy / apartments.length,
                        avgCommission: commissions.reduce((a, b) => a + b, 0) / commissions.length
                    });
                }
            }
            
            return systems;
        },
        
        // Update recent activity
        updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            const recentReservations = [...this.filteredData.reservations]
                .sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn))
                .slice(0, 5);
            
            container.innerHTML = recentReservations.map(res => {
                const apartment = this.data.apartments?.find(a => a.id === res.apartmentId);
                const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                const checkIn = new Date(res.checkIn).toLocaleDateString('tr-TR');
                const icon = this.getPlatformIcon(res.platform);
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 ${this.getPlatformColor(res.platform)} rounded-full flex items-center justify-center text-white">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${apartment?.code || 'Bilinmeyen'}</p>
                                <p class="text-xs text-gray-500">${res.guestName} â€¢ ${checkIn}</p>
                            </div>
                        </div>
                        <p class="font-semibold text-emerald-600">â‚¬${amount.toFixed(0)}</p>
                    </div>
                `;
            }).join('');
            
            if (recentReservations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">HenÃ¼z rezervasyon bulunmuyor</p>';
            }
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Update alerts
        updateAlerts() {
            const container = document.getElementById('importantAlerts');
            if (!container) return;
            
            const alerts = this.generateAlerts();
            
            container.innerHTML = alerts.slice(0, 5).map(alert => `
                <div class="flex items-start space-x-3 p-3 ${alert.bgColor} rounded-lg">
                    <div class="flex-shrink-0">
                        <i data-lucide="${alert.icon}" class="w-5 h-5 ${alert.color}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${alert.title}</p>
                        <p class="text-xs text-gray-600 mt-1">${alert.message}</p>
                    </div>
                </div>
            `).join('');
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Ã–nemli uyarÄ± bulunmuyor</p>';
            }
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Generate alerts
        generateAlerts() {
            const alerts = [];
            const lowOccupancyThreshold = this.settings.lowOccupancyThreshold;
            const highExpenseThreshold = this.settings.highExpenseThreshold;
            
            // Check low occupancy apartments
            this.data.apartments?.forEach(apartment => {
                const occupancy = this.calculateOccupancyRate(apartment.id);
                if (occupancy < lowOccupancyThreshold && occupancy > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: 'alert-triangle',
                        color: 'text-orange-600',
                        bgColor: 'bg-orange-50',
                        title: `DÃ¼ÅŸÃ¼k Doluluk - ${apartment.code}`,
                        message: `Doluluk oranÄ± %${occupancy.toFixed(1)} (EÅŸik: %${lowOccupancyThreshold})`,
                        priority: 2
                    });
                }
                
                // Check high expenses
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                expenses.forEach(expense => {
                    const amount = this.convertToEUR(expense.amount, expense.currency);
                    if (amount > highExpenseThreshold) {
                        alerts.push({
                            type: 'error',
                            icon: 'alert-circle',
                            color: 'text-red-600',
                            bgColor: 'bg-red-50',
                            title: `YÃ¼ksek Gider - ${apartment.code}`,
                            message: `${expense.category}: â‚¬${amount.toFixed(2)}`,
                            priority: 1
                        });
                    }
                });
            });
            
            // Check apartments with no reservations
            const apartmentsWithNoReservations = this.data.apartments?.filter(apartment => {
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                return reservations.length === 0;
            }) || [];
            
            if (apartmentsWithNoReservations.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'info',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    title: 'Rezervasyon Yok',
                    message: `${apartmentsWithNoReservations.length} dairede rezervasyon bulunmuyor`,
                    priority: 3
                });
            }
            
            // Sort by priority
            alerts.sort((a, b) => a.priority - b.priority);
            
            return alerts;
        },
        
        // Generate notifications
        generateNotifications() {
            this.notifications = [];
            
            // Add system notifications
            const stats = this.calculateQuickStats();
            
            if (stats.avgOccupancy < 30) {
                this.notifications.push({
                    id: Date.now(),
                    type: 'warning',
                    title: 'DÃ¼ÅŸÃ¼k Doluluk OranÄ±',
                    message: `Ortalama doluluk %${stats.avgOccupancy.toFixed(1)} seviyesinde`,
                    time: new Date()
                });
            }
            
            if (stats.monthlyRevenue > stats.monthlyTarget) {
                this.notifications.push({
                    id: Date.now() + 1,
                    type: 'success',
                    title: 'AylÄ±k Hedef AÅŸÄ±ldÄ±!',
                    message: `Bu ay â‚¬${stats.monthlyRevenue.toLocaleString()} kazanÃ§ elde edildi`,
                    time: new Date()
                });
            }
            
            // Update notification count
            document.getElementById('notificationCount').textContent = this.notifications.length;
        },
        
        // Show notifications modal
        showNotifications() {
            const modal = document.getElementById('notificationModal');
            const list = document.getElementById('notificationList');
            
            if (list) {
                list.innerHTML = this.notifications.map(notif => `
                    <div class="p-4 ${this.getNotificationBgColor(notif.type)} rounded-lg">
                        <div class="flex items-start space-x-3">
                            <i data-lucide="${this.getNotificationIcon(notif.type)}" 
                               class="w-5 h-5 ${this.getNotificationColor(notif.type)} flex-shrink-0"></i>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${notif.title}</p>
                                <p class="text-sm text-gray-600 mt-1">${notif.message}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ${new Date(notif.time).toLocaleString('tr-TR')}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (this.notifications.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">Bildirim bulunmuyor</p>';
                }
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => lucide.createIcons(), 100);
        },
        // Comparison functionality
        runComparison() {
            const comparisonType = document.getElementById('comparisonType').value;
            const resultsContainer = document.getElementById('comparisonResults');
            
            if (!resultsContainer) return;
            
            let comparisonData = null;
            
            switch(comparisonType) {
                case 'apartments':
                    comparisonData = this.compareApartments();
                    break;
                case 'periods':
                    comparisonData = this.comparePeriods();
                    break;
                case 'systems':
                    comparisonData = this.compareSystems();
                    break;
                case 'mixed':
                    comparisonData = this.mixedComparison();
                    break;
            }
            
            if (comparisonData) {
                resultsContainer.innerHTML = this.renderComparisonResults(comparisonData);
                resultsContainer.classList.remove('hidden');
                this.createComparisonCharts(comparisonData);
                setTimeout(() => lucide.createIcons(), 100);
            }
        },
        
        // Compare apartments
        compareApartments() {
            const firstApartments = Array.from(document.getElementById('firstApartments').selectedOptions)
                .map(opt => opt.value);
            const secondApartments = Array.from(document.getElementById('secondApartments').selectedOptions)
                .map(opt => opt.value);
            
            if (firstApartments.length === 0 || secondApartments.length === 0) {
                this.showToast('LÃ¼tfen karÅŸÄ±laÅŸtÄ±rÄ±lacak daireleri seÃ§in', 'warning');
                return null;
            }
            
            const firstMetrics = this.calculateGroupMetrics(firstApartments);
            const secondMetrics = this.calculateGroupMetrics(secondApartments);
            
            return {
                type: 'apartments',
                first: {
                    label: `Grup 1 (${firstApartments.length} daire)`,
                    metrics: firstMetrics
                },
                second: {
                    label: `Grup 2 (${secondApartments.length} daire)`,
                    metrics: secondMetrics
                },
                comparison: this.calculateMetricComparison(firstMetrics, secondMetrics)
            };
        },
        
        // Compare periods
        comparePeriods() {
            const firstStart = document.getElementById('firstPeriodStart').value;
            const firstEnd = document.getElementById('firstPeriodEnd').value;
            const secondStart = document.getElementById('secondPeriodStart').value;
            const secondEnd = document.getElementById('secondPeriodEnd').value;
            
            if (!firstStart || !firstEnd || !secondStart || !secondEnd) {
                this.showToast('LÃ¼tfen tÃ¼m dÃ¶nemleri seÃ§in', 'warning');
                return null;
            }
            
            const firstMetrics = this.calculatePeriodMetrics(new Date(firstStart), new Date(firstEnd));
            const secondMetrics = this.calculatePeriodMetrics(new Date(secondStart), new Date(secondEnd));
            
            return {
                type: 'periods',
                first: {
                    label: `${firstStart} - ${firstEnd}`,
                    metrics: firstMetrics
                },
                second: {
                    label: `${secondStart} - ${secondEnd}`,
                    metrics: secondMetrics
                },
                comparison: this.calculateMetricComparison(firstMetrics, secondMetrics)
            };
        },
        
        // Calculate group metrics
        calculateGroupMetrics(apartmentIds) {
            const metrics = {
                totalRevenue: 0,
                totalOwnerShare: 0,
                totalExpenses: 0,
                avgOccupancy: 0,
                reservationCount: 0,
                avgNightlyRate: 0,
                platformDistribution: {},
                expenseCategories: {}
            };
            
            apartmentIds.forEach(apartmentId => {
                const apartment = this.data.apartments?.find(a => a.id === apartmentId);
                if (!apartment) return;
                
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartmentId) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartmentId) || [];
                
                metrics.totalRevenue += this.calculateLagirioRevenue(apartment, reservations, expenses);
                metrics.totalOwnerShare += this.calculateOwnerShare(apartment, reservations, expenses);
                metrics.totalExpenses += expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                metrics.avgOccupancy += this.calculateOccupancyRate(apartmentId);
                metrics.reservationCount += reservations.length;
                metrics.avgNightlyRate += this.calculateAvgNightlyRate(reservations);
                
                // Platform distribution
                reservations.forEach(res => {
                    const platform = res.platform || 'Direkt';
                    metrics.platformDistribution[platform] = (metrics.platformDistribution[platform] || 0) + 1;
                });
                
                // Expense categories
                expenses.forEach(exp => {
                    const amount = this.convertToEUR(exp.amount, exp.currency);
                    metrics.expenseCategories[exp.category] = (metrics.expenseCategories[exp.category] || 0) + amount;
                });
            });
            
            // Calculate averages
            const count = apartmentIds.length;
            if (count > 0) {
                metrics.avgOccupancy = metrics.avgOccupancy / count;
                metrics.avgNightlyRate = metrics.avgNightlyRate / count;
            }
            
            return metrics;
        },
        
        // Calculate period metrics
        calculatePeriodMetrics(startDate, endDate) {
            const metrics = {
                totalRevenue: 0,
                totalOwnerShare: 0,
                totalExpenses: 0,
                avgOccupancy: 0,
                reservationCount: 0,
                avgNightlyRate: 0,
                platformDistribution: {},
                expenseCategories: {}
            };
            
            this.data.apartments?.forEach(apartment => {
                const reservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                           date >= startDate && date <= endDate;
                }) || [];
                
                const expenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                           date >= startDate && date <= endDate;
                }) || [];
                
                metrics.totalRevenue += this.calculateLagirioRevenue(apartment, reservations, expenses);
                metrics.totalOwnerShare += this.calculateOwnerShare(apartment, reservations, expenses);
                metrics.totalExpenses += expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                metrics.reservationCount += reservations.length;
                metrics.avgNightlyRate += this.calculateAvgNightlyRate(reservations);
                
                // Occupancy for period
                const occupancy = this.calculateOccupancyRate(apartment.id, startDate, endDate);
                metrics.avgOccupancy += occupancy;
                
                // Platform distribution
                reservations.forEach(res => {
                    const platform = res.platform || 'Direkt';
                    metrics.platformDistribution[platform] = (metrics.platformDistribution[platform] || 0) + 1;
                });
                
                // Expense categories
                expenses.forEach(exp => {
                    const amount = this.convertToEUR(exp.amount, exp.currency);
                    metrics.expenseCategories[exp.category] = (metrics.expenseCategories[exp.category] || 0) + amount;
                });
            });
            
            // Calculate averages
            const count = this.data.apartments?.length || 1;
            metrics.avgOccupancy = metrics.avgOccupancy / count;
            metrics.avgNightlyRate = metrics.avgNightlyRate / count;
            
            return metrics;
        },
        
        // Calculate metric comparison
        calculateMetricComparison(first, second) {
            return {
                revenue: {
                    diff: first.totalRevenue - second.totalRevenue,
                    percent: second.totalRevenue > 0 ? 
                        ((first.totalRevenue - second.totalRevenue) / second.totalRevenue * 100) : 0
                },
                expenses: {
                    diff: first.totalExpenses - second.totalExpenses,
                    percent: second.totalExpenses > 0 ? 
                        ((first.totalExpenses - second.totalExpenses) / second.totalExpenses * 100) : 0
                },
                occupancy: {
                    diff: first.avgOccupancy - second.avgOccupancy,
                    percent: second.avgOccupancy > 0 ? 
                        ((first.avgOccupancy - second.avgOccupancy) / second.avgOccupancy * 100) : 0
                },
                reservations: {
                    diff: first.reservationCount - second.reservationCount,
                    percent: second.reservationCount > 0 ? 
                        ((first.reservationCount - second.reservationCount) / second.reservationCount * 100) : 0
                }
            };
        },
        
        // Render comparison results
        renderComparisonResults(data) {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- First Group/Period -->
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h4 class="font-semibold text-blue-900 mb-4">${data.first.label}</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam KazanÃ§:</span>
                                <span class="font-semibold">â‚¬${data.first.metrics.totalRevenue.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam Gider:</span>
                                <span class="font-semibold">â‚¬${data.first.metrics.totalExpenses.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ortalama Doluluk:</span>
                                <span class="font-semibold">${data.first.metrics.avgOccupancy.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Rezervasyon SayÄ±sÄ±:</span>
                                <span class="font-semibold">${data.first.metrics.reservationCount}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ort. Gecelik Ãœcret:</span>
                                <span class="font-semibold">â‚¬${data.first.metrics.avgNightlyRate.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Group/Period -->
                    <div class="bg-green-50 rounded-lg p-6">
                        <h4 class="font-semibold text-green-900 mb-4">${data.second.label}</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam KazanÃ§:</span>
                                <span class="font-semibold">â‚¬${data.second.metrics.totalRevenue.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam Gider:</span>
                                <span class="font-semibold">â‚¬${data.second.metrics.totalExpenses.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ortalama Doluluk:</span>
                                <span class="font-semibold">${data.second.metrics.avgOccupancy.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Rezervasyon SayÄ±sÄ±:</span>
                                <span class="font-semibold">${data.second.metrics.reservationCount}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ort. Gecelik Ãœcret:</span>
                                <span class="font-semibold">â‚¬${data.second.metrics.avgNightlyRate.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h4 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-indigo-600"></i>
                        <span>KarÅŸÄ±laÅŸtÄ±rma Ã–zeti</span>
                    </h4>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">KazanÃ§ FarkÄ±</p>
                            <p class="text-xl font-bold ${data.comparison.revenue.diff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.revenue.diff >= 0 ? '+' : ''}â‚¬${data.comparison.revenue.diff.toFixed(0)}
                            </p>
                            <p class="text-sm ${data.comparison.revenue.percent >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.revenue.percent >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(data.comparison.revenue.percent).toFixed(1)}%
                            </p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Gider FarkÄ±</p>
                            <p class="text-xl font-bold ${data.comparison.expenses.diff <= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.expenses.diff >= 0 ? '+' : ''}â‚¬${data.comparison.expenses.diff.toFixed(0)}
                            </p>
                            <p class="text-sm ${data.comparison.expenses.percent <= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.expenses.percent >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(data.comparison.expenses.percent).toFixed(1)}%
                            </p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Doluluk FarkÄ±</p>
                            <p class="text-xl font-bold ${data.comparison.occupancy.diff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.occupancy.diff >= 0 ? '+' : ''}${data.comparison.occupancy.diff.toFixed(1)}%
                            </p>
                            <p class="text-sm ${data.comparison.occupancy.percent >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.occupancy.percent >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(data.comparison.occupancy.percent).toFixed(1)}%
                            </p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Rezervasyon FarkÄ±</p>
                            <p class="text-xl font-bold ${data.comparison.reservations.diff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.reservations.diff >= 0 ? '+' : ''}${data.comparison.reservations.diff}
                            </p>
                            <p class="text-sm ${data.comparison.reservations.percent >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.reservations.percent >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(data.comparison.reservations.percent).toFixed(1)}%
                            </p>
                        </div>
                    </div>
                    
                    <!-- Comparison Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="chart-container-sm" id="comparisonBarChart"></div>
                        <div class="chart-container-sm" id="comparisonRadarChart"></div>
                    </div>
                </div>
            `;
        },
        
        // Create comparison charts
        createComparisonCharts(data) {
            // Bar chart
            const barContainer = document.getElementById('comparisonBarChart');
            if (barContainer) {
                const chart = echarts.init(barContainer);
                
                chart.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: {
                        data: [data.first.label, data.second.label]
                    },
                    xAxis: {
                        type: 'category',
                        data: ['KazanÃ§', 'Gider', 'Doluluk', 'Rezervasyon']
                    },
                    yAxis: { type: 'value' },
                    series: [
                        {
                            name: data.first.label,
                            type: 'bar',
                            data: [
                                data.first.metrics.totalRevenue,
                                data.first.metrics.totalExpenses,
                                data.first.metrics.avgOccupancy * 100,
                                data.first.metrics.reservationCount
                            ],
                            itemStyle: { color: '#3b82f6' }
                        },
                        {
                            name: data.second.label,
                            type: 'bar',
                            data: [
                                data.second.metrics.totalRevenue,
                                data.second.metrics.totalExpenses,
                                data.second.metrics.avgOccupancy * 100,
                                data.second.metrics.reservationCount
                            ],
                            itemStyle: { color: '#10b981' }
                        }
                    ]
                });
            }
        },
        
        // Report generation
        generateReport(type) {
            const reportPreview = document.getElementById('reportPreview');
            if (!reportPreview) return;
            
            let reportContent = '';
            
            switch(type) {
                case 'summary':
                    reportContent = this.generateSummaryReport();
                    break;
                case 'detailed':
                    reportContent = this.generateDetailedReport();
                    break;
                case 'comparison':
                    reportContent = this.generateComparisonReport();
                    break;
                case 'financial':
                    reportContent = this.generateFinancialReport();
                    break;
                case 'performance':
                    reportContent = this.generatePerformanceReport();
                    break;
                case 'custom':
                    this.showModal('customReportModal');
                    return;
            }
            
            reportPreview.innerHTML = reportContent;
            reportPreview.classList.remove('hidden');
            
            // Scroll to preview
            reportPreview.scrollIntoView({ behavior: 'smooth' });
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Generate summary report
        generateSummaryReport() {
            const stats = this.calculateQuickStats();
            const metrics = this.calculatePerformanceMetrics();
            const systemData = this.getSystemComparisonData();
            
            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">YÃ¶netici Ã–zet Raporu</h2>
                        <p class="text-gray-500">OluÅŸturulma: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-emerald-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Toplam PortfÃ¶y</p>
                            <p class="text-2xl font-bold text-emerald-600">â‚¬${stats.totalPortfolio.toLocaleString()}</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">AylÄ±k KazanÃ§</p>
                            <p class="text-2xl font-bold text-blue-600">â‚¬${stats.monthlyRevenue.toLocaleString()}</p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Ortalama Doluluk</p>
                            <p class="text-2xl font-bold text-orange-600">${stats.avgOccupancy.toFixed(1)}%</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Aktif Daire</p>
                            <p class="text-2xl font-bold text-purple-600">${stats.activeProperties}/${stats.totalProperties}</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Sistem PerformansÄ±</h3>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm">Sistem</th>
                                    <th class="px-4 py-2 text-right text-sm">KazanÃ§</th>
                                    <th class="px-4 py-2 text-right text-sm">Doluluk</th>
                                    <th class="px-4 py-2 text-right text-sm">Verimlilik</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${systemData.systems.map((system, index) => `
                                    <tr class="border-b">
                                        <td class="px-4 py-2">${system}</td>
                                        <td class="px-4 py-2 text-right">â‚¬${systemData.revenues[index].toLocaleString()}</td>
                                        <td class="px-4 py-2 text-right">${systemData.occupancies[index].toFixed(1)}%</td>
                                        <td class="px-4 py-2 text-right">${systemData.efficiencies[index].toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                YazdÄ±r
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF Ä°ndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },
        
        // Helper methods
        getPlatformColor(platform) {
            const colors = {
                'Booking.com': 'bg-blue-500',
                'Airbnb': 'bg-red-500',
                'Direkt': 'bg-green-500'
            };
            return colors[platform] || 'bg-gray-500';
        },
        
        getPlatformIcon(platform) {
            const icons = {
                'Booking.com': 'globe',
                'Airbnb': 'home',
                'Direkt': 'mail'
            };
            return icons[platform] || 'circle';
        },
        
        getRankColor(index) {
            const colors = [
                'from-yellow-400 to-yellow-500',
                'from-gray-300 to-gray-400',
                'from-orange-400 to-orange-500',
                'from-blue-400 to-blue-500',
                'from-purple-400 to-purple-500'
            ];
            return colors[index] || 'from-gray-400 to-gray-500';
        },
        
        getNotificationBgColor(type) {
            const colors = {
                success: 'bg-green-50',
                warning: 'bg-orange-50',
                error: 'bg-red-50',
                info: 'bg-blue-50'
            };
            return colors[type] || 'bg-gray-50';
        },
        
        getNotificationColor(type) {
            const colors = {
                success: 'text-green-600',
                warning: 'text-orange-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            return colors[type] || 'text-gray-600';
        },
        
        getNotificationIcon(type) {
            const icons = {
                success: 'check-circle',
                warning: 'alert-triangle',
                error: 'x-circle',
                info: 'info'
            };
            return icons[type] || 'bell';
        },
        
        // UI Helper methods
        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => lucide.createIcons(), 100);
            }
        },
        
        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        },
        
        closeAllModals() {
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.classList.add('hidden');
            });
        },
        
        showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        },
        
        hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        },
        
        showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toastId = Date.now();
            const toast = document.createElement('div');
            toast.className = `toast-${toastId} animate-slide-up flex items-center space-x-3 px-4 py-3 ${this.getNotificationBgColor(type)} rounded-lg shadow-lg min-w-[300px]`;
            
            toast.innerHTML = `
                <i data-lucide="${this.getNotificationIcon(type)}" class="w-5 h-5 ${this.getNotificationColor(type)}"></i>
                <p class="flex-1 text-gray-800">${message}</p>
                <button onclick="Analytics.removeToast('toast-${toastId}')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                this.removeToast(`toast-${toastId}`);
            }, 5000);
        },
        
        removeToast(toastClass) {
            const toast = document.querySelector(`.${toastClass}`);
            if (toast) {
                toast.classList.add('opacity-0', 'transition');
                setTimeout(() => toast.remove(), 300);
            }
        },
        
        // Quick actions
        toggleQuickActions() {
            const menu = document.getElementById('quickActionsMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        },
        
        quickExport() {
            this.exportExcel();
            this.toggleQuickActions();
        },
        
        quickCompare() {
            this.switchMainTab('comparison');
            this.toggleQuickActions();
        },
        
        quickReport() {
            this.generateReport('summary');
            this.switchMainTab('reports');
            this.toggleQuickActions();
        },
        
        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
            this.toggleQuickActions();
        },
        
        // Export functions
        exportPDF() {
            window.print();
        },
        
        exportExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            csvContent += "Daire Kodu,Sahip,Sistem,Toplam Gelir (EUR),Lagirio Komisyonu (EUR),Ev Sahibi PayÄ± (EUR),Giderler (EUR),Doluluk (%),Rezervasyon SayÄ±sÄ±,Platform\n";
            
            // Data rows
            this.data.apartments?.forEach(apartment => {
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                
                const totalIncome = reservations.reduce((sum, res) => 
                    sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                
                const totalExpenses = expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                
                const lagirioRevenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                const ownerShare = this.calculateOwnerShare(apartment, reservations, expenses);
                const occupancy = this.calculateOccupancyRate(apartment.id);
                
                // Platform distribution
                const platforms = {};
                reservations.forEach(res => {
                    platforms[res.platform || 'Direkt'] = (platforms[res.platform || 'Direkt'] || 0) + 1;
                });
                const platformStr = Object.entries(platforms)
                    .map(([p, c]) => `${p}:${c}`)
                    .join(';');
                
                csvContent += `${apartment.code},${apartment.ownerName},Sistem ${apartment.systemType},`;
                csvContent += `${totalIncome.toFixed(2)},${lagirioRevenue.toFixed(2)},${ownerShare.toFixed(2)},`;
                csvContent += `${totalExpenses.toFixed(2)},${occupancy.toFixed(1)},${reservations.length},"${platformStr}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `lagirio_analytics_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            this.showToast('Excel dosyasÄ± indiriliyor...', 'success');
        },
        
        // Settings
        showSettings() {
            this.showModal('settingsModal');
        },
        
        loadSettings() {
            const saved = localStorage.getItem('lagirioSettings');
            if (saved) {
                this.settings = { ...this.settings, ...JSON.parse(saved) };
                this.applySettings();
            }
        },
        
        saveSettings() {
            // Get values from form
            this.settings.darkMode = document.getElementById('darkMode').checked;
            this.settings.animations = document.getElementById('animations').checked;
            this.settings.compactView = document.getElementById('compactView').checked;
            this.settings.defaultCurrency = document.getElementById('defaultCurrency').value;
            this.settings.dateFormat = document.getElementById('dateFormat').value;
            this.settings.lowOccupancyThreshold = parseInt(document.getElementById('lowOccupancyThreshold').value);
            this.settings.highExpenseThreshold = parseInt(document.getElementById('highExpenseThreshold').value);
            
            // Save to localStorage
            localStorage.setItem('lagirioSettings', JSON.stringify(this.settings));
            
            // Apply settings
            this.applySettings();
            
            // Close modal
            this.closeModal('settingsModal');
            this.showToast('Ayarlar kaydedildi', 'success');
            
            // Refresh data if needed
            if (this.data) {
                this.refreshData();
            }
        },
        
        applySettings() {
            // Apply dark mode
            if (this.settings.darkMode) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            // Apply animations
            if (!this.settings.animations) {
                document.querySelectorAll('[class*="animate-"]').forEach(el => {
                    el.style.animation = 'none';
                });
            }
            
            // Apply compact view
            if (this.settings.compactView) {
                document.body.classList.add('compact');
            } else {
                document.body.classList.remove('compact');
            }
        },
        
        switchMainTab(tab) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');  // â† DEÄžÄ°ÅžTÄ°
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById(`${tab}-content`);
            if (selectedContent) {
                selectedContent.classList.add('active');  // â† DEÄžÄ°ÅžTÄ°
            }
            
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(btn => {
                const isActive = btn.dataset.tab === tab;
                if (isActive) {
                    btn.classList.add('active', 'bg-white/20', 'text-white');
                    btn.classList.remove('text-white/80', 'hover:text-white');
                } else {
                    btn.classList.remove('active', 'bg-white/20', 'text-white');
                    btn.classList.add('text-white/80', 'hover:text-white');
                }
            });
            
            this.currentMainTab = tab;

            // Initialize specific tab content if needed
            if (tab === 'analysis' && !this.charts.systemComparison) {
                setTimeout(() => this.createSystemAnalysisCharts(), 100);
            }

            if (tab === 'trends' && !this.charts.revenueTrendAnalysis) {
                setTimeout(() => this.createTrendAnalysisCharts(), 100);
            }

            if (tab === 'efficiency' && !this.charts.costEfficiency) {
                setTimeout(() => this.createEfficiencyCharts(), 100);
            }
        },
        
        switchAnalysisTab(tab) {
            // Hide all analysis contents
            document.querySelectorAll('.analysis-content').forEach(content => {
                content.classList.remove('active');  // â† DEÄžÄ°ÅžTÄ°
            });
            
            // Show selected analysis content
            const selectedContent = document.getElementById(`${tab}-analysis`);
            if (selectedContent) {
                selectedContent.classList.add('active');  // â† DEÄžÄ°ÅžTÄ°
            }
            
            // Update analysis tab buttons
            document.querySelectorAll('.analysis-tab').forEach(btn => {
                const isActive = btn.dataset.analysis === tab;
                if (isActive) {
                    btn.classList.add('active', 'bg-white', 'shadow-sm');
                    btn.classList.remove('text-gray-600', 'hover:text-gray-900');
                } else {
                    btn.classList.remove('active', 'bg-white', 'shadow-sm');
                    btn.classList.add('text-gray-600', 'hover:text-gray-900');
                }
            });
            
            this.currentAnalysisTab = tab;
        },
        
        // Populate selectors
        populateSelectors() {
            // Apartment selectors
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            ['firstApartments', 'secondApartments', 'reportApartments'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = apartmentOptions;
                }
            });
        },
        
        // Date filter methods
        applyDatePreset(preset) {
            const now = new Date();
            let startDate, endDate;
            
            switch(preset) {
                case 'this-month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'last-3-months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    endDate = now;
                    break;
                case 'last-6-months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    endDate = now;
                    break;
                case 'this-year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = now;
                    break;
                case 'last-year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                case 'all':
                    this.dateFilter = { start: null, end: null };
                    this.filteredData = this.data;
                    this.refreshData();
                    return;
            }
            
            this.dateFilter = { start: startDate, end: endDate };
            this.applyDateFilter();
        },
        
        applyDateFilter() {
            const startInput = document.getElementById('startDate')?.value;
            const endInput = document.getElementById('endDate')?.value;
            
            if (startInput && endInput) {
                this.dateFilter.start = new Date(startInput);
                this.dateFilter.end = new Date(endInput);
            }
            
            if (!this.dateFilter.start && !this.dateFilter.end) {
                this.filteredData = this.data;
            } else {
                this.filteredData = {
                    ...this.data,
                    reservations: this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return (!this.dateFilter.start || date >= this.dateFilter.start) &&
                               (!this.dateFilter.end || date <= this.dateFilter.end);
                    }) || [],
                    expenses: this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return (!this.dateFilter.start || date >= this.dateFilter.start) &&
                               (!this.dateFilter.end || date <= this.dateFilter.end);
                    }) || []
                };
            }
            
            this.refreshData();
        },
        
        refreshData() {
            this.cache.calculations.clear();
            this.updateAllMetrics();
            
            // Grafikleri yeniden oluÅŸtur
            setTimeout(() => {
                this.initializeCharts();
            }, 100);
            
            this.showToast('Veriler gÃ¼ncellendi', 'success');
        },
        resizeAllCharts() {
            Object.values(this.charts).forEach(chart => {
                if (chart && chart.resize) {
                    chart.resize();
                }
            });
        },
        
        // Initialize tooltips
        initializeTooltips() {
            // Simple tooltip implementation
            document.addEventListener('mouseover', (e) => {
                if (e.target.hasAttribute('title')) {
                    const title = e.target.getAttribute('title');
                    e.target.removeAttribute('title');
                    e.target.setAttribute('data-tooltip', title);
                    
                    // Create tooltip element
                    const tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    tooltip.textContent = title;
                    document.body.appendChild(tooltip);
                    
                    // Position tooltip
                    const rect = e.target.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.bottom + 5) + 'px';
                    tooltip.classList.add('show');
                    
                    e.target.addEventListener('mouseleave', () => {
                        tooltip.remove();
                        e.target.setAttribute('title', title);
                    }, { once: true });
                }
            });
        },
        
        // Check for notifications on load
        checkNotifications() {
            // Check for any important notifications
            setTimeout(() => {
                if (this.notifications.length > 0) {
                    const badge = document.getElementById('notificationCount');
                    if (badge) {
                        badge.classList.add('animate-pulse-soft');
                    }
                }
            }, 1000);
        },
        
        // Handle comparison type change
        handleComparisonTypeChange(type) {
            const periodControls = document.getElementById('periodComparisonControls');
            const firstSelect = document.getElementById('firstComparisonSelect');
            const secondSelect = document.getElementById('secondComparisonSelect');
            
            if (type === 'periods') {
                periodControls?.classList.remove('hidden');
                firstSelect?.classList.add('hidden');
                secondSelect?.classList.add('hidden');
            } else {
                periodControls?.classList.add('hidden');
                firstSelect?.classList.remove('hidden');
                secondSelect?.classList.remove('hidden');
            }
            
            this.comparisonType = type;
        },

        // ===========================================
        // ADVANCED COMPARISON METHODS
        // ===========================================

        // Set comparison mode
        setComparisonMode(mode) {
            this.comparisonMode = mode;
            
            // Update UI buttons
            document.querySelectorAll('.comparison-mode-btn').forEach(btn => {
                btn.classList.remove('active', 'border-emerald-500', 'border-blue-500', 'border-purple-500', 'border-orange-500');
                btn.classList.add('border-gray-300');
            });
            
            event.target.closest('.comparison-mode-btn').classList.add('active');
            
            // Set active color based on mode
            const colorMap = {
                'apartment-apartment': 'border-emerald-500',
                'apartment-period': 'border-blue-500',
                'group-group': 'border-purple-500',
                'system-system': 'border-orange-500'
            };
            event.target.closest('.comparison-mode-btn').classList.add(colorMap[mode]);
            
            // Render appropriate panels
            this.renderComparisonPanels();
        },

        // Render comparison panels based on mode
        renderComparisonPanels() {
            const container = document.getElementById('comparisonPanels');
            if (!container) return;
            
            let html = '';
            
            switch(this.comparisonMode) {
                case 'apartment-apartment':
                    html = this.renderApartmentVsApartmentPanel();
                    break;
                case 'apartment-period':
                    html = this.renderApartmentVsPeriodPanel();
                    break;
                case 'group-group':
                    html = this.renderGroupVsGroupPanel();
                    break;
                case 'system-system':
                    html = this.renderSystemVsSystemPanel();
                    break;
            }
            
            container.innerHTML = html;
            setTimeout(() => lucide.createIcons(), 100);
        },

        // Render: Daire vs Daire (aynÄ± dÃ¶nem)
        renderApartmentVsApartmentPanel() {
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Period Selection -->
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">DÃ¶nem SeÃ§imi</label>
                        <div class="flex items-center space-x-2">
                            <input type="month" id="compPeriod" value="${new Date().toISOString().slice(0,7)}" 
                                class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            <span class="text-gray-500 text-sm">veya</span>
                            <select id="compPeriodPreset" onchange="Analytics.applyComparisonPeriodPreset()" 
                                    class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                                <option value="">Ã–zel SeÃ§im</option>
                                <option value="this-month">Bu Ay</option>
                                <option value="last-month">GeÃ§en Ay</option>
                                <option value="last-3-months">Son 3 Ay</option>
                                <option value="all">TÃ¼m Zamanlar</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Apartment A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Daire
                        </label>
                        <select id="compApartmentA" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Daire SeÃ§in</option>
                            ${apartmentOptions}
                        </select>
                    </div>
                    
                    <!-- VS Icon -->
                    <div class="flex items-end justify-center pb-2">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-gray-600">VS</span>
                        </div>
                    </div>
                    
                    <!-- Apartment B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            Ä°kinci Daire
                        </label>
                        <select id="compApartmentB" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Daire SeÃ§in</option>
                            ${apartmentOptions}
                        </select>
                    </div>
                </div>
            `;
        },

        // Render: Daire vs DÃ¶nem (bir daire, farklÄ± aylar)
        renderApartmentVsPeriodPanel() {
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Apartment Selection -->
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Daire SeÃ§imi</label>
                        <select id="compSingleApartment" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Daire SeÃ§in</option>
                            ${apartmentOptions}
                        </select>
                    </div>
                    
                    <!-- Period A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci DÃ¶nem
                        </label>
                        <input type="month" id="compPeriodA" 
                            value="${new Date(new Date().setMonth(new Date().getMonth()-1)).toISOString().slice(0,7)}"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                    
                    <!-- VS Icon -->
                    <div class="flex items-end justify-center pb-2">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-gray-600">VS</span>
                        </div>
                    </div>
                    
                    <!-- Period B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            Ä°kinci DÃ¶nem
                        </label>
                        <input type="month" id="compPeriodB" 
                            value="${new Date().toISOString().slice(0,7)}"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                </div>
            `;
        },

        // Render: Grup vs Grup (Ã§oklu daire)
        renderGroupVsGroupPanel() {
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Period Selection -->
                    <div class="lg:col-span-2 mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">DÃ¶nem SeÃ§imi</label>
                        <input type="month" id="compGroupPeriod" value="${new Date().toISOString().slice(0,7)}" 
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                    
                    <!-- Group A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Grup
                        </label>
                        <select id="compGroupA" multiple size="8" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            ${apartmentOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd ile Ã§oklu seÃ§im yapabilirsiniz</p>
                    </div>
                    
                    <!-- Group B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            Ä°kinci Grup
                        </label>
                        <select id="compGroupB" multiple size="8" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            ${apartmentOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd ile Ã§oklu seÃ§im yapabilirsiniz</p>
                    </div>
                </div>
            `;
        },

        // Render: Sistem vs Sistem
        renderSystemVsSystemPanel() {
            const systemNames = {
                '1': 'Sistem 1 - Kira',
                '2': 'Sistem 2 - KiÅŸi Åžirketi',
                '3': 'Sistem 3 - Komisyon',
                '4': 'Sistem 4 - Ã–zel Komisyon',
                '5': 'Sistem 5 - StopajlÄ±',
                '6': 'Sistem 6 - Platform AyrÄ±mlÄ±',
                '7': 'Sistem 7 - Karma Platform',
                '8': 'Sistem 8 - KÃ¢r BazlÄ±'
            };
            
            const systemOptions = Object.entries(systemNames).map(([id, name]) => 
                `<option value="${id}">${name}</option>`
            ).join('');
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Period Selection -->
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">DÃ¶nem SeÃ§imi</label>
                        <input type="month" id="compSystemPeriod" value="${new Date().toISOString().slice(0,7)}" 
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                    
                    <!-- System A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Sistem
                        </label>
                        <select id="compSystemA" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Sistem SeÃ§in</option>
                            ${systemOptions}
                        </select>
                    </div>
                    
                    <!-- VS Icon -->
                    <div class="flex items-end justify-center pb-2">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-gray-600">VS</span>
                        </div>
                    </div>
                    
                    <!-- System B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            Ä°kinci Sistem
                        </label>
                        <select id="compSystemB" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Sistem SeÃ§in</option>
                            ${systemOptions}
                        </select>
                    </div>
                </div>
            `;
        },

        // Apply comparison period preset
        applyComparisonPeriodPreset() {
            const preset = document.getElementById('compPeriodPreset')?.value;
            const periodInput = document.getElementById('compPeriod');
            
            if (!preset || !periodInput) return;
            
            const now = new Date();
            let targetDate;
            
            switch(preset) {
                case 'this-month':
                    targetDate = now;
                    break;
                case 'last-month':
                    targetDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
                case 'last-3-months':
                    targetDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    break;
                case 'all':
                    periodInput.value = '';
                    return;
            }
            
            periodInput.value = targetDate.toISOString().slice(0, 7);
        },

        // Run advanced comparison
        runAdvancedComparison() {
            let comparisonData = null;
            
            switch(this.comparisonMode) {
                case 'apartment-apartment':
                    comparisonData = this.compareApartmentVsApartment();
                    break;
                case 'apartment-period':
                    comparisonData = this.compareApartmentVsPeriod();
                    break;
                case 'group-group':
                    comparisonData = this.compareGroupVsGroup();
                    break;
                case 'system-system':
                    comparisonData = this.compareSystemVsSystem();
                    break;
            }
            
            if (comparisonData) {
                this.displayComparisonResults(comparisonData);
            }
        },

        // Compare: Apartment vs Apartment (same period)
        compareApartmentVsApartment() {
            const apartmentAId = document.getElementById('compApartmentA')?.value;
            const apartmentBId = document.getElementById('compApartmentB')?.value;
            const period = document.getElementById('compPeriod')?.value;
            
            if (!apartmentAId || !apartmentBId) {
                this.showToast('LÃ¼tfen iki daire seÃ§in', 'warning');
                return null;
            }
            
            const apartmentA = this.data.apartments?.find(a => a.id === apartmentAId);
            const apartmentB = this.data.apartments?.find(a => a.id === apartmentBId);
            
            if (!apartmentA || !apartmentB) {
                this.showToast('Daireler bulunamadÄ±', 'error');
                return null;
            }
            
            // Calculate metrics for both apartments
            let periodStart, periodEnd;
            
            if (period) {
                const [year, month] = period.split('-').map(Number);
                periodStart = new Date(year, month - 1, 1);
                periodEnd = new Date(year, month, 0);
            } else {
                // All time
                periodStart = new Date(2000, 0, 1);
                periodEnd = new Date();
            }
            
            const metricsA = this.calculateApartmentMetrics(apartmentA, periodStart, periodEnd);
            const metricsB = this.calculateApartmentMetrics(apartmentB, periodStart, periodEnd);
            
            return {
                mode: 'apartment-apartment',
                title: `${apartmentA.code} vs ${apartmentB.code}`,
                subtitle: period ? `DÃ¶nem: ${this.formatMonthYear(periodStart)}` : 'TÃ¼m Zamanlar',
                groupA: {
                    label: apartmentA.code,
                    sublabel: apartmentA.ownerName,
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: apartmentB.code,
                    sublabel: apartmentB.ownerName,
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Compare: Apartment vs Period
        compareApartmentVsPeriod() {
            const apartmentId = document.getElementById('compSingleApartment')?.value;
            const periodA = document.getElementById('compPeriodA')?.value;
            const periodB = document.getElementById('compPeriodB')?.value;
            
            if (!apartmentId || !periodA || !periodB) {
                this.showToast('LÃ¼tfen daire ve iki dÃ¶nem seÃ§in', 'warning');
                return null;
            }
            
            const apartment = this.data.apartments?.find(a => a.id === apartmentId);
            
            if (!apartment) {
                this.showToast('Daire bulunamadÄ±', 'error');
                return null;
            }
            
            // Parse periods
            const [yearA, monthA] = periodA.split('-').map(Number);
            const [yearB, monthB] = periodB.split('-').map(Number);
            
            const periodStartA = new Date(yearA, monthA - 1, 1);
            const periodEndA = new Date(yearA, monthA, 0);
            
            const periodStartB = new Date(yearB, monthB - 1, 1);
            const periodEndB = new Date(yearB, monthB, 0);
            
            const metricsA = this.calculateApartmentMetrics(apartment, periodStartA, periodEndA);
            const metricsB = this.calculateApartmentMetrics(apartment, periodStartB, periodEndB);
            
            return {
                mode: 'apartment-period',
                title: `${apartment.code} - DÃ¶nem KarÅŸÄ±laÅŸtÄ±rmasÄ±`,
                subtitle: apartment.ownerName,
                groupA: {
                    label: this.formatMonthYear(periodStartA),
                    sublabel: 'DÃ¶nem A',
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: this.formatMonthYear(periodStartB),
                    sublabel: 'DÃ¶nem B',
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Compare: Group vs Group
        compareGroupVsGroup() {
            const groupAIds = Array.from(document.getElementById('compGroupA')?.selectedOptions || [])
                .map(opt => opt.value);
            const groupBIds = Array.from(document.getElementById('compGroupB')?.selectedOptions || [])
                .map(opt => opt.value);
            const period = document.getElementById('compGroupPeriod')?.value;
            
            if (groupAIds.length === 0 || groupBIds.length === 0) {
                this.showToast('LÃ¼tfen her iki grup iÃ§in daire seÃ§in', 'warning');
                return null;
            }
            
            // Parse period
            let periodStart, periodEnd;
            
            if (period) {
                const [year, month] = period.split('-').map(Number);
                periodStart = new Date(year, month - 1, 1);
                periodEnd = new Date(year, month, 0);
            } else {
                periodStart = new Date(2000, 0, 1);
                periodEnd = new Date();
            }
            
            const metricsA = this.calculateGroupMetrics(groupAIds, periodStart, periodEnd);
            const metricsB = this.calculateGroupMetrics(groupBIds, periodStart, periodEnd);
            
            return {
                mode: 'group-group',
                title: 'Grup KarÅŸÄ±laÅŸtÄ±rmasÄ±',
                subtitle: period ? `DÃ¶nem: ${this.formatMonthYear(periodStart)}` : 'TÃ¼m Zamanlar',
                groupA: {
                    label: `Grup A (${groupAIds.length} daire)`,
                    sublabel: 'Toplam Performans',
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: `Grup B (${groupBIds.length} daire)`,
                    sublabel: 'Toplam Performans',
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Compare: System vs System
        compareSystemVsSystem() {
            const systemA = document.getElementById('compSystemA')?.value;
            const systemB = document.getElementById('compSystemB')?.value;
            const period = document.getElementById('compSystemPeriod')?.value;
            
            if (!systemA || !systemB) {
                this.showToast('LÃ¼tfen iki sistem seÃ§in', 'warning');
                return null;
            }
            
            const systemNames = {
                '1': 'Sistem 1 - Kira',
                '2': 'Sistem 2 - KiÅŸi Åžirketi',
                '3': 'Sistem 3 - Komisyon',
                '4': 'Sistem 4 - Ã–zel Komisyon',
                '5': 'Sistem 5 - StopajlÄ±',
                '6': 'Sistem 6 - Platform AyrÄ±mlÄ±',
                '7': 'Sistem 7 - Karma Platform',
                '8': 'Sistem 8 - KÃ¢r BazlÄ±'
            };
            
            // Parse period
            let periodStart, periodEnd;
            
            if (period) {
                const [year, month] = period.split('-').map(Number);
                periodStart = new Date(year, month - 1, 1);
                periodEnd = new Date(year, month, 0);
            } else {
                periodStart = new Date(2000, 0, 1);
                periodEnd = new Date();
            }
            
            const metricsA = this.calculateSystemMetrics(systemA, periodStart, periodEnd);
            const metricsB = this.calculateSystemMetrics(systemB, periodStart, periodEnd);
            
            return {
                mode: 'system-system',
                title: 'Sistem KarÅŸÄ±laÅŸtÄ±rmasÄ±',
                subtitle: period ? `DÃ¶nem: ${this.formatMonthYear(periodStart)}` : 'TÃ¼m Zamanlar',
                groupA: {
                    label: systemNames[systemA],
                    sublabel: `${metricsA.apartmentCount} daire`,
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: systemNames[systemB],
                    sublabel: `${metricsB.apartmentCount} daire`,
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Helper: Calculate apartment metrics
        calculateApartmentMetrics(apartment, startDate, endDate) {
            const reservations = this.data.reservations?.filter(res => {
                const checkIn = new Date(res.checkIn);
                return res.apartmentId === apartment.id &&
                    checkIn >= startDate && checkIn <= endDate;
            }) || [];
            
            const expenses = this.data.expenses?.filter(exp => {
                const date = new Date(exp.date);
                return exp.apartmentId === apartment.id &&
                    date >= startDate && date <= endDate;
            }) || [];
            
            const lagirioRevenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
            const ownerShare = this.calculateOwnerShare(apartment, reservations, expenses);
            
            const totalIncome = reservations.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            
            const totalExpenses = expenses.reduce((sum, exp) => 
                sum + this.convertToEUR(exp.amount, exp.currency), 0);
            
            const occupancy = this.calculateOccupancyRate(apartment.id, startDate, endDate);
            const avgNightlyRate = this.calculateAvgNightlyRate(reservations);
            
            // Calculate total nights
            const totalNights = reservations.reduce((sum, res) => {
                const nights = Math.ceil((new Date(res.checkOut) - new Date(res.checkIn)) / (1000 * 60 * 60 * 24));
                return sum + nights;
            }, 0);
            
            return {
                lagirioRevenue,
                ownerShare,
                totalIncome,
                totalExpenses,
                occupancy,
                avgNightlyRate,
                reservationCount: reservations.length,
                totalNights,
                profitMargin: totalIncome > 0 ? (lagirioRevenue / totalIncome * 100) : 0,
                expenseRatio: totalIncome > 0 ? (totalExpenses / totalIncome * 100) : 0
            };
        },

        // Helper: Calculate group metrics
        calculateGroupMetrics(apartmentIds, startDate, endDate) {
            let metrics = {
                lagirioRevenue: 0,
                ownerShare: 0,
                totalIncome: 0,
                totalExpenses: 0,
                occupancy: 0,
                avgNightlyRate: 0,
                reservationCount: 0,
                totalNights: 0,
                apartmentCount: apartmentIds.length
            };
            
            apartmentIds.forEach(apartmentId => {
                const apartment = this.data.apartments?.find(a => a.id === apartmentId);
                if (!apartment) return;
                
                const apartmentMetrics = this.calculateApartmentMetrics(apartment, startDate, endDate);
                
                metrics.lagirioRevenue += apartmentMetrics.lagirioRevenue;
                metrics.ownerShare += apartmentMetrics.ownerShare;
                metrics.totalIncome += apartmentMetrics.totalIncome;
                metrics.totalExpenses += apartmentMetrics.totalExpenses;
                metrics.occupancy += apartmentMetrics.occupancy;
                metrics.avgNightlyRate += apartmentMetrics.avgNightlyRate;
                metrics.reservationCount += apartmentMetrics.reservationCount;
                metrics.totalNights += apartmentMetrics.totalNights;
            });
            
            // Calculate averages
            if (apartmentIds.length > 0) {
                metrics.occupancy = metrics.occupancy / apartmentIds.length;
                metrics.avgNightlyRate = metrics.avgNightlyRate / apartmentIds.length;
            }
            
            metrics.profitMargin = metrics.totalIncome > 0 ? (metrics.lagirioRevenue / metrics.totalIncome * 100) : 0;
            metrics.expenseRatio = metrics.totalIncome > 0 ? (metrics.totalExpenses / metrics.totalIncome * 100) : 0;
            
            return metrics;
        },

        // Helper: Calculate system metrics
        calculateSystemMetrics(systemType, startDate, endDate) {
            const systemApartments = this.data.apartments?.filter(a => a.systemType === systemType) || [];
            const apartmentIds = systemApartments.map(a => a.id);
            
            const metrics = this.calculateGroupMetrics(apartmentIds, startDate, endDate);
            
            // Add commission average
            const commissions = systemApartments.map(a => a.lagirioCommission);
            metrics.avgCommission = commissions.length > 0 ? 
                commissions.reduce((a, b) => a + b, 0) / commissions.length : 0;
            
            return metrics;
        },

        // Helper: Format month/year
        formatMonthYear(date) {
            const months = ['Oca', 'Åžub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        },

        // Display comparison results
        displayComparisonResults(data) {
            const container = document.getElementById('comparisonResults');
            if (!container) return;
            
            const colorA = data.groupA.color;
            const colorB = data.groupB.color;
            
            // Calculate differences
            const diff = {
                revenue: data.groupA.metrics.lagirioRevenue - data.groupB.metrics.lagirioRevenue,
                revenuePercent: data.groupB.metrics.lagirioRevenue > 0 ? 
                    ((data.groupA.metrics.lagirioRevenue - data.groupB.metrics.lagirioRevenue) / data.groupB.metrics.lagirioRevenue * 100) : 0,
                
                income: data.groupA.metrics.totalIncome - data.groupB.metrics.totalIncome,
                incomePercent: data.groupB.metrics.totalIncome > 0 ? 
                    ((data.groupA.metrics.totalIncome - data.groupB.metrics.totalIncome) / data.groupB.metrics.totalIncome * 100) : 0,
                
                expenses: data.groupA.metrics.totalExpenses - data.groupB.metrics.totalExpenses,
                expensesPercent: data.groupB.metrics.totalExpenses > 0 ? 
                    ((data.groupA.metrics.totalExpenses - data.groupB.metrics.totalExpenses) / data.groupB.metrics.totalExpenses * 100) : 0,
                
                occupancy: data.groupA.metrics.occupancy - data.groupB.metrics.occupancy,
                occupancyPercent: data.groupB.metrics.occupancy > 0 ? 
                    ((data.groupA.metrics.occupancy - data.groupB.metrics.occupancy) / data.groupB.metrics.occupancy * 100) : 0,
                
                reservations: data.groupA.metrics.reservationCount - data.groupB.metrics.reservationCount,
                reservationsPercent: data.groupB.metrics.reservationCount > 0 ? 
                    ((data.groupA.metrics.reservationCount - data.groupB.metrics.reservationCount) / data.groupB.metrics.reservationCount * 100) : 0,
                
                nightlyRate: data.groupA.metrics.avgNightlyRate - data.groupB.metrics.avgNightlyRate,
                nightlyRatePercent: data.groupB.metrics.avgNightlyRate > 0 ? 
                    ((data.groupA.metrics.avgNightlyRate - data.groupB.metrics.avgNightlyRate) / data.groupB.metrics.avgNightlyRate * 100) : 0
            };
            
            container.innerHTML = `
                <!-- Comparison Header -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 animate-fade-in">
                    <div class="text-center mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${data.title}</h3>
                        <p class="text-gray-500">${data.subtitle}</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <!-- Group A -->
                        <div class="text-center p-6 bg-${colorA}-50 rounded-lg">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-${colorA}-500 text-white rounded-full mb-3">
                                <span class="text-2xl font-bold">A</span>
                            </div>
                            <h4 class="font-bold text-lg text-gray-800">${data.groupA.label}</h4>
                            <p class="text-sm text-gray-600">${data.groupA.sublabel}</p>
                        </div>
                        
                        <!-- VS -->
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 rounded-full">
                                <span class="text-3xl font-bold text-gray-600">VS</span>
                            </div>
                        </div>
                        
                        <!-- Group B -->
                        <div class="text-center p-6 bg-${colorB}-50 rounded-lg">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-${colorB}-500 text-white rounded-full mb-3">
                                <span class="text-2xl font-bold">B</span>
                            </div>
                            <h4 class="font-bold text-lg text-gray-800">${data.groupB.label}</h4>
                            <p class="text-sm text-gray-600">${data.groupB.sublabel}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Comparison Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Group A Metrics -->
                    <div class="bg-${colorA}-50 rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-${colorA}-900 mb-4 flex items-center space-x-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-${colorA}-500 text-white rounded-full text-xs">A</span>
                            <span>${data.groupA.label} - Detaylar</span>
                        </h4>
                        <div class="space-y-3">
                            ${this.renderMetricRow('Lagirio KazancÄ±', data.groupA.metrics.lagirioRevenue, 'EUR')}
                            ${this.renderMetricRow('Toplam Gelir', data.groupA.metrics.totalIncome, 'EUR')}
                            ${this.renderMetricRow('Toplam Gider', data.groupA.metrics.totalExpenses, 'EUR')}
                            ${this.renderMetricRow('Ev Sahibi PayÄ±', data.groupA.metrics.ownerShare, 'EUR')}
                            ${this.renderMetricRow('Doluluk OranÄ±', data.groupA.metrics.occupancy, '%')}
                            ${this.renderMetricRow('Rezervasyon SayÄ±sÄ±', data.groupA.metrics.reservationCount, '')}
                            ${this.renderMetricRow('Toplam Gece', data.groupA.metrics.totalNights, '')}
                            ${this.renderMetricRow('Ort. Gecelik Ãœcret', data.groupA.metrics.avgNightlyRate, 'EUR')}
                            ${this.renderMetricRow('KÃ¢r MarjÄ±', data.groupA.metrics.profitMargin, '%')}
                            ${this.renderMetricRow('Gider/Gelir OranÄ±', data.groupA.metrics.expenseRatio, '%')}
                        </div>
                    </div>
                    
                    <!-- Group B Metrics -->
                    <div class="bg-${colorB}-50 rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-${colorB}-900 mb-4 flex items-center space-x-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-${colorB}-500 text-white rounded-full text-xs">B</span>
                            <span>${data.groupB.label} - Detaylar</span>
                        </h4>
                        <div class="space-y-3">
                            ${this.renderMetricRow('Lagirio KazancÄ±', data.groupB.metrics.lagirioRevenue, 'EUR')}
                            ${this.renderMetricRow('Toplam Gelir', data.groupB.metrics.totalIncome, 'EUR')}
                            ${this.renderMetricRow('Toplam Gider', data.groupB.metrics.totalExpenses, 'EUR')}
                            ${this.renderMetricRow('Ev Sahibi PayÄ±', data.groupB.metrics.ownerShare, 'EUR')}
                            ${this.renderMetricRow('Doluluk OranÄ±', data.groupB.metrics.occupancy, '%')}
                            ${this.renderMetricRow('Rezervasyon SayÄ±sÄ±', data.groupB.metrics.reservationCount, '')}
                            ${this.renderMetricRow('Toplam Gece', data.groupB.metrics.totalNights, '')}
                            ${this.renderMetricRow('Ort. Gecelik Ãœcret', data.groupB.metrics.avgNightlyRate, 'EUR')}
                            ${this.renderMetricRow('KÃ¢r MarjÄ±', data.groupB.metrics.profitMargin, '%')}
                            ${this.renderMetricRow('Gider/Gelir OranÄ±', data.groupB.metrics.expenseRatio, '%')}
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Summary -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h4 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                        <span>KarÅŸÄ±laÅŸtÄ±rma Ã–zeti (A - B)</span>
                    </h4>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        ${this.renderDiffCard('Lagirio KazancÄ±', diff.revenue, diff.revenuePercent, 'EUR', true)}
                        ${this.renderDiffCard('Toplam Gelir', diff.income, diff.incomePercent, 'EUR', true)}
                        ${this.renderDiffCard('Toplam Gider', diff.expenses, diff.expensesPercent, 'EUR', false)}
                        ${this.renderDiffCard('Doluluk OranÄ±', diff.occupancy, diff.occupancyPercent, '%', true)}
                        ${this.renderDiffCard('Rezervasyon', diff.reservations, diff.reservationsPercent, '', true)}
                        ${this.renderDiffCard('Gecelik Ãœcret', diff.nightlyRate, diff.nightlyRatePercent, 'EUR', true)}
                    </div>
                </div>
                
                <!-- Comparison Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">Gelir KarÅŸÄ±laÅŸtÄ±rmasÄ±</h4>
                        <div class="chart-container-sm" id="comparisonRevenueChart"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">Performans RadarÄ±</h4>
                        <div class="chart-container-sm" id="comparisonRadarChart"></div>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
            
            // Create charts
            setTimeout(() => {
                this.createComparisonCharts(data);
                lucide.createIcons();
            }, 100);
            
            // Scroll to results
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            this.showToast('KarÅŸÄ±laÅŸtÄ±rma tamamlandÄ±!', 'success');
        },

        // Helper: Render metric row
        renderMetricRow(label, value, unit) {
            let formattedValue;
            
            if (unit === 'EUR') {
                formattedValue = `â‚¬${value.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            } else if (unit === '%') {
                formattedValue = `${value.toFixed(1)}%`;
            } else {
                formattedValue = Math.round(value).toLocaleString();
            }
            
            return `
                <div class="flex justify-between items-center py-2 border-b border-white/50">
                    <span class="text-gray-700 text-sm">${label}:</span>
                    <span class="font-semibold text-gray-900">${formattedValue}</span>
                </div>
            `;
        },

        // Helper: Render difference card
        renderDiffCard(label, diffValue, diffPercent, unit, higherIsBetter) {
            let formattedDiff;
            let icon, colorClass;
            
            if (unit === 'EUR') {
                formattedDiff = `â‚¬${Math.abs(diffValue).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            } else if (unit === '%') {
                formattedDiff = `${Math.abs(diffValue).toFixed(1)}%`;
            } else {
                formattedDiff = Math.abs(Math.round(diffValue)).toLocaleString();
            }
            
            // Determine color and icon
            if (diffValue > 0) {
                icon = higherIsBetter ? 'â†‘' : 'â†“';
                colorClass = higherIsBetter ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
            } else if (diffValue < 0) {
                icon = higherIsBetter ? 'â†“' : 'â†‘';
                colorClass = higherIsBetter ? 'text-red-600 bg-red-50' : 'text-green-600 bg-green-50';
            } else {
                icon = 'â†’';
                colorClass = 'text-gray-600 bg-gray-50';
            }
            
            return `
                <div class="text-center p-4 ${colorClass} rounded-lg">
                    <p class="text-xs text-gray-600 mb-1">${label}</p>
                    <p class="text-2xl font-bold ${colorClass.includes('green') ? 'text-green-600' : colorClass.includes('red') ? 'text-red-600' : 'text-gray-600'}">
                        ${diffValue > 0 ? '+' : diffValue < 0 ? '-' : ''}${formattedDiff}
                    </p>
                    <p class="text-sm mt-1 ${colorClass.includes('green') ? 'text-green-600' : colorClass.includes('red') ? 'text-red-600' : 'text-gray-600'}">
                        ${icon} ${Math.abs(diffPercent).toFixed(1)}%
                    </p>
                </div>
            `;
        },

        // Create comparison charts
        createComparisonCharts(data) {
            this.createComparisonRevenueChart(data);
            this.createComparisonRadarChart(data);
        },

        // Create comparison revenue chart
        createComparisonRevenueChart(data) {
            const container = document.getElementById('comparisonRevenueChart');
            if (!container) return;
            
            const chart = echarts.init(container);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: [data.groupA.label, data.groupB.label],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['Lagirio\nKazancÄ±', 'Toplam\nGelir', 'Toplam\nGider', 'Ev Sahibi\nPayÄ±']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: value => `â‚¬${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [
                    {
                        name: data.groupA.label,
                        type: 'bar',
                        data: [
                            data.groupA.metrics.lagirioRevenue,
                            data.groupA.metrics.totalIncome,
                            data.groupA.metrics.totalExpenses,
                            data.groupA.metrics.ownerShare
                        ],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: data.groupA.color === 'emerald' ? '#10b981' : '#3b82f6' },
                                { offset: 1, color: data.groupA.color === 'emerald' ? '#059669' : '#2563eb' }
                            ]),
                            borderRadius: [4, 4, 0, 0]
                        }
                    },
                    {
                        name: data.groupB.label,
                        type: 'bar',
                        data: [
                            data.groupB.metrics.lagirioRevenue,
                            data.groupB.metrics.totalIncome,
                            data.groupB.metrics.totalExpenses,
                            data.groupB.metrics.ownerShare
                        ],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: data.groupB.color === 'blue' ? '#3b82f6' : '#10b981' },
                                { offset: 1, color: data.groupB.color === 'blue' ? '#2563eb' : '#059669' }
                            ]),
                            borderRadius: [4, 4, 0, 0]
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            this.charts.comparisonRevenue = chart;
        },

        // Create comparison radar chart
        createComparisonRadarChart(data) {
            const container = document.getElementById('comparisonRadarChart');
            if (!container) return;
            
            const chart = echarts.init(container);
            
            // Normalize values for radar (0-100 scale)
            const maxRevenue = Math.max(data.groupA.metrics.lagirioRevenue, data.groupB.metrics.lagirioRevenue);
            const maxReservations = Math.max(data.groupA.metrics.reservationCount, data.groupB.metrics.reservationCount);
            const maxNightlyRate = Math.max(data.groupA.metrics.avgNightlyRate, data.groupB.metrics.avgNightlyRate);
            
            const option = {
                tooltip: {},
                legend: {
                    data: [data.groupA.label, data.groupB.label],
                    bottom: 0
                },
                radar: {
                    indicator: [
                        { name: 'KazanÃ§', max: 100 },
                        { name: 'Doluluk', max: 100 },
                        { name: 'Rezervasyon', max: 100 },
                        { name: 'Gecelik Ãœcret', max: 100 },
                        { name: 'KÃ¢r MarjÄ±', max: 100 }
                    ],
                    radius: '60%'
                },
                series: [{
                    type: 'radar',
                    data: [
                        {
                            value: [
                                maxRevenue > 0 ? (data.groupA.metrics.lagirioRevenue / maxRevenue * 100) : 0,
                                data.groupA.metrics.occupancy,
                                maxReservations > 0 ? (data.groupA.metrics.reservationCount / maxReservations * 100) : 0,
                                maxNightlyRate > 0 ? (data.groupA.metrics.avgNightlyRate / maxNightlyRate * 100) : 0,
                                data.groupA.metrics.profitMargin
                            ],
                            name: data.groupA.label,
                            areaStyle: {
                                color: data.groupA.color === 'emerald' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(59, 130, 246, 0.3)'
                            },
                            lineStyle: {
                                color: data.groupA.color === 'emerald' ? '#10b981' : '#3b82f6'
                            }
                        },
                        {
                            value: [
                                maxRevenue > 0 ? (data.groupB.metrics.lagirioRevenue / maxRevenue * 100) : 0,
                                data.groupB.metrics.occupancy,
                                maxReservations > 0 ? (data.groupB.metrics.reservationCount / maxReservations * 100) : 0,
                                maxNightlyRate > 0 ? (data.groupB.metrics.avgNightlyRate / maxNightlyRate * 100) : 0,
                                data.groupB.metrics.profitMargin
                            ],
                            name: data.groupB.label,
                            areaStyle: {
                                color: data.groupB.color === 'blue' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)'
                            },
                            lineStyle: {
                                color: data.groupB.color === 'blue' ? '#3b82f6' : '#10b981'
                            }
                        }
                    ]
                }]
            };
            
            chart.setOption(option);
            this.charts.comparisonRadar = chart;
        },
        
        // ==================== TREND ANALYSIS CHARTS ====================

        createTrendAnalysisCharts() {
            this.createRevenueTrendAnalysisChart();
            this.createOccupancyTrendChart();
            this.createSeasonalAnalysisChart();
            this.createGrowthAnalysisChart();
            this.updateForecastCards();
        },

        createRevenueTrendAnalysisChart() {
            const container = document.getElementById('revenueTrendAnalysisChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.revenueTrendAnalysis = chart;

            // Son 12 aylÄ±k veri
            const data = { months: [], revenues: [], expenses: [], profit: [] };
            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = targetDate.toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' });

                let monthRevenue = 0;
                let monthExpenses = 0;

                this.data.apartments?.forEach(apartment => {
                    const monthReservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    const monthExpensesList = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    monthRevenue += this.calculateLagirioRevenue(apartment, monthReservations, monthExpensesList);
                    monthExpenses += monthExpensesList.reduce((sum, exp) =>
                        sum + this.convertToEUR(exp.amount, exp.currency), 0);
                });

                data.months.push(monthName);
                data.revenues.push(monthRevenue);
                data.expenses.push(monthExpenses);
                data.profit.push(monthRevenue - monthExpenses);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent'
                },
                legend: {
                    data: ['Gelir', 'Gider', 'Net KÃ¢r'],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.months,
                    axisLabel: { rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: value => `â‚¬${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [
                    {
                        name: 'Gelir',
                        type: 'line',
                        data: data.revenues,
                        smooth: true,
                        itemStyle: { color: '#10b981' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                                { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'Gider',
                        type: 'line',
                        data: data.expenses,
                        smooth: true,
                        itemStyle: { color: '#ef4444' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                                { offset: 1, color: 'rgba(239, 68, 68, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'Net KÃ¢r',
                        type: 'bar',
                        data: data.profit,
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#3b82f6' },
                                { offset: 1, color: '#2563eb' }
                            ])
                        }
                    }
                ]
            };

            chart.setOption(option);
        },

        createOccupancyTrendChart() {
            const container = document.getElementById('occupancyTrendChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.occupancyTrend = chart;

            // Son 12 aylÄ±k doluluk oranÄ±
            const data = { months: [], occupancy: [] };
            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = targetDate.toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' });

                let totalOccupancy = 0;
                let activeCount = 0;

                this.data.apartments?.forEach(apartment => {
                    const monthStart = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
                    const monthEnd = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);

                    const hasReservations = this.data.reservations?.some(res => {
                        const checkIn = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            checkIn >= monthStart && checkIn <= monthEnd;
                    });

                    if (hasReservations) {
                        const occupancy = this.calculateOccupancyRate(apartment.id, monthStart, monthEnd);
                        totalOccupancy += occupancy;
                        activeCount++;
                    }
                });

                data.months.push(monthName);
                data.occupancy.push(activeCount > 0 ? totalOccupancy / activeCount : 0);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: params => `${params[0].name}<br/>Doluluk: ${params[0].value.toFixed(1)}%`
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.months,
                    axisLabel: { rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'Doluluk',
                    type: 'line',
                    data: data.occupancy,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    itemStyle: { color: '#f59e0b' },
                    lineStyle: { width: 3 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(245, 158, 11, 0.4)' },
                            { offset: 1, color: 'rgba(245, 158, 11, 0.05)' }
                        ])
                    }
                }]
            };

            chart.setOption(option);
        },

        createSeasonalAnalysisChart() {
            const container = document.getElementById('seasonalAnalysisChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.seasonalAnalysis = chart;

            // Aylara gÃ¶re ortalama kazanÃ§
            const monthlyData = Array(12).fill(0);
            const monthlyCounts = Array(12).fill(0);

            this.data.apartments?.forEach(apartment => {
                this.data.reservations?.filter(res => res.apartmentId === apartment.id).forEach(res => {
                    const month = new Date(res.checkIn).getMonth();
                    const expenses = this.data.expenses?.filter(exp => {
                        const expMonth = new Date(exp.date).getMonth();
                        const expYear = new Date(exp.date).getFullYear();
                        const resYear = new Date(res.checkIn).getFullYear();
                        return exp.apartmentId === apartment.id && expMonth === month && expYear === resYear;
                    }) || [];

                    monthlyData[month] += this.calculateLagirioRevenue(apartment, [res], expenses);
                    monthlyCounts[month]++;
                });
            });

            const avgMonthlyRevenue = monthlyData.map((total, i) =>
                monthlyCounts[i] > 0 ? total / monthlyCounts[i] : 0
            );

            const monthNames = ['Oca', 'Åžub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara'];

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: params => `${params[0].name}<br/>Ort. KazanÃ§: â‚¬${params[0].value.toLocaleString()}`
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: monthNames
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: value => `â‚¬${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [{
                    name: 'Ortalama KazanÃ§',
                    type: 'bar',
                    data: avgMonthlyRevenue,
                    itemStyle: {
                        color: params => {
                            const colors = [
                                '#3b82f6', '#3b82f6', '#10b981', '#10b981', '#22c55e', '#fbbf24',
                                '#f59e0b', '#ef4444', '#10b981', '#22c55e', '#3b82f6', '#3b82f6'
                            ];
                            return colors[params.dataIndex];
                        },
                        borderRadius: [4, 4, 0, 0]
                    }
                }]
            };

            chart.setOption(option);
        },

        createGrowthAnalysisChart() {
            const container = document.getElementById('growthAnalysisChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.growthAnalysis = chart;

            // YÄ±llÄ±k bÃ¼yÃ¼me analizi
            const yearlyData = {};

            this.data.apartments?.forEach(apartment => {
                this.data.reservations?.filter(res => res.apartmentId === apartment.id).forEach(res => {
                    const year = new Date(res.checkIn).getFullYear();
                    if (!yearlyData[year]) {
                        yearlyData[year] = { revenue: 0, count: 0 };
                    }

                    const expenses = this.data.expenses?.filter(exp => {
                        const expYear = new Date(exp.date).getFullYear();
                        return exp.apartmentId === apartment.id && expYear === year;
                    }) || [];

                    yearlyData[year].revenue += this.calculateLagirioRevenue(apartment, [res], expenses);
                    yearlyData[year].count++;
                });
            });

            const years = Object.keys(yearlyData).sort();
            const revenues = years.map(year => yearlyData[year].revenue);
            const growth = revenues.map((rev, i) => {
                if (i === 0) return 0;
                return ((rev - revenues[i-1]) / revenues[i-1] * 100);
            });

            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['Gelir', 'BÃ¼yÃ¼me %'],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: years
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Gelir',
                        position: 'left',
                        axisLabel: {
                            formatter: value => `â‚¬${(value / 1000).toFixed(0)}k`
                        }
                    },
                    {
                        type: 'value',
                        name: 'BÃ¼yÃ¼me %',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    }
                ],
                series: [
                    {
                        name: 'Gelir',
                        type: 'bar',
                        data: revenues,
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#10b981' },
                                { offset: 1, color: '#059669' }
                            ])
                        }
                    },
                    {
                        name: 'BÃ¼yÃ¼me %',
                        type: 'line',
                        yAxisIndex: 1,
                        data: growth,
                        smooth: true,
                        itemStyle: { color: '#8b5cf6' },
                        lineStyle: { width: 3 }
                    }
                ]
            };

            chart.setOption(option);
        },

        updateForecastCards() {
            // Basit tahmin: son 3 ayÄ±n ortalamasÄ±
            const revenues = [];
            const now = new Date();

            for (let i = 2; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                let monthRevenue = 0;

                this.data.apartments?.forEach(apartment => {
                    const monthReservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    const monthExpenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    monthRevenue += this.calculateLagirioRevenue(apartment, monthReservations, monthExpenses);
                });

                revenues.push(monthRevenue);
            }

            const avgRevenue = revenues.reduce((a, b) => a + b, 0) / revenues.length;

            const nextMonthForecast = document.getElementById('nextMonthForecast');
            const quarterForecast = document.getElementById('quarterForecast');
            const yearlyTarget = document.getElementById('yearlyTarget');

            if (nextMonthForecast) nextMonthForecast.textContent = `â‚¬${Math.round(avgRevenue).toLocaleString()}`;
            if (quarterForecast) quarterForecast.textContent = `â‚¬${Math.round(avgRevenue * 3).toLocaleString()}`;
            if (yearlyTarget) yearlyTarget.textContent = `â‚¬${Math.round(avgRevenue * 12).toLocaleString()}`;
        },

        // ==================== EFFICIENCY CHARTS ====================

        createEfficiencyCharts() {
            this.createCostEfficiencyChart();
            this.createSystemEfficiencyChart();
            this.updateEfficiencyMetrics();
        },

        createCostEfficiencyChart() {
            const container = document.getElementById('costEfficiencyChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.costEfficiency = chart;

            // Her daire iÃ§in gider/gelir oranÄ±
            const apartmentData = [];

            this.data.apartments?.forEach(apartment => {
                const reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];

                const totalIncome = reservations.reduce((sum, res) =>
                    sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);

                const totalExpenses = expenses.reduce((sum, exp) =>
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);

                const ratio = totalIncome > 0 ? (totalExpenses / totalIncome * 100) : 0;

                apartmentData.push({
                    name: apartment.code,
                    ratio: ratio,
                    income: totalIncome,
                    expenses: totalExpenses
                });
            });

            // Gider/gelir oranÄ±na gÃ¶re sÄ±rala
            apartmentData.sort((a, b) => a.ratio - b.ratio);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: params => {
                        const data = apartmentData[params[0].dataIndex];
                        return `${data.name}<br/>
                                Gider: â‚¬${data.expenses.toLocaleString()}<br/>
                                Gelir: â‚¬${data.income.toLocaleString()}<br/>
                                Oran: ${data.ratio.toFixed(1)}%`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: apartmentData.map(d => d.name),
                    axisLabel: { rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    name: 'Gider/Gelir OranÄ± (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'Gider/Gelir',
                    type: 'bar',
                    data: apartmentData.map(d => d.ratio),
                    itemStyle: {
                        color: params => {
                            const ratio = params.value;
                            if (ratio < 20) return '#10b981'; // YeÅŸil - Ã§ok iyi
                            if (ratio < 40) return '#22c55e'; // AÃ§Ä±k yeÅŸil - iyi
                            if (ratio < 60) return '#fbbf24'; // SarÄ± - orta
                            if (ratio < 80) return '#f59e0b'; // Turuncu - kÃ¶tÃ¼
                            return '#ef4444'; // KÄ±rmÄ±zÄ± - Ã§ok kÃ¶tÃ¼
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    markLine: {
                        data: [
                            { yAxis: 50, label: { formatter: 'Hedef: 50%' }, lineStyle: { color: '#6b7280' } }
                        ]
                    }
                }]
            };

            chart.setOption(option);
        },

        createSystemEfficiencyChart() {
            const container = document.getElementById('systemEfficiencyChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.systemEfficiency = chart;

            const systemData = this.getSystemComparisonData();

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}%'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: systemData.systems
                },
                series: [{
                    name: 'Verimlilik',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {d}%'
                    },
                    data: systemData.systems.map((system, index) => ({
                        value: systemData.efficiencies[index],
                        name: system
                    }))
                }]
            };

            chart.setOption(option);
        },

        updateEfficiencyMetrics() {
            const tbody = document.getElementById('efficiencyMetricsTable');
            if (!tbody) return;

            const metrics = this.calculatePerformanceMetrics();

            tbody.innerHTML = metrics.topApartments.map(apt => {
                // BoÅŸ gÃ¼n maliyeti hesapla
                const daysInPeriod = 30;
                const occupiedDays = (apt.occupancy / 100) * daysInPeriod;
                const emptyDays = daysInPeriod - occupiedDays;
                const emptyCost = emptyDays * apt.avgNightlyRate;

                // Verimlilik skoru (0-100)
                const efficiencyScore = Math.min(100, (apt.occupancy + apt.profitMargin) / 2);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${apt.code}</div>
                            <div class="text-xs text-gray-500">${apt.ownerName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-${apt.expenseRatio < 40 ? 'green' : apt.expenseRatio < 60 ? 'yellow' : 'red'}-500 h-2 rounded-full"
                                        style="width: ${Math.min(100, apt.expenseRatio)}%"></div>
                                </div>
                                <span class="text-sm text-gray-700">${apt.expenseRatio.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-semibold ${apt.profitMargin > 30 ? 'text-green-600' : apt.profitMargin > 15 ? 'text-yellow-600' : 'text-red-600'}">
                                ${apt.profitMargin.toFixed(1)}%
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            â‚¬${apt.avgNightlyRate.toFixed(0)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            â‚¬${emptyCost.toFixed(0)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full"
                                        style="width: ${efficiencyScore}%"></div>
                                </div>
                                <span class="text-sm font-semibold text-gray-700">${efficiencyScore.toFixed(0)}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        },

        // ==================== REPORT GENERATION ====================

        generateDetailedReport() {
            const stats = this.calculateQuickStats();
            const metrics = this.calculatePerformanceMetrics();

            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">DetaylÄ± Analiz Raporu</h2>
                        <p class="text-gray-500">OluÅŸturulma: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Daire BazlÄ± Performans</h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm border">Daire</th>
                                    <th class="px-4 py-2 text-right text-sm border">Lagirio KazancÄ±</th>
                                    <th class="px-4 py-2 text-right text-sm border">Ev Sahibi PayÄ±</th>
                                    <th class="px-4 py-2 text-right text-sm border">Doluluk</th>
                                    <th class="px-4 py-2 text-right text-sm border">Rezervasyon</th>
                                    <th class="px-4 py-2 text-right text-sm border">Ort. Gecelik</th>
                                    <th class="px-4 py-2 text-right text-sm border">KÃ¢r MarjÄ±</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${metrics.topApartments.map(apt => `
                                    <tr class="border-b">
                                        <td class="px-4 py-2 border">${apt.code}<br/><span class="text-xs text-gray-500">${apt.ownerName}</span></td>
                                        <td class="px-4 py-2 text-right border font-semibold">â‚¬${apt.revenue.toLocaleString()}</td>
                                        <td class="px-4 py-2 text-right border">â‚¬${apt.ownerShare.toLocaleString()}</td>
                                        <td class="px-4 py-2 text-right border">${apt.occupancy.toFixed(1)}%</td>
                                        <td class="px-4 py-2 text-right border">${apt.reservationCount}</td>
                                        <td class="px-4 py-2 text-right border">â‚¬${apt.avgNightlyRate.toFixed(0)}</td>
                                        <td class="px-4 py-2 text-right border">${apt.profitMargin.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold">
                                <tr>
                                    <td class="px-4 py-2 border">TOPLAM</td>
                                    <td class="px-4 py-2 text-right border">â‚¬${metrics.topApartments.reduce((s, a) => s + a.revenue, 0).toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">â‚¬${metrics.topApartments.reduce((s, a) => s + a.ownerShare, 0).toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">${stats.avgOccupancy.toFixed(1)}%</td>
                                    <td class="px-4 py-2 text-right border">${metrics.totalReservations}</td>
                                    <td class="px-4 py-2 text-right border">-</td>
                                    <td class="px-4 py-2 text-right border">${metrics.avgProfitMargin.toFixed(1)}%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                YazdÄ±r
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF Ä°ndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        generateComparisonReport() {
            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">KarÅŸÄ±laÅŸtÄ±rma Raporu</h2>
                        <p class="text-gray-500">KarÅŸÄ±laÅŸtÄ±rma modÃ¼lÃ¼nÃ¼ kullanarak detaylÄ± karÅŸÄ±laÅŸtÄ±rma yapabilirsiniz.</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <p class="text-blue-800">
                            <i data-lucide="info" class="w-5 h-5 inline mr-2"></i>
                            KarÅŸÄ±laÅŸtÄ±rma yapmak iÃ§in yukarÄ±daki menÃ¼den "KarÅŸÄ±laÅŸtÄ±rma" sekmesine gidin.
                        </p>
                    </div>
                </div>
            `;
        },

        generateFinancialReport() {
            const stats = this.calculateQuickStats();

            // Platform bazlÄ± gelir analizi
            const platformRevenue = {};
            this.data.reservations?.forEach(res => {
                const platform = res.platform || 'Direkt';
                if (!platformRevenue[platform]) platformRevenue[platform] = 0;
                platformRevenue[platform] += this.convertToEUR(res.totalAmount, res.currency || 'EUR');
            });

            // Ã–deme yÃ¶ntemi bazlÄ± analiz
            const paymentData = this.getPaymentMethodData();

            // Toplam giderler - kategori bazÄ±nda
            const expenseCategories = {};
            this.data.expenses?.forEach(exp => {
                const category = exp.category || 'DiÄŸer';
                if (!expenseCategories[category]) expenseCategories[category] = 0;
                expenseCategories[category] += this.convertToEUR(exp.amount, exp.currency);
            });

            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Finansal Rapor</h2>
                        <p class="text-gray-500">OluÅŸturulma: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <p class="text-sm text-gray-600">Toplam Gelir</p>
                            <p class="text-2xl font-bold text-green-600">â‚¬${stats.totalPortfolio.toLocaleString()}</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                            <p class="text-sm text-gray-600">Toplam Gider</p>
                            <p class="text-2xl font-bold text-red-600">â‚¬${Object.values(expenseCategories).reduce((a, b) => a + b, 0).toLocaleString()}</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <p class="text-sm text-gray-600">Net KÃ¢r</p>
                            <p class="text-2xl font-bold text-blue-600">â‚¬${(stats.totalPortfolio - Object.values(expenseCategories).reduce((a, b) => a + b, 0)).toLocaleString()}</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Platform BazlÄ± Gelir</h3>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm border">Platform</th>
                                <th class="px-4 py-2 text-right text-sm border">Gelir</th>
                                <th class="px-4 py-2 text-right text-sm border">Oran</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(platformRevenue).map(([platform, revenue]) => `
                                <tr class="border-b">
                                    <td class="px-4 py-2 border">${platform}</td>
                                    <td class="px-4 py-2 text-right border">â‚¬${revenue.toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">${((revenue / stats.totalPortfolio) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Ã–deme YÃ¶ntemi DaÄŸÄ±lÄ±mÄ±</h3>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Banka Transferi</p>
                            <p class="text-xl font-bold text-blue-600">â‚¬${paymentData.bank.toLocaleString()}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Nakit</p>
                            <p class="text-xl font-bold text-green-600">â‚¬${paymentData.cash.toLocaleString()}</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Gider Kategorileri</h3>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm border">Kategori</th>
                                <th class="px-4 py-2 text-right text-sm border">Tutar</th>
                                <th class="px-4 py-2 text-right text-sm border">Oran</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(expenseCategories).map(([category, amount]) => `
                                <tr class="border-b">
                                    <td class="px-4 py-2 border">${category}</td>
                                    <td class="px-4 py-2 text-right border">â‚¬${amount.toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">${((amount / Object.values(expenseCategories).reduce((a, b) => a + b, 0)) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                YazdÄ±r
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF Ä°ndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        generatePerformanceReport() {
            const metrics = this.calculatePerformanceMetrics();
            const systemData = this.getSystemComparisonData();

            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Performans Raporu</h2>
                        <p class="text-gray-500">KPI ve Metrik Analizi - ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Anahtar Performans GÃ¶stergeleri (KPI)</h3>
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
                            <p class="text-xs text-gray-600">Ortalama Doluluk</p>
                            <p class="text-2xl font-bold text-emerald-600">${metrics.topApartments.reduce((s, a) => s + a.occupancy, 0) / metrics.topApartments.length.toFixed(1)}%</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                            <p class="text-xs text-gray-600">Ortalama KÃ¢r MarjÄ±</p>
                            <p class="text-2xl font-bold text-blue-600">${metrics.avgProfitMargin.toFixed(1)}%</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                            <p class="text-xs text-gray-600">Toplam Rezervasyon</p>
                            <p class="text-2xl font-bold text-purple-600">${metrics.totalReservations}</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                            <p class="text-xs text-gray-600">Ort. Gider/Gelir</p>
                            <p class="text-2xl font-bold text-orange-600">${metrics.avgExpenseRatio.toFixed(1)}%</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 5 En Ä°yi Performans</h3>
                    <div class="space-y-3 mb-6">
                        ${metrics.topApartments.slice(0, 5).map((apt, index) => `
                            <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 rounded-full ${index === 0 ? 'bg-yellow-400' : index === 1 ? 'bg-gray-300' : index === 2 ? 'bg-orange-400' : 'bg-blue-400'} flex items-center justify-center text-white font-bold">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">${apt.code}</p>
                                        <p class="text-xs text-gray-500">${apt.ownerName}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-emerald-600">â‚¬${apt.revenue.toLocaleString()}</p>
                                    <p class="text-xs text-gray-500">${apt.occupancy.toFixed(1)}% doluluk</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Sistem PerformansÄ±</h3>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm border">Sistem</th>
                                <th class="px-4 py-2 text-right text-sm border">KazanÃ§</th>
                                <th class="px-4 py-2 text-right text-sm border">Doluluk</th>
                                <th class="px-4 py-2 text-right text-sm border">Verimlilik</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${systemData.systems.map((system, index) => `
                                <tr class="border-b">
                                    <td class="px-4 py-2 border">${system}</td>
                                    <td class="px-4 py-2 text-right border font-semibold">â‚¬${systemData.revenues[index].toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">${systemData.occupancies[index].toFixed(1)}%</td>
                                    <td class="px-4 py-2 text-right border">${systemData.efficiencies[index].toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                YazdÄ±r
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF Ä°ndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // Initialize application when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        if (Auth.checkSession()) {
            Auth.showApp();
        }
    });
    </script>
</body>
</html>