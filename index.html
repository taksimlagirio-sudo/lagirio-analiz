<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagirio Analytics Pro - Gelişmiş Veri Analizi</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230d3028'/><text x='50' y='68' font-size='60' font-family='sans-serif' font-weight='bold' fill='white' text-anchor='middle'>L</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Identity Services + API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <script>
        // Tailwind config
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'lagirio': {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            950: '#052e16',
                            beige: '#f5e6d3',
                            green: '#004d40',
                            orange: '#ff9800',
                            'orange-dark': '#f57c00',
                        }
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        }
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #16a34a, #22c55e);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #15803d, #16a34a);
        }
        
        /* Glass effect */
        .glass {
            background: rgba(255, 253, 251, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(250, 246, 240, 0.5);
        }
        
        .glass-dark {
            background: rgba(0, 77, 64, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Chart container heights */
        .chart-container {
            height: 320px;
        }
        
        .chart-container-lg {
            height: 420px;
        }
        
        .chart-container-sm {
            height: 250px;
        }
        
        /* Tab transitions */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Gradient backgrounds */
        .gradient-mesh {
            background-image: radial-gradient(at 47% 33%, hsl(35, 45%, 92%) 0, transparent 59%),
                            radial-gradient(at 82% 65%, hsl(44, 40%, 88%) 0, transparent 55%);
            filter: blur(40px);
            opacity: 0.3;
        }
        
        /* Loading animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tooltip styles */
        .custom-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .custom-tooltip.show {
            opacity: 1;
        }

        /* ========= LOGIN SCREEN ========= */
        .login-screen {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #052e16 0%, #14532d 30%, #15803d 60%, #16a34a 100%);
            position: relative; overflow: hidden;
        }
        .login-screen::before {
            content: ''; position: absolute; top: -50%; right: -30%; width: 80%; height: 200%;
            background: radial-gradient(ellipse, rgba(255,156,0,0.1) 0%, transparent 70%);
            pointer-events: none; animation: loginFloat 8s ease-in-out infinite;
        }
        .login-screen::after {
            content: ''; position: absolute; bottom: -30%; left: -20%; width: 60%; height: 120%;
            background: radial-gradient(ellipse, rgba(34,197,94,0.08) 0%, transparent 60%);
            pointer-events: none; animation: loginFloat 10s ease-in-out infinite reverse;
        }
        .login-screen.hidden { display: none; }
        .login-error { color: #ef4444; font-size: 13px; margin-top: 12px; display: none; text-align: center; }
        @keyframes loginFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }

        /* ========= APP WRAPPER ========= */
        .app-wrapper { display: none; }
        .app-wrapper.active { display: block; animation: fadeIn 0.4s ease-out; }

        /* ========= UPLOAD PANELS ========= */
        .upload-panel.hidden { display: none; }
        .upload-tab.active { background: linear-gradient(135deg, #16a34a, #15803d) !important; color: white !important; border-color: transparent !important; box-shadow: 0 4px 12px rgba(22,163,74,0.3) !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-[#faf6f0] via-[#fdfcfa] to-[#faf6f0] font-inter min-h-screen">
    
    <!-- ========= LOGIN SCREEN ========= -->
    <div class="login-screen" id="loginScreen">
        <div class="absolute inset-0 overflow-hidden pointer-events-none z-0">
            <div class="absolute top-[10%] left-[15%] w-32 h-32 bg-white/[0.03] rounded-full" style="animation: loginFloat 6s ease-in-out infinite;"></div>
            <div class="absolute top-[60%] right-[10%] w-20 h-20 bg-white/[0.04] rounded-full" style="animation: loginFloat 8s ease-in-out 1s infinite;"></div>
            <div class="absolute bottom-[20%] left-[8%] w-16 h-16 bg-emerald-400/[0.05] rounded-full" style="animation: loginFloat 7s ease-in-out 2s infinite;"></div>
        </div>

        <div class="bg-white/[0.97] backdrop-blur-2xl rounded-3xl p-12 w-[440px] max-w-[90vw] shadow-[0_32px_64px_rgba(0,0,0,0.2)] text-center relative z-10 border border-white/20">
            <div class="w-[80px] h-[80px] bg-gradient-to-br from-emerald-900 via-emerald-700 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-6 text-[30px] font-extrabold text-white tracking-tight shadow-[0_8px_24px_rgba(22,101,52,0.3)] rotate-3 hover:rotate-0 transition-transform">L</div>
            <h1 class="text-[26px] font-extrabold bg-gradient-to-r from-emerald-900 to-emerald-600 bg-clip-text text-transparent mb-1.5">Lagirio Analytics</h1>
            <p class="text-sm text-gray-400 mb-8 font-medium">Gelişmiş Veri Analiz Paneli</p>

            <div class="mb-5 text-left">
                <label class="block text-[12px] font-bold text-gray-400 mb-2 uppercase tracking-wider">Kullanıcı Adı</label>
                <div class="relative">
                    <input type="text" id="loginUser" placeholder="Kullanıcı adınız" autocomplete="username"
                           class="w-full px-4 py-3.5 border-2 border-gray-100 rounded-xl text-[15px] font-inter bg-[#faf8f4] transition-all duration-300 focus:outline-none focus:border-emerald-500 focus:bg-white focus:ring-[4px] focus:ring-emerald-500/10 focus:shadow-lg pl-11">
                    <i data-lucide="user" class="w-4 h-4 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>
            <div class="mb-5 text-left">
                <label class="block text-[12px] font-bold text-gray-400 mb-2 uppercase tracking-wider">Şifre</label>
                <div class="relative">
                    <input type="password" id="loginPass" placeholder="Şifreniz" autocomplete="current-password"
                           class="w-full px-4 py-3.5 border-2 border-gray-100 rounded-xl text-[15px] font-inter bg-[#faf8f4] transition-all duration-300 focus:outline-none focus:border-emerald-500 focus:bg-white focus:ring-[4px] focus:ring-emerald-500/10 focus:shadow-lg pl-11"
                           onkeydown="if(event.key==='Enter')Auth.login()">
                    <i data-lucide="lock" class="w-4 h-4 text-gray-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>

            <button id="loginBtn" onclick="Auth.login()"
                    class="w-full py-4 bg-gradient-to-r from-emerald-800 via-emerald-700 to-emerald-600 text-white border-none rounded-xl text-[15px] font-bold font-inter cursor-pointer transition-all duration-300 mt-3 hover:-translate-y-0.5 hover:shadow-[0_8px_24px_rgba(13,48,40,0.35)] active:translate-y-0 active:shadow-md flex items-center justify-center gap-2">
                <i data-lucide="log-in" class="w-4 h-4"></i>
                Giriş Yap
            </button>
            <p id="loginError" class="login-error"></p>

            <div class="mt-8 pt-6 border-t border-gray-100 flex items-center justify-center gap-6 text-[11px] text-gray-400 font-medium">
                <span class="flex items-center gap-1"><i data-lucide="shield-check" class="w-3 h-3"></i> Güvenli</span>
                <span class="flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> Hızlı</span>
                <span class="flex items-center gap-1"><i data-lucide="bar-chart-2" class="w-3 h-3"></i> Detaylı</span>
            </div>
        </div>
    </div>

    <!-- ========= MAIN APP WRAPPER (hidden until login) ========= -->
    <div class="app-wrapper" id="appWrapper">

    <!-- Gradient Mesh Background -->
    <div class="fixed inset-0 gradient-mesh pointer-events-none"></div>

    <!-- Header -->
    <header class="glass-dark shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-br from-lagirio-orange to-lagirio-orange-dark text-white font-bold text-xl px-4 py-2 rounded-lg shadow-lg">
                        <span class="flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            lagirio.
                        </span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Analytics Pro</h1>
                        <p class="text-emerald-200 text-xs">Gelişmiş Veri Analizi Platformu</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Quick Stats -->
                    <div class="hidden lg:flex items-center space-x-6 mr-6">
                        <div class="text-center">
                            <p class="text-emerald-200 text-xs">Portföy Değeri</p>
                            <p class="text-white font-bold text-lg" id="headerPortfolioValue">€0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-emerald-200 text-xs">Bu Ay</p>
                            <p class="text-white font-bold text-lg" id="headerMonthlyValue">€0</p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <button onclick="Analytics.showNotifications()" class="relative bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" id="notificationCount">0</span>
                    </button>
                    
                    <button onclick="Analytics.exportPDF()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">PDF</span>
                    </button>
                    
                    <button onclick="Analytics.exportExcel()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <i data-lucide="table" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Excel</span>
                    </button>
                    
                    <button onclick="GoogleDrive.accessToken ? GoogleDrive.saveToDrive() : UploadUI.switchTab('drive')" id="headerDriveBtn" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition" title="Google Drive'a Kaydet">
                        <i data-lucide="hard-drive" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Drive</span>
                    </button>

                    <button onclick="Analytics.showSettings()" class="bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>

                    <div class="w-px h-8 bg-white/10"></div>

                    <button onclick="Auth.logout()" class="bg-red-500/10 hover:bg-red-500/20 text-red-300 px-3 py-2 rounded-lg flex items-center space-x-2 transition text-sm">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Çıkış</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Upload Section -->
    <div id="uploadSection" class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">

            <!-- Section Title -->
            <div class="text-center mb-8 animate-fade-in">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-full mb-4 shadow-lg">
                    <i data-lucide="upload-cloud" class="w-10 h-10 text-white"></i>
                </div>
                <h2 class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-800 bg-clip-text text-transparent mb-2">
                    Veri Yükleme Merkezi
                </h2>
                <p class="text-gray-500">Verilerinizi yükleyerek güçlü analizlere başlayın</p>
            </div>

            <!-- Upload Tabs -->
            <div class="flex justify-center gap-2 mb-6">
                <button onclick="UploadUI.switchTab('json')" id="uploadTab-json" class="upload-tab active px-5 py-2.5 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 bg-emerald-600 text-white shadow-lg">
                    <i data-lucide="file-json" class="w-4 h-4"></i> JSON Dosya
                </button>
                <button onclick="UploadUI.switchTab('drive')" id="uploadTab-drive" class="upload-tab px-5 py-2.5 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 bg-white text-gray-600 border border-gray-200 hover:border-emerald-300 hover:text-emerald-600">
                    <i data-lucide="hard-drive" class="w-4 h-4"></i> Google Drive
                </button>
                <!-- PMS Rezervasyon tab artık Dashboard > Projeksiyon sekmesinde -->
            </div>

            <!-- ===== JSON Upload Panel ===== -->
            <div id="uploadPanel-json" class="upload-panel glass rounded-2xl shadow-2xl p-8 animate-fade-in">
                <div id="uploadArea" class="border-2 border-dashed border-emerald-300 rounded-xl py-12 px-6 hover:border-emerald-500 hover:bg-emerald-50/50 transition-all cursor-pointer group">
                    <div class="text-center">
                        <i data-lucide="folder-open" class="w-12 h-12 text-emerald-400 mx-auto mb-4 group-hover:scale-110 transition-transform"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">JSON Dosya Seçin veya Sürükleyin</h3>
                        <p class="text-sm text-gray-500 mb-4">Daire, rezervasyon ve gider verilerini içeren JSON dosyası</p>
                        <input type="file" id="fileInput" accept=".json" class="hidden">

                        <div class="flex items-center justify-center space-x-4 mt-6">
                            <button class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg flex items-center space-x-2">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span>Dosya Seç</span>
                            </button>
                            <button onclick="Analytics.loadSampleData()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-lg hover:from-orange-600 hover:to-orange-700 transition shadow-lg flex items-center space-x-2">
                                <i data-lucide="database" class="w-4 h-4"></i>
                                <span>Örnek Veri</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Google Drive Panel ===== -->
            <div id="uploadPanel-drive" class="upload-panel glass rounded-2xl shadow-2xl p-8 hidden">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                        <i data-lucide="hard-drive" class="w-8 h-8 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Google Drive Bağlantısı</h3>
                    <p class="text-sm text-gray-500">Bir dosyaya bağlanın, sonraki girişlerde otomatik yüklensin</p>
                </div>

                <!-- Step indicator -->
                <div id="driveSteps" class="flex items-center justify-center gap-2 mb-6 text-xs font-semibold">
                    <div id="driveStep1" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-100 text-blue-700">
                        <span class="w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px]">1</span>
                        Client ID
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    <div id="driveStep2" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-gray-400">
                        <span class="w-5 h-5 rounded-full bg-gray-300 text-white flex items-center justify-center text-[10px]">2</span>
                        Bağlan
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    <div id="driveStep3" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-gray-400">
                        <span class="w-5 h-5 rounded-full bg-gray-300 text-white flex items-center justify-center text-[10px]">3</span>
                        Dosya Seç
                    </div>
                </div>

                <!-- Status Banner (dynamic) -->
                <div id="driveStatus" class="mb-6"></div>

                <!-- Phase 1: Client ID Input (only if not saved) -->
                <div id="drivePhase1" class="space-y-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase tracking-wider">Google Cloud Client ID</label>
                        <input type="text" id="driveClientId" placeholder="xxxx.apps.googleusercontent.com"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-[11px] text-gray-400 mt-1.5">Google Cloud Console &gt; APIs &gt; Credentials &gt; OAuth 2.0 Client ID</p>
                    </div>
                </div>

                <!-- Phase 2: Connect Button -->
                <div id="drivePhase2" class="mb-6 text-center">
                    <button onclick="GoogleDrive.connect()" id="driveConnectBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-3 rounded-xl flex items-center gap-2 hover:shadow-lg transition font-semibold mx-auto">
                        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12.545 10.239v3.821h5.445c-.712 2.315-2.647 3.972-5.445 3.972a6.033 6.033 0 110-12.064c1.498 0 2.866.549 3.921 1.453l2.814-2.814A9.969 9.969 0 0012.545 2C7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-.013z"/></svg>
                        Google ile Giriş Yap
                    </button>
                </div>

                <!-- Phase 3: File Selection / Linked File -->
                <div id="drivePhase3" class="hidden mb-6">
                    <!-- Linked file info (shown when already linked) -->
                    <div id="driveLinkedFile" class="hidden bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i data-lucide="file-check" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-sm text-emerald-800" id="driveFileName">lagirio-analiz-data.json</p>
                                    <p class="text-[11px] text-emerald-600" id="driveFileInfo">Bağlı dosya</p>
                                </div>
                            </div>
                            <button onclick="GoogleDrive.unlinkFile()" class="text-xs text-red-400 hover:text-red-600 underline">Bağlantıyı Kes</button>
                        </div>
                    </div>

                    <!-- New file / existing file selection -->
                    <div id="driveFileSelect" class="hidden space-y-3">
                        <p class="text-sm text-gray-600 font-medium text-center mb-3">Hangi dosyayı kullanmak istersiniz?</p>
                        <button onclick="GoogleDrive.createNewFile()" class="w-full bg-white border-2 border-dashed border-blue-300 rounded-xl p-4 text-left hover:border-blue-500 hover:bg-blue-50/50 transition group">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center group-hover:bg-blue-200 transition">
                                    <i data-lucide="file-plus" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-sm text-gray-800">Yeni Dosya Oluştur</p>
                                    <p class="text-[11px] text-gray-400">Drive'da yeni bir JSON dosyası oluşturulur</p>
                                </div>
                            </div>
                        </button>
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                            <div class="relative flex justify-center text-xs"><span class="bg-white px-3 text-gray-400">veya</span></div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-xl p-4">
                            <p class="font-semibold text-sm text-gray-800 mb-2">Mevcut Dosya ID Gir</p>
                            <div class="flex gap-2">
                                <input type="text" id="driveFileId" placeholder="Drive dosya ID'si yapıştırın"
                                       class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="GoogleDrive.linkExistingFile()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                                    Bağla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons (shown when connected + linked) -->
                <div id="driveActions" class="hidden">
                    <div class="flex gap-3 justify-center mb-3">
                        <button onclick="GoogleDrive.loadFromDrive()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl flex items-center justify-center gap-2 hover:shadow-lg transition font-semibold">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Drive'dan Veri Çek
                        </button>
                        <button onclick="GoogleDrive.saveToDrive()" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white py-3 rounded-xl flex items-center justify-center gap-2 hover:shadow-lg transition font-semibold">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Drive'a Kaydet
                        </button>
                    </div>

                    <!-- Auto-load toggle -->
                    <label class="flex items-center justify-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="driveAutoLoad" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked onchange="GoogleDrive.saveConfig()">
                        <span class="text-xs text-gray-500 group-hover:text-gray-700">Giriş yapıldığında otomatik Drive'dan çek</span>
                    </label>
                </div>

                <!-- Message area -->
                <p id="driveMessage" class="text-center text-sm mt-4 hidden"></p>

                <!-- Connected user info -->
                <div id="driveUserInfo" class="hidden mt-4 pt-4 border-t border-gray-100 text-center">
                    <p class="text-xs text-gray-400">Bağlı hesap: <span id="driveUserEmail" class="font-semibold text-gray-600"></span></p>
                </div>
            </div>

            <!-- ===== PMS HTML Reservation Panel ===== -->
            <!-- PMS Rezervasyon paneli artık Dashboard > Projeksiyon sekmesinde -->

            <!-- Bottom Feature Icons -->
            <div class="mt-6 grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-full mb-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <p class="text-xs text-gray-600">Güvenli İşlem</p>
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-full mb-2">
                        <i data-lucide="zap" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <p class="text-xs text-gray-600">Hızlı Analiz</p>
                </div>
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-emerald-100 rounded-full mb-2">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <p class="text-xs text-gray-600">Detaylı Raporlar</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Dashboard (Hidden initially) -->
    <div id="mainDashboard" class="container mx-auto px-4 py-6 hidden">
        
        <!-- Top Controls Bar -->
        <div class="glass rounded-xl shadow-lg p-4 mb-6 animate-slide-up">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Date Range Selector -->
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="calendar-days" class="w-5 h-5 text-emerald-600"></i>
                        <select id="datePreset" class="px-4 py-2 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                            <option value="this-month">Bu Ay</option>
                            <option value="last-month">Geçen Ay</option>
                            <option value="last-3-months">Son 3 Ay</option>
                            <option value="last-6-months">Son 6 Ay</option>
                            <option value="this-year">Bu Yıl</option>
                            <option value="last-year">Geçen Yıl</option>
                            <option value="all" selected>Tüm Zamanlar</option>
                            <option value="custom">Özel Seçim</option>
                        </select>
                    </div>
                    
                    <div id="customDateRange" class="hidden flex items-center space-x-2 animate-fade-in">
                        <input type="date" id="startDate" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm">
                        <span class="text-gray-400">→</span>
                        <input type="date" id="endDate" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm">
                        <button onclick="Analytics.applyDateFilter()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition flex items-center space-x-1">
                            <i data-lucide="check" class="w-4 h-4"></i>
                            <span>Uygula</span>
                        </button>
                    </div>
                </div>
                
                <!-- Currency Settings -->
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2 bg-white/50 px-3 py-2 rounded-lg">
                        <span class="text-sm text-gray-600">€/₺</span>
                        <input type="number" id="exchangeRateTL" value="48.5" step="0.1" class="w-16 px-2 py-1 bg-white border border-gray-200 rounded text-sm">
                    </div>
                    <div class="flex items-center space-x-2 bg-white/50 px-3 py-2 rounded-lg">
                        <span class="text-sm text-gray-600">€/$</span>
                        <input type="number" id="exchangeRateUSD" value="0.86" step="0.01" class="w-16 px-2 py-1 bg-white border border-gray-200 rounded text-sm">
                    </div>
                    <button onclick="Analytics.refreshData()" class="bg-emerald-100 text-emerald-700 p-2 rounded-lg hover:bg-emerald-200 transition" title="Verileri Yenile">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <!-- Portfolio Value Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.1s">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-emerald-600/10 group-hover:from-emerald-500/20 group-hover:to-emerald-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-emerald-100 rounded-lg">
                            <i data-lucide="trending-up" class="w-5 h-5 text-emerald-600"></i>
                        </div>
                        <span class="text-xs text-emerald-600 font-semibold" id="portfolioTrend">+0%</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Toplam Portföy</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalPortfolioValue">€0</p>
                    <div class="mt-2 h-1 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full transition-all duration-500" id="portfolioProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Monthly Revenue Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.2s">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-blue-600/10 group-hover:from-blue-500/20 group-hover:to-blue-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i data-lucide="euro" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <span class="text-xs text-blue-600 font-semibold" id="monthlyTrend">→</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1" id="revenueLabel">Bu Ay Kazanç</p>
                    <p class="text-2xl font-bold text-gray-800" id="monthlyRevenue">€0</p>
                    <p class="text-xs text-gray-400 mt-2" id="monthlyChange">vs geçen dönem</p>
                </div>
            </div>
            
            <!-- Active Properties Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.3s">
                <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-purple-600/10 group-hover:from-purple-500/20 group-hover:to-purple-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <i data-lucide="home" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full" id="activePercentage">0%</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Aktif Daireler</p>
                    <p class="text-2xl font-bold text-gray-800" id="activeProperties">0/0</p>
                    <p class="text-xs text-gray-400 mt-2">Rezervasyonlu</p>
                </div>
            </div>
            
            <!-- Average Occupancy Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.4s">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-500/10 to-orange-600/10 group-hover:from-orange-500/20 group-hover:to-orange-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-orange-100 rounded-lg">
                            <i data-lucide="calendar-check" class="w-5 h-5 text-orange-600"></i>
                        </div>
                        <span class="text-xs text-orange-600" id="occupancyIndicator">→</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">Ortalama Doluluk</p>
                    <p class="text-2xl font-bold text-gray-800" id="avgOccupancy">0%</p>
                    <div class="mt-2 flex space-x-1">
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                        <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                    </div>
                </div>
            </div>
            
            <!-- Best System Card -->
            <div class="glass rounded-xl p-6 relative overflow-hidden group hover:shadow-xl transition-shadow animate-slide-up" style="animation-delay: 0.5s">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-teal-600/10 group-hover:from-emerald-500/20 group-hover:to-teal-600/20 transition"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-2">
                        <div class="p-2 bg-emerald-100 rounded-lg">
                            <i data-lucide="award" class="w-5 h-5 text-emerald-600"></i>
                        </div>
                        <i data-lucide="crown" class="w-4 h-4 text-yellow-500"></i>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">En Karlı Sistem</p>
                    <p class="text-xl font-bold text-gray-800" id="bestSystem">-</p>
                    <p class="text-xs text-emerald-600 font-semibold mt-2" id="systemProfit">€0</p>
                </div>
            </div>
        </div>
        
        <!-- Main Navigation Tabs -->
        <div class="glass rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 p-1">
                <nav class="flex flex-wrap">
                    <button onclick="Analytics.switchMainTab('overview')" class="main-tab active flex-1 px-4 py-3 text-sm font-semibold text-white bg-white/20 rounded-t-lg transition hover:bg-white/30 flex items-center justify-center space-x-2" data-tab="overview">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                        <span>Genel Bakış</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('analysis')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="analysis">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i>
                        <span>Detaylı Analiz</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('comparison')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="comparison">
                        <i data-lucide="git-compare" class="w-4 h-4"></i>
                        <span>Karşılaştırma</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('trends')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="trends">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                        <span>Trendler</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('efficiency')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="efficiency">
                        <i data-lucide="gauge" class="w-4 h-4"></i>
                        <span>Verimlilik</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('reports')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="reports">
                        <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                        <span>Raporlar</span>
                    </button>
                    <button onclick="Analytics.switchMainTab('projection')" class="main-tab flex-1 px-4 py-3 text-sm font-semibold text-white/80 hover:text-white transition hover:bg-white/10 rounded-t-lg flex items-center justify-center space-x-2" data-tab="projection">
                        <i data-lucide="telescope" class="w-4 h-4"></i>
                        <span>Projeksiyon</span>
                    </button>
                </nav>
            </div>
            
            <!-- Overview Tab Content -->
            <div id="overview-content" class="tab-content active bg-white/95 p-6">
                <!-- Performance Metrics Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Revenue Trend Chart -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                                <i data-lucide="line-chart" class="w-5 h-5 text-emerald-600"></i>
                                <span>Gelir Trendi</span>
                            </h3>
                            <select id="trendPeriod" class="text-sm px-3 py-1 border border-gray-200 rounded-lg">
                                <option value="daily">Günlük</option>
                                <option value="weekly">Haftalık</option>
                                <option value="monthly" selected>Aylık</option>
                                <option value="yearly">Yıllık</option>
                            </select>
                        </div>
                        <div class="chart-container" id="revenueTrendChart"></div>
                    </div>
                    
                    <!-- Top Performers -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>
                            <span>En İyi Performans</span>
                        </h3>
                        <div class="space-y-3" id="topPerformers">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
                
                <!-- System Performance Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- System cards will be dynamically generated -->
                    <div id="systemPerformanceCards"></div>
                </div>
                
                <!-- Platform Distribution -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="globe" class="w-5 h-5 text-blue-600"></i>
                            <span>Platform Dağılımı</span>
                        </h3>
                        <div class="chart-container-sm" id="platformDistChart"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="credit-card" class="w-5 h-5 text-green-600"></i>
                            <span>Ödeme Yöntemi Dağılımı</span>
                        </h3>
                        <div class="chart-container-sm" id="paymentMethodChart"></div>
                    </div>
                </div>
                
                <!-- Recent Activity & Alerts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="activity" class="w-5 h-5 text-purple-600"></i>
                            <span>Son Aktiviteler</span>
                        </h3>
                        <div class="space-y-3" id="recentActivity">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600"></i>
                            <span>Önemli Uyarılar</span>
                        </h3>
                        <div class="space-y-3" id="importantAlerts">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tab Content -->
            <div id="analysis-content" class="tab-content hidden bg-white/95 p-6">
                <!-- Analysis Sub-tabs -->
                <div class="bg-gray-50 rounded-lg p-1 mb-6">
                    <nav class="flex flex-wrap">
                        <button onclick="Analytics.switchAnalysisTab('system')" class="analysis-tab active flex-1 px-4 py-2 text-sm font-medium bg-white rounded-lg shadow-sm" data-analysis="system">
                            Sistem Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('apartment')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="apartment">
                            Daire Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('platform')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="platform">
                            Platform Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('expense')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="expense">
                            Gider Analizi
                        </button>
                        <button onclick="Analytics.switchAnalysisTab('owner')" class="analysis-tab flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900" data-analysis="owner">
                            Sahip Analizi
                        </button>
                    </nav>
                </div>
                
                <!-- Analysis Content Areas -->
                <div id="system-analysis" class="analysis-content active">
                    <!-- System analysis content -->
                </div>
                <div id="apartment-analysis" class="analysis-content hidden">
                    <!-- Apartment analysis content -->
                </div>
                <div id="platform-analysis" class="analysis-content hidden">
                    <!-- Platform analysis content -->
                </div>
                <div id="expense-analysis" class="analysis-content hidden">
                    <!-- Expense analysis content -->
                </div>
                <div id="owner-analysis" class="analysis-content hidden">
                    <!-- Owner analysis content -->
                </div>
            </div>
            
            <!-- Comparison Tab Content -->
            <div id="comparison-content" class="tab-content hidden bg-white/95 p-6">
                <!-- Advanced Comparison Controls -->
                <!-- Advanced Comparison Controls -->
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Karşılaştırma Parametreleri</h3>
                    
                    <!-- Comparison Mode Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Karşılaştırma Modu</label>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            <button onclick="Analytics.setComparisonMode('apartment-apartment')" 
                                    class="comparison-mode-btn active px-4 py-3 bg-white border-2 border-emerald-500 rounded-lg hover:bg-emerald-50 transition text-left">
                                <div class="font-semibold text-emerald-700">Daire vs Daire</div>
                                <div class="text-xs text-gray-500 mt-1">Aynı dönemde</div>
                            </button>
                            
                            <button onclick="Analytics.setComparisonMode('apartment-period')" 
                                    class="comparison-mode-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 transition text-left">
                                <div class="font-semibold text-gray-700">Daire vs Dönem</div>
                                <div class="text-xs text-gray-500 mt-1">Bir daire, farklı aylar</div>
                            </button>
                            
                            <button onclick="Analytics.setComparisonMode('group-group')" 
                                    class="comparison-mode-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-purple-50 hover:border-purple-500 transition text-left">
                                <div class="font-semibold text-gray-700">Grup vs Grup</div>
                                <div class="text-xs text-gray-500 mt-1">Çoklu daire karşılaştır</div>
                            </button>
                            
                            <button onclick="Analytics.setComparisonMode('system-system')" 
                                    class="comparison-mode-btn px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-orange-50 hover:border-orange-500 transition text-left">
                                <div class="font-semibold text-gray-700">Sistem vs Sistem</div>
                                <div class="text-xs text-gray-500 mt-1">Sistem karşılaştır</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dynamic Comparison Panels -->
                    <div id="comparisonPanels">
                        <!-- Will be filled dynamically -->
                    </div>
                    
                    <button onclick="Analytics.runAdvancedComparison()" 
                            class="mt-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg flex items-center space-x-2 mx-auto">
                        <i data-lucide="git-compare" class="w-5 h-5"></i>
                        <span>Karşılaştır</span>
                    </button>
                </div>

                        
                        <!-- First Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Birinci Seçim</label>
                            <div id="firstComparisonSelect">
                                <select id="firstApartments" class="w-full px-3 py-2 border border-gray-200 rounded-lg" multiple>
                                    <!-- Dynamic options -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Second Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">İkinci Seçim</label>
                            <div id="secondComparisonSelect">
                                <select id="secondApartments" class="w-full px-3 py-2 border border-gray-200 rounded-lg" multiple>
                                    <!-- Dynamic options -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Period Selection for Period Comparison -->
                    <div id="periodComparisonControls" class="hidden mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Birinci Dönem</label>
                            <div class="flex space-x-2">
                                <input type="month" id="firstPeriodStart" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                                <span class="self-center">→</span>
                                <input type="month" id="firstPeriodEnd" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">İkinci Dönem</label>
                            <div class="flex space-x-2">
                                <input type="month" id="secondPeriodStart" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                                <span class="self-center">→</span>
                                <input type="month" id="secondPeriodEnd" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                
                <!-- Comparison Results -->
                <div id="comparisonResults" class="hidden">
                    <!-- Dynamic comparison results -->
                </div>
            </div>
            
            <!-- Trends Tab Content -->
            <div id="trends-content" class="tab-content hidden bg-white/95 p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Revenue Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="trending-up" class="w-5 h-5 text-emerald-600"></i>
                            <span>Gelir Trend Analizi</span>
                        </h3>
                        <div class="chart-container" id="revenueTrendAnalysisChart"></div>
                    </div>
                    
                    <!-- Occupancy Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="calendar-range" class="w-5 h-5 text-blue-600"></i>
                            <span>Doluluk Trend Analizi</span>
                        </h3>
                        <div class="chart-container" id="occupancyTrendChart"></div>
                    </div>
                    
                    <!-- Seasonal Analysis -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="sun" class="w-5 h-5 text-orange-600"></i>
                            <span>Mevsimsel Analiz</span>
                        </h3>
                        <div class="chart-container" id="seasonalAnalysisChart"></div>
                    </div>
                    
                    <!-- Growth Analysis -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-purple-600"></i>
                            <span>Büyüme Analizi</span>
                        </h3>
                        <div class="chart-container" id="growthAnalysisChart"></div>
                    </div>
                </div>
                
                <!-- Forecast Section -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                        <i data-lucide="crystal-ball" class="w-5 h-5 text-indigo-600"></i>
                        <span>Tahminler ve Projeksiyonlar</span>
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-indigo-50 rounded-lg p-4">
                            <h4 class="font-medium text-indigo-900 mb-2">Sonraki Ay Tahmini</h4>
                            <p class="text-2xl font-bold text-indigo-600" id="nextMonthForecast">€0</p>
                            <p class="text-sm text-indigo-700 mt-1">Geçmiş verilere dayalı</p>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-4">
                            <h4 class="font-medium text-emerald-900 mb-2">3 Aylık Projeksiyon</h4>
                            <p class="text-2xl font-bold text-emerald-600" id="quarterForecast">€0</p>
                            <p class="text-sm text-emerald-700 mt-1">Trend analizi bazlı</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h4 class="font-medium text-purple-900 mb-2">Yıllık Hedef</h4>
                            <p class="text-2xl font-bold text-purple-600" id="yearlyTarget">€0</p>
                            <p class="text-sm text-purple-700 mt-1">Mevcut performansa göre</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Efficiency Tab Content -->
            <div id="efficiency-content" class="tab-content hidden bg-white/95 p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Cost Efficiency -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="coins" class="w-5 h-5 text-yellow-600"></i>
                            <span>Maliyet Verimliliği</span>
                        </h3>
                        <div class="chart-container" id="costEfficiencyChart"></div>
                    </div>
                    
                    <!-- System Efficiency -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="gauge" class="w-5 h-5 text-red-600"></i>
                            <span>Sistem Verimliliği</span>
                        </h3>
                        <div class="chart-container" id="systemEfficiencyChart"></div>
                    </div>
                </div>
                
                <!-- Efficiency Metrics Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="table" class="w-5 h-5 text-gray-600"></i>
                            <span>Detaylı Verimlilik Metrikleri</span>
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Daire</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gider/Gelir</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Kar Marjı</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">€/Gece</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Boş Gün Maliyeti</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verimlilik Skoru</th>
                                </tr>
                            </thead>
                            <tbody id="efficiencyMetricsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab Content -->
            <div id="reports-content" class="tab-content hidden bg-white/95 p-6">
                <!-- Report Type Selection -->
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Rapor Oluştur</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onclick="Analytics.generateReport('summary')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="file-text" class="w-8 h-8 text-emerald-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Özet Rapor</h4>
                            <p class="text-sm text-gray-600">Tek sayfalık yönetici özeti</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('detailed')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="file-bar-chart" class="w-8 h-8 text-blue-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Detaylı Rapor</h4>
                            <p class="text-sm text-gray-600">Kapsamlı analiz raporu</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('comparison')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="git-compare" class="w-8 h-8 text-purple-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Karşılaştırma Raporu</h4>
                            <p class="text-sm text-gray-600">Dönem/daire karşılaştırması</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('financial')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="wallet" class="w-8 h-8 text-green-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Finansal Rapor</h4>
                            <p class="text-sm text-gray-600">Gelir-gider detayları</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('performance')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="trending-up" class="w-8 h-8 text-orange-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Performans Raporu</h4>
                            <p class="text-sm text-gray-600">KPI ve metrik analizi</p>
                        </button>
                        
                        <button onclick="Analytics.generateReport('custom')" class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition group">
                            <i data-lucide="settings" class="w-8 h-8 text-gray-600 mb-3 group-hover:scale-110 transition"></i>
                            <h4 class="font-semibold text-gray-800 mb-1">Özel Rapor</h4>
                            <p class="text-sm text-gray-600">Kendi raporunuzu oluşturun</p>
                        </button>
                    </div>
                </div>
                
                <!-- Şirket Giderleri Yönetimi -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4 cursor-pointer" onclick="document.getElementById('companyExpSection').classList.toggle('hidden'); this.querySelector('svg:last-child')?.classList.toggle('rotate-180')">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="building" class="w-5 h-5 text-orange-600"></i>
                            <span>Şirket Giderleri (Lagirio)</span>
                        </h3>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-400" id="companyExpTotal">Toplam: €0</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transition-transform"></i>
                        </div>
                    </div>

                    <div id="companyExpSection" class="hidden">
                        <!-- Ekleme formu -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                <div>
                                    <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Tarih</label>
                                    <input type="date" id="compExpDate" class="w-full text-sm px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Kategori</label>
                                    <select id="compExpCategory" class="w-full text-sm px-3 py-2 border border-gray-200 rounded-lg">
                                        <option value="Ofis">Ofis Giderleri</option>
                                        <option value="Personel">Personel Giderleri</option>
                                        <option value="Yazilim">Yazılım/Teknoloji</option>
                                        <option value="Pazarlama">Pazarlama</option>
                                        <option value="Ulasim">Ulaşım</option>
                                        <option value="Vergi">Vergi/Harçlar</option>
                                        <option value="Sigorta">Sigorta</option>
                                        <option value="Diger">Diğer</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Açıklama</label>
                                    <input type="text" id="compExpDesc" placeholder="Gider açıklaması" class="w-full text-sm px-3 py-2 border border-gray-200 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Tutar</label>
                                    <div class="flex gap-1">
                                        <input type="number" id="compExpAmount" step="0.01" min="0" placeholder="0.00" class="flex-1 text-sm px-3 py-2 border border-gray-200 rounded-lg">
                                        <select id="compExpCurrency" class="text-sm px-2 py-2 border border-gray-200 rounded-lg w-20">
                                            <option value="EUR">EUR</option>
                                            <option value="TL">TL</option>
                                            <option value="USD">USD</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="Analytics.addCompanyExpense()" class="w-full text-sm font-semibold bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Ekle</button>
                                </div>
                            </div>
                        </div>

                        <!-- Liste -->
                        <div id="companyExpList" class="max-h-[250px] overflow-y-auto">
                            <p class="text-sm text-gray-400 text-center py-4">Henüz şirket gideri yok</p>
                        </div>
                    </div>
                </div>

                <!-- Report Preview Area -->
                <div id="reportPreview" class="hidden bg-white rounded-xl shadow-lg p-6">
                    <!-- Dynamic report content -->
                </div>
            </div>

            <!-- ===== PROJEKSIYON TAB ===== -->
            <div id="projection-content" class="tab-content hidden bg-white/95 p-6">

                <!-- PMS HTML Import Section (inside dashboard) -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="calendar-plus" class="w-5 h-5 text-purple-600"></i>
                            <span>Gelecek Rezervasyonları Yükle (PMS)</span>
                        </h3>
                        <span class="text-xs text-gray-400">Zirkon / PMS HTML dışa aktarma</span>
                    </div>

                    <div class="flex gap-4">
                        <!-- Drop zone -->
                        <div id="projHtmlUploadArea" class="flex-1 border-2 border-dashed border-purple-200 rounded-xl py-6 px-4 hover:border-purple-400 hover:bg-purple-50/30 transition-all cursor-pointer group text-center"
                             onclick="document.getElementById('projHtmlFileInput').click()">
                            <i data-lucide="file-code" class="w-8 h-8 text-purple-300 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="text-sm font-medium text-gray-600">HTML Dosya Sürükle / Seç</p>
                            <p class="text-xs text-gray-400">.html, .htm</p>
                        </div>
                        <input type="file" id="projHtmlFileInput" accept=".html,.htm" class="hidden" multiple onchange="Projection.handleHTMLFiles(event)">

                        <!-- Loaded files summary -->
                        <div class="w-72 bg-gray-50 rounded-xl p-4">
                            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Yüklenen Dosyalar</div>
                            <div id="projFilesList" class="space-y-1.5 max-h-24 overflow-y-auto">
                                <p class="text-xs text-gray-400">Henüz dosya yüklenmedi</p>
                            </div>
                            <div id="projResCounts" class="mt-2 pt-2 border-t border-gray-200 text-xs hidden">
                                <span class="text-emerald-600 font-semibold"><span id="projFutureCount">0</span> gelecek</span>
                                <span class="text-gray-300 mx-1">|</span>
                                <span class="text-gray-500"><span id="projPastCount">0</span> geçmiş</span>
                            </div>
                        </div>
                    </div>
                    <div id="projImportStatus" class="mt-3 hidden"></div>

                    <!-- Eşleştirme butonu -->
                    <div id="projMatchingBar" class="mt-3 hidden">
                        <div class="flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg px-4 py-2.5">
                            <div class="flex items-center gap-2">
                                <i data-lucide="link-2" class="w-4 h-4 text-amber-500"></i>
                                <span class="text-xs text-amber-700" id="projMatchingStatus">Eşleşmeyen daireler var</span>
                            </div>
                            <button onclick="Projection.showMatchingModal()" class="text-xs font-semibold bg-amber-500 text-white px-3 py-1.5 rounded-lg hover:bg-amber-600 transition">
                                Daire Eşleştir
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Karma Tahmin Ayarları -->
                <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                    <div class="flex items-center gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sliders" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-xs font-semibold text-gray-500 uppercase">Karma Tahmin</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">Veri olmayan aylar için ayarlama (%):</label>
                            <input type="number" id="projDefaultAdjust" value="0" step="1"
                                class="w-20 text-sm border border-gray-200 rounded-lg px-2 py-1.5 text-center focus:ring-2 focus:ring-purple-300 focus:border-purple-400"
                                onchange="Projection.calculate()">
                        </div>
                        <div class="flex items-center gap-3 ml-auto text-[10px] text-gray-400">
                            <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-sm bg-emerald-400"></span> Mevcut Rez.</span>
                            <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-sm bg-amber-400"></span> Geçmiş +5%</span>
                            <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-sm bg-blue-400"></span> Ortalama</span>
                            <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-sm bg-orange-400"></span> Zincir</span>
                            <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded-sm bg-red-300"></span> Veri Yok</span>
                        </div>
                    </div>
                </div>

                <!-- Projection Summary Cards -->
                <div id="projSummaryCards" class="hidden mb-6">
                    <!-- Top row: big cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-5 text-white">
                            <div class="text-sm opacity-80 mb-1">Tahmini Brüt Gelir</div>
                            <div class="text-2xl font-bold" id="projGrossRevenue">€0</div>
                            <div class="text-xs opacity-60 mt-1" id="projGrossDetail">Ort. gecelik × 25 gün/ay</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white">
                            <div class="text-sm opacity-80 mb-1">Lagirio Net Kazanç</div>
                            <div class="text-2xl font-bold" id="projLagirioNet">€0</div>
                            <div class="text-xs opacity-60 mt-1" id="projLagirioDetail">Sistem bazlı komisyon hesabı</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white">
                            <div class="text-sm opacity-80 mb-1">Ort. Gecelik Fiyat</div>
                            <div class="text-2xl font-bold" id="projAvgNightly">€0</div>
                            <div class="text-xs opacity-60 mt-1" id="projNightlyDetail">Gelecek rez. ortalaması</div>
                        </div>
                    </div>
                    <!-- Bottom row: kesintiler -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white border border-orange-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-semibold text-orange-500 uppercase">Tahmini Giderler</div>
                                    <div class="text-xl font-bold text-gray-800 mt-1" id="projExpenses">€0</div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400" id="projExpenseDetail">%0</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-red-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-semibold text-red-500 uppercase">Tahmini KDV</div>
                                    <div class="text-xl font-bold text-gray-800 mt-1" id="projKDV">€0</div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400" id="projKDVDetail">Sistem bazlı</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-indigo-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-semibold text-indigo-500 uppercase">Tahmini Platform Komisyonu</div>
                                    <div class="text-xl font-bold text-gray-800 mt-1" id="projPlatComm">€0</div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400" id="projPlatCommDetail">%0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Chart -->
                <div id="projMonthlySection" class="mb-6 hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 text-emerald-600"></i>
                            <span>Aylık Projeksiyon (Lagirio Kazancı)</span>
                        </h3>
                        <div class="chart-container" id="projMonthlyChart" style="height:280px"></div>
                    </div>

                    <!-- Monthly Overview Table -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="calendar-range" class="w-5 h-5 text-indigo-600"></i>
                            <span>Aylık Lagirio Kazanç Detayı</span>
                            <span class="text-xs text-gray-400 ml-2">(tüm daireler toplam)</span>
                        </h3>
                        <div id="projMonthlyOverview"></div>
                    </div>

                    <!-- Per-apartment accordion -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                            <i data-lucide="building-2" class="w-5 h-5 text-blue-600"></i>
                            <span>Daire Bazlı Tahmin</span>
                            <span class="text-xs text-gray-400 ml-2">(tıklayarak aylık detay görün)</span>
                        </h3>
                        <div id="projApartmentList" class="space-y-1">
                            <p class="text-sm text-gray-400">Veri bekleniyor...</p>
                        </div>
                    </div>
                </div>

                <!-- Detailed Future Reservations Table -->
                <div id="projResTableSection" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                            <i data-lucide="list" class="w-5 h-5 text-purple-600"></i>
                            <span>Gelecek Rezervasyonlar Listesi</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <select id="projPlatformFilter" onchange="Projection.renderTable()" class="text-xs px-3 py-1.5 border border-gray-200 rounded-lg">
                                <option value="all">Tüm Platformlar</option>
                            </select>
                            <button onclick="Projection.clearAll()" class="text-xs text-red-400 hover:text-red-600 px-2 py-1">Temizle</button>
                        </div>
                    </div>
                    <div id="projResTable" class="max-h-[400px] overflow-y-auto"></div>
                </div>

            </div>
        </div>
    </div>
    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span>Bildirimler</span>
                    </h2>
                    <button onclick="Analytics.closeModal('notificationModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="notificationList" class="space-y-3">
                    <!-- Dynamic notifications -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-gray-700 to-gray-800 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Ayarlar</span>
                    </h2>
                    <button onclick="Analytics.closeModal('settingsModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Display Settings -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Görüntüleme Ayarları</h3>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="darkMode" class="w-4 h-4 text-emerald-600 rounded">
                                <span class="text-gray-600">Karanlık Tema</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="animations" checked class="w-4 h-4 text-emerald-600 rounded">
                                <span class="text-gray-600">Animasyonları Etkinleştir</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="compactView" class="w-4 h-4 text-emerald-600 rounded">
                                <span class="text-gray-600">Kompakt Görünüm</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Data Settings -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Veri Ayarları</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Varsayılan Para Birimi</label>
                                <select id="defaultCurrency" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    <option value="EUR">EUR (€)</option>
                                    <option value="USD">USD ($)</option>
                                    <option value="TL">TL (₺)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Tarih Formatı</label>
                                <select id="dateFormat" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                                    <option value="DD/MM/YYYY">GG/AA/YYYY</option>
                                    <option value="MM/DD/YYYY">AA/GG/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-AA-GG</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Settings -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Uyarı Ayarları</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Düşük Doluluk Uyarısı (%)</label>
                                <input type="number" id="lowOccupancyThreshold" value="30" min="0" max="100" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Yüksek Gider Uyarısı (€)</label>
                                <input type="number" id="highExpenseThreshold" value="500" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Admin Giriş -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="shield" class="w-4 h-4 text-blue-500"></i>
                            Admin Girişi (Drive Yazma Yetkisi)
                        </h3>
                        <p class="text-xs text-gray-400 mb-2">Admin şifresi ile giriş yapıldığında eşleştirme Drive'a kaydedilebilir.</p>
                        <div class="flex gap-2">
                            <input type="password" id="adminPinInput" placeholder="Admin şifresi" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm">
                            <button onclick="Projection.adminLogin()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-medium">Giriş</button>
                            <button onclick="Projection.adminLogout()" class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition text-sm text-gray-500">Çıkış</button>
                        </div>
                        <p id="adminStatusText" class="text-xs text-gray-400 mt-1.5">Admin girişi yapılmadı</p>
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-[10px] text-gray-300 mb-1">Yeni admin şifresi belirle (sadece admin):</p>
                            <div class="flex gap-2">
                                <input type="password" id="newAdminPinInput" placeholder="Yeni şifre" class="flex-1 px-2 py-1.5 border border-gray-200 rounded-lg text-xs">
                                <button onclick="Projection.changeAdminPin()" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-xs">Değiştir</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="Analytics.closeModal('settingsModal')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        İptal
                    </button>
                    <button onclick="Analytics.saveSettings()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition">
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apartment Matching Modal -->
    <div id="aptMatchingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-5 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold flex items-center space-x-2">
                        <i data-lucide="link-2" class="w-5 h-5"></i>
                        <span>Daire Eşleştirme</span>
                    </h2>
                    <button onclick="Analytics.closeModal('aptMatchingModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-xs text-white/70 mt-1">PMS'deki oda numaralarını analiz dairelerine eşleştirin. Eşleşenler sistem tipi, KDV ve komisyon bilgilerini otomatik alır.</p>
            </div>
            <div class="p-5 max-h-[65vh] overflow-y-auto">
                <div id="aptMatchingContent" class="space-y-3">
                    <p class="text-sm text-gray-400">Yükleniyor...</p>
                </div>
            </div>
            <div class="border-t border-gray-100 px-5 py-3 flex items-center justify-between bg-gray-50">
                <span class="text-xs text-gray-400" id="aptMatchingSummary"></span>
                <div class="flex gap-2">
                    <button onclick="Analytics.closeModal('aptMatchingModal')" class="px-3 py-1.5 text-xs border border-gray-300 rounded-lg hover:bg-gray-100 transition">İptal</button>
                    <button onclick="Projection.saveMatching()" class="px-4 py-1.5 text-xs font-semibold bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition">Sadece Lokal Kaydet</button>
                    <button id="aptMatchDriveBtn" onclick="Projection.saveMatchingToDrive()" class="px-4 py-1.5 text-xs font-semibold bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition hidden">
                        <span class="flex items-center gap-1"><i data-lucide="cloud-upload" class="w-3 h-3"></i> Drive'a Kaydet</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Report Modal -->
    <div id="customReportModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i data-lucide="file-plus" class="w-5 h-5"></i>
                        <span>Özel Rapor Oluştur</span>
                    </h2>
                    <button onclick="Analytics.closeModal('customReportModal')" class="p-1 hover:bg-white/20 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="space-y-6">
                    <!-- Report Sections Selection -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Rapor Bölümleri</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="summary" checked class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Özet</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="revenue" checked class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Gelir Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="expenses" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Gider Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="occupancy" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Doluluk Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="systems" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Sistem Karşılaştırması</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="platforms" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Platform Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="trends" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Trend Analizi</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="forecast" class="report-section w-4 h-4 text-purple-600 rounded">
                                <span class="text-sm">Tahminler</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Apartment Selection -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Daire Seçimi</h3>
                        <select id="reportApartments" class="w-full px-3 py-2 border border-gray-200 rounded-lg" multiple size="5">
                            <!-- Dynamic options -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd tuşuna basılı tutarak birden fazla seçim yapabilirsiniz</p>
                    </div>
                    
                    <!-- Date Range -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Tarih Aralığı</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Başlangıç</label>
                                <input type="date" id="reportStartDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Bitiş</label>
                                <input type="date" id="reportEndDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="Analytics.closeModal('customReportModal')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        İptal
                    </button>
                    <button onclick="Analytics.generateCustomReport()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition flex items-center space-x-2">
                        <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                        <span>Rapor Oluştur</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <div class="fixed bottom-6 right-6 z-40">
        <button onclick="Analytics.toggleQuickActions()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>
        
        <!-- Quick Actions Menu -->
        <div id="quickActionsMenu" class="absolute bottom-16 right-0 bg-white rounded-lg shadow-xl p-2 min-w-[200px] hidden animate-slide-up">
            <button onclick="Analytics.quickExport()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="download" class="w-4 h-4 text-gray-600"></i>
                <span>Hızlı Export</span>
            </button>
            <button onclick="Analytics.quickCompare()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="git-compare" class="w-4 h-4 text-gray-600"></i>
                <span>Hızlı Karşılaştırma</span>
            </button>
            <button onclick="Analytics.quickReport()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="file-text" class="w-4 h-4 text-gray-600"></i>
                <span>Hızlı Rapor</span>
            </button>
            <button onclick="Analytics.toggleFullscreen()" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg flex items-center space-x-2">
                <i data-lucide="maximize" class="w-4 h-4 text-gray-600"></i>
                <span>Tam Ekran</span>
            </button>
        </div>
    </div>
    
    </div><!-- /app-wrapper -->

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-6 left-6 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-10 shadow-[0_32px_64px_rgba(0,0,0,0.2)] text-center">
            <div class="loader mx-auto mb-5"></div>
            <p class="text-gray-600 font-medium">İşleniyor...</p>
            <div class="mt-3 flex justify-center gap-1">
                <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0s;"></span>
                <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0.15s;"></span>
                <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce" style="animation-delay: 0.3s;"></span>
            </div>
        </div>
    </div>
    
    <script>
    // Initialize Lucide icons
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

    // ============================================================
    // AUTH MODULE - Kullanıcı Kimlik Doğrulama
    // ============================================================
    const Auth = {
        currentUser: null,
        STORAGE_KEY: 'lagirioAnalytics_auth',

        users: [
            { username: 'admin', password: 'lagirio2025', role: 'admin' },
            { username: 'viewer', password: 'view2025', role: 'viewer' }
        ],

        login() {
            const username = document.getElementById('loginUser').value.trim();
            const password = document.getElementById('loginPass').value.trim();
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'Lütfen kullanıcı adı ve şifre girin';
                errorEl.style.display = 'block';
                return;
            }

            const user = this.users.find(u => u.username === username && u.password === password);
            if (!user) {
                errorEl.textContent = 'Geçersiz kullanıcı adı veya şifre';
                errorEl.style.display = 'block';
                document.getElementById('loginPass').value = '';
                return;
            }

            this.currentUser = { username: user.username, role: user.role };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.currentUser));
            errorEl.style.display = 'none';
            this.showApp();
        },

        logout() {
            this.currentUser = null;
            localStorage.removeItem(this.STORAGE_KEY);
            document.getElementById('appWrapper').classList.remove('active');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            document.getElementById('loginError').style.display = 'none';
        },

        checkSession() {
            try {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (saved) {
                    const session = JSON.parse(saved);
                    const valid = this.users.find(u => u.username === session.username);
                    if (valid) {
                        this.currentUser = session;
                        return true;
                    }
                }
            } catch(e) {}
            return false;
        },

        showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appWrapper').classList.add('active');
            lucide.createIcons();
            Analytics.init();

            // Google Drive: UI'ı güncelle ve otomatik bağlanmayı dene
            GoogleDrive.updateUI();
            // Google API yüklenmesini bekleyip otomatik bağlan
            const tryAuto = () => {
                if (typeof google !== 'undefined' && google.accounts) {
                    GoogleDrive.tryAutoConnect();
                } else {
                    // API henüz yüklenmediyse kısa süre sonra tekrar dene
                    setTimeout(tryAuto, 500);
                }
            };
            setTimeout(tryAuto, 300);
        }
    };

    // ============================================================
    // UPLOAD UI - Tab Switching
    // ============================================================
    const UploadUI = {
        switchTab(tab) {
            document.querySelectorAll('.upload-tab').forEach(t => {
                t.classList.remove('active');
                t.className = t.className.replace(/bg-emerald-600 text-white shadow-lg/g, 'bg-white text-gray-600 border border-gray-200');
            });
            document.querySelectorAll('.upload-panel').forEach(p => p.classList.add('hidden'));

            const btn = document.getElementById('uploadTab-' + tab);
            if (btn) {
                btn.classList.add('active');
            }
            const panel = document.getElementById('uploadPanel-' + tab);
            if (panel) {
                panel.classList.remove('hidden');
                panel.style.animation = 'fadeIn 0.3s ease-out';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    };

    // ============================================================
    // GOOGLE DRIVE - Otomatik Bağlantı & Veri Senkronizasyonu
    // ============================================================
    const GoogleDrive = {
        STORAGE_KEY: 'lagirioDriveConfig',
        accessToken: null,
        tokenClient: null,
        userEmail: null,

        // ---- Config Management ----
        getConfig() {
            try {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch(e) { return {}; }
        },

        saveConfig() {
            const clientEl = document.getElementById('driveClientId');
            const autoEl = document.getElementById('driveAutoLoad');
            const config = this.getConfig();
            if (clientEl && clientEl.value) config.clientId = clientEl.value.trim();
            if (autoEl) config.autoLoad = autoEl.checked;
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
        },

        saveFileLink(fileId, fileName) {
            const config = this.getConfig();
            config.fileId = fileId;
            config.fileName = fileName || 'lagirio-analiz-data.json';
            config.linkedAt = new Date().toISOString();
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
        },

        // ---- UI Helpers ----
        showMessage(text, type) {
            const el = document.getElementById('driveMessage');
            if (!el) return;
            el.innerHTML = text;
            el.className = 'text-center text-sm mt-4 font-medium ' +
                (type === 'error' ? 'text-red-600' : type === 'success' ? 'text-emerald-600' : 'text-blue-600');
            el.classList.remove('hidden');
        },

        hideMessage() {
            const el = document.getElementById('driveMessage');
            if (el) el.classList.add('hidden');
        },

        setStep(step) {
            for (let i = 1; i <= 3; i++) {
                const el = document.getElementById('driveStep' + i);
                if (!el) continue;
                const numEl = el.querySelector('span');
                if (i < step) {
                    el.className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-100 text-emerald-700';
                    if (numEl) { numEl.className = 'w-5 h-5 rounded-full bg-emerald-600 text-white flex items-center justify-center text-[10px]'; numEl.textContent = '\u2713'; }
                } else if (i === step) {
                    el.className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-100 text-blue-700';
                    if (numEl) { numEl.className = 'w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px]'; numEl.textContent = i; }
                } else {
                    el.className = 'flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-gray-400';
                    if (numEl) { numEl.className = 'w-5 h-5 rounded-full bg-gray-300 text-white flex items-center justify-center text-[10px]'; numEl.textContent = i; }
                }
            }
        },

        showStatus(html) {
            const el = document.getElementById('driveStatus');
            if (el) el.innerHTML = html;
        },

        updateUI() {
            const config = this.getConfig();
            const hasClientId = !!config.clientId;
            const isConnected = !!this.accessToken;
            const hasFile = !!config.fileId;

            // Fill inputs
            const clientEl = document.getElementById('driveClientId');
            const autoEl = document.getElementById('driveAutoLoad');
            if (clientEl && config.clientId) clientEl.value = config.clientId;
            if (autoEl) autoEl.checked = config.autoLoad !== false;

            // Phase 1: Client ID
            const p1 = document.getElementById('drivePhase1');
            if (p1) p1.style.display = hasClientId && isConnected ? 'none' : '';

            // Phase 2: Connect button
            const p2 = document.getElementById('drivePhase2');
            if (p2) p2.style.display = isConnected ? 'none' : '';

            // Phase 3: File selection/linked
            const p3 = document.getElementById('drivePhase3');
            if (p3) p3.classList.toggle('hidden', !isConnected);

            const linkedEl = document.getElementById('driveLinkedFile');
            const selectEl = document.getElementById('driveFileSelect');
            if (hasFile && isConnected) {
                if (linkedEl) { linkedEl.classList.remove('hidden'); }
                if (selectEl) selectEl.classList.add('hidden');
                const nameEl = document.getElementById('driveFileName');
                const infoEl = document.getElementById('driveFileInfo');
                if (nameEl) nameEl.textContent = config.fileName || 'lagirio-analiz-data.json';
                if (infoEl) infoEl.textContent = 'ID: ' + config.fileId.substring(0, 16) + '...' + (config.linkedAt ? ' | Bağlantı: ' + new Date(config.linkedAt).toLocaleDateString('tr-TR') : '');
            } else if (isConnected) {
                if (linkedEl) linkedEl.classList.add('hidden');
                if (selectEl) selectEl.classList.remove('hidden');
            }

            // Actions
            const actionsEl = document.getElementById('driveActions');
            if (actionsEl) actionsEl.classList.toggle('hidden', !(isConnected && hasFile));

            // User info
            const userEl = document.getElementById('driveUserInfo');
            if (userEl && this.userEmail) {
                userEl.classList.remove('hidden');
                document.getElementById('driveUserEmail').textContent = this.userEmail;
            }

            // Steps
            if (!hasClientId) this.setStep(1);
            else if (!isConnected) this.setStep(2);
            else if (!hasFile) this.setStep(3);
            else { this.setStep(4); /* all done */ }

            // Status banner
            if (isConnected && hasFile) {
                this.showStatus('<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 flex items-center gap-2 text-sm text-emerald-700"><i data-lucide="check-circle-2" class="w-4 h-4 flex-shrink-0"></i> Drive bağlantısı aktif. Veriler otomatik bu dosyadan yüklenir.</div>');
            } else if (isConnected) {
                this.showStatus('<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-2 text-sm text-blue-700"><i data-lucide="info" class="w-4 h-4 flex-shrink-0"></i> Bağlantı kuruldu! Bir dosya seçin veya yeni oluşturun.</div>');
            } else if (hasClientId) {
                this.showStatus('<div class="bg-amber-50 border border-amber-200 rounded-xl p-3 flex items-center gap-2 text-sm text-amber-700"><i data-lucide="info" class="w-4 h-4 flex-shrink-0"></i> Client ID kayıtlı. Google ile giriş yaparak bağlanın.</div>');
            } else {
                this.showStatus('<div class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm text-gray-600"><p class="font-semibold mb-1">Nasıl Kurulur?</p><ol class="list-decimal list-inside text-xs space-y-1 text-gray-500"><li><a href="https://console.cloud.google.com" target="_blank" class="text-blue-500 underline">Google Cloud Console</a>\'a gidin</li><li>APIs &amp; Services &gt; Credentials &gt; Create OAuth Client ID</li><li>Application type: <b>Web application</b></li><li>Authorized JavaScript origins: sitenizin URL\'ini ekleyin</li><li>Oluşan Client ID\'yi yukarıya yapıştırın</li></ol></div>');
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        // ---- Core Actions ----
        connect() {
            const clientEl = document.getElementById('driveClientId');
            const clientId = clientEl?.value?.trim() || this.getConfig().clientId;
            if (!clientId) {
                this.showMessage('Lütfen Google Client ID girin!', 'error');
                return;
            }

            // Save clientId
            const config = this.getConfig();
            config.clientId = clientId;
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));

            try {
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        if (response.error) {
                            this.showMessage('Bağlantı hatası: ' + response.error, 'error');
                            return;
                        }
                        this.accessToken = response.access_token;

                        // Fetch user email
                        try {
                            const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': 'Bearer ' + this.accessToken }
                            });
                            if (r.ok) {
                                const info = await r.json();
                                this.userEmail = info.email;
                            }
                        } catch(e) {}

                        this.hideMessage();
                        this.updateUI();

                        // If already linked to a file and autoLoad is on, load automatically
                        const cfg = this.getConfig();
                        if (cfg.fileId && cfg.autoLoad !== false) {
                            this.loadFromDrive(true);
                        }
                    }
                });
                this.tokenClient.requestAccessToken();
            } catch(e) {
                this.showMessage('Google API yüklenemedi. Sayfayı yenileyin ve tekrar deneyin.', 'error');
            }
        },

        // Auto-connect on page load (silent - uses prompt: 'none')
        tryAutoConnect() {
            const config = this.getConfig();
            if (!config.clientId || !config.fileId) return;

            // Show a loading hint on the drive panel
            this.showStatus('<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-2 text-sm text-blue-700"><i data-lucide="loader" class="w-4 h-4 animate-spin flex-shrink-0"></i> Otomatik bağlanılıyor...</div>');

            try {
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: config.clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        if (response.error) {
                            this.updateUI();
                            return;
                        }
                        this.accessToken = response.access_token;

                        try {
                            const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': 'Bearer ' + this.accessToken }
                            });
                            if (r.ok) this.userEmail = (await r.json()).email;
                        } catch(e) {}

                        this.updateUI();

                        // Auto-load if enabled
                        if (config.autoLoad !== false) {
                            this.loadFromDrive(true);
                        }
                    }
                });
                // Try silent first, falls back to prompt
                this.tokenClient.requestAccessToken({ prompt: '' });
            } catch(e) {
                this.updateUI();
            }
        },

        async createNewFile() {
            if (!this.accessToken) return;
            this.showMessage('Yeni dosya oluşturuluyor...', 'info');

            const initialData = Analytics.data || { apartments: [], reservations: [], expenses: [], categories: [], capitalExpenses: [] };
            const metadata = { name: 'lagirio-analiz-data.json', mimeType: 'application/json' };
            const boundary = '-------314159265358979323846';
            const body = '--' + boundary + '\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) + '\r\n--' + boundary + '\r\nContent-Type: application/json\r\n\r\n' +
                JSON.stringify(initialData, null, 2) + '\r\n--' + boundary + '--';

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + this.accessToken,
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body
                });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const result = await response.json();

                this.saveFileLink(result.id, result.name);
                this.showMessage('Dosya oluşturuldu ve bağlandı!', 'success');
                this.updateUI();
            } catch(e) {
                this.showMessage('Dosya oluşturma hatası: ' + e.message, 'error');
            }
        },

        async linkExistingFile() {
            if (!this.accessToken) return;
            const fileId = document.getElementById('driveFileId')?.value?.trim();
            if (!fileId) {
                this.showMessage('Lütfen bir dosya ID girin!', 'error');
                return;
            }

            this.showMessage('Dosya kontrol ediliyor...', 'info');
            try {
                const r = await fetch('https://www.googleapis.com/drive/v3/files/' + fileId + '?fields=id,name,modifiedTime', {
                    headers: { 'Authorization': 'Bearer ' + this.accessToken }
                });
                if (!r.ok) throw new Error('Dosya bulunamadı (HTTP ' + r.status + ')');
                const info = await r.json();
                this.saveFileLink(info.id, info.name);
                this.showMessage('Dosya bağlandı: ' + info.name, 'success');
                this.updateUI();
            } catch(e) {
                this.showMessage('Hata: ' + e.message, 'error');
            }
        },

        unlinkFile() {
            if (!confirm('Dosya bağlantısını kesmek istediğinizden emin misiniz? (Drive\'daki dosya silinmez)')) return;
            const config = this.getConfig();
            delete config.fileId;
            delete config.fileName;
            delete config.linkedAt;
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
            this.updateUI();
        },

        async saveToDrive() {
            if (!this.accessToken) { this.showMessage('Önce Google ile bağlanın!', 'error'); return; }
            if (!Analytics.data) { this.showMessage('Kaydedilecek veri yok. Önce veri yükleyin.', 'error'); return; }

            const config = this.getConfig();
            if (!config.fileId) { this.showMessage('Önce bir dosya bağlayın!', 'error'); return; }

            this.showMessage('<i data-lucide="loader" class="w-3 h-3 inline animate-spin"></i> Drive\'a kaydediliyor...', 'info');

            try {
                const fileContent = JSON.stringify(Analytics.data, null, 2);
                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files/' + config.fileId + '?uploadType=media',
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + this.accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    }
                );
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const now = new Date().toLocaleTimeString('tr-TR');
                this.showMessage('Drive\'a kaydedildi! (Son: ' + now + ')', 'success');
                if (typeof Analytics.showToast === 'function') Analytics.showToast('Drive\'a kaydedildi!', 'success');
            } catch(e) {
                this.showMessage('Kaydetme hatası: ' + e.message, 'error');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        async loadFromDrive(silent) {
            if (!this.accessToken) {
                if (!silent) this.showMessage('Önce Google ile bağlanın!', 'error');
                return;
            }

            const config = this.getConfig();
            if (!config.fileId) {
                if (!silent) this.showMessage('Önce bir dosya bağlayın!', 'error');
                return;
            }

            if (!silent) this.showMessage('<i data-lucide="loader" class="w-3 h-3 inline animate-spin"></i> Drive\'dan çekiliyor...', 'info');

            try {
                const response = await fetch(
                    'https://www.googleapis.com/drive/v3/files/' + config.fileId + '?alt=media',
                    { headers: { 'Authorization': 'Bearer ' + this.accessToken } }
                );
                if (!response.ok) throw new Error('HTTP ' + response.status);

                const data = await response.json();
                Analytics.data = data;
                Analytics.validateData();
                Analytics.filteredData = data;
                Analytics.processData();

                // Drive'dan gelen mapping'i localStorage'a da sync et
                if (data.aptMapping && Object.keys(data.aptMapping).length > 0) {
                    localStorage.setItem('projAptMapping', JSON.stringify(data.aptMapping));
                    // Projeksiyon varsa eşleştirme durumunu güncelle
                    if (typeof Projection !== 'undefined') {
                        Projection.checkMatchingStatus();
                    }
                }

                const now = new Date().toLocaleTimeString('tr-TR');
                this.showMessage('Drive\'dan yüklendi! (' + now + ')', 'success');
                if (typeof Analytics.showToast === 'function') Analytics.showToast('Drive\'dan veri yüklendi!', 'success');
            } catch(e) {
                if (!silent) this.showMessage('Yükleme hatası: ' + e.message, 'error');
                console.error('Drive load error:', e);
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    };

    // ============================================================
    // HTML RESERVATIONS - PMS HTML Import
    // ============================================================
    const HTMLReservations = {
        reservations: [],
        uploadedFiles: [],
        currentTab: 'future',

        init() {
            const saved = localStorage.getItem('pmsReservations');
            if (saved) {
                try { this.reservations = JSON.parse(saved); } catch(e) {}
            }
            const savedFiles = localStorage.getItem('pmsUploadedFiles');
            if (savedFiles) {
                try { this.uploadedFiles = JSON.parse(savedFiles); } catch(e) {}
            }
            this.renderUI();

            // Drag & drop
            const area = document.getElementById('htmlUploadArea');
            if (area) {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('border-purple-500', 'bg-purple-50/50');
                });
                area.addEventListener('dragleave', () => {
                    area.classList.remove('border-purple-500', 'bg-purple-50/50');
                });
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('border-purple-500', 'bg-purple-50/50');
                    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.html') || f.name.endsWith('.htm'));
                    if (files.length > 0) this.processFiles(files);
                });
            }
        },

        handleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) this.processFiles(files);
            event.target.value = '';
        },

        async processFiles(files) {
            const statusEl = document.getElementById('htmlImportStatus');
            statusEl.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-sm text-blue-700 flex items-center gap-2"><i data-lucide="loader" class="w-4 h-4 animate-spin"></i> İşleniyor...</div>';
            statusEl.classList.remove('hidden');

            let totalAdded = 0;
            let totalSkipped = 0;

            for (const file of files) {
                try {
                    const htmlContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });

                    const { reservations: parsed, skipped } = this.parseHTML(htmlContent);

                    // Remove old reservations from same file
                    this.reservations = this.reservations.filter(r => r.sourceFile !== file.name);
                    this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== file.name);

                    // Add new
                    const withSource = parsed.map(r => ({ ...r, sourceFile: file.name }));
                    this.reservations.push(...withSource);
                    this.uploadedFiles.push({
                        name: file.name,
                        uploadDate: new Date().toISOString(),
                        count: parsed.length,
                        skipped
                    });

                    totalAdded += parsed.length;
                    totalSkipped += skipped.noApartment + skipped.noPrice + skipped.invalidDate;
                } catch(e) {
                    console.error('HTML parse error:', e);
                }
            }

            this.save();
            this.renderUI();

            const msg = totalAdded > 0
                ? `<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 text-sm text-emerald-700">✅ ${totalAdded} rezervasyon yüklendi!${totalSkipped > 0 ? ' (' + totalSkipped + ' atlanan)' : ''}</div>`
                : `<div class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-700">⚠️ Geçerli rezervasyon bulunamadı. (${totalSkipped} satır atlandı)</div>`;
            statusEl.innerHTML = msg;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        parseHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const rows = doc.querySelectorAll('tr');
            const reservationsList = [];
            const skipped = { noPrice: 0, noApartment: 0, invalidDate: 0 };

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                let m = dateStr.match(/(\d{2})\.(\d{2})\.(\d{4})\s*(\d{2})?:?(\d{2})?/);
                if (m) return new Date(+m[3], +m[2]-1, +m[1], +(m[4]||12), +(m[5]||0));
                m = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (m) return new Date(+m[1], +m[2]-1, +m[3], 12, 0);
                m = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (m) return new Date(+m[3], +m[2]-1, +m[1], 12, 0);
                const d = new Date(dateStr);
                return isNaN(d.getTime()) ? null : d;
            };

            const parsePrice = (s) => {
                if (!s) return 0;
                s = s.replace(/[\u2800\u200B-\u200D\uFEFF\u00A0\u2000-\u200A\u202F\u205F\u3000]/g, ' ').trim();
                s = s.replace(/[€$£₺]/g, '').trim();
                const parts = s.split(/\s+/);
                const numStr = parts.find(p => /^\d/.test(p)) || '';
                const cleaned = numStr.replace(/[^\d.,-]/g, '');
                if (!cleaned) return 0;
                const lastDot = cleaned.lastIndexOf('.');
                const lastComma = cleaned.lastIndexOf(',');
                // Her iki ayraç da var: son ayraç = ondalık, öncekiler binlik (380.049,32 → 380.32)
                if (lastDot >= 0 && lastComma >= 0) {
                    if (lastComma > lastDot) return parseFloat(cleaned.replace(/\./g, '').replace(',', '.')) || 0;
                    if (lastDot > lastComma) return parseFloat(cleaned.replace(/,/g, '')) || 0;
                }
                // Tek ayraç: ondalık (380,32 → 380.32 veya 380.32 → 380.32)
                if (lastComma >= 0 && lastDot < 0) return parseFloat(cleaned.replace(',', '.')) || 0;
                if (lastDot >= 0 && lastComma < 0) return parseFloat(cleaned) || 0;
                return parseFloat(cleaned) || 0;
            };

            const convertToEUR = (amount, currency) => {
                const c = (currency || 'EUR').toUpperCase();
                if (c === 'EUR') return amount;
                if (c === 'TRY' || c === 'TL') return amount / 37.5;
                if (c === 'USD' || c === '$') return amount * 0.92;
                if (c === 'GBP' || c === '\u00a3') return amount * 1.17;
                return amount;
            };

            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return;

                let roomNo, agency, guestName, checkInStr, checkOutStr, adults, children, currency, totalPrice;

                if (cells.length >= 10) {
                    roomNo = cells[1]?.textContent?.trim();
                    agency = cells[2]?.textContent?.trim();
                    guestName = cells[3]?.textContent?.trim();
                    checkInStr = cells[4]?.textContent?.trim();
                    checkOutStr = cells[5]?.textContent?.trim();
                    adults = parseInt(cells[6]?.textContent?.trim()) || 0;
                    children = parseInt(cells[7]?.textContent?.trim()) || 0;
                    currency = cells[8]?.textContent?.trim() || 'EUR';
                    totalPrice = parsePrice(cells[9]?.textContent?.trim());
                } else {
                    roomNo = cells[1]?.textContent?.trim();
                    agency = cells[2]?.textContent?.trim();
                    guestName = cells[3]?.textContent?.trim();
                    checkInStr = cells[4]?.textContent?.trim();
                    checkOutStr = cells[5]?.textContent?.trim();
                    adults = parseInt(cells[6]?.textContent?.trim()) || 0;
                    children = parseInt(cells[7]?.textContent?.trim()) || 0;
                    currency = 'EUR';
                    totalPrice = 0;
                }

                if (!roomNo || !checkInStr || !agency) return;
                if (totalPrice <= 0) { skipped.noPrice++; return; }

                const checkIn = parseDate(checkInStr);
                const checkOut = parseDate(checkOutStr);
                if (!checkIn || !checkOut) { skipped.invalidDate++; return; }

                const nights = Math.max(1, Math.ceil((checkOut - checkIn) / 86400000));
                const priceInEUR = convertToEUR(totalPrice, currency);

                let platform = (agency || '').toUpperCase();
                if (platform.includes('AIRBNB')) platform = 'Airbnb';
                else if (platform.includes('BOOKING')) platform = 'Booking.com';
                else if (platform.includes('WALKIN') || platform.includes('WALK')) platform = 'Direkt';
                else if (platform.includes('ONLINE')) platform = 'Online';
                else platform = agency;

                reservationsList.push({
                    id: 'pms-' + Date.now() + '-' + index,
                    apartmentId: roomNo,
                    platform,
                    guestName: guestName || '',
                    checkIn: checkIn.toISOString(),
                    checkOut: checkOut.toISOString(),
                    nights,
                    adults,
                    children,
                    currency: 'EUR',
                    originalCurrency: currency,
                    originalPrice: totalPrice,
                    totalPrice: Math.round(priceInEUR * 100) / 100,
                    pricePerNight: Math.round((priceInEUR / nights) * 100) / 100
                });
            });

            return { reservations: reservationsList, skipped };
        },

        save() {
            localStorage.setItem('pmsReservations', JSON.stringify(this.reservations));
            localStorage.setItem('pmsUploadedFiles', JSON.stringify(this.uploadedFiles));
        },

        switchTab(tab) {
            this.currentTab = tab;
            document.getElementById('resTab-future').className = tab === 'future'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-emerald-600 text-white transition-all'
                : 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-white text-gray-600 border border-gray-200 transition-all';
            document.getElementById('resTab-past').className = tab === 'past'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-emerald-600 text-white transition-all'
                : 'flex-1 py-2.5 rounded-xl text-sm font-semibold bg-white text-gray-600 border border-gray-200 transition-all';
            this.renderReservationList();
        },

        renderUI() {
            // Files list
            const filesEl = document.getElementById('htmlFilesList');
            const filesContent = document.getElementById('htmlFilesListContent');
            if (this.uploadedFiles.length > 0 && filesEl && filesContent) {
                filesEl.classList.remove('hidden');
                filesContent.innerHTML = this.uploadedFiles.map(f => `
                    <div class="flex items-center justify-between bg-white rounded-lg px-3 py-2 text-sm border border-gray-100">
                        <div class="flex items-center gap-2">
                            <span class="text-purple-500">📄</span>
                            <span class="font-medium">${f.name}</span>
                            <span class="text-xs text-gray-400">${f.count} rez.</span>
                        </div>
                        <button onclick="HTMLReservations.removeFile('${f.name}')" class="text-red-400 hover:text-red-600 text-xs">✕</button>
                    </div>
                `).join('');
            } else if (filesEl) {
                filesEl.classList.add('hidden');
            }

            // Stats & list
            const statsEl = document.getElementById('htmlResStats');
            const mergeEl = document.getElementById('htmlMergeSection');
            if (this.reservations.length > 0) {
                if (statsEl) statsEl.classList.remove('hidden');
                if (mergeEl) mergeEl.classList.remove('hidden');

                const today = new Date(); today.setHours(0,0,0,0);
                const future = this.reservations.filter(r => new Date(r.checkIn) >= today);
                const past = this.reservations.filter(r => new Date(r.checkIn) < today);
                document.getElementById('resFutureCount').textContent = '(' + future.length + ')';
                document.getElementById('resPastCount').textContent = '(' + past.length + ')';
                this.renderReservationList();
            } else {
                if (statsEl) statsEl.classList.add('hidden');
                if (mergeEl) mergeEl.classList.add('hidden');
            }
        },

        renderReservationList() {
            const el = document.getElementById('htmlResList');
            if (!el) return;
            const today = new Date(); today.setHours(0,0,0,0);

            const filtered = this.reservations.filter(r => {
                const d = new Date(r.checkIn); d.setHours(0,0,0,0);
                return this.currentTab === 'future' ? d >= today : d < today;
            }).sort((a, b) => {
                const da = new Date(a.checkIn), db = new Date(b.checkIn);
                return this.currentTab === 'future' ? da - db : db - da;
            });

            if (filtered.length === 0) {
                el.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">Rezervasyon bulunamadı</div>';
                return;
            }

            // Group by month
            const groups = {};
            filtered.forEach(r => {
                const d = new Date(r.checkIn);
                const key = d.getFullYear() + '-' + (d.getMonth()+1);
                const monthNames = ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'];
                if (!groups[key]) groups[key] = { label: monthNames[d.getMonth()] + ' ' + d.getFullYear(), items: [], total: 0, nights: 0 };
                groups[key].items.push(r);
                groups[key].total += r.totalPrice || 0;
                groups[key].nights += r.nights || 0;
            });

            el.innerHTML = Object.entries(groups).map(([key, g]) => `
                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-100">
                        <span class="font-semibold text-sm text-gray-700">📅 ${g.label}</span>
                        <div class="flex gap-3 text-xs text-gray-500">
                            <span>${g.items.length} rez.</span>
                            <span>${g.nights} gece</span>
                            <span class="font-semibold text-emerald-600">€${g.total.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-50">
                        ${g.items.map(r => {
                            const ci = new Date(r.checkIn);
                            const co = new Date(r.checkOut);
                            const fmt = d => d.getDate() + '.' + (d.getMonth()+1) + '.' + d.getFullYear();
                            return `<div class="flex items-center justify-between px-4 py-2.5 text-xs hover:bg-gray-50/50">
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-0.5 rounded-full text-[10px] font-bold" style="background:${r.platform==='Airbnb'?'#fff0f0':r.platform==='Booking.com'?'#e8f0ff':'#f0fff0'};color:${r.platform==='Airbnb'?'#FF5A5F':r.platform==='Booking.com'?'#003580':'#16a34a'}">${r.platform}</span>
                                    <span class="font-medium text-gray-700">${r.apartmentId}</span>
                                    <span class="text-gray-400">${r.guestName || '-'}</span>
                                </div>
                                <div class="flex items-center gap-3 text-gray-500">
                                    <span>${fmt(ci)} → ${fmt(co)}</span>
                                    <span>${r.nights}g</span>
                                    <span class="font-bold text-gray-700">€${(r.totalPrice || 0).toFixed(2)}</span>
                                    <span class="text-gray-400">€${(r.pricePerNight || 0).toFixed(2)}/g</span>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        },

        removeFile(fileName) {
            if (!confirm('"' + fileName + '" dosyasını ve rezervasyonlarını silmek istediğinizden emin misiniz?')) return;
            this.reservations = this.reservations.filter(r => r.sourceFile !== fileName);
            this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== fileName);
            this.save();
            this.renderUI();
        },

        mergeToAnalytics() {
            if (this.reservations.length === 0) return;

            // Convert PMS reservations to Analytics format
            const converted = this.reservations.map(r => ({
                id: r.id,
                apartmentId: r.apartmentId,
                guestName: r.guestName,
                checkIn: r.checkIn.split('T')[0],
                checkOut: r.checkOut.split('T')[0],
                platform: r.platform,
                totalAmount: r.totalPrice,
                platformCommission: r.platform === 'Direkt' ? 0 : r.totalPrice * 0.15,
                paymentMethod: 'Banka',
                currency: 'EUR'
            }));

            if (!Analytics.data) {
                // Create minimal data structure
                Analytics.data = {
                    apartments: [],
                    reservations: converted,
                    expenses: [],
                    categories: ['Temizlik', 'Elektrik', 'Su', 'İnternet', 'Yönetim', 'Bakım'],
                    capitalExpenses: [],
                    lagirioExpenses: []
                };

                // Auto-create apartments from reservation apartmentIds
                const aptIds = [...new Set(converted.map(r => r.apartmentId))];
                Analytics.data.apartments = aptIds.map(id => ({
                    id, code: id, location: '', ownerName: '',
                    systemType: '3', lagirioCommission: 15, taxRate: 8,
                    incomeTaxRate: 0, stopajRate: 0
                }));
            } else {
                // Merge: add new reservations, avoid duplicates by ID
                const existingIds = new Set(Analytics.data.reservations.map(r => r.id));
                const newOnes = converted.filter(r => !existingIds.has(r.id));
                Analytics.data.reservations = [...Analytics.data.reservations, ...newOnes];

                // Auto-create missing apartments
                const existingAptIds = new Set(Analytics.data.apartments.map(a => a.id));
                const newAptIds = [...new Set(newOnes.map(r => r.apartmentId))].filter(id => !existingAptIds.has(id));
                for (const id of newAptIds) {
                    Analytics.data.apartments.push({
                        id, code: id, location: '', ownerName: '',
                        systemType: '3', lagirioCommission: 15, taxRate: 8,
                        incomeTaxRate: 0, stopajRate: 0
                    });
                }
            }

            Analytics.filteredData = Analytics.data;
            Analytics.processData();
            if (typeof Analytics.showToast === 'function') {
                Analytics.showToast(converted.length + ' rezervasyon analize aktarıldı!', 'success');
            }
        }
    };

    // ============================================================
    // PROJECTION - Gelecek Rezervasyon Projeksiyonu & Lagirio Kazancı
    // ============================================================
    const Projection = {
        STORAGE_KEY: 'projReservations',
        FILES_KEY: 'projUploadedFiles',
        reservations: [],
        uploadedFiles: [],

        init() {
            try {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (saved) this.reservations = JSON.parse(saved);
            } catch(e) {}
            try {
                const saved = localStorage.getItem(this.FILES_KEY);
                if (saved) this.uploadedFiles = JSON.parse(saved);
            } catch(e) {}

            // Drag & drop
            const area = document.getElementById('projHtmlUploadArea');
            if (area) {
                area.addEventListener('dragover', (e) => { e.preventDefault(); area.classList.add('border-purple-400', 'bg-purple-50/30'); });
                area.addEventListener('dragleave', () => { area.classList.remove('border-purple-400', 'bg-purple-50/30'); });
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('border-purple-400', 'bg-purple-50/30');
                    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.html') || f.name.endsWith('.htm'));
                    if (files.length > 0) this.processFiles(files);
                });
            }
            this.updateFilesUI();
            // Sayfa yüklendiğinde mevcut verilerle eşleştirme durumunu kontrol et
            setTimeout(() => this.checkMatchingStatus(), 500);
        },

        save() {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.reservations));
            localStorage.setItem(this.FILES_KEY, JSON.stringify(this.uploadedFiles));
        },

        handleHTMLFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) this.processFiles(files);
            event.target.value = '';
        },

        async processFiles(files) {
            const statusEl = document.getElementById('projImportStatus');
            if (statusEl) {
                statusEl.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-sm text-blue-700 flex items-center gap-2"><i data-lucide="loader" class="w-4 h-4 animate-spin"></i> HTML dosyası işleniyor...</div>';
                statusEl.classList.remove('hidden');
            }

            let totalAdded = 0;
            for (const file of files) {
                try {
                    const htmlContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });

                    // Reuse HTMLReservations parser
                    const { reservations: parsed, skipped } = HTMLReservations.parseHTML(htmlContent);

                    // Remove old data from same file
                    this.reservations = this.reservations.filter(r => r.sourceFile !== file.name);
                    this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== file.name);

                    const withSource = parsed.map(r => ({ ...r, sourceFile: file.name }));
                    this.reservations.push(...withSource);
                    this.uploadedFiles.push({ name: file.name, uploadDate: new Date().toISOString(), count: parsed.length });
                    totalAdded += parsed.length;
                } catch(e) { console.error('Projection HTML parse error:', e); }
            }

            this.save();
            this.updateFilesUI();
            this.checkMatchingStatus();
            this.calculate();

            if (statusEl) {
                statusEl.innerHTML = totalAdded > 0
                    ? '<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 text-sm text-emerald-700">\u2705 ' + totalAdded + ' rezervasyon yüklendi!</div>'
                    : '<div class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-700">\u26a0\ufe0f Geçerli rezervasyon bulunamadı</div>';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        updateFilesUI() {
            const el = document.getElementById('projFilesList');
            if (!el) return;
            if (this.uploadedFiles.length === 0) {
                el.innerHTML = '<p class="text-xs text-gray-400">Henüz dosya yüklenmedi</p>';
                return;
            }
            el.innerHTML = this.uploadedFiles.map(f =>
                '<div class="flex items-center justify-between text-xs">' +
                '<span class="text-gray-600 truncate"><span class="text-purple-400 mr-1">\ud83d\udcc4</span>' + f.name + ' <span class="text-gray-400">(' + f.count + ')</span></span>' +
                '<button onclick="Projection.removeFile(\'' + f.name + '\')" class="text-red-300 hover:text-red-500 ml-1">\u2715</button></div>'
            ).join('');

            const today = new Date(); today.setHours(0,0,0,0);
            const future = this.reservations.filter(r => new Date(r.checkIn) >= today);
            const past = this.reservations.filter(r => new Date(r.checkIn) < today);
            const countsEl = document.getElementById('projResCounts');
            if (countsEl && this.reservations.length > 0) {
                countsEl.classList.remove('hidden');
                document.getElementById('projFutureCount').textContent = future.length;
                document.getElementById('projPastCount').textContent = past.length;
            }
        },

        removeFile(name) {
            this.reservations = this.reservations.filter(r => r.sourceFile !== name);
            this.uploadedFiles = this.uploadedFiles.filter(f => f.name !== name);
            this.save();
            this.updateFilesUI();
            this.calculate();
        },

        clearAll() {
            if (!confirm('Tüm projeksiyon verilerini temizlemek istediğinizden emin misiniz?')) return;
            this.reservations = [];
            this.uploadedFiles = [];
            this.save();
            this.updateFilesUI();
            document.getElementById('projSummaryCards')?.classList.add('hidden');
            document.getElementById('projMonthlySection')?.classList.add('hidden');
            document.getElementById('projResTableSection')?.classList.add('hidden');
        },

        // ---- KARMA TAHMİN SİSTEMİ ----
        // Gelir tahmini: gelecek rez. / geçmiş yıl aynı ay / ortalama / zincir
        // Gider: daire bazlı standart gider (ekstrem eliminasyonlu)
        // Projeksiyon: mevcut aydan 12 ay ilerisi
        OCCUPANCY_DAYS: 25,
        chainAdjustments: {}, // aptId_month_year → % adjustment

        // Daire için aylık standart gider hesapla (ekstrem değer eliminasyonlu)
        getStandardExpense(analyticsAptId) {
            if (!Analytics.data?.expenses || !Analytics.data?.reservations) return 0;
            const convertEUR = Analytics.convertToEUR ? Analytics.convertToEUR.bind(Analytics) : (a) => a;

            // Aylık gider toplamları
            const monthlyExp = {};
            Analytics.data.expenses.filter(e => e.apartmentId === analyticsAptId).forEach(exp => {
                const d = new Date(exp.date);
                const key = d.getFullYear() + '-' + d.getMonth();
                if (!monthlyExp[key]) monthlyExp[key] = 0;
                monthlyExp[key] += convertEUR(exp.amount, exp.currency);
            });

            // Rezervasyon olan aylar
            const monthsWithRes = {};
            Analytics.data.reservations.filter(r => r.apartmentId === analyticsAptId).forEach(res => {
                const d = new Date(res.checkIn);
                const key = d.getFullYear() + '-' + d.getMonth();
                monthsWithRes[key] = true;
            });

            // Sadece rez. olan ayların giderleri
            const validExpenses = Object.keys(monthlyExp)
                .filter(k => monthsWithRes[k])
                .map(k => monthlyExp[k]);

            if (validExpenses.length === 0) return 0;

            // Medyan hesapla (ekstrem düşük eleme için - ortalamadan daha sağlıklı, uç değerlerden etkilenmez)
            const sorted = [...validExpenses].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            const median = sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            // Ekstrem düşük: medyanın 1/5'inden az olanları ele
            const nonTrivial = validExpenses.filter(e => e >= median / 5);
            if (nonTrivial.length === 0) return 0;

            // En düşük gider = standart (trivial olanlar elendikten sonra)
            const minExp = Math.min(...nonTrivial);
            // %100'den fazla sapanları ele (en düşüğün 2 katını aşanlar)
            const threshold = minExp * 2;
            const normalExp = nonTrivial.filter(e => e <= threshold);

            if (normalExp.length === 0) return minExp;
            return normalExp.reduce((s, e) => s + e, 0) / normalExp.length;
        },

        // Analytics verisinden belirli ay/yıl rezervasyonları
        getAnalyticsResForMonth(analyticsAptId, month, year) {
            if (!Analytics.data?.reservations) return [];
            return Analytics.data.reservations.filter(r => {
                const d = new Date(r.checkIn);
                return r.apartmentId === analyticsAptId &&
                    d.getMonth() === month && d.getFullYear() === year;
            });
        },

        // PMS verisinden belirli ay/yıl rezervasyonları (mapping dahil)
        getPmsResForMonth(analyticsAptId, month, year) {
            const mapping = this.loadMapping();
            // Reverse mapping: analyticsId → pmsId(ler)
            const pmsIds = [analyticsAptId];
            Object.entries(mapping).forEach(([pmsId, aId]) => {
                if (aId === analyticsAptId && !pmsIds.includes(pmsId)) pmsIds.push(pmsId);
            });
            // Analytics data'daki dairenin code'una da bak
            const apt = Analytics.data?.apartments?.find(a => a.id === analyticsAptId);
            if (apt && apt.code && !pmsIds.includes(apt.code)) pmsIds.push(apt.code);

            return this.reservations.filter(r => {
                const d = new Date(r.checkIn);
                return pmsIds.includes(r.apartmentId) &&
                    d.getMonth() === month && d.getFullYear() === year;
            });
        },

        // Zincir geriye git: en yakın veri olan ayı bul
        chainBackward(analyticsAptId, startMonth, startYear, maxSteps) {
            maxSteps = maxSteps || 24;
            let m = startMonth, y = startYear;
            for (let i = 0; i < maxSteps; i++) {
                m--; if (m < 0) { m = 11; y--; }
                // Hem Analytics hem PMS'de ara
                const aRes = this.getAnalyticsResForMonth(analyticsAptId, m, y);
                const pRes = this.getPmsResForMonth(analyticsAptId, m, y);
                const all = aRes.concat(pRes);
                if (all.length > 0) return { month: m, year: y, reservations: all, source: aRes.length > 0 ? 'analytics' : 'pms' };
            }
            return null;
        },

        // Rezervasyon listesinden ortalama gecelik ve toplam gelir hesapla
        // HTML (PMS) format: { totalPrice, pricePerNight, nights, currency }
        // JSON (Analytics) format: { totalAmount, paymentMethod, platformCommission, currency }
        calcRevenueFromRes(reservations) {
            const convertEUR = Analytics.convertToEUR ? Analytics.convertToEUR.bind(Analytics) : (a) => a;
            let totalNights = 0, totalRevenue = 0;
            reservations.forEach(r => {
                // Gece sayısı: PMS 'nights' alanı var, JSON'da yoksa tarihten hesapla
                const nights = r.nights || Math.max(1, Math.round((new Date(r.checkOut) - new Date(r.checkIn)) / 86400000));
                // Tutar: PMS 'totalPrice' kullanır, JSON 'totalAmount' kullanır
                const amount = r.totalPrice ?? r.totalAmount ?? 0;
                const currency = r.currency || 'EUR';
                totalNights += nights;
                totalRevenue += convertEUR(amount, currency);
            });
            const avgNightly = totalNights > 0 ? totalRevenue / totalNights : 0;
            return {
                avgNightly,
                estMonthlyGross: avgNightly * this.OCCUPANCY_DAYS, // Tam ay tahmini (×25 gün)
                totalRevenue,  // Gerçek rezervasyon toplamı
                totalNights,
                count: reservations.length
            };
        },

        // Karma tahmin: bir daire + hedef ay için gelir tahmini
        estimateMonthRevenue(analyticsAptId, targetMonth, targetYear, defaultAdjust) {
            const monthNamesShort = ['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara'];

            // "Gelecek" = PMS + Analytics (hedef ay, hedef yıl)
            const futureFromPms = this.getPmsResForMonth(analyticsAptId, targetMonth, targetYear);
            const futureFromAnalytics = this.getAnalyticsResForMonth(analyticsAptId, targetMonth, targetYear);
            const futureRes = futureFromPms.concat(futureFromAnalytics);

            // "Geçmiş" = Analytics + PMS (aynı ay, geçen yıl)
            const pastFromAnalytics = this.getAnalyticsResForMonth(analyticsAptId, targetMonth, targetYear - 1);
            const pastFromPms = this.getPmsResForMonth(analyticsAptId, targetMonth, targetYear - 1);
            const pastRes = pastFromAnalytics.concat(pastFromPms);

            const hasFuture = futureRes.length > 0;
            const hasPast = pastRes.length > 0;

            if (hasFuture && !hasPast) {
                const calc = this.calcRevenueFromRes(futureRes);
                return { ...calc, source: 'gelecek', sourceLabel: 'Mevcut Rez.', confidence: 'high', sourceColor: 'emerald' };
            } else if (!hasFuture && hasPast) {
                const calc = this.calcRevenueFromRes(pastRes);
                return {
                    avgNightly: calc.avgNightly * 1.05,
                    totalRevenue: calc.totalRevenue * 1.05,
                    totalNights: calc.totalNights,
                    count: calc.count,
                    source: 'gecmis', sourceLabel: 'Geçmiş Yıl +5%', confidence: 'medium', sourceColor: 'amber'
                };
            } else if (hasFuture && hasPast) {
                const fCalc = this.calcRevenueFromRes(futureRes);
                const pCalc = this.calcRevenueFromRes(pastRes);
                return {
                    avgNightly: (fCalc.avgNightly + pCalc.avgNightly) / 2,
                    totalRevenue: (fCalc.totalRevenue + pCalc.totalRevenue) / 2,
                    totalNights: Math.round((fCalc.totalNights + pCalc.totalNights) / 2),
                    count: Math.round((fCalc.count + pCalc.count) / 2),
                    source: 'ortalama', sourceLabel: 'Gelecek+Geçmiş Ort.', confidence: 'high', sourceColor: 'blue'
                };
            } else {
                // Ne gelecek ne geçmiş → zincir geriye git
                const chain = this.chainBackward(analyticsAptId, targetMonth, targetYear);
                if (chain) {
                    const adjustKey = analyticsAptId + '_' + targetMonth + '_' + targetYear;
                    const adjustPct = this.chainAdjustments[adjustKey] !== undefined
                        ? this.chainAdjustments[adjustKey] : (defaultAdjust || 0);
                    const multiplier = 1 + (adjustPct / 100);
                    const calc = this.calcRevenueFromRes(chain.reservations);
                    return {
                        avgNightly: calc.avgNightly * multiplier,
                        totalRevenue: calc.totalRevenue * multiplier,
                        totalNights: calc.totalNights,
                        count: calc.count,
                        source: 'zincir',
                        sourceLabel: 'Zincir (' + monthNamesShort[chain.month] + ' ' + chain.year + ') ' + (adjustPct >= 0 ? '+' : '') + adjustPct + '%',
                        confidence: 'low', sourceColor: 'orange',
                        needsAdjustment: true, adjustKey, adjustPct
                    };
                }
                return {
                    avgNightly: 0, totalRevenue: 0, totalNights: 0, count: 0,
                    source: 'veri-yok', sourceLabel: 'Veri Yok', confidence: 'none', sourceColor: 'red'
                };
            }
        },

        updateChainAdjust(key, value) {
            this.chainAdjustments[key] = parseFloat(value) || 0;
            this.calculate();
        },

        calculate() {
            const today = new Date(); today.setHours(0,0,0,0);
            const defaultAdjust = parseFloat(document.getElementById('projDefaultAdjust')?.value) || 0;

            // Daire verisi yoksa çık
            const apartments = Analytics.data?.apartments || [];
            if (apartments.length === 0) {
                document.getElementById('projSummaryCards')?.classList.add('hidden');
                document.getElementById('projMonthlySection')?.classList.add('hidden');
                document.getElementById('projResTableSection')?.classList.add('hidden');
                return;
            }

            // --- 1. 12 aylık periyot oluştur ---
            const now = new Date();
            const startMonth = now.getMonth();
            const startYear = now.getFullYear();
            const months12 = [];
            for (let i = 0; i < 12; i++) {
                let m = startMonth + i, y = startYear;
                if (m >= 12) { m -= 12; y++; }
                const monthKey = y + '-' + String(m + 1).padStart(2, '0');
                months12.push({ month: m, year: y, monthKey });
            }

            // --- 2. Geçmiş verilerden oranlar (platform komisyon, banka/nakit) ---
            const hist = this.getHistoricalRatios();

            // KDV sistemleri
            const kdvSystems = new Set(['1','3','4','5','9']);
            const kdvBookingOnlySystems = new Set(['7']);

            let totalEstGross = 0, totalEstExpenses = 0, totalEstKDV = 0, totalEstPlatComm = 0, totalLagirioNet = 0;
            const monthlyData = {};
            const aptTotals = {};
            const aptMonthlyDetail = {};
            let totalResCount = 0;

            // --- 3. Her daire × 12 ay karma tahmin ---
            apartments.forEach(apartment => {
                const aptId = apartment.id;
                const sysType = apartment.systemType || '?';
                const taxRate = apartment.taxRate || 0;
                const stdExpense = this.getStandardExpense(aptId);

                // Platform komisyon ve banka/nakit oranları
                const platCommRatio = hist.platformCommRate[aptId] ?? hist.avgPlatformCommRate;
                const bankCashRatio = hist.bankRatio[aptId] ?? hist.avgBankRatio;

                if (!aptTotals[aptId]) aptTotals[aptId] = { id: aptId, code: apartment.code || aptId, systemType: sysType, commission: apartment.lagirioCommission || 0, gross: 0, expenses: 0, kdv: 0, platComm: 0, lagirio: 0, months: 0, avgNightly: 0, count: 0 };
                if (!aptMonthlyDetail[aptId]) aptMonthlyDetail[aptId] = {};

                months12.forEach(({ month, year, monthKey }) => {
                    // --- Karma gelir tahmini ---
                    const estimate = this.estimateMonthRevenue(aptId, month, year, defaultAdjust);
                    const avgNightly = estimate.avgNightly;
                    // Brüt gelir = ort. gecelik fiyat × doluluk günü (tam ay tahmini)
                    const estMonthlyGross = avgNightly * this.OCCUPANCY_DAYS;

                    // --- Gider: daire bazlı standart (ekstrem eliminasyonlu) ---
                    const estExpenses = stdExpense;

                    // --- Platform komisyonu ---
                    const estPlatformComm = estMonthlyGross * platCommRatio;

                    // --- KDV ---
                    let estKDV = 0;
                    const bankAmount = estMonthlyGross * bankCashRatio;
                    if (taxRate > 0) {
                        if (kdvSystems.has(sysType)) {
                            estKDV = bankAmount * (taxRate / 100) / (1 + taxRate / 100);
                        } else if (kdvBookingOnlySystems.has(sysType)) {
                            const bookingPortion = bankAmount * 0.7;
                            estKDV = bookingPortion * (taxRate / 100) / (1 + taxRate / 100);
                        }
                    }

                    // --- Lagirio kazancı ---
                    let lagirioEarning = 0;
                    if (Analytics.calculateLagirioRevenue) {
                        const cashAmount = estMonthlyGross * (1 - bankCashRatio);
                        const fakeReservations = [];
                        if (bankAmount > 0) {
                            fakeReservations.push({ totalAmount: bankAmount, currency: 'EUR', platformCommission: bankAmount * platCommRatio, paymentMethod: 'Banka', platform: 'Booking.com' });
                        }
                        if (cashAmount > 0) {
                            fakeReservations.push({ totalAmount: cashAmount, currency: 'EUR', platformCommission: cashAmount * platCommRatio, paymentMethod: 'Nakit', platform: 'Direkt' });
                        }
                        const fakeExpenses = [{ amount: estExpenses, currency: 'EUR' }];
                        lagirioEarning = Analytics.calculateLagirioRevenue(apartment, fakeReservations, fakeExpenses);
                    } else {
                        lagirioEarning = (estMonthlyGross - estPlatformComm - estExpenses) * 0.15;
                    }

                    // --- Topla ---
                    totalEstGross += estMonthlyGross;
                    totalEstExpenses += estExpenses;
                    totalEstKDV += estKDV;
                    totalEstPlatComm += estPlatformComm;
                    totalLagirioNet += lagirioEarning;
                    totalResCount += estimate.count;

                    // Aylık veri
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = { gross: 0, expenses: 0, kdv: 0, platComm: 0, lagirio: 0, count: 0, avgNightly: 0, aptCount: 0 };
                    monthlyData[monthKey].gross += estMonthlyGross;
                    monthlyData[monthKey].expenses += estExpenses;
                    monthlyData[monthKey].kdv += estKDV;
                    monthlyData[monthKey].platComm += estPlatformComm;
                    monthlyData[monthKey].lagirio += lagirioEarning;
                    monthlyData[monthKey].count += estimate.count;
                    monthlyData[monthKey].avgNightly += avgNightly;
                    monthlyData[monthKey].aptCount++;

                    // Daire toplamı
                    aptTotals[aptId].gross += estMonthlyGross;
                    aptTotals[aptId].expenses += estExpenses;
                    aptTotals[aptId].kdv += estKDV;
                    aptTotals[aptId].platComm += estPlatformComm;
                    aptTotals[aptId].lagirio += lagirioEarning;
                    aptTotals[aptId].months++;
                    aptTotals[aptId].avgNightly += avgNightly;
                    aptTotals[aptId].count += estimate.count;

                    // Daire-ay detayı
                    aptMonthlyDetail[aptId][monthKey] = {
                        gross: estMonthlyGross,
                        actualRevenue: estimate.totalRevenue,
                        expenses: estExpenses,
                        kdv: estKDV,
                        platComm: estPlatformComm,
                        lagirio: lagirioEarning,
                        avgNightly: avgNightly,
                        resCount: estimate.count,
                        totalNights: estimate.totalNights,
                        source: estimate.source,
                        sourceLabel: estimate.sourceLabel,
                        sourceColor: estimate.sourceColor,
                        confidence: estimate.confidence,
                        needsAdjustment: estimate.needsAdjustment,
                        adjustKey: estimate.adjustKey,
                        adjustPct: estimate.adjustPct
                    };
                });

                // Daire ortalamasını düzelt
                if (aptTotals[aptId].months > 0) aptTotals[aptId].avgNightly = aptTotals[aptId].avgNightly / aptTotals[aptId].months;
            });

            // Ay bazlı ortalamaları düzelt
            Object.values(monthlyData).forEach(m => {
                if (m.aptCount > 0) m.avgNightly = m.avgNightly / m.aptCount;
            });

            // --- 4. UI Güncelle ---
            this.renderSummaryCards(totalEstGross, totalEstExpenses, totalEstKDV, totalEstPlatComm, totalLagirioNet, totalResCount, Object.keys(aptTotals).length);
            this.renderMonthlyChart(monthlyData);
            this.renderMonthlyOverview(monthlyData, aptMonthlyDetail);
            this.renderApartmentList(Object.values(aptTotals), aptMonthlyDetail);
            this.renderTable();
            const futureRes = this.reservations.filter(r => new Date(r.checkIn) >= today);
            this.renderPlatformFilter(futureRes);

            document.getElementById('projSummaryCards')?.classList.remove('hidden');
            document.getElementById('projMonthlySection')?.classList.remove('hidden');
            document.getElementById('projResTableSection')?.classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        // Geçmiş verilerden daire bazlı oranları çıkar
        getHistoricalRatios() {
            const result = {
                expenseRatio: {},      // aptId → gider/gelir oranı
                platformCommRate: {},   // aptId → platform komisyon/gelir oranı
                bankRatio: {},          // aptId → banka gelir / toplam gelir oranı
                avgExpenseRatio: 0.12,
                avgPlatformCommRate: 0.15,
                avgBankRatio: 0.85      // varsayılan %85 banka
            };

            if (!Analytics.data?.apartments) return result;

            let gTotalGross = 0, gTotalExp = 0, gTotalPlatComm = 0, gTotalBank = 0;

            Analytics.data.apartments.forEach(apt => {
                const reses = Analytics.data.reservations?.filter(r => r.apartmentId === apt.id) || [];
                const exps = Analytics.data.expenses?.filter(e => e.apartmentId === apt.id) || [];

                const aptGross = reses.reduce((s, r) => s + (Analytics.convertToEUR ? Analytics.convertToEUR(r.totalAmount, r.currency || 'EUR') : (r.totalAmount || 0)), 0);
                const aptExp = exps.reduce((s, e) => s + (Analytics.convertToEUR ? Analytics.convertToEUR(e.amount, e.currency) : (e.amount || 0)), 0);
                const aptPlatComm = reses.reduce((s, r) => s + (r.platformCommission || 0), 0);
                const aptBankIncome = reses.filter(r => r.paymentMethod !== 'Nakit')
                    .reduce((s, r) => s + (Analytics.convertToEUR ? Analytics.convertToEUR(r.totalAmount, r.currency || 'EUR') : (r.totalAmount || 0)), 0);

                if (aptGross > 0) {
                    result.expenseRatio[apt.id] = aptExp / aptGross;
                    result.platformCommRate[apt.id] = aptPlatComm / aptGross;
                    result.bankRatio[apt.id] = aptBankIncome / aptGross;
                }

                gTotalGross += aptGross;
                gTotalExp += aptExp;
                gTotalPlatComm += aptPlatComm;
                gTotalBank += aptBankIncome;
            });

            if (gTotalGross > 0) {
                result.avgExpenseRatio = gTotalExp / gTotalGross;
                result.avgPlatformCommRate = gTotalPlatComm / gTotalGross;
                result.avgBankRatio = gTotalBank / gTotalGross;
            }

            // Mapping: PMS aptId → Analytics aptId ise, oranları PMS ID'ye de kopyala
            const mapping = this.loadMapping();
            Object.entries(mapping).forEach(([pmsId, analyticsId]) => {
                if (pmsId !== analyticsId) {
                    if (result.expenseRatio[analyticsId] !== undefined) result.expenseRatio[pmsId] = result.expenseRatio[analyticsId];
                    if (result.platformCommRate[analyticsId] !== undefined) result.platformCommRate[pmsId] = result.platformCommRate[analyticsId];
                    if (result.bankRatio[analyticsId] !== undefined) result.bankRatio[pmsId] = result.bankRatio[analyticsId];
                }
            });

            return result;
        },

        // ---- Render Functions ----
        renderSummaryCards(estGross, estExpenses, estKDV, estPlatComm, lagirioNet, resCount, aptCount) {
            // Üst satır: Brüt, Lagirio, Gecelik
            document.getElementById('projGrossRevenue').textContent = '\u20ac' + estGross.toFixed(2);
            document.getElementById('projGrossDetail').textContent = aptCount + ' daire | 12 ay | Karma tahmin';

            document.getElementById('projLagirioNet').textContent = '\u20ac' + lagirioNet.toFixed(2);
            const lagirioRatio = estGross > 0 ? Math.round((lagirioNet / estGross) * 100) : 0;
            document.getElementById('projLagirioDetail').textContent = 'Br\u00fct gelirin %' + lagirioRatio + '\'i';

            const avgNightly = estGross > 0 ? estGross / (aptCount * 12 * this.OCCUPANCY_DAYS || 1) : 0;
            document.getElementById('projAvgNightly').textContent = '\u20ac' + avgNightly.toFixed(2);
            document.getElementById('projNightlyDetail').textContent = aptCount + ' daire | ' + this.OCCUPANCY_DAYS + ' gün/ay | Brüt/' + (aptCount*12) + ' ay';

            // Alt satır: Gider, KDV, Platform Komis.
            document.getElementById('projExpenses').textContent = '\u20ac' + estExpenses.toFixed(2);
            const expRatio = estGross > 0 ? Math.round((estExpenses / estGross) * 100) : 0;
            document.getElementById('projExpenseDetail').textContent = 'Daire bazlı standart (ekstrem eleme)';

            document.getElementById('projKDV').textContent = '\u20ac' + estKDV.toFixed(2);
            const kdvRatio = estGross > 0 ? ((estKDV / estGross) * 100).toFixed(1) : 0;
            document.getElementById('projKDVDetail').textContent = 'Br\u00fct\u00fcn %' + kdvRatio + '\'i';

            document.getElementById('projPlatComm').textContent = '\u20ac' + estPlatComm.toFixed(2);
            const platRatio = estGross > 0 ? Math.round((estPlatComm / estGross) * 100) : 0;
            document.getElementById('projPlatCommDetail').textContent = 'Ge\u00e7mi\u015f oran\u0131: %' + platRatio;
        },

        renderMonthlyChart(monthlyData) {
            const container = document.getElementById('projMonthlyChart');
            if (!container) return;
            const monthNames = ['Oca','\u015eub','Mar','Nis','May','Haz','Tem','A\u011fu','Eyl','Eki','Kas','Ara'];
            const sortedKeys = Object.keys(monthlyData).sort();

            if (sortedKeys.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-8">Veri yok</p>';
                return;
            }

            const maxVal = Math.max(...sortedKeys.map(k => monthlyData[k].gross));

            container.innerHTML = '<div class="flex items-end gap-3 h-56">' + sortedKeys.map(key => {
                const d = monthlyData[key];
                const [y, m] = key.split('-');
                const label = monthNames[parseInt(m)-1] + ' ' + y.slice(2);
                const grossH = maxVal > 0 ? Math.max(8, (d.gross / maxVal) * 190) : 8;
                const lagirioH = maxVal > 0 ? Math.max(4, (d.lagirio / maxVal) * 190) : 4;
                const expH = maxVal > 0 ? Math.max(2, (d.expenses / maxVal) * 190) : 2;

                return '<div class="flex-1 flex flex-col items-center gap-1">' +
                    '<div class="text-center mb-1">' +
                    '<span class="text-[10px] font-bold text-emerald-600 block">\u20ac' + d.lagirio.toFixed(2) + '</span>' +
                    '<span class="text-[9px] text-gray-400">\u20ac' + d.avgNightly.toFixed(2) + '/g</span></div>' +
                    '<div class="w-full flex gap-0.5 items-end justify-center" style="height:' + grossH + 'px">' +
                    '<div class="flex-1 bg-emerald-100 rounded-t-sm h-full relative">' +
                    '<div class="absolute bottom-0 left-0 right-0 bg-emerald-500 rounded-t-sm" style="height:' + lagirioH + 'px"></div></div>' +
                    '<div class="w-2 bg-orange-300 rounded-t-sm" style="height:' + expH + 'px"></div></div>' +
                    '<span class="text-[10px] text-gray-600 whitespace-nowrap font-medium">' + label + '</span>' +
                    '<span class="text-[9px] text-gray-400">' + d.count + ' rez. | ' + d.aptCount + ' daire</span>' +
                    '</div>';
            }).join('') + '</div>' +
            '<div class="flex items-center gap-4 mt-3 justify-center text-[10px] text-gray-400">' +
            '<span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-100 rounded"></span> Karma Tahmini Brüt</span>' +
            '<span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded"></span> Lagirio Kazancı</span>' +
            '<span class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-300 rounded"></span> Standart Gider</span>' +
            '</div>';
        },

        renderMonthlyOverview(monthlyData, aptMonthlyDetail) {
            const container = document.getElementById('projMonthlyOverview');
            if (!container) return;
            const monthNames = ['Ocak','\u015eubat','Mart','Nisan','May\u0131s','Haziran','Temmuz','A\u011fustos','Eyl\u00fcl','Ekim','Kas\u0131m','Aral\u0131k'];
            const sortedKeys = Object.keys(monthlyData).sort();

            if (sortedKeys.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Veri yok</p>';
                return;
            }

            // Grand totals
            let grandGross = 0, grandExp = 0, grandKdv = 0, grandPlat = 0, grandLagirio = 0, grandCount = 0;
            sortedKeys.forEach(k => {
                const d = monthlyData[k];
                grandGross += d.gross; grandExp += d.expenses; grandKdv += d.kdv;
                grandPlat += d.platComm; grandLagirio += d.lagirio; grandCount += d.count;
            });

            let html = '<div class="overflow-x-auto">' +
                '<table class="w-full text-xs border-collapse">' +
                '<thead><tr class="bg-gray-50 text-gray-500">' +
                '<th class="py-2 px-3 text-left font-medium">Ay</th>' +
                '<th class="py-2 px-3 text-right font-medium">Rez.</th>' +
                '<th class="py-2 px-3 text-right font-medium">Daire</th>' +
                '<th class="py-2 px-3 text-right font-medium">Ort. Gecelik</th>' +
                '<th class="py-2 px-3 text-right font-medium">Br\u00fct Gelir</th>' +
                '<th class="py-2 px-3 text-right font-medium">Gider</th>' +
                '<th class="py-2 px-3 text-right font-medium">KDV</th>' +
                '<th class="py-2 px-3 text-right font-medium">Plt.Kom</th>' +
                '<th class="py-2 px-3 text-right font-medium text-emerald-700">Lagirio</th>' +
                '</tr></thead><tbody>';

            sortedKeys.forEach((mk, idx) => {
                const d = monthlyData[mk];
                const [y, m] = mk.split('-');
                const mName = monthNames[parseInt(m) - 1] + ' ' + y;
                const lagirioRatio = d.gross > 0 ? ((d.lagirio / d.gross) * 100).toFixed(1) : '0.0';

                html += '<tr class="border-t border-gray-100 hover:bg-indigo-50/40 cursor-pointer transition-colors" onclick="Projection.toggleMonthlyDetail(' + idx + ')">' +
                    '<td class="py-2.5 px-3 font-medium text-gray-700"><i data-lucide="chevron-right" class="w-3 h-3 inline mr-1 text-gray-400 transition-transform" id="projMonthChev_' + idx + '"></i>' + mName + '</td>' +
                    '<td class="py-2.5 px-3 text-right text-gray-600">' + d.count + '</td>' +
                    '<td class="py-2.5 px-3 text-right text-gray-600">' + d.aptCount + '</td>' +
                    '<td class="py-2.5 px-3 text-right text-gray-600">\u20ac' + d.avgNightly.toFixed(2) + '</td>' +
                    '<td class="py-2.5 px-3 text-right font-medium text-gray-700">\u20ac' + d.gross.toFixed(2) + '</td>' +
                    '<td class="py-2.5 px-3 text-right text-orange-500">\u20ac' + d.expenses.toFixed(2) + '</td>' +
                    '<td class="py-2.5 px-3 text-right text-red-500">\u20ac' + d.kdv.toFixed(2) + '</td>' +
                    '<td class="py-2.5 px-3 text-right text-indigo-500">\u20ac' + d.platComm.toFixed(2) + '</td>' +
                    '<td class="py-2.5 px-3 text-right font-bold text-emerald-600">\u20ac' + d.lagirio.toFixed(2) + ' <span class="text-[9px] text-gray-400 font-normal">%' + lagirioRatio + '</span></td>' +
                    '</tr>';

                // Expandable apartment detail for this month
                html += '<tr id="projMonthDetail_' + idx + '" class="hidden"><td colspan="9" class="p-0">';
                html += '<div class="bg-indigo-50/30 px-4 py-3 border-t border-indigo-100">';

                // Get per-apartment data for this month
                const aptRows = [];
                if (aptMonthlyDetail) {
                    Object.entries(aptMonthlyDetail).forEach(([aptId, months]) => {
                        const md = months[mk];
                        if (md && (md.gross > 0 || md.lagirio > 0 || md.resCount > 0)) {
                            const apartments = (window.Analytics?.data?.apartments || []);
                            const apt = apartments.find(a => a.id === aptId);
                            const code = apt?.code || aptId;
                            aptRows.push({ code, ...md });
                        }
                    });
                }
                aptRows.sort((a, b) => b.lagirio - a.lagirio);

                if (aptRows.length > 0) {
                    html += '<table class="w-full text-[11px]">' +
                        '<thead><tr class="text-gray-400">' +
                        '<th class="py-1 px-2 text-left font-medium">Daire</th>' +
                        '<th class="py-1 px-2 text-left font-medium">Kaynak</th>' +
                        '<th class="py-1 px-2 text-right font-medium">Rez.</th>' +
                        '<th class="py-1 px-2 text-right font-medium">Ort.Gclk</th>' +
                        '<th class="py-1 px-2 text-right font-medium">Br\u00fct</th>' +
                        '<th class="py-1 px-2 text-right font-medium">Gider</th>' +
                        '<th class="py-1 px-2 text-right font-medium">KDV</th>' +
                        '<th class="py-1 px-2 text-right font-medium">Plt.Kom</th>' +
                        '<th class="py-1 px-2 text-right font-medium text-emerald-700">Lagirio</th>' +
                        '</tr></thead><tbody>';

                    const sourceColors = { emerald: 'text-emerald-600', amber: 'text-amber-600', blue: 'text-blue-600', orange: 'text-orange-500', red: 'text-red-400' };
                    aptRows.forEach(a => {
                        const sColor = sourceColors[a.sourceColor] || 'text-gray-500';
                        html += '<tr class="border-t border-gray-100/60">' +
                            '<td class="py-1.5 px-2 font-medium text-gray-700">' + a.code + '</td>' +
                            '<td class="py-1.5 px-2 ' + sColor + '">' + (a.sourceLabel || '-') + '</td>' +
                            '<td class="py-1.5 px-2 text-right text-gray-600">' + (a.resCount || 0) + '</td>' +
                            '<td class="py-1.5 px-2 text-right text-gray-600">\u20ac' + (a.avgNightly || 0).toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-right text-gray-700">\u20ac' + (a.gross || 0).toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-right text-orange-500">\u20ac' + (a.expenses || 0).toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-right text-red-500">\u20ac' + (a.kdv || 0).toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-right text-indigo-500">\u20ac' + (a.platComm || 0).toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-right font-bold text-emerald-600">\u20ac' + (a.lagirio || 0).toFixed(2) + '</td>' +
                            '</tr>';
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p class="text-gray-400 text-xs py-2">Bu ay i\u00e7in daire detay\u0131 yok</p>';
                }
                html += '</div></td></tr>';
            });

            // Grand total row
            const grandRatio = grandGross > 0 ? ((grandLagirio / grandGross) * 100).toFixed(1) : '0.0';
            html += '<tr class="border-t-2 border-gray-300 bg-gray-50 font-bold">' +
                '<td class="py-2.5 px-3 text-gray-800">TOPLAM (12 Ay)</td>' +
                '<td class="py-2.5 px-3 text-right text-gray-700">' + grandCount + '</td>' +
                '<td class="py-2.5 px-3 text-right text-gray-500">-</td>' +
                '<td class="py-2.5 px-3 text-right text-gray-500">-</td>' +
                '<td class="py-2.5 px-3 text-right text-gray-800">\u20ac' + grandGross.toFixed(2) + '</td>' +
                '<td class="py-2.5 px-3 text-right text-orange-600">\u20ac' + grandExp.toFixed(2) + '</td>' +
                '<td class="py-2.5 px-3 text-right text-red-600">\u20ac' + grandKdv.toFixed(2) + '</td>' +
                '<td class="py-2.5 px-3 text-right text-indigo-600">\u20ac' + grandPlat.toFixed(2) + '</td>' +
                '<td class="py-2.5 px-3 text-right text-emerald-700">\u20ac' + grandLagirio.toFixed(2) + ' <span class="text-[9px] text-gray-400 font-normal">%' + grandRatio + '</span></td>' +
                '</tr>';

            html += '</tbody></table></div>';
            container.innerHTML = html;
        },

        toggleMonthlyDetail(idx) {
            const row = document.getElementById('projMonthDetail_' + idx);
            const chev = document.getElementById('projMonthChev_' + idx);
            if (!row) return;
            const isHidden = row.classList.contains('hidden');
            row.classList.toggle('hidden');
            if (chev) chev.style.transform = isHidden ? 'rotate(90deg)' : '';
        },

        renderApartmentList(results, aptMonthlyDetail) {
            const el = document.getElementById('projApartmentList');
            if (!el) return;
            this._aptMonthlyDetail = aptMonthlyDetail || {};
            const sorted = results.sort((a, b) => b.lagirio - a.lagirio);
            const sysNames = { '1': 'S1 Net', '2': 'S2 Brüt', '3': 'S3 Kar', '4': 'S4 Plat', '5': 'S5 Stop', '6': 'S6 Net', '7': 'S7 Karma', '8': 'S8 Kar', '9': 'S9 Stop-KDV' };
            const monthNames = ['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara'];
            const sourceColorMap = { emerald: 'bg-emerald-50 border-l-2 border-emerald-400', amber: 'bg-amber-50 border-l-2 border-amber-400', blue: 'bg-blue-50 border-l-2 border-blue-400', orange: 'bg-orange-50 border-l-2 border-orange-400', red: 'bg-red-50 border-l-2 border-red-300' };

            el.innerHTML = sorted.map((apt, i) => {
                const detail = this._aptMonthlyDetail[apt.id] || {};
                const months = Object.keys(detail).sort();

                let monthRows = '';
                if (months.length > 0) {
                    monthRows = months.map(mk => {
                        const d = detail[mk];
                        const [y, m] = mk.split('-');
                        const mName = monthNames[parseInt(m)-1] + ' ' + y;
                        const rowClass = sourceColorMap[d.sourceColor] || '';
                        const adjustInput = d.needsAdjustment
                            ? ' <input type="number" value="' + (d.adjustPct || 0) + '" style="width:45px;font-size:10px;padding:1px 3px;border:1px solid #ddd;border-radius:3px;text-align:center;" onchange="Projection.updateChainAdjust(\'' + d.adjustKey + '\', this.value)" title="% ayarlama">%'
                            : '';
                        const nightsInfo = d.totalNights > 0 ? d.totalNights + 'g' : '-';
                        const isClickable = d.resCount > 0 && d.source !== 'veri-yok';
                        const clickAttr = isClickable ? ' onclick="event.stopPropagation(); Projection.showReservationDetail(\'' + apt.id + '\',' + (parseInt(m)-1) + ',' + y + ')" style="cursor:pointer;" title="Rezervasyon detayı için tıklayın"' : '';
                        return '<tr class="border-t border-gray-100 ' + rowClass + (isClickable ? ' hover:bg-gray-100 transition-colors' : '') + '"' + clickAttr + '>' +
                            '<td class="py-1.5 px-2 text-xs font-medium text-gray-600">' + mName + (isClickable ? ' <i data-lucide="search" class="w-3 h-3 inline text-gray-300"></i>' : '') + '</td>' +
                            '<td class="py-1.5 px-2 text-[10px] text-gray-400">' + (d.sourceLabel || '') + adjustInput + '</td>' +
                            '<td class="py-1.5 px-2 text-xs text-right">' + d.resCount + ' <span class="text-gray-300">(' + nightsInfo + ')</span></td>' +
                            '<td class="py-1.5 px-2 text-xs text-right">\u20ac' + d.avgNightly.toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-xs text-right font-medium">\u20ac' + d.gross.toFixed(2) + ' <span class="text-[9px] text-gray-300">\u00d7' + Projection.OCCUPANCY_DAYS + 'g</span></td>' +
                            '<td class="py-1.5 px-2 text-xs text-right text-orange-500">\u20ac' + d.expenses.toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-xs text-right text-red-500">\u20ac' + d.kdv.toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-xs text-right text-indigo-500">\u20ac' + d.platComm.toFixed(2) + '</td>' +
                            '<td class="py-1.5 px-2 text-xs text-right font-bold text-emerald-600">\u20ac' + d.lagirio.toFixed(2) + '</td>' +
                            '</tr>';
                    }).join('');
                }

                const detailTable = '<div id="projAptDetail_' + i + '" class="hidden mt-2 mb-1 mx-1">' +
                    '<div class="bg-gray-50 rounded-lg p-3 overflow-x-auto">' +
                    '<table class="w-full text-xs">' +
                    '<thead><tr class="text-gray-400 text-[10px] uppercase">' +
                    '<th class="py-1 px-2 text-left">Ay</th>' +
                    '<th class="py-1 px-2 text-left">Kaynak</th>' +
                    '<th class="py-1 px-2 text-right">Rez (Gece)</th>' +
                    '<th class="py-1 px-2 text-right">/Gece</th>' +
                    '<th class="py-1 px-2 text-right">Brüt (\u00d725g)</th>' +
                    '<th class="py-1 px-2 text-right">Gider</th>' +
                    '<th class="py-1 px-2 text-right">KDV</th>' +
                    '<th class="py-1 px-2 text-right">Plt.Kom</th>' +
                    '<th class="py-1 px-2 text-right">Lagirio</th>' +
                    '</tr></thead><tbody>' + monthRows +
                    '<tr class="border-t-2 border-gray-300 font-bold">' +
                    '<td class="py-1.5 px-2 text-xs" colspan="2">TOPLAM (12 Ay)</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right">' + apt.count + '</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right">\u20ac' + apt.avgNightly.toFixed(2) + '</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right">\u20ac' + apt.gross.toFixed(2) + '</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right text-orange-500">\u20ac' + apt.expenses.toFixed(2) + '</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right text-red-500">\u20ac' + apt.kdv.toFixed(2) + '</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right text-indigo-500">\u20ac' + apt.platComm.toFixed(2) + '</td>' +
                    '<td class="py-1.5 px-2 text-xs text-right text-emerald-600">\u20ac' + apt.lagirio.toFixed(2) + '</td>' +
                    '</tr></tbody></table></div></div>';

                return '<div class="border border-gray-100 rounded-lg overflow-hidden">' +
                    '<div class="flex items-center justify-between py-2.5 px-3 cursor-pointer hover:bg-gray-50 transition-colors" onclick="Projection.toggleAptDetail(' + i + ')">' +
                    '<div class="flex items-center gap-2">' +
                    '<span class="text-xs font-bold text-gray-300 w-5">' + (i+1) + '</span>' +
                    '<i data-lucide="chevron-right" class="w-3.5 h-3.5 text-gray-400 transition-transform" id="projAptChev_' + i + '"></i>' +
                    '<div><p class="text-sm font-semibold text-gray-700">' + apt.code + '</p>' +
                    '<p class="text-[10px] text-gray-400">' + (sysNames[apt.systemType] || 'S?') + ' | %' + apt.commission + ' | ' + apt.months + ' ay | \u20ac' + apt.avgNightly.toFixed(2) + '/g</p></div></div>' +
                    '<div class="text-right">' +
                    '<p class="text-sm font-bold text-emerald-600">\u20ac' + apt.lagirio.toFixed(2) + '</p>' +
                    '<p class="text-[10px] text-gray-400">Brüt \u20ac' + apt.gross.toFixed(2) + ' | Gdr \u20ac' + apt.expenses.toFixed(2) + ' | KDV \u20ac' + apt.kdv.toFixed(2) + ' | Plt \u20ac' + apt.platComm.toFixed(2) + '</p></div></div>' +
                    detailTable + '</div>';
            }).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        toggleAptDetail(idx) {
            const detail = document.getElementById('projAptDetail_' + idx);
            const chev = document.getElementById('projAptChev_' + idx);
            if (!detail) return;
            const isHidden = detail.classList.contains('hidden');
            detail.classList.toggle('hidden');
            if (chev) chev.style.transform = isHidden ? 'rotate(90deg)' : '';
        },

        showReservationDetail(aptId, month, year) {
            const monthNamesFull = ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'];
            const convertEUR = Analytics.convertToEUR ? Analytics.convertToEUR.bind(Analytics) : (a) => a;
            const apt = Analytics.data?.apartments?.find(a => a.id === aptId);
            const aptCode = apt ? apt.code : aptId;

            // Get reservations from all sources
            const futureFromPms = this.getPmsResForMonth(aptId, month, year);
            const futureFromAnalytics = this.getAnalyticsResForMonth(aptId, month, year);
            const pastFromPms = this.getPmsResForMonth(aptId, month, year - 1);
            const pastFromAnalytics = this.getAnalyticsResForMonth(aptId, month, year - 1);
            const futureRes = futureFromPms.concat(futureFromAnalytics);
            const pastRes = pastFromPms.concat(pastFromAnalytics);
            const hasFuture = futureRes.length > 0;
            const hasPast = pastRes.length > 0;

            let sections = [];
            if (hasFuture && !hasPast) {
                sections.push({ title: 'Mevcut Rezervasyonlar (' + monthNamesFull[month] + ' ' + year + ')', reservations: futureRes, badge: 'Gerçek Veri', badgeColor: 'emerald', note: null });
            } else if (!hasFuture && hasPast) {
                sections.push({ title: 'Geçmiş Yıl Rezervasyonları (' + monthNamesFull[month] + ' ' + (year - 1) + ')', reservations: pastRes, badge: 'Geçmiş Yıl +5%', badgeColor: 'amber', note: 'Bu ay için ' + year + ' yılında rezervasyon bulunmadığından, ' + (year - 1) + ' yılı verileri %5 artışla kullanılmıştır.' });
            } else if (hasFuture && hasPast) {
                sections.push({ title: 'Mevcut Rezervasyonlar (' + monthNamesFull[month] + ' ' + year + ')', reservations: futureRes, badge: 'Gelecek', badgeColor: 'emerald', note: null });
                sections.push({ title: 'Geçmiş Yıl Rezervasyonları (' + monthNamesFull[month] + ' ' + (year - 1) + ')', reservations: pastRes, badge: 'Geçmiş Yıl', badgeColor: 'amber', note: 'Her iki yılın ortalaması alınarak hesaplanmıştır.' });
            } else {
                const chain = this.chainBackward(aptId, month, year);
                if (chain) {
                    const adjustKey = aptId + '_' + month + '_' + year;
                    const adjustPct = this.chainAdjustments[adjustKey] !== undefined ? this.chainAdjustments[adjustKey] : 0;
                    sections.push({ title: 'Zincir Kaynak: ' + monthNamesFull[chain.month] + ' ' + chain.year, reservations: chain.reservations, badge: 'Zincir ' + (adjustPct >= 0 ? '+' : '') + adjustPct + '%', badgeColor: 'orange', note: 'Bu ay için doğrudan veri bulunmadığından, en yakın veri olan ' + monthNamesFull[chain.month] + ' ' + chain.year + ' ayı kullanılmıştır.' });
                }
            }

            if (sections.length === 0) return;

            const badgeColorMap = { emerald: 'bg-emerald-100 text-emerald-700', amber: 'bg-amber-100 text-amber-700', orange: 'bg-orange-100 text-orange-700', blue: 'bg-blue-100 text-blue-700' };
            const borderColorMap = { emerald: 'border-emerald-400', amber: 'border-amber-400', orange: 'border-orange-400', blue: 'border-blue-400' };
            const fmt = d => { const dt = new Date(d); return dt.getDate() + '.' + (dt.getMonth()+1) + '.' + dt.getFullYear(); };

            let html = '<div id="projResDetailOverlay" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this)this.remove()">';
            html += '<div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">';

            // Header
            html += '<div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white p-5 rounded-t-2xl flex justify-between items-center">';
            html += '<div><h3 class="text-lg font-bold">' + aptCode + ' - ' + monthNamesFull[month] + ' ' + year + '</h3>';
            html += '<p class="text-emerald-100 text-sm mt-1">Hesaplamaya Dahil Edilen Rezervasyonlar</p></div>';
            html += '<button onclick="document.getElementById(\'projResDetailOverlay\').remove()" class="text-white/70 hover:text-white text-2xl leading-none">&times;</button>';
            html += '</div>';

            html += '<div class="p-5 space-y-6">';

            sections.forEach(function(section) {
                html += '<div>';
                html += '<div class="flex items-center gap-3 mb-3">';
                html += '<h4 class="text-sm font-bold text-gray-700">' + section.title + '</h4>';
                html += '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full ' + (badgeColorMap[section.badgeColor] || 'bg-gray-100 text-gray-600') + '">' + section.badge + '</span>';
                html += '</div>';

                if (section.note) {
                    html += '<p class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg mb-3 border-l-3 ' + (borderColorMap[section.badgeColor] || '') + '">' + section.note + '</p>';
                }

                html += '<div class="overflow-x-auto"><table class="w-full text-xs">';
                html += '<thead class="bg-gray-50"><tr>';
                html += '<th class="py-2 px-3 text-left font-semibold text-gray-500">Misafir</th>';
                html += '<th class="py-2 px-3 text-center font-semibold text-gray-500">Giriş</th>';
                html += '<th class="py-2 px-3 text-center font-semibold text-gray-500">Çıkış</th>';
                html += '<th class="py-2 px-3 text-center font-semibold text-gray-500">Gece</th>';
                html += '<th class="py-2 px-3 text-left font-semibold text-gray-500">Platform</th>';
                html += '<th class="py-2 px-3 text-right font-semibold text-gray-500">Tutar</th>';
                html += '<th class="py-2 px-3 text-right font-semibold text-gray-500">/Gece</th>';
                html += '</tr></thead><tbody>';

                let totalAmount = 0, totalNights = 0;

                section.reservations.forEach(function(res) {
                    const nights = res.nights || Math.max(1, Math.round((new Date(res.checkOut) - new Date(res.checkIn)) / 86400000));
                    const amount = res.totalPrice ?? res.totalAmount ?? 0;
                    const currency = res.currency || 'EUR';
                    const amountEUR = convertEUR(amount, currency);
                    const perNight = nights > 0 ? amountEUR / nights : 0;
                    totalAmount += amountEUR;
                    totalNights += nights;
                    const platformColor = (res.platform === 'Airbnb') ? 'bg-red-50 text-red-600' : (res.platform === 'Booking.com') ? 'bg-blue-50 text-blue-700' : 'bg-green-50 text-green-600';

                    html += '<tr class="border-t border-gray-100 hover:bg-gray-50">';
                    html += '<td class="py-2 px-3 font-medium text-gray-700">' + (res.guestName || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-gray-600">' + fmt(res.checkIn) + '</td>';
                    html += '<td class="py-2 px-3 text-center text-gray-600">' + fmt(res.checkOut) + '</td>';
                    html += '<td class="py-2 px-3 text-center font-semibold">' + nights + '</td>';
                    html += '<td class="py-2 px-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ' + platformColor + '">' + (res.platform || '-') + '</span></td>';
                    html += '<td class="py-2 px-3 text-right font-medium">\u20ac' + amountEUR.toFixed(2) + '</td>';
                    html += '<td class="py-2 px-3 text-right text-gray-500">\u20ac' + perNight.toFixed(2) + '</td>';
                    html += '</tr>';
                });

                // Total row
                const avgNightly = totalNights > 0 ? totalAmount / totalNights : 0;
                html += '<tr class="border-t-2 border-gray-300 font-bold bg-gray-50">';
                html += '<td class="py-2 px-3" colspan="2">TOPLAM</td>';
                html += '<td></td>';
                html += '<td class="py-2 px-3 text-center">' + totalNights + '</td>';
                html += '<td></td>';
                html += '<td class="py-2 px-3 text-right text-emerald-600">\u20ac' + totalAmount.toFixed(2) + '</td>';
                html += '<td class="py-2 px-3 text-right text-gray-500">\u20ac' + avgNightly.toFixed(2) + '</td>';
                html += '</tr>';
                html += '</tbody></table></div>';

                // Summary cards
                html += '<div class="flex gap-3 mt-3 flex-wrap">';
                html += '<div class="bg-emerald-50 px-3 py-2 rounded-lg text-xs"><span class="text-gray-500">Ort. Gecelik:</span> <strong class="text-emerald-700">\u20ac' + avgNightly.toFixed(2) + '</strong></div>';
                html += '<div class="bg-blue-50 px-3 py-2 rounded-lg text-xs"><span class="text-gray-500">Toplam Gece:</span> <strong class="text-blue-700">' + totalNights + '</strong></div>';
                html += '<div class="bg-amber-50 px-3 py-2 rounded-lg text-xs"><span class="text-gray-500">Rez. Sayısı:</span> <strong class="text-amber-700">' + section.reservations.length + '</strong></div>';
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';

            // Footer
            html += '<div class="p-4 border-t border-gray-100 flex justify-end">';
            html += '<button onclick="document.getElementById(\'projResDetailOverlay\').remove()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">Kapat</button>';
            html += '</div>';

            html += '</div></div>';

            // Remove existing overlay if any
            document.getElementById('projResDetailOverlay')?.remove();
            document.body.insertAdjacentHTML('beforeend', html);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        renderPlatformFilter(futureRes) {
            const select = document.getElementById('projPlatformFilter');
            if (!select) return;
            const platforms = [...new Set(futureRes.map(r => r.platform))];
            const current = select.value;
            select.innerHTML = '<option value="all">Tüm Platformlar</option>' +
                platforms.map(p => '<option value="' + p + '">' + p + '</option>').join('');
            select.value = current;
        },

        renderTable() {
            const el = document.getElementById('projResTable');
            if (!el) return;
            const today = new Date(); today.setHours(0,0,0,0);
            const platform = document.getElementById('projPlatformFilter')?.value || 'all';

            const filtered = this.reservations
                .filter(r => new Date(r.checkIn) >= today)
                .filter(r => platform === 'all' || r.platform === platform)
                .sort((a, b) => new Date(a.checkIn) - new Date(b.checkIn));

            if (filtered.length === 0) {
                el.innerHTML = '<p class="text-center py-8 text-sm text-gray-400">Gelecek rezervasyon yok</p>';
                return;
            }

            const fmt = d => { const dt = new Date(d); return dt.getDate() + '.' + (dt.getMonth()+1) + '.' + dt.getFullYear(); };
            const platformColor = p => {
                if (p === 'Airbnb') return 'bg-red-50 text-red-600';
                if (p === 'Booking.com') return 'bg-blue-50 text-blue-700';
                return 'bg-green-50 text-green-600';
            };

            el.innerHTML = '<table class="w-full text-xs">' +
                '<thead class="bg-gray-50 sticky top-0"><tr>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Daire</th>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Platform</th>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Misafir</th>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Giriş</th>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Çıkış</th>' +
                '<th class="text-right py-2 px-3 font-semibold text-gray-500">Gece</th>' +
                '<th class="text-right py-2 px-3 font-semibold text-gray-500">Toplam</th>' +
                '<th class="text-right py-2 px-3 font-semibold text-gray-500">/Gece</th>' +
                '</tr></thead><tbody>' +
                filtered.map(r =>
                    '<tr class="border-t border-gray-50 hover:bg-gray-50/50">' +
                    '<td class="py-2 px-3 font-medium text-gray-700">' + r.apartmentId + '</td>' +
                    '<td class="py-2 px-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ' + platformColor(r.platform) + '">' + r.platform + '</span></td>' +
                    '<td class="py-2 px-3 text-gray-500">' + (r.guestName || '-') + '</td>' +
                    '<td class="py-2 px-3 text-gray-600">' + fmt(r.checkIn) + '</td>' +
                    '<td class="py-2 px-3 text-gray-600">' + fmt(r.checkOut) + '</td>' +
                    '<td class="py-2 px-3 text-right text-gray-600">' + r.nights + '</td>' +
                    '<td class="py-2 px-3 text-right font-bold text-gray-800">\u20ac' + (r.totalPrice || 0).toFixed(2) + '</td>' +
                    '<td class="py-2 px-3 text-right text-gray-500">\u20ac' + (r.pricePerNight || 0).toFixed(2) + '</td></tr>'
                ).join('') +
                '</tbody></table>';
        },

        // ============================================================
        // APARTMENT MATCHING SYSTEM
        // ============================================================
        MAPPING_KEY: 'projAptMapping',

        loadMapping() {
            // Önce Analytics.data'dan (Drive sync), yoksa localStorage'dan
            try {
                if (Analytics.data?.aptMapping && Object.keys(Analytics.data.aptMapping).length > 0) {
                    return Analytics.data.aptMapping;
                }
                return JSON.parse(localStorage.getItem(this.MAPPING_KEY) || '{}');
            } catch { return {}; }
        },

        saveMapping(mapping) {
            localStorage.setItem(this.MAPPING_KEY, JSON.stringify(mapping));
            // Analytics.data'ya da yaz (Drive'a kaydedilecek)
            if (Analytics.data) {
                Analytics.data.aptMapping = mapping;
            }
        },

        // PMS'deki oda numaralarını alır
        getPmsApartmentIds() {
            return [...new Set(this.reservations.map(r => r.apartmentId))].sort();
        },

        // Analytics'teki daire listesi
        getAnalyticsApartments() {
            return (Analytics.data?.apartments || []).map(a => ({
                id: a.id,
                code: a.code,
                systemType: a.systemType,
                commission: a.lagirioCommission,
                taxRate: a.taxRate
            }));
        },

        // Otomatik eşleştirme: tam eşleşme veya normalize edilmiş eşleşme
        autoMatch(pmsIds, analyticsApts) {
            const mapping = this.loadMapping();
            const analyticsMap = {};
            analyticsApts.forEach(a => {
                analyticsMap[a.id] = a;
                analyticsMap[a.code] = a;
                // Normalize: boşluk/tire çıkar, küçük harf
                const normId = a.id.replace(/[\s\-_\.]/g, '').toLowerCase();
                const normCode = a.code.replace(/[\s\-_\.]/g, '').toLowerCase();
                if (!analyticsMap[normId]) analyticsMap[normId] = a;
                if (!analyticsMap[normCode]) analyticsMap[normCode] = a;
            });

            pmsIds.forEach(pmsId => {
                if (mapping[pmsId]) return; // zaten eşleştirilmiş

                // Tam eşleşme
                if (analyticsMap[pmsId]) {
                    mapping[pmsId] = analyticsMap[pmsId].id;
                    return;
                }
                // Normalize eşleşme
                const normPms = pmsId.replace(/[\s\-_\.]/g, '').toLowerCase();
                if (analyticsMap[normPms]) {
                    mapping[pmsId] = analyticsMap[normPms].id;
                    return;
                }
                // Sayısal eşleşme: "Oda 3" → "3", "D-03" → "03" vs.
                const pmsNum = pmsId.replace(/\D/g, '');
                if (pmsNum) {
                    const match = analyticsApts.find(a => {
                        const aNum = a.id.replace(/\D/g, '');
                        const cNum = a.code.replace(/\D/g, '');
                        return (aNum && aNum === pmsNum) || (cNum && cNum === pmsNum);
                    });
                    if (match) {
                        mapping[pmsId] = match.id;
                    }
                }
            });

            return mapping;
        },

        // Resolve: PMS apartmentId → Analytics apartment object
        resolveApartment(pmsAptId) {
            const mapping = this.loadMapping();
            const targetId = mapping[pmsAptId] || pmsAptId;
            return Analytics.data?.apartments?.find(a => a.id === targetId || a.code === targetId) || null;
        },

        // Eşleştirme durumunu kontrol et ve bar'ı göster/gizle
        checkMatchingStatus() {
            const pmsIds = this.getPmsApartmentIds();
            const analyticsApts = this.getAnalyticsApartments();
            if (pmsIds.length === 0 || analyticsApts.length === 0) {
                document.getElementById('projMatchingBar')?.classList.add('hidden');
                return;
            }

            const mapping = this.autoMatch(pmsIds, analyticsApts);
            this.saveMapping(mapping);

            const unmatched = pmsIds.filter(id => !mapping[id]);
            const bar = document.getElementById('projMatchingBar');
            const status = document.getElementById('projMatchingStatus');

            if (unmatched.length > 0) {
                if (bar) bar.classList.remove('hidden');
                if (status) status.textContent = unmatched.length + ' / ' + pmsIds.length + ' daire eşleşmedi';
            } else {
                if (bar) bar.classList.add('hidden');
            }
        },

        showMatchingModal() {
            const pmsIds = this.getPmsApartmentIds();
            const analyticsApts = this.getAnalyticsApartments();
            const mapping = this.loadMapping();

            const sysNames = { '1': 'S1', '2': 'S2', '3': 'S3', '4': 'S4', '5': 'S5', '6': 'S6', '7': 'S7', '8': 'S8', '9': 'S9' };

            const content = document.getElementById('aptMatchingContent');
            if (!content) return;

            if (pmsIds.length === 0) {
                content.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">PMS\'den yüklenen rezervasyon yok.</p>';
                Analytics.showModal('aptMatchingModal');
                return;
            }

            // Analytics apt seçenekleri
            const aptOptions = analyticsApts.map(a =>
                '<option value="' + a.id + '">' + a.code + ' (' + (sysNames[a.systemType] || '?') + ', %' + a.commission + ', KDV %' + a.taxRate + ')</option>'
            ).join('');

            let matched = 0;
            const rows = pmsIds.map(pmsId => {
                const isMatched = !!mapping[pmsId];
                const matchedApt = isMatched ? analyticsApts.find(a => a.id === mapping[pmsId]) : null;
                if (isMatched) matched++;

                const statusIcon = isMatched
                    ? '<span class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs font-bold">&#10003;</span>'
                    : '<span class="w-6 h-6 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-xs font-bold">?</span>';

                const matchInfo = isMatched && matchedApt
                    ? '<span class="text-[10px] text-emerald-600">' + (sysNames[matchedApt.systemType] || '?') + ' | %' + matchedApt.commission + ' | KDV %' + matchedApt.taxRate + '</span>'
                    : '<span class="text-[10px] text-red-400">Varsayılan: S3, %15, KDV %8</span>';

                return '<div class="flex items-center gap-3 p-2.5 rounded-lg border ' + (isMatched ? 'border-emerald-100 bg-emerald-50/30' : 'border-red-100 bg-red-50/30') + '">' +
                    statusIcon +
                    '<div class="flex-1 min-w-0">' +
                    '<div class="flex items-center gap-2">' +
                    '<span class="text-sm font-bold text-gray-700">' + pmsId + '</span>' +
                    '<i data-lucide="arrow-right" class="w-3.5 h-3.5 text-gray-300"></i>' +
                    '<select data-pms-id="' + pmsId + '" class="apt-match-select text-xs border border-gray-200 rounded-lg px-2 py-1 min-w-[200px] ' + (isMatched ? 'bg-emerald-50 border-emerald-200' : 'bg-white') + '" onchange="Projection.onMatchChange(this)">' +
                    '<option value="">-- Eşleştirme yok --</option>' +
                    aptOptions +
                    '</select></div>' +
                    matchInfo +
                    '</div></div>';
            }).join('');

            content.innerHTML = rows;

            // Mevcut eşleştirmeleri select'lere yansıt
            content.querySelectorAll('.apt-match-select').forEach(sel => {
                const pmsId = sel.dataset.pmsId;
                if (mapping[pmsId]) sel.value = mapping[pmsId];
            });

            const summary = document.getElementById('aptMatchingSummary');
            if (summary) summary.textContent = matched + ' / ' + pmsIds.length + ' eşleşti';

            Analytics.showModal('aptMatchingModal');

            // Admin ise Drive'a Kaydet butonunu göster
            const driveBtn = document.getElementById('aptMatchDriveBtn');
            if (driveBtn) {
                driveBtn.classList.toggle('hidden', !this.isAdmin());
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        onMatchChange(selectEl) {
            const pmsId = selectEl.dataset.pmsId;
            const row = selectEl.closest('.flex.items-center');
            const analyticsApts = this.getAnalyticsApartments();
            const sysNames = { '1': 'S1', '2': 'S2', '3': 'S3', '4': 'S4', '5': 'S5', '6': 'S6', '7': 'S7', '8': 'S8', '9': 'S9' };

            if (selectEl.value) {
                const apt = analyticsApts.find(a => a.id === selectEl.value);
                row.className = row.className.replace(/border-red-100 bg-red-50\/30/g, 'border-emerald-100 bg-emerald-50/30');
                selectEl.className = selectEl.className.replace('bg-white', 'bg-emerald-50 border-emerald-200');
                const infoSpan = row.querySelector('.text-\\[10px\\]');
                if (infoSpan && apt) {
                    infoSpan.className = 'text-[10px] text-emerald-600';
                    infoSpan.textContent = (sysNames[apt.systemType] || '?') + ' | %' + apt.commission + ' | KDV %' + apt.taxRate;
                }
            } else {
                row.className = row.className.replace(/border-emerald-100 bg-emerald-50\/30/g, 'border-red-100 bg-red-50/30');
                selectEl.className = selectEl.className.replace('bg-emerald-50 border-emerald-200', 'bg-white');
                const infoSpan = row.querySelector('.text-\\[10px\\]');
                if (infoSpan) {
                    infoSpan.className = 'text-[10px] text-red-400';
                    infoSpan.textContent = 'Varsayılan: S3, %15, KDV %8';
                }
            }

            // Sayacı güncelle
            const allSelects = document.querySelectorAll('.apt-match-select');
            const matchedCount = [...allSelects].filter(s => s.value).length;
            const summary = document.getElementById('aptMatchingSummary');
            if (summary) summary.textContent = matchedCount + ' / ' + allSelects.length + ' eşleşti';
        },

        adminAuthenticated: false,

        // Basit hash fonksiyonu (SHA-256 benzeri, güvenlik için yeterli)
        async hashPin(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin + '_lagirio_salt_2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        },

        async adminLogin() {
            const input = document.getElementById('adminPinInput');
            const pin = input?.value?.trim();
            if (!pin) return;

            const storedHash = Analytics.data?.adminPinHash;
            if (!storedHash) {
                // İlk kez şifre belirleniyor
                const hash = await this.hashPin(pin);
                if (!Analytics.data) Analytics.data = {};
                Analytics.data.adminPinHash = hash;
                this.adminAuthenticated = true;

                // Drive'a kaydet
                if (GoogleDrive.accessToken && GoogleDrive.getConfig().fileId) {
                    await GoogleDrive.saveToDrive();
                }

                if (typeof Analytics.showToast === 'function') {
                    Analytics.showToast('Admin şifresi oluşturuldu ve giriş yapıldı!', 'success');
                }
            } else {
                const hash = await this.hashPin(pin);
                if (hash === storedHash) {
                    this.adminAuthenticated = true;
                    if (typeof Analytics.showToast === 'function') {
                        Analytics.showToast('Admin girişi başarılı!', 'success');
                    }
                } else {
                    this.adminAuthenticated = false;
                    if (typeof Analytics.showToast === 'function') {
                        Analytics.showToast('Yanlış şifre!', 'error');
                    }
                }
            }

            if (input) input.value = '';
            const statusEl = document.getElementById('adminStatusText');
            if (statusEl) {
                statusEl.textContent = this.adminAuthenticated ? 'Admin oturumu aktif' : 'Yanlış şifre';
                statusEl.className = 'text-xs ' + (this.adminAuthenticated ? 'text-emerald-600 font-semibold' : 'text-red-500');
            }
        },

        adminLogout() {
            this.adminAuthenticated = false;
            const statusEl = document.getElementById('adminStatusText');
            if (statusEl) {
                statusEl.textContent = 'Admin oturumu kapatıldı';
                statusEl.className = 'text-xs text-gray-400';
            }
            if (typeof Analytics.showToast === 'function') {
                Analytics.showToast('Admin oturumu kapatıldı', 'info');
            }
        },

        async changeAdminPin() {
            if (!this.adminAuthenticated) {
                if (typeof Analytics.showToast === 'function') {
                    Analytics.showToast('Önce admin girişi yapın!', 'error');
                }
                return;
            }
            const input = document.getElementById('newAdminPinInput');
            const newPin = input?.value?.trim();
            if (!newPin || newPin.length < 4) {
                if (typeof Analytics.showToast === 'function') {
                    Analytics.showToast('Şifre en az 4 karakter olmalı!', 'error');
                }
                return;
            }
            const hash = await this.hashPin(newPin);
            Analytics.data.adminPinHash = hash;

            if (GoogleDrive.accessToken && GoogleDrive.getConfig().fileId) {
                await GoogleDrive.saveToDrive();
            }

            if (input) input.value = '';
            if (typeof Analytics.showToast === 'function') {
                Analytics.showToast('Admin şifresi değiştirildi!', 'success');
            }
        },

        isAdmin() {
            return this.adminAuthenticated;
        },

        saveMatching() {
            const mapping = {};
            document.querySelectorAll('.apt-match-select').forEach(sel => {
                const pmsId = sel.dataset.pmsId;
                if (sel.value) mapping[pmsId] = sel.value;
            });
            this.saveMapping(mapping);
            Analytics.closeModal('aptMatchingModal');

            // Yeniden hesapla
            this.calculate();

            if (typeof Analytics.showToast === 'function') {
                const count = Object.keys(mapping).length;
                Analytics.showToast(count + ' daire eşleştirmesi kaydedildi!', 'success');
            }
        },

        async saveMatchingToDrive() {
            if (!this.isAdmin()) {
                if (typeof Analytics.showToast === 'function') {
                    Analytics.showToast('Drive\'a kaydetme yetkisi sadece admin kullanıcılara aittir.', 'error');
                }
                return;
            }

            // Önce mapping'i kaydet
            const mapping = {};
            document.querySelectorAll('.apt-match-select').forEach(sel => {
                const pmsId = sel.dataset.pmsId;
                if (sel.value) mapping[pmsId] = sel.value;
            });
            this.saveMapping(mapping);

            // Drive'a kaydet
            if (GoogleDrive.accessToken && GoogleDrive.getConfig().fileId) {
                await GoogleDrive.saveToDrive();
            }

            Analytics.closeModal('aptMatchingModal');
            this.calculate();

            if (typeof Analytics.showToast === 'function') {
                Analytics.showToast('Eşleştirme Drive\'a kaydedildi! Tüm kullanıcılar görecek.', 'success');
            }
        }
    };

    // Main Analytics Application
    const Analytics = {
        // Data properties
        data: null,
        filteredData: null,
        charts: {},
        
        // State properties
        currentMainTab: 'overview',
        currentAnalysisTab: 'system',
        comparisonType: 'apartments',
        comparisonMode: 'apartment-apartment',
        comparisonSelections: {
            groupA: { apartments: [], period: null },
            groupB: { apartments: [], period: null }
        },
        notifications: [],
        settings: {
            darkMode: false,
            animations: true,
            compactView: false,
            defaultCurrency: 'EUR',
            dateFormat: 'DD/MM/YYYY',
            lowOccupancyThreshold: 30,
            highExpenseThreshold: 500
        },
        
        // Filter properties
        dateFilter: {
            start: null,
            end: null
        },
        
        // Cache for performance
        cache: {
            calculations: new Map(),
            lastUpdate: null
        },
        
        // Initialize the application
        init() {
            this.setupEventListeners();
            this.loadSettings();
            this.initializeTooltips();
            this.checkNotifications();
        },
        
        // Setup all event listeners
        setupEventListeners() {
            // File upload handlers
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-emerald-500', 'bg-emerald-50/50');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-emerald-500', 'bg-emerald-50/50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-emerald-500', 'bg-emerald-50/50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    this.handleFile(e.target.files[0]);
                }
            });
            
            // Date preset change handler
            document.getElementById('datePreset').addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    document.getElementById('customDateRange').classList.remove('hidden');
                } else {
                    document.getElementById('customDateRange').classList.add('hidden');
                    this.applyDatePreset(e.target.value);
                }
            });
            
            // Exchange rate change handlers
            document.getElementById('exchangeRateTL').addEventListener('change', () => {
                if (this.data) this.refreshData();
            });
            
            document.getElementById('exchangeRateUSD').addEventListener('change', () => {
                if (this.data) this.refreshData();
            });
            
            // Comparison type change handler
            const comparisonType = document.getElementById('comparisonType');
            if (comparisonType) {
                comparisonType.addEventListener('change', (e) => {
                    this.handleComparisonTypeChange(e.target.value);
                });
            }
            
            // Trend period change handler
            const trendPeriod = document.getElementById('trendPeriod');
            if (trendPeriod) {
                trendPeriod.addEventListener('change', () => {
                    this.updateRevenueTrendChart();
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + E: Export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    this.quickExport();
                }
                // Ctrl/Cmd + R: Refresh (without page reload)
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    this.refreshData();
                }
                // Ctrl/Cmd + F: Fullscreen
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    this.toggleFullscreen();
                }
                // ESC: Close modals
                if (e.key === 'Escape') {
                    this.closeAllModals();
                }
            });
            
            // Window resize handler for responsive charts
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    this.resizeAllCharts();
                }, 250);
            });
        },
        
        // File handling
        handleFile(file) {
            if (file.type !== 'application/json') {
                this.showToast('Lütfen geçerli bir JSON dosyası seçin!', 'error');
                return;
            }
            
            this.showLoading();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    this.data = JSON.parse(e.target.result);
                    this.validateData();
                    this.filteredData = this.data;
                    this.processData();
                    this.showToast('Veri başarıyla yüklendi!', 'success');
                } catch (error) {
                    this.showToast('Dosya okuma hatası: ' + error.message, 'error');
                    console.error('File parsing error:', error);
                } finally {
                    this.hideLoading();
                }
            };
            
            reader.onerror = () => {
                this.hideLoading();
                this.showToast('Dosya okuma hatası!', 'error');
            };
            
            reader.readAsText(file);
        },
        
        // Data validation
        validateData() {
            if (!this.data) {
                throw new Error('Veri bulunamadı');
            }
            
            const requiredFields = ['apartments', 'reservations'];
            for (const field of requiredFields) {
                if (!this.data[field]) {
                    throw new Error(`Gerekli alan eksik: ${field}`);
                }
            }
            
            // Set default empty arrays for optional fields
            this.data.expenses = this.data.expenses || [];
            this.data.categories = this.data.categories || [];
            this.data.capitalExpenses = this.data.capitalExpenses || [];
            this.data.lagirioExpenses = this.data.lagirioExpenses || [];

        },
        
        // Load sample data for testing
        loadSampleData() {
            this.showLoading();
            
            // Gerçekçi örnek veri oluştur
            const sampleData = {
                apartments: [
                    { id: '1', code: '101-A', location: 'Kadıköy', ownerName: 'Ahmet Yılmaz', systemType: '3', lagirioCommission: 15, taxRate: 8, incomeTaxRate: 20, stopajRate: 0 },
                    { id: '2', code: '102-B', location: 'Beşiktaş', ownerName: 'Mehmet Kaya', systemType: '2', lagirioCommission: 18, taxRate: 8, incomeTaxRate: 0, stopajRate: 0 },
                    { id: '3', code: '201-A', location: 'Şişli', ownerName: 'Ayşe Demir', systemType: '5', lagirioCommission: 12, taxRate: 8, incomeTaxRate: 0, stopajRate: 20 },
                    { id: '4', code: '201-B', location: 'Kadıköy', ownerName: 'Fatma Öz', systemType: '1', lagirioCommission: 100, taxRate: 8, incomeTaxRate: 0, stopajRate: 0 },
                    { id: '5', code: '301-A', location: 'Beyoğlu', ownerName: 'Ali Şahin', systemType: '4', lagirioCommission: 16, taxRate: 8, incomeTaxRate: 20, stopajRate: 0 }
                ],
                reservations: [],
                expenses: [],
                categories: ['Temizlik', 'Elektrik', 'Su', 'İnternet', 'Yönetim', 'Bakım', 'Diğer'],
                capitalExpenses: []
            };
            
            // Generate realistic reservations for the past 6 months
            const platforms = ['Booking.com', 'Airbnb', 'Direkt'];
            const paymentMethods = ['Banka', 'Nakit'];
            const today = new Date();
            
            for (let monthOffset = 5; monthOffset >= 0; monthOffset--) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() - monthOffset, 1);
                
                sampleData.apartments.forEach(apartment => {
                    // Generate 3-8 reservations per apartment per month
                    const reservationCount = Math.floor(Math.random() * 6) + 3;
                    let currentDay = 1;
                    
                    for (let i = 0; i < reservationCount; i++) {
                        const checkInDay = currentDay + Math.floor(Math.random() * 3);
                        const stayLength = Math.floor(Math.random() * 5) + 2; // 2-7 nights
                        
                        const checkIn = new Date(monthDate.getFullYear(), monthDate.getMonth(), checkInDay);
                        const checkOut = new Date(monthDate.getFullYear(), monthDate.getMonth(), checkInDay + stayLength);
                        
                        const platform = platforms[Math.floor(Math.random() * platforms.length)];
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
                        const nightlyRate = 100 + Math.floor(Math.random() * 150); // €100-250 per night
                        const totalAmount = nightlyRate * stayLength;
                        const platformCommission = platform === 'Direkt' ? 0 : totalAmount * 0.15;
                        
                        sampleData.reservations.push({
                            id: `res_${apartment.id}_${monthOffset}_${i}`,
                            apartmentId: apartment.id,
                            guestName: `Guest ${Math.floor(Math.random() * 1000)}`,
                            checkIn: checkIn.toISOString().split('T')[0],
                            checkOut: checkOut.toISOString().split('T')[0],
                            platform: platform,
                            totalAmount: totalAmount,
                            platformCommission: platformCommission,
                            paymentMethod: paymentMethod,
                            currency: 'EUR'
                        });
                        
                        currentDay = checkInDay + stayLength + Math.floor(Math.random() * 3); // Gap between reservations
                        if (currentDay > 28) break; // Don't exceed month
                    }
                    
                    // Generate expenses for each apartment
                    const expenseCount = Math.floor(Math.random() * 4) + 2; // 2-5 expenses per month
                    for (let i = 0; i < expenseCount; i++) {
                        const category = sampleData.categories[Math.floor(Math.random() * sampleData.categories.length)];
                        const amount = 50 + Math.floor(Math.random() * 200); // 50-250 TL
                        
                        sampleData.expenses.push({
                            id: `exp_${apartment.id}_${monthOffset}_${i}`,
                            category: category,
                            amount: amount,
                            currency: 'TL',
                            date: new Date(monthDate.getFullYear(), monthDate.getMonth(), 15).toISOString().split('T')[0],
                            apartmentId: apartment.id
                        });
                    }
                });
            }
            
            setTimeout(() => {
                this.data = sampleData;
                this.filteredData = sampleData;
                this.processData();
                this.showToast('Örnek veri yüklendi!', 'success');
                this.hideLoading();
            }, 500);
        },
        
        processData() {
            console.log('📦 processData başladı');

            // DEBUG: Sistem tipine göre gider dökümü
            if (this.data?.apartments && this.data?.expenses) {
                console.log('🔍 === GİDER DEBUG BAŞLANGIÇ ===');
                console.log('Toplam gider kaydı:', this.data.expenses.length);
                const systemGroups = {};
                this.data.apartments.forEach(apt => {
                    const sys = apt.systemType || '?';
                    if (!systemGroups[sys]) systemGroups[sys] = { apartments: [], totalExpenses: 0, expenseCount: 0 };
                    const aptExpenses = this.data.expenses.filter(e => e.apartmentId === apt.id);
                    const aptTotal = aptExpenses.reduce((s, e) => s + this.convertToEUR(e.amount, e.currency), 0);
                    // Aylık kırılım hesapla
                    const monthlyBreakdown = {};
                    aptExpenses.forEach(e => {
                        const d = new Date(e.date);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyBreakdown[key]) monthlyBreakdown[key] = { count: 0, totalEUR: 0, items: [] };
                        const eur = this.convertToEUR(e.amount, e.currency);
                        monthlyBreakdown[key].count++;
                        monthlyBreakdown[key].totalEUR += eur;
                        monthlyBreakdown[key].items.push({ amount: e.amount, currency: e.currency, eur, category: e.category, date: e.date });
                    });

                    systemGroups[sys].apartments.push({
                        code: apt.code, id: apt.id,
                        expenseCount: aptExpenses.length,
                        totalEUR: Math.round(aptTotal * 100) / 100,
                        currencies: [...new Set(aptExpenses.map(e => e.currency))],
                        monthlyBreakdown
                    });
                    systemGroups[sys].totalExpenses += aptTotal;
                    systemGroups[sys].expenseCount += aptExpenses.length;
                });
                // Sadece Sistem 2 (Kişi Şirketi) göster
                Object.entries(systemGroups).filter(([sys]) => sys === '2').forEach(([sys, data]) => {
                    console.log(`\n📊 Sistem ${sys}: ${data.apartments.length} daire, ${data.expenseCount} gider, toplam €${Math.round(data.totalExpenses)}`);
                    data.apartments.forEach(a => {
                        console.log(`   ${a.code} (${a.id}): ${a.expenseCount} gider = €${a.totalEUR} [${a.currencies.join(',')}]`);
                        if (a.monthlyBreakdown) {
                            Object.keys(a.monthlyBreakdown).sort().forEach(month => {
                                const m = a.monthlyBreakdown[month];
                                console.log(`      ${month}: ${m.count} gider = €${m.totalEUR.toFixed(2)}`);
                                m.items.forEach(e => console.log(`        - ${e.amount} ${e.currency} → €${e.eur.toFixed(2)} | ${e.category} (${e.date})`));
                            });
                        }
                    });
                });
                // Eşleşmeyen giderler (apartmentId'si hiçbir daireye ait olmayan)
                const aptIds = new Set(this.data.apartments.map(a => a.id));
                const orphanExpenses = this.data.expenses.filter(e => !aptIds.has(e.apartmentId));
                if (orphanExpenses.length > 0) {
                    console.log(`\n⚠️ UYARI: ${orphanExpenses.length} gider hiçbir daireyle eşleşmiyor!`);
                    orphanExpenses.slice(0, 5).forEach(e => console.log(`   apartmentId: "${e.apartmentId}", amount: ${e.amount} ${e.currency}`));
                }
                console.log('🔍 === GİDER DEBUG BİTİŞ ===');
            }
            
            // Hide upload section
            document.getElementById('uploadSection').classList.add('hidden');
            
            // Show main dashboard
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            // Clear cache
            this.cache.calculations.clear();
            this.cache.lastUpdate = Date.now();
            
            // Initialize dashboard
            this.updateAllMetrics();
            this.populateSelectors();
            this.generateNotifications();
            this.renderCompanyExpenses();

            // Şirket gideri tarih alanını bugüne set et
            const compExpDate = document.getElementById('compExpDate');
            if (compExpDate && !compExpDate.value) compExpDate.valueAsDate = new Date();
            
            // ✅ Grafikleri gecikmeyle çiz
            setTimeout(() => {
                console.log('🎨 Grafikler çiziliyor...');
                this.initializeCharts();
                
                // Grafikleri resize et
                setTimeout(() => {
                    Object.values(this.charts).forEach(chart => {
                        if (chart && chart.resize) {
                            chart.resize();
                        }
                    });
                    console.log('✅ Toplam grafik:', Object.keys(this.charts).length);
                }, 200);
                
                lucide.createIcons();
            }, 300);
        },
                
        updateAllMetrics() {
            this.updateQuickStats();
            this.updateKPICards();
            this.updatePerformanceMetrics();
            // this.updateTopPerformers(); // ← YORUMA AL (performanceMetrics içinde zaten var)
            this.updateSystemCards();
            this.updateRecentActivity();
            this.updateAlerts();
            this.updateEfficiencyMetrics();
            
            // Grafikleri yeniden çiz
            if (Object.keys(this.charts).length > 0) {
                this.resizeAllCharts();
            }
        },
        // Update trend indicators
        updateTrendIndicators(stats) {
            // Portfolio trend calculation
            const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
            const portfolioTrend = lastMonthRevenue > 0 ? 
                ((stats.totalPortfolio - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
            
            const trendElement = document.getElementById('portfolioTrend');
            if (trendElement) {
                trendElement.textContent = portfolioTrend > 0 ? `+${portfolioTrend}%` : 
                                        portfolioTrend < 0 ? `${portfolioTrend}%` : '→';
                trendElement.className = portfolioTrend > 0 ? 'text-xs text-emerald-600 font-semibold' :
                                        portfolioTrend < 0 ? 'text-xs text-red-600 font-semibold' :
                                        'text-xs text-gray-600 font-semibold';
            }
            
            // Monthly trend
            const monthlyTrend = this.calculateMonthlyTrend();
            const monthlyTrendElement = document.getElementById('monthlyTrend');
            if (monthlyTrendElement) {
                monthlyTrendElement.textContent = monthlyTrend.icon;
                monthlyTrendElement.className = `text-xs font-semibold ${monthlyTrend.color}`;
            }
            
            // Occupancy indicator
            const occupancyIndicator = document.getElementById('occupancyIndicator');
            if (occupancyIndicator) {
                const lastMonthOccupancy = this.calculateAverageOccupancy(-1);
                const occupancyDiff = stats.avgOccupancy - lastMonthOccupancy;
                occupancyIndicator.textContent = occupancyDiff > 5 ? '↑' :
                                                occupancyDiff < -5 ? '↓' : '→';
                occupancyIndicator.className = occupancyDiff > 5 ? 'text-xs text-emerald-600' :
                                            occupancyDiff < -5 ? 'text-xs text-red-600' :
                                            'text-xs text-orange-600';
            }
        },
        
        // Update quick stats in header and cards
        // Update quick stats in header and cards
        updateQuickStats() {
            const stats = this.calculateQuickStats();
            
            // Header stats
            document.getElementById('headerPortfolioValue').textContent = `€${stats.totalPortfolio.toLocaleString()}`;
            document.getElementById('headerMonthlyValue').textContent = `€${stats.monthlyRevenue.toLocaleString()}`;
            
            // KPI Cards
            document.getElementById('totalPortfolioValue').textContent = `€${stats.totalPortfolio.toLocaleString()}`;
            document.getElementById('monthlyRevenue').textContent = `€${stats.monthlyRevenue.toLocaleString()}`;
            document.getElementById('activeProperties').textContent = `${stats.activeProperties}/${stats.totalProperties}`;
            document.getElementById('avgOccupancy').textContent = `${stats.avgOccupancy.toFixed(1)}%`;
            document.getElementById('bestSystem').textContent = `Sistem ${stats.bestSystem.id}`;
            document.getElementById('systemProfit').textContent = `€${stats.bestSystem.profit.toLocaleString()}`;
            
            // Update trends and indicators
            this.updateTrendIndicators(stats); // ← Çağrı burada
            
            // Update progress bars
            const portfolioProgress = document.getElementById('portfolioProgress');
            if (portfolioProgress) {
                const progressPercent = Math.min(100, (stats.monthlyRevenue / stats.monthlyTarget) * 100);
                portfolioProgress.style.width = `${progressPercent}%`;
            }
            
            // Active percentage badge
            const activePercentage = (stats.activeProperties / stats.totalProperties * 100).toFixed(0);
            document.getElementById('activePercentage').textContent = `${activePercentage}%`;
            
            // Notification count
            document.getElementById('notificationCount').textContent = this.notifications.length;
        },

        // ✅ BURAYA EKLE (updateQuickStats fonksiyonunun DIŞINDA)
        updateTrendIndicators(stats) {
            // Portfolio trend
            const trendElement = document.getElementById('portfolioTrend');
            if (trendElement) {
                const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
                const portfolioTrend = lastMonthRevenue > 0 ? 
                    ((stats.totalPortfolio - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
                
                trendElement.textContent = portfolioTrend > 0 ? `+${portfolioTrend}%` : 
                                        portfolioTrend < 0 ? `${portfolioTrend}%` : '→';
                trendElement.className = portfolioTrend > 0 ? 'text-xs text-emerald-600 font-semibold' :
                                        portfolioTrend < 0 ? 'text-xs text-red-600 font-semibold' :
                                        'text-xs text-gray-600 font-semibold';
            }
        },

        // Şirket giderleri toplamı (opsiyonel tarih filtresi)
        getLagirioExpensesTotal(startDate, endDate) {
            const exps = this.data?.lagirioExpenses || [];
            return exps
                .filter(e => {
                    if (!startDate && !endDate) return true;
                    const d = new Date(e.date);
                    if (startDate && d < new Date(startDate)) return false;
                    if (endDate && d > new Date(endDate)) return false;
                    return true;
                })
                .reduce((sum, e) => sum + this.convertToEUR(e.amount, e.currency), 0);
        },

        // Aylık şirket giderleri toplamı
        getLagirioExpensesForMonth(month, year) {
            return (this.data?.lagirioExpenses || [])
                .filter(e => {
                    const d = new Date(e.date);
                    return d.getMonth() === month && d.getFullYear() === year;
                })
                .reduce((sum, e) => sum + this.convertToEUR(e.amount, e.currency), 0);
        },

        // Şirket gideri ekleme
        addCompanyExpense() {
            const date = document.getElementById('compExpDate')?.value;
            const category = document.getElementById('compExpCategory')?.value;
            const description = document.getElementById('compExpDesc')?.value?.trim();
            const amount = parseFloat(document.getElementById('compExpAmount')?.value);
            const currency = document.getElementById('compExpCurrency')?.value || 'EUR';

            if (!date || !category || !amount || amount <= 0) {
                this.showToast('Tarih, kategori ve tutar zorunludur!', 'error');
                return;
            }

            if (!this.data) this.data = {};
            if (!this.data.lagirioExpenses) this.data.lagirioExpenses = [];

            this.data.lagirioExpenses.push({
                id: Date.now(),
                date,
                category,
                description: description || '',
                amount,
                currency
            });

            // Formu temizle
            document.getElementById('compExpDesc').value = '';
            document.getElementById('compExpAmount').value = '';

            this.renderCompanyExpenses();
            this.showToast('Şirket gideri eklendi!', 'success');
        },

        deleteCompanyExpense(id) {
            if (!this.data?.lagirioExpenses) return;
            this.data.lagirioExpenses = this.data.lagirioExpenses.filter(e => e.id !== id);
            this.renderCompanyExpenses();
            this.showToast('Gider silindi', 'info');
        },

        renderCompanyExpenses() {
            const el = document.getElementById('companyExpList');
            const totalEl = document.getElementById('companyExpTotal');
            if (!el) return;

            const exps = (this.data?.lagirioExpenses || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const total = exps.reduce((s, e) => s + this.convertToEUR(e.amount, e.currency), 0);

            if (totalEl) totalEl.textContent = 'Toplam: \u20ac' + total.toFixed(2);

            if (exps.length === 0) {
                el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Henüz şirket gideri yok</p>';
                return;
            }

            const catNames = { 'Ofis': 'Ofis', 'Personel': 'Personel', 'Yazilim': 'Yazılım', 'Pazarlama': 'Pazarlama', 'Ulasim': 'Ulaşım', 'Vergi': 'Vergi', 'Sigorta': 'Sigorta', 'Diger': 'Diğer' };
            const catColors = { 'Ofis': 'bg-blue-100 text-blue-700', 'Personel': 'bg-purple-100 text-purple-700', 'Yazilim': 'bg-cyan-100 text-cyan-700', 'Pazarlama': 'bg-pink-100 text-pink-700', 'Ulasim': 'bg-amber-100 text-amber-700', 'Vergi': 'bg-red-100 text-red-700', 'Sigorta': 'bg-green-100 text-green-700', 'Diger': 'bg-gray-100 text-gray-700' };

            const fmt = d => { const dt = new Date(d); return dt.getDate() + '.' + (dt.getMonth()+1) + '.' + dt.getFullYear(); };

            el.innerHTML = '<table class="w-full text-xs">' +
                '<thead class="bg-gray-50 sticky top-0"><tr>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Tarih</th>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Kategori</th>' +
                '<th class="text-left py-2 px-3 font-semibold text-gray-500">Açıklama</th>' +
                '<th class="text-right py-2 px-3 font-semibold text-gray-500">Tutar</th>' +
                '<th class="text-right py-2 px-3 font-semibold text-gray-500 w-10"></th>' +
                '</tr></thead><tbody>' +
                exps.map(e =>
                    '<tr class="border-t border-gray-50 hover:bg-gray-50/50">' +
                    '<td class="py-2 px-3 text-gray-600">' + fmt(e.date) + '</td>' +
                    '<td class="py-2 px-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ' + (catColors[e.category] || 'bg-gray-100 text-gray-700') + '">' + (catNames[e.category] || e.category) + '</span></td>' +
                    '<td class="py-2 px-3 text-gray-500">' + (e.description || '-') + '</td>' +
                    '<td class="py-2 px-3 text-right font-medium text-gray-800">' + (e.currency === 'EUR' ? '\u20ac' : e.currency === 'TL' ? '\u20ba' : '$') + e.amount.toFixed(2) + '</td>' +
                    '<td class="py-2 px-3 text-right"><button onclick="Analytics.deleteCompanyExpense(' + e.id + ')" class="text-red-300 hover:text-red-500 transition" title="Sil">\u00d7</button></td>' +
                    '</tr>'
                ).join('') +
                '</tbody></table>';
        },

        // Calculate quick statistics
        calculateQuickStats() {
            const cacheKey = 'quickStats';
            if (this.cache.calculations.has(cacheKey)) {
                return this.cache.calculations.get(cacheKey);
            }
            
            const stats = {
                totalPortfolio: 0,
                monthlyRevenue: 0,
                totalProperties: this.data.apartments?.length || 0,
                activeProperties: 0,
                avgOccupancy: 0,
                bestSystem: { id: '-', profit: 0 },
                monthlyTarget: 10000 // Default target
            };
            
            // Calculate total portfolio value
            this.data.apartments?.forEach(apartment => {
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                stats.totalPortfolio += revenue;
                
                if (reservations.length > 0) {
                    stats.activeProperties++;
                }
            });
            
            // Calculate monthly revenue
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            this.data.apartments?.forEach(apartment => {
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                           date.getMonth() === currentMonth &&
                           date.getFullYear() === currentYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                           date.getMonth() === currentMonth &&
                           date.getFullYear() === currentYear;
                }) || [];
                
                stats.monthlyRevenue += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            // Calculate average occupancy
            let totalOccupancy = 0;
            let occupancyCount = 0;
            
            this.data.apartments?.forEach(apartment => {
                const occupancy = this.calculateOccupancyRate(apartment.id);
                if (occupancy > 0) {
                    totalOccupancy += occupancy;
                    occupancyCount++;
                }
            });
            
            stats.avgOccupancy = occupancyCount > 0 ? totalOccupancy / occupancyCount : 0;
            
            // Find best performing system
            const systemRevenues = {};
            
            this.data.apartments?.forEach(apartment => {
                const systemType = apartment.systemType;
                if (!systemRevenues[systemType]) {
                    systemRevenues[systemType] = 0;
                }
                
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                systemRevenues[systemType] += this.calculateLagirioRevenue(apartment, reservations, expenses);
            });
            
            Object.entries(systemRevenues).forEach(([system, revenue]) => {
                if (revenue > stats.bestSystem.profit) {
                    stats.bestSystem = { id: system, profit: revenue };
                }
            });
            
            this.cache.calculations.set(cacheKey, stats);
            return stats;
        },
        // 1. Para birimi dönüştürme
        convertToEUR(amount, currency) {
            const tlRate = parseFloat(document.getElementById('exchangeRateTL')?.value) || 48.5;
            const usdRate = parseFloat(document.getElementById('exchangeRateUSD')?.value) || 0.86;
            
            const rates = {
                EUR: 1,
                '€': 1,
                USD: usdRate,
                '$': usdRate,
                TL: 1 / tlRate,
                '₺': 1 / tlRate
            };
            
            return amount * (rates[currency] || 1);
        },

        // 2. Lagirio kazancı hesaplama
        calculateLagirioRevenue(apartment, reservations, expenses = []) {
            // Banka/Nakit ayrımı
            const bank = reservations.filter(r => r.paymentMethod !== 'Nakit');
            const cash = reservations.filter(r => r.paymentMethod === 'Nakit');

            // Gelir hesaplama
            const bankIncome = bank.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            const cashIncome = cash.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            const totalIncome = bankIncome + cashIncome;

            // Platform komisyonları
            const bankCommission = bank.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
            const cashCommission = cash.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
            const totalPlatformCommission = bankCommission + cashCommission;

            // Giderler
            const totalExpenses = expenses.reduce((sum, exp) => 
                sum + this.convertToEUR(exp.amount, exp.currency), 0);

            // KDV hesaplaması - SİSTEM BAZLI
            let totalKDV = 0;
            switch(apartment.systemType) {
                case '1':
                case '3':
                case '4':
                case '5':
                case '9': // Sistem 9 - KDV var
                    totalKDV = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    break;
                case '7':
                    const system7BookingDirect = reservations.filter(r => r.platform !== 'Airbnb');
                    const bookingDirectBank = system7BookingDirect.filter(r => r.paymentMethod !== 'Nakit');
                    const bookingBankIncome = bookingDirectBank.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    totalKDV = bookingBankIncome * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    break;
                default:
                    totalKDV = 0;
            }

            // Sistem bazlı Lagirio kazancı hesaplama
            let lagirioProfit = 0;

            switch(apartment.systemType) {
                case '1': // Sistem 1 - Net kar Lagirio'nun
                    lagirioProfit = totalIncome - bankCommission - cashCommission - totalExpenses - totalKDV;
                    break;

                case '2': // Sistem 2 - Komisyonlar Lagirio'nun
                    const bankLagirioComm2 = bankIncome * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform2 = cashIncome - cashCommission;
                    const cashLagirioComm2 = cashAfterPlatform2 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm2 + cashLagirioComm2;
                    break;

                case '3': // Sistem 3
                    const afterDeductions3 = bankIncome - totalExpenses - totalKDV - bankCommission;
                    const bankLagirioComm3 = afterDeductions3 * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform3 = cashIncome - cashCommission;
                    const cashLagirioComm3 = cashAfterPlatform3 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm3 + cashLagirioComm3;
                    break;

                case '4': // Sistem 4
                    const afterPlatform4 = bankIncome - bankCommission;
                    const bankLagirioComm4 = afterPlatform4 * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform4 = cashIncome - cashCommission;
                    const cashLagirioComm4 = cashAfterPlatform4 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm4 + cashLagirioComm4;
                    break;

                case '5': // Sistem 5 - Stopajlı
                    const afterPlatform5 = bankIncome - bankCommission;
                    const bankLagirioComm5 = afterPlatform5 * (apartment.lagirioCommission / 100);
                    const cashAfterPlatform5 = cashIncome - cashCommission;
                    const cashLagirioComm5 = cashAfterPlatform5 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm5 + cashLagirioComm5;
                    break;

                case '6': // Sistem 6 - Platform Ayrımlı
                    const netIncome6 = totalIncome - totalPlatformCommission - totalExpenses;
                    lagirioProfit = netIncome6 * (apartment.lagirioCommission / 100);
                    break;

                case '7': // Sistem 7 - Karma Platform
                    const airbnbRes = reservations.filter(r => r.platform === 'Airbnb');
                    const otherRes = reservations.filter(r => r.platform !== 'Airbnb');
                    
                    // Airbnb hesaplamaları
                    const airbnbIncome = airbnbRes.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const airbnbComm = airbnbRes.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const airbnbAfterPlatform = airbnbIncome - airbnbComm;
                    const airbnbLagirioComm = airbnbAfterPlatform * (apartment.lagirioCommission / 100);
                    
                    // Booking/Direct - Banka
                    const bookingBank = otherRes.filter(r => r.paymentMethod !== 'Nakit');
                    const bookingBankIncome7 = bookingBank.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingBankComm = bookingBank.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingBankAfterPlatform = bookingBankIncome7 - bookingBankComm;
                    const bookingBankLagirioComm = bookingBankAfterPlatform * (apartment.lagirioCommission / 100);
                    
                    // Booking/Direct - Nakit
                    const bookingCash = otherRes.filter(r => r.paymentMethod === 'Nakit');
                    const bookingCashIncome = bookingCash.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingCashComm = bookingCash.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingCashAfterPlatform = bookingCashIncome - bookingCashComm;
                    const bookingCashLagirioComm = bookingCashAfterPlatform * (apartment.lagirioCommission / 100);
                    
                    lagirioProfit = airbnbLagirioComm + bookingBankLagirioComm + bookingCashLagirioComm;
                    break;

                case '8': // Sistem 8 - Kâr bazlı komisyon
                    const profit8 = bankIncome - totalExpenses - bankCommission;
                    const bankLagirioComm8 = profit8 > 0 ? profit8 * (apartment.lagirioCommission / 100) : 0;
                    const cashAfterPlatform8 = cashIncome - cashCommission;
                    const cashLagirioComm8 = cashAfterPlatform8 * (apartment.lagirioCommission / 100);
                    lagirioProfit = bankLagirioComm8 + cashLagirioComm8;
                    break;

                case '9': // Sistem 9 - Stopajlı (KDV Düşülmüş)
                    const afterPlatform9 = bankIncome - bankCommission;
                    const afterKDV9 = afterPlatform9 - totalKDV;
                    const bankLagirioComm9 = afterKDV9 > 0 ? afterKDV9 * (apartment.lagirioCommission / 100) : 0;
                    const cashAfterPlatform9 = cashIncome - cashCommission;
                    const cashLagirioComm9 = cashAfterPlatform9 > 0 ? cashAfterPlatform9 * (apartment.lagirioCommission / 100) : 0;
                    lagirioProfit = bankLagirioComm9 + cashLagirioComm9;
                    break;

                default:
                    lagirioProfit = 0;
            }

            return lagirioProfit;
        },

        // 3. Ev sahibi payı hesaplama
        calculateOwnerShare(apartment, reservations, expenses = []) {
            // Banka/Nakit ayrımı
            const bank = reservations.filter(r => r.paymentMethod !== 'Nakit');
            const cash = reservations.filter(r => r.paymentMethod === 'Nakit');

            // Gelir hesaplama
            const bankIncome = bank.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            const cashIncome = cash.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);

            // Platform komisyonları
            const bankCommission = bank.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
            const cashCommission = cash.reduce((sum, res) => sum + (res.platformCommission || 0), 0);

            // Giderler
            const totalExpenses = expenses.reduce((sum, exp) => 
                sum + this.convertToEUR(exp.amount, exp.currency), 0);

            // Sistem bazlı daire sahibi kazancı
            let ownerShare = 0;

            switch(apartment.systemType) {
                case '1': // Sistem 1 - Tümü Lagirio'nun
                    ownerShare = 0;
                    break;

                case '2': // Sistem 2
                    const lagirioComm2 = bankIncome * (apartment.lagirioCommission / 100);
                    const toBeReturned2 = totalExpenses + bankCommission + lagirioComm2;
                    const kdvOnReturn2 = toBeReturned2 * 0.20;
                    const bankOwner2 = bankIncome - toBeReturned2 - kdvOnReturn2;
                    
                    const cashAfter2 = cashIncome - cashCommission;
                    const cashLagirioComm2 = cashAfter2 * (apartment.lagirioCommission / 100);
                    const cashOwner2 = cashAfter2 - cashLagirioComm2;
                    
                    ownerShare = bankOwner2 + cashOwner2;
                    break;

                case '3': // Sistem 3
                    const kdv3 = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    const afterDeductions3 = bankIncome - totalExpenses - kdv3 - bankCommission;
                    const lagirioComm3 = afterDeductions3 * (apartment.lagirioCommission / 100);
                    const afterLagirio3 = afterDeductions3 - lagirioComm3;
                    const incomeTax3 = afterLagirio3 * (apartment.incomeTaxRate / 100);
                    const bankOwner3 = afterLagirio3 - incomeTax3;
                    
                    const cashAfter3 = cashIncome - cashCommission;
                    const cashLagirioComm3 = cashAfter3 * (apartment.lagirioCommission / 100);
                    const cashOwner3 = cashAfter3 - cashLagirioComm3;
                    
                    ownerShare = bankOwner3 + cashOwner3;
                    break;

                case '4': // Sistem 4
                    const kdv4 = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    const afterPlatform4 = bankIncome - bankCommission;
                    const lagirioComm4 = afterPlatform4 * (apartment.lagirioCommission / 100);
                    const afterLagirio4 = afterPlatform4 - lagirioComm4 - totalExpenses - kdv4;
                    const incomeTax4 = afterLagirio4 * (apartment.incomeTaxRate / 100);
                    const bankOwner4 = afterLagirio4 - incomeTax4;
                    
                    const cashAfter4 = cashIncome - cashCommission;
                    const cashLagirioComm4 = cashAfter4 * (apartment.lagirioCommission / 100);
                    const cashOwner4 = cashAfter4 - cashLagirioComm4;
                    
                    ownerShare = bankOwner4 + cashOwner4;
                    break;

                case '5': // Sistem 5 - Stopajlı
                    const afterPlatform5 = bankIncome - bankCommission;
                    const lagirioComm5 = afterPlatform5 * (apartment.lagirioCommission / 100);
                    const kdv5 = bank.reduce((sum, res) => {
                        const amountInEur = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        return sum + amountInEur * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    }, 0);
                    const afterAllDeductions5 = afterPlatform5 - lagirioComm5 - totalExpenses - kdv5;
                    const stopaj5 = afterAllDeductions5 * (apartment.stopajRate / 100);
                    const bankOwner5 = afterAllDeductions5 - stopaj5;
                    
                    const cashAfter5 = cashIncome - cashCommission;
                    const cashLagirioComm5 = cashAfter5 * (apartment.lagirioCommission / 100);
                    const cashOwner5 = cashAfter5 - cashLagirioComm5;
                    
                    ownerShare = bankOwner5 + cashOwner5;
                    break;

                case '6': // Sistem 6 - Platform ayrımlı
                    const totalIncome6 = bankIncome + cashIncome;
                    const totalComm6 = bankCommission + cashCommission;
                    const netIncome6 = totalIncome6 - totalComm6 - totalExpenses;
                    const lagirioComm6 = netIncome6 * (apartment.lagirioCommission / 100);
                    ownerShare = netIncome6 - lagirioComm6;
                    break;

                case '7': // Sistem 7 - Karma platform
                    const airbnbRes7 = reservations.filter(r => r.platform === 'Airbnb');
                    const otherRes7 = reservations.filter(r => r.platform !== 'Airbnb');
                    
                    // Airbnb
                    const airbnbIncome7 = airbnbRes7.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const airbnbComm7 = airbnbRes7.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const airbnbAfter7 = airbnbIncome7 - airbnbComm7;
                    const airbnbLagirioComm7 = airbnbAfter7 * (apartment.lagirioCommission / 100);
                    const airbnbOwner7 = airbnbAfter7 - airbnbLagirioComm7;
                    
                    // Booking/Direct Banka
                    const bookingBank7 = otherRes7.filter(r => r.paymentMethod !== 'Nakit');
                    const bookingBankIncome7 = bookingBank7.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingBankComm7 = bookingBank7.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingKDV7 = bookingBankIncome7 * (apartment.taxRate / 100) / (1 + apartment.taxRate / 100);
                    const bookingAfterPlatform7 = bookingBankIncome7 - bookingBankComm7;
                    const bookingLagirioComm7 = bookingAfterPlatform7 * (apartment.lagirioCommission / 100);
                    const afterLagirio7 = bookingAfterPlatform7 - bookingLagirioComm7;
                    const afterExpenses7 = afterLagirio7 - totalExpenses - bookingKDV7;
                    const bookingIncomeTax7 = afterExpenses7 * (apartment.incomeTaxRate / 100);
                    const bookingBankOwner7 = afterExpenses7 - bookingIncomeTax7;
                    
                    // Booking/Direct Nakit
                    const bookingCash7 = otherRes7.filter(r => r.paymentMethod === 'Nakit');
                    const bookingCashIncome7 = bookingCash7.reduce((sum, res) => 
                        sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                    const bookingCashComm7 = bookingCash7.reduce((sum, res) => sum + (res.platformCommission || 0), 0);
                    const bookingCashAfter7 = bookingCashIncome7 - bookingCashComm7;
                    const bookingCashLagirioComm7 = bookingCashAfter7 * (apartment.lagirioCommission / 100);
                    const bookingCashOwner7 = bookingCashAfter7 - bookingCashLagirioComm7;
                    
                    ownerShare = airbnbOwner7 + bookingBankOwner7 + bookingCashOwner7;
                    break;

                case '8': // Sistem 8 - Kâr bazlı
                    const profit8 = bankIncome - totalExpenses - bankCommission;
                    const lagirioComm8 = profit8 > 0 ? profit8 * (apartment.lagirioCommission / 100) : 0;
                    const bankOwner8 = bankIncome - totalExpenses - bankCommission - lagirioComm8;
                    
                    const cashAfter8 = cashIncome - cashCommission;
                    const cashLagirioComm8 = cashAfter8 * (apartment.lagirioCommission / 100);
                    const cashOwner8 = cashAfter8 - cashLagirioComm8;
                    
                    ownerShare = bankOwner8 + cashOwner8;
                    break;

                default:
                    ownerShare = 0;
            }

            return ownerShare;
        },

        // 4. Doluluk oranı hesaplama
        calculateOccupancyRate(apartmentId, startDate = null, endDate = null) {
            // Tarih aralığı belirleme
            if (!startDate || !endDate) {
                if (this.dateFilter.start || this.dateFilter.end) {
                    // Filtre varsa, filtrenin ayını kullan
                    const filterDate = this.dateFilter.start || this.dateFilter.end;
                    startDate = new Date(filterDate.getFullYear(), filterDate.getMonth(), 1);
                    endDate = new Date(filterDate.getFullYear(), filterDate.getMonth() + 1, 0);
                } else {
                    // Filtre yoksa, tüm zamanlar
                    startDate = new Date(new Date().getFullYear(), 0, 1);
                    endDate = new Date();
                }
            }
            
            // HER ZAMAN this.data kullan - tarih filtresi burada uygulanır
            const reservations = this.data.reservations?.filter(r => r.apartmentId === apartmentId) || [];
            let bookedNights = 0;
            
            reservations.forEach(res => {
                const checkIn = new Date(res.checkIn);
                const checkOut = new Date(res.checkOut);
                
                const overlapStart = Math.max(checkIn.getTime(), startDate.getTime());
                const overlapEnd = Math.min(checkOut.getTime(), endDate.getTime());
                
                if (overlapStart < overlapEnd) {
                    const nights = Math.ceil((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24));
                    bookedNights += nights;
                }
            });
            
            const totalNights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            return totalNights > 0 ? (bookedNights / totalNights) * 100 : 0;
        },

        // 5. Hızlı istatistikleri hesaplama
        calculateQuickStats() {
            const cacheKey = 'quickStats';
            if (this.cache.calculations.has(cacheKey)) {
                return this.cache.calculations.get(cacheKey);
            }
            
            const stats = {
                totalPortfolio: 0,
                monthlyRevenue: 0,
                totalProperties: this.data.apartments?.length || 0,
                activeProperties: 0,
                avgOccupancy: 0,
                bestSystem: { id: '-', profit: 0 },
                monthlyTarget: 10000
            };
            
            // Tüm zamanlar için toplam portföy değeri
            this.data.apartments?.forEach(apartment => {
                const reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                stats.totalPortfolio += revenue;
                
                if (reservations.length > 0) {
                    stats.activeProperties++;
                }
            });
            
            // Aylık gelir - tarih filtresine göre
            let targetMonth, targetYear;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
            } else {
                const now = new Date();
                targetMonth = now.getMonth();
                targetYear = now.getFullYear();
            }
            
            this.data.apartments?.forEach(apartment => {
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                stats.monthlyRevenue += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            // Ortalama doluluk - sadece aktif daireleri say
            let totalOccupancy = 0;
            let activeCount = 0;
            
            this.data.apartments?.forEach(apartment => {
                // Bu dönemde rezervasyonu var mı kontrol et
                const hasReservations = this.data.reservations?.some(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                });
                
                if (hasReservations) {
                    const occupancy = this.calculateOccupancyRate(apartment.id);
                    totalOccupancy += occupancy;
                    activeCount++;
                }
            });
            
            stats.avgOccupancy = activeCount > 0 ? totalOccupancy / activeCount : 0;
            
            // En iyi sistem
            const systemRevenues = {};
            
            this.data.apartments?.forEach(apartment => {
                const systemType = apartment.systemType;
                if (!systemRevenues[systemType]) {
                    systemRevenues[systemType] = 0;
                }
                
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                systemRevenues[systemType] += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            Object.entries(systemRevenues).forEach(([system, revenue]) => {
                if (revenue > stats.bestSystem.profit) {
                    stats.bestSystem = { id: system, profit: revenue };
                }
            });
            
            this.cache.calculations.set(cacheKey, stats);
            return stats;
        },

        // 6. Aktif daire sayısı hesaplama
        calculateActiveApartments() {
            const activeApartments = new Set();
            
            // Tarih filtresine göre hedef ay
            let targetMonth, targetYear;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
                
                // Seçili ayda rezervasyonu olanlar
                this.data.reservations?.forEach(res => {
                    const date = new Date(res.checkIn);
                    if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                        activeApartments.add(res.apartmentId);
                    }
                });
            } else {
                // Tüm zamanlarda rezervasyonu olanlar
                this.data.reservations?.forEach(res => {
                    activeApartments.add(res.apartmentId);
                });
            }
            
            return activeApartments.size;
        },

        // 7. Aylık gelir hesaplama
        calculateMonthlyRevenue(monthOffset = 0) {
            let totalRevenue = 0;
            
            const targetDate = new Date();
            
            if ((this.dateFilter.start || this.dateFilter.end) && monthOffset === 0) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetDate.setMonth(filterDate.getMonth());
                targetDate.setFullYear(filterDate.getFullYear());
            } else {
                targetDate.setMonth(targetDate.getMonth() + monthOffset);
            }
            
            const targetMonth = targetDate.getMonth();
            const targetYear = targetDate.getFullYear();
            
            // HER ZAMAN this.data kullan
            this.data.apartments?.forEach(apartment => {
                const monthlyReservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                const monthlyExpenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
                
                totalRevenue += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
            });
            
            return totalRevenue;
        },

        // 8. Toplam Lagirio geliri hesaplama
        calculateTotalLagirioRevenue() {
            let total = 0;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                const targetMonth = filterDate.getMonth();
                const targetYear = filterDate.getFullYear();
                
                this.data.apartments?.forEach(apartment => {
                    const monthlyReservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    const monthlyExpenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    total += this.calculateLagirioRevenue(apartment, monthlyReservations, monthlyExpenses);
                });
            } else {
                this.data.apartments?.forEach(apartment => {
                    const reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                    const expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                    total += this.calculateLagirioRevenue(apartment, reservations, expenses);
                });
            }
            
            return total;
        },

        // 9. Ortalama doluluk oranı hesaplama
        calculateAverageOccupancy(monthOffset = 0) {
            let totalOccupancy = 0;
            let activeApartmentCount = 0;
            
            let startDate, endDate;
            
            if (this.dateFilter.start || this.dateFilter.end) {
                startDate = this.dateFilter.start || new Date(new Date().getFullYear(), 0, 1);
                endDate = this.dateFilter.end || new Date();
            } else {
                const targetDate = new Date();
                targetDate.setMonth(targetDate.getMonth() + monthOffset);
                startDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
                endDate = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);
            }
            
            this.data.apartments?.forEach(apartment => {
                // Bu dönemde rezervasyonu var mı kontrol et
                const hasReservations = this.data.reservations?.some(res => {
                    const checkIn = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                        checkIn >= startDate && checkIn <= endDate;
                });
                
                // Sadece rezervasyonu olan daireleri hesaba kat
                if (hasReservations) {
                    const occupancy = this.calculateOccupancyRate(apartment.id, startDate, endDate);
                    totalOccupancy += occupancy;
                    activeApartmentCount++;
                }
            });
            
            return activeApartmentCount > 0 ? totalOccupancy / activeApartmentCount : 0;
        },

        // 10. Aylık trend hesaplama
        calculateMonthlyTrend() {
            const currentRevenue = this.calculateMonthlyRevenue(0);
            const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
            
            if (lastMonthRevenue === 0) {
                return { icon: '↑', color: 'text-blue-600', value: 100 };
            }
            
            const change = ((currentRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
            
            return {
                icon: change > 10 ? '↑↑' : change > 0 ? '↑' : change < -10 ? '↓↓' : change < 0 ? '↓' : '→',
                color: change > 0 ? 'text-emerald-600' : change < 0 ? 'text-red-600' : 'text-blue-600',
                value: change
            };
        },

        // 11. Performans metrikleri hesaplama
        calculatePerformanceMetrics() {
            const apartmentMetrics = [];
            
            // Tarih filtresine göre hedef ay
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
            }
            
            this.data.apartments?.forEach(apartment => {
                let reservations, expenses;
                
                if (useMonthFilter) {
                    reservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    expenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                } else {
                    reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                    expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                }
                
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                const ownerShare = this.calculateOwnerShare(apartment, reservations, expenses);
                const occupancy = this.calculateOccupancyRate(apartment.id);
                
                const totalIncome = reservations.reduce((sum, res) => 
                    sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                
                const totalExpenses = expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                
                const expenseRatio = totalIncome > 0 ? (totalExpenses / totalIncome) * 100 : 0;
                const profitMargin = totalIncome > 0 ? ((revenue / totalIncome) * 100) : 0;
                
                apartmentMetrics.push({
                    ...apartment,
                    revenue,
                    ownerShare,
                    occupancy,
                    totalIncome,
                    totalExpenses,
                    expenseRatio,
                    profitMargin,
                    reservationCount: reservations.length,
                    avgNightlyRate: this.calculateAvgNightlyRate(reservations),
                    efficiency: this.calculateEfficiency(apartment.id, revenue)
                });
            });
            
            // Gelire göre sırala
            apartmentMetrics.sort((a, b) => b.revenue - a.revenue);
            
            return {
                topApartments: apartmentMetrics,
                avgExpenseRatio: apartmentMetrics.reduce((sum, apt) => sum + apt.expenseRatio, 0) / apartmentMetrics.length || 0,
                avgProfitMargin: apartmentMetrics.reduce((sum, apt) => sum + apt.profitMargin, 0) / apartmentMetrics.length || 0,
                totalReservations: apartmentMetrics.reduce((sum, apt) => sum + apt.reservationCount, 0)
            };
        },

        // 12. Ortalama gecelik ücret hesaplama
        calculateAvgNightlyRate(reservations) {
            if (reservations.length === 0) return 0;
            
            let totalAmount = 0;
            let totalNights = 0;
            
            reservations.forEach(res => {
                const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                const nights = Math.ceil((new Date(res.checkOut) - new Date(res.checkIn)) / (1000 * 60 * 60 * 24));
                totalAmount += amount;
                totalNights += nights;
            });
            
            return totalNights > 0 ? totalAmount / totalNights : 0;
        },

        // 13. Verimlilik skoru hesaplama
        calculateEfficiency(apartmentId, revenue) {
            const occupancy = this.calculateOccupancyRate(apartmentId);
            
            // Tarih filtresine göre rezervasyonları al
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let reservations;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                const targetMonth = filterDate.getMonth();
                const targetYear = filterDate.getFullYear();
                
                reservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartmentId &&
                        date.getMonth() === targetMonth &&
                        date.getFullYear() === targetYear;
                }) || [];
            } else {
                reservations = this.data.reservations?.filter(r => r.apartmentId === apartmentId) || [];
            }
            
            const avgRate = this.calculateAvgNightlyRate(reservations);
            
            if (avgRate === 0 || occupancy === 0) return 0;
            
            // Verimlilik = (Gerçek Gelir / Potansiyel Gelir) * 100
            const potentialRevenue = (occupancy / 100) * avgRate * 30; // Aylık potansiyel
            return potentialRevenue > 0 ? (revenue / potentialRevenue) * 100 : 0;
        },
        
                // 14. Grafikleri başlatma
        initializeCharts() {
            // Dispose existing charts
            Object.values(this.charts).forEach(chart => {
                if (chart && chart.dispose) {
                    chart.dispose();
                }
            });
            this.charts = {};
            
            // Create new charts
            this.createRevenueTrendChart();
            this.createPlatformDistChart();
            this.createPaymentMethodChart();
            
            // Diğer chart fonksiyonlarını kaldır (çünkü boşlar ve hata veriyor)
            // this.createSystemAnalysisCharts();
            this.createTrendAnalysisCharts();
            this.createEfficiencyCharts();
            
            // ✅ Grafikleri zorla resize/refresh et
            setTimeout(() => {
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.resize) {
                        chart.resize();
                    }
                });
            }, 100);
        },

        // 15. Gelir trend grafiği oluşturma
        createRevenueTrendChart() {
            const container = document.getElementById('revenueTrendChart');
            if (!container) return;
            
            const period = document.getElementById('trendPeriod')?.value || 'monthly';
            const data = this.getRevenueTrendData(period);
            
            const chart = echarts.init(container);
            this.charts.revenueTrend = chart;
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' },
                    formatter: params => {
                        const value = params[0].value;
                        return `${params[0].name}<br/>
                                <span style="color:${params[0].color}">●</span> Kazanç: €${value.toLocaleString()}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.labels,
                    axisLine: {
                        lineStyle: { color: '#e5e7eb' }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: { color: '#f3f4f6', type: 'dashed' }
                    },
                    axisLabel: {
                        color: '#6b7280',
                        formatter: value => `€${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [{
                    name: 'Kazanç',
                    type: 'line',
                    data: data.values,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    lineStyle: {
                        width: 3,
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#10b981' },
                            { offset: 1, color: '#059669' }
                        ])
                    },
                    itemStyle: {
                        color: '#10b981',
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                            { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                        ])
                    },
                    emphasis: {
                        scale: 1.2,
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(16, 185, 129, 0.5)'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
        },

        // 16. Platform dağılım grafiği oluşturma
        createPlatformDistChart() {
            const container = document.getElementById('platformDistChart');
            if (!container) return;
            
            const data = this.getPlatformDistributionData();
            
            const chart = echarts.init(container);
            this.charts.platformDist = chart;
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' },
                    formatter: '{b}<br/>{c} rezervasyon ({d}%)'
                },
                legend: {
                    bottom: '0%',
                    left: 'center',
                    textStyle: { color: '#6b7280', fontSize: 11 }
                },
                series: [{
                    type: 'pie',
                    radius: ['45%', '75%'],
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    label: { show: false },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    },
                    data: data.platforms.map((platform, index) => ({
                        value: data.counts[index],
                        name: platform,
                        itemStyle: {
                            color: this.getPlatformColor(platform)
                        }
                    }))
                }]
            };
            
            chart.setOption(option);
        },

        // 17. Ödeme yöntemi grafiği oluşturma
        createPaymentMethodChart() {
            const container = document.getElementById('paymentMethodChart');
            if (!container) return;
            
            const data = this.getPaymentMethodData();
            
            const chart = echarts.init(container);
            this.charts.paymentMethod = chart;
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' },
                    formatter: params => {
                        const percentage = params.percent;
                        const value = params.value;
                        return `${params.name}<br/>€${value.toLocaleString()} (${percentage}%)`;
                    }
                },
                series: [{
                    type: 'pie',
                    radius: '75%',
                    center: ['50%', '50%'],
                    data: [
                        {
                            value: data.bank,
                            name: 'Banka',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                    { offset: 0, color: '#3b82f6' },
                                    { offset: 1, color: '#1d4ed8' }
                                ])
                            }
                        },
                        {
                            value: data.cash,
                            name: 'Nakit',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                    { offset: 0, color: '#10b981' },
                                    { offset: 1, color: '#059669' }
                                ])
                            }
                        }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        },
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        }
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%',
                        fontSize: 12,
                        fontWeight: 'bold'
                    }
                }]
            };
            
            chart.setOption(option);
        },

        // 18. Sistem analiz grafikleri oluşturma
        // System analysis charts
        createSystemAnalysisCharts() {
            try {
                this.createSystemComparisonChart();
                console.log('✅ System comparison chart OK');
            } catch (e) {
                console.error('❌ System comparison hatası:', e);
            }
            // Diğerleri henüz tamamlanmadı
            // this.createSystemEfficiencyChart();
            // this.createSystemRevenueChart();
        },

        // System analysis charts
        createSystemAnalysisCharts() {
            try {
                this.createSystemComparisonChart();
                console.log('✅ System comparison chart OK');
            } catch (e) {
                console.error('❌ System comparison hatası:', e);
            }
        },

        // Placeholder fonksiyonlar (sonra tamamlanacak)
        createSystemEfficiencyChart() {
            console.log('⚠️ System efficiency chart henüz tamamlanmadı');
        },

        createSystemRevenueChart() {
            console.log('⚠️ System revenue chart henüz tamamlanmadı');
        },

        createTrendAnalysisCharts() {
            console.log('⚠️ Trend analysis charts henüz tamamlanmadı');
        },

        createEfficiencyCharts() {
            console.log('⚠️ Efficiency charts henüz tamamlanmadı');
        },

        updateEfficiencyMetrics() {
            console.log('⚠️ Efficiency metrics henüz tamamlanmadı');
        },

        // 19. Sistem karşılaştırma grafiği oluşturma
        createSystemComparisonChart() {
            const container = document.getElementById('systemComparisonChart');
            if (!container) return;
            
            const data = this.getSystemComparisonData();
            
            const chart = echarts.init(container);
            this.charts.systemComparison = chart;
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: ['Toplam Kazanç', 'Ortalama Doluluk'],
                    top: '0%',
                    textStyle: { color: '#6b7280' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.systems,
                    axisLabel: {
                        color: '#6b7280',
                        fontSize: 11
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Kazanç (€)',
                        position: 'left',
                        axisLabel: {
                            formatter: value => `€${(value / 1000).toFixed(0)}k`
                        }
                    },
                    {
                        type: 'value',
                        name: 'Doluluk (%)',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%'
                        },
                        max: 100
                    }
                ],
                series: [
                    {
                        name: 'Toplam Kazanç',
                        type: 'bar',
                        data: data.revenues,
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#10b981' },
                                { offset: 1, color: '#059669' }
                            ]),
                            borderRadius: [4, 4, 0, 0]
                        }
                    },
                    {
                        name: 'Ortalama Doluluk',
                        type: 'line',
                        yAxisIndex: 1,
                        data: data.occupancies,
                        symbol: 'circle',
                        symbolSize: 8,
                        lineStyle: {
                            width: 2,
                            color: '#f59e0b'
                        },
                        itemStyle: {
                            color: '#f59e0b'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        },

        // 20. Gelir trend verisi hazırlama
        getRevenueTrendData(period = 'monthly') {
            const data = { labels: [], values: [] };
            const now = new Date();
            
            switch(period) {
                case 'daily':
                    // Son 30 gün
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                        data.labels.push(dateStr);
                        
                        let dayRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const dayReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate.toDateString() === date.toDateString();
                            }) || [];
                            
                            const dayExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate.toDateString() === date.toDateString();
                            }) || [];
                            
                            dayRevenue += this.calculateLagirioRevenue(apartment, dayReservations, dayExpenses);
                        });
                        data.values.push(dayRevenue);
                    }
                    break;
                    
                case 'weekly':
                    // Son 12 hafta
                    for (let i = 11; i >= 0; i--) {
                        const weekStart = new Date(now);
                        weekStart.setDate(weekStart.getDate() - (i * 7) - weekStart.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        
                        data.labels.push(`H${12 - i}`);
                        
                        let weekRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const weekReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate >= weekStart && resDate <= weekEnd;
                            }) || [];
                            
                            const weekExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate >= weekStart && expDate <= weekEnd;
                            }) || [];
                            
                            weekRevenue += this.calculateLagirioRevenue(apartment, weekReservations, weekExpenses);
                        });
                        data.values.push(weekRevenue);
                    }
                    break;
                    
                case 'yearly':
                    // Son 3 yıl
                    for (let i = 2; i >= 0; i--) {
                        const year = now.getFullYear() - i;
                        data.labels.push(year.toString());
                        
                        let yearRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const yearReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate.getFullYear() === year;
                            }) || [];
                            
                            const yearExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate.getFullYear() === year;
                            }) || [];
                            
                            yearRevenue += this.calculateLagirioRevenue(apartment, yearReservations, yearExpenses);
                        });
                        data.values.push(yearRevenue);
                    }
                    break;
                    
                default: // monthly
                    const months = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                    
                    for (let i = 5; i >= 0; i--) {
                        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const monthLabel = `${months[monthDate.getMonth()]} ${monthDate.getFullYear()}`;
                        data.labels.push(monthLabel);
                        
                        let monthRevenue = 0;
                        this.data.apartments?.forEach(apartment => {
                            const monthReservations = this.data.reservations?.filter(res => {
                                const resDate = new Date(res.checkIn);
                                return res.apartmentId === apartment.id &&
                                    resDate.getMonth() === monthDate.getMonth() &&
                                    resDate.getFullYear() === monthDate.getFullYear();
                            }) || [];
                            
                            const monthExpenses = this.data.expenses?.filter(exp => {
                                const expDate = new Date(exp.date);
                                return exp.apartmentId === apartment.id &&
                                    expDate.getMonth() === monthDate.getMonth() &&
                                    expDate.getFullYear() === monthDate.getFullYear();
                            }) || [];
                            
                            monthRevenue += this.calculateLagirioRevenue(apartment, monthReservations, monthExpenses);
                        });
                        data.values.push(monthRevenue);
                    }
            }
            
            return data;
        },

        // 21. Platform dağılım verisi hazırlama
        getPlatformDistributionData() {
            const platformCounts = {};
            const platformRevenues = {};
            
            // Tarih filtresine göre
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
                
                this.data.reservations?.forEach(res => {
                    const date = new Date(res.checkIn);
                    if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                        const platform = res.platform || 'Direkt';
                        platformCounts[platform] = (platformCounts[platform] || 0) + 1;
                        platformRevenues[platform] = (platformRevenues[platform] || 0) + 
                            this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                    }
                });
            } else {
                this.data.reservations?.forEach(res => {
                    const platform = res.platform || 'Direkt';
                    platformCounts[platform] = (platformCounts[platform] || 0) + 1;
                    platformRevenues[platform] = (platformRevenues[platform] || 0) + 
                        this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                });
            }
            
            return {
                platforms: Object.keys(platformCounts),
                counts: Object.values(platformCounts),
                revenues: Object.values(platformRevenues)
            };
        },

        // 22. Ödeme yöntemi verisi hazırlama
        getPaymentMethodData() {
            let bankTotal = 0;
            let cashTotal = 0;
            
            // Tarih filtresine göre
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
                
                this.data.reservations?.forEach(res => {
                    const date = new Date(res.checkIn);
                    if (date.getMonth() === targetMonth && date.getFullYear() === targetYear) {
                        const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                        if (res.paymentMethod === 'Nakit') {
                            cashTotal += amount;
                        } else {
                            bankTotal += amount;
                        }
                    }
                });
            } else {
                this.data.reservations?.forEach(res => {
                    const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                    if (res.paymentMethod === 'Nakit') {
                        cashTotal += amount;
                    } else {
                        bankTotal += amount;
                    }
                });
            }
            
            return {
                bank: bankTotal,
                cash: cashTotal
            };
        },

        // 23. Sistem karşılaştırma verisi hazırlama
        getSystemComparisonData() {
            const systemData = {};
            const systemNames = {
                '1': 'Sistem 1 - Kira',
                '2': 'Sistem 2 - Kişi Şrkt',
                '3': 'Sistem 3 - Komisyon',
                '4': 'Sistem 4 - Kom. Özel',
                '5': 'Sistem 5 - Stopajlı',
                '6': 'Sistem 6 - Platform',
                '7': 'Sistem 7 - Karma',
                '8': 'Sistem 8 - Kâr Bazlı'
            };
            
            // Sistem verilerini başlat
            for (let i = 1; i <= 8; i++) {
                systemData[i] = {
                    name: systemNames[i],
                    revenue: 0,
                    occupancy: 0,
                    apartmentCount: 0,
                    activeApartmentCount: 0,
                    efficiency: 0,
                    avgCommission: 0,
                    commissions: []
                };
            }
            
            // Tarih filtresine göre
            const useMonthFilter = this.dateFilter.start || this.dateFilter.end;
            let targetMonth, targetYear;
            
            if (useMonthFilter) {
                const filterDate = this.dateFilter.start || this.dateFilter.end;
                targetMonth = filterDate.getMonth();
                targetYear = filterDate.getFullYear();
            }
            
            // Sistem metriklerini hesapla
            this.data.apartments?.forEach(apartment => {
                const system = apartment.systemType;
                systemData[system].apartmentCount++;
                systemData[system].commissions.push(apartment.lagirioCommission);
                
                let reservations, expenses;
                
                if (useMonthFilter) {
                    reservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                    
                    expenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetMonth &&
                            date.getFullYear() === targetYear;
                    }) || [];
                } else {
                    reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                    expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                }
                
                const revenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                systemData[system].revenue += revenue;
                
                // Sadece rezervasyonu olan daireleri doluluk hesabına kat
                if (reservations.length > 0) {
                    systemData[system].activeApartmentCount++;
                    systemData[system].occupancy += this.calculateOccupancyRate(apartment.id);
                    
                    // Verimlilik hesaplama
                    const totalNights = reservations.reduce((sum, res) => {
                        const nights = Math.ceil((new Date(res.checkOut) - new Date(res.checkIn)) / (1000 * 60 * 60 * 24));
                        return sum + nights;
                    }, 0);
                    
                    if (totalNights > 0) {
                        systemData[system].efficiency += revenue / totalNights;
                    }
                }
            });
            
            // Ortalamaları hesapla
            Object.values(systemData).forEach(system => {
                if (system.activeApartmentCount > 0) {
                    system.occupancy = system.occupancy / system.activeApartmentCount;
                    system.efficiency = system.efficiency / system.activeApartmentCount;
                }
                if (system.commissions.length > 0) {
                    system.avgCommission = system.commissions.reduce((a, b) => a + b, 0) / system.commissions.length;
                }
            });
            
            // Boş olmayan sistemleri filtrele
            const activeSystems = Object.values(systemData).filter(s => s.apartmentCount > 0);
            
            return {
                systems: activeSystems.map(s => s.name),
                revenues: activeSystems.map(s => s.revenue),
                occupancies: activeSystems.map(s => s.occupancy),
                efficiencies: activeSystems.map(s => s.efficiency),
                avgCommissions: activeSystems.map(s => s.avgCommission)
            };
        },

        // 24. KPI kartlarını güncelleme
        updateKPICards() {
            const stats = this.calculateQuickStats();
            
            // Portfolio trend hesaplama
            const lastMonthRevenue = this.calculateMonthlyRevenue(-1);
            const portfolioTrend = lastMonthRevenue > 0 ? 
                ((stats.totalPortfolio - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1) : 0;
            
            const trendElement = document.getElementById('portfolioTrend');
            if (trendElement) {
                trendElement.textContent = portfolioTrend > 0 ? `+${portfolioTrend}%` : 
                                        portfolioTrend < 0 ? `${portfolioTrend}%` : '→';
                trendElement.className = portfolioTrend > 0 ? 'text-xs text-emerald-600 font-semibold' :
                                        portfolioTrend < 0 ? 'text-xs text-red-600 font-semibold' :
                                        'text-xs text-gray-600 font-semibold';
            }
            
            // Aylık trend
            const monthlyTrend = this.calculateMonthlyTrend();
            const monthlyTrendElement = document.getElementById('monthlyTrend');
            if (monthlyTrendElement) {
                monthlyTrendElement.textContent = monthlyTrend.icon;
                monthlyTrendElement.className = `text-xs font-semibold ${monthlyTrend.color}`;
            }
            
            // Doluluk indikatörü
            const occupancyIndicator = document.getElementById('occupancyIndicator');
            if (occupancyIndicator) {
                const lastMonthOccupancy = this.calculateAverageOccupancy(-1);
                const occupancyDiff = stats.avgOccupancy - lastMonthOccupancy;
                occupancyIndicator.textContent = occupancyDiff > 5 ? '↑' :
                                                occupancyDiff < -5 ? '↓' : '→';
                occupancyIndicator.className = occupancyDiff > 5 ? 'text-xs text-emerald-600' :
                                            occupancyDiff < -5 ? 'text-xs text-red-600' :
                                            'text-xs text-orange-600';
            }
            
            // Doluluk çubuklarını güncelle
            const occupancyBars = document.querySelectorAll('#avgOccupancy').forEach(element => {
                const parent = element.closest('.relative');
                if (parent) {
                    const bars = parent.querySelectorAll('.h-1');
                    bars.forEach((bar, index) => {
                        const threshold = (index + 1) * 20;
                        if (stats.avgOccupancy >= threshold) {
                            bar.classList.remove('bg-gray-200');
                            bar.classList.add('bg-orange-500');
                        } else {
                            bar.classList.remove('bg-orange-500');
                            bar.classList.add('bg-gray-200');
                        }
                    });
                }
            });
        },

        // 25. Performans metriklerini güncelleme
        updatePerformanceMetrics() {
            const metrics = this.calculatePerformanceMetrics();
            
            // En iyi performans gösteren daireler listesi
            const topPerformersContainer = document.getElementById('topPerformers');
            if (topPerformersContainer) {
                topPerformersContainer.innerHTML = metrics.topApartments.slice(0, 5).map((apt, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br ${this.getRankColor(index)} rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${index + 1}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${apt.code}</p>
                                <p class="text-xs text-gray-500">${apt.ownerName}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-emerald-600">€${apt.revenue.toLocaleString()}</p>
                            <p class="text-xs text-gray-500">${apt.occupancy.toFixed(1)}% doluluk</p>
                        </div>
                    </div>
                `).join('');
            }
        },
        // Update system performance cards
        updateSystemCards() {
            const container = document.getElementById('systemPerformanceCards');
            if (!container) return;
            
            const systemData = this.getSystemPerformanceData();
            
            container.innerHTML = systemData.map(system => `
                <div class="col-span-1 bg-gradient-to-br ${system.color} rounded-xl p-6 text-white relative overflow-hidden group hover:shadow-xl transition-all">
                    <div class="absolute top-0 right-0 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="${system.icon}" class="w-24 h-24"></i>
                    </div>
                    <div class="relative">
                        <h4 class="font-semibold mb-3">${system.name}</h4>
                        <p class="text-3xl font-bold mb-2">€${system.revenue.toLocaleString()}</p>
                        <div class="flex justify-between text-sm opacity-90">
                            <span>${system.apartmentCount} daire</span>
                            <span>${system.avgOccupancy.toFixed(1)}% doluluk</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-white/20">
                            <div class="flex justify-between text-xs">
                                <span>Ort. Komisyon</span>
                                <span class="font-semibold">${system.avgCommission.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Get system performance data
        getSystemPerformanceData() {
            const systemColors = [
                'from-blue-500 to-blue-600',
                'from-purple-500 to-purple-600',
                'from-emerald-500 to-emerald-600',
                'from-orange-500 to-orange-600',
                'from-red-500 to-red-600',
                'from-indigo-500 to-indigo-600',
                'from-pink-500 to-pink-600',
                'from-gray-500 to-gray-600'
            ];
            
            const systemIcons = [
                'home', 'building', 'percent', 'star',
                'shield', 'globe', 'layers', 'trending-up'
            ];
            
            const systemNames = {
                '1': 'Kira',
                '2': 'Kişi Şirketi',
                '3': 'Komisyon',
                '4': 'Özel Komisyon',
                '5': 'Stopajlı',
                '6': 'Platform Ayrımlı',
                '7': 'Karma Platform',
                '8': 'Kâr Bazlı'
            };
            
            const systems = [];
            
            for (let i = 1; i <= 8; i++) {
                const apartments = this.data.apartments?.filter(a => a.systemType === String(i)) || [];
                
                if (apartments.length > 0) {
                    let totalRevenue = 0;
                    let totalOccupancy = 0;
                    let commissions = [];
                    
                    apartments.forEach(apartment => {
                        const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                        const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                        
                        totalRevenue += this.calculateLagirioRevenue(apartment, reservations, expenses);
                        totalOccupancy += this.calculateOccupancyRate(apartment.id);
                        commissions.push(apartment.lagirioCommission);
                    });
                    
                    systems.push({
                        id: i,
                        name: systemNames[i],
                        color: systemColors[i - 1],
                        icon: systemIcons[i - 1],
                        revenue: totalRevenue,
                        apartmentCount: apartments.length,
                        avgOccupancy: totalOccupancy / apartments.length,
                        avgCommission: commissions.reduce((a, b) => a + b, 0) / commissions.length
                    });
                }
            }
            
            return systems;
        },
        
        // Update recent activity
        updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            const recentReservations = [...this.filteredData.reservations]
                .sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn))
                .slice(0, 5);
            
            container.innerHTML = recentReservations.map(res => {
                const apartment = this.data.apartments?.find(a => a.id === res.apartmentId);
                const amount = this.convertToEUR(res.totalAmount, res.currency || 'EUR');
                const checkIn = new Date(res.checkIn).toLocaleDateString('tr-TR');
                const icon = this.getPlatformIcon(res.platform);
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 ${this.getPlatformColor(res.platform)} rounded-full flex items-center justify-center text-white">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${apartment?.code || 'Bilinmeyen'}</p>
                                <p class="text-xs text-gray-500">${res.guestName} • ${checkIn}</p>
                            </div>
                        </div>
                        <p class="font-semibold text-emerald-600">€${amount.toFixed(0)}</p>
                    </div>
                `;
            }).join('');
            
            if (recentReservations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Henüz rezervasyon bulunmuyor</p>';
            }
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Update alerts
        updateAlerts() {
            const container = document.getElementById('importantAlerts');
            if (!container) return;
            
            const alerts = this.generateAlerts();
            
            container.innerHTML = alerts.slice(0, 5).map(alert => `
                <div class="flex items-start space-x-3 p-3 ${alert.bgColor} rounded-lg">
                    <div class="flex-shrink-0">
                        <i data-lucide="${alert.icon}" class="w-5 h-5 ${alert.color}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${alert.title}</p>
                        <p class="text-xs text-gray-600 mt-1">${alert.message}</p>
                    </div>
                </div>
            `).join('');
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Önemli uyarı bulunmuyor</p>';
            }
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Generate alerts
        generateAlerts() {
            const alerts = [];
            const lowOccupancyThreshold = this.settings.lowOccupancyThreshold;
            const highExpenseThreshold = this.settings.highExpenseThreshold;
            
            // Check low occupancy apartments
            this.data.apartments?.forEach(apartment => {
                const occupancy = this.calculateOccupancyRate(apartment.id);
                if (occupancy < lowOccupancyThreshold && occupancy > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: 'alert-triangle',
                        color: 'text-orange-600',
                        bgColor: 'bg-orange-50',
                        title: `Düşük Doluluk - ${apartment.code}`,
                        message: `Doluluk oranı %${occupancy.toFixed(1)} (Eşik: %${lowOccupancyThreshold})`,
                        priority: 2
                    });
                }
                
                // Check high expenses
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                expenses.forEach(expense => {
                    const amount = this.convertToEUR(expense.amount, expense.currency);
                    if (amount > highExpenseThreshold) {
                        alerts.push({
                            type: 'error',
                            icon: 'alert-circle',
                            color: 'text-red-600',
                            bgColor: 'bg-red-50',
                            title: `Yüksek Gider - ${apartment.code}`,
                            message: `${expense.category}: €${amount.toFixed(2)}`,
                            priority: 1
                        });
                    }
                });
            });
            
            // Check apartments with no reservations
            const apartmentsWithNoReservations = this.data.apartments?.filter(apartment => {
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                return reservations.length === 0;
            }) || [];
            
            if (apartmentsWithNoReservations.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'info',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    title: 'Rezervasyon Yok',
                    message: `${apartmentsWithNoReservations.length} dairede rezervasyon bulunmuyor`,
                    priority: 3
                });
            }
            
            // Sort by priority
            alerts.sort((a, b) => a.priority - b.priority);
            
            return alerts;
        },
        
        // Generate notifications
        generateNotifications() {
            this.notifications = [];
            
            // Add system notifications
            const stats = this.calculateQuickStats();
            
            if (stats.avgOccupancy < 30) {
                this.notifications.push({
                    id: Date.now(),
                    type: 'warning',
                    title: 'Düşük Doluluk Oranı',
                    message: `Ortalama doluluk %${stats.avgOccupancy.toFixed(1)} seviyesinde`,
                    time: new Date()
                });
            }
            
            if (stats.monthlyRevenue > stats.monthlyTarget) {
                this.notifications.push({
                    id: Date.now() + 1,
                    type: 'success',
                    title: 'Aylık Hedef Aşıldı!',
                    message: `Bu ay €${stats.monthlyRevenue.toLocaleString()} kazanç elde edildi`,
                    time: new Date()
                });
            }
            
            // Update notification count
            document.getElementById('notificationCount').textContent = this.notifications.length;
        },
        
        // Show notifications modal
        showNotifications() {
            const modal = document.getElementById('notificationModal');
            const list = document.getElementById('notificationList');
            
            if (list) {
                list.innerHTML = this.notifications.map(notif => `
                    <div class="p-4 ${this.getNotificationBgColor(notif.type)} rounded-lg">
                        <div class="flex items-start space-x-3">
                            <i data-lucide="${this.getNotificationIcon(notif.type)}" 
                               class="w-5 h-5 ${this.getNotificationColor(notif.type)} flex-shrink-0"></i>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${notif.title}</p>
                                <p class="text-sm text-gray-600 mt-1">${notif.message}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ${new Date(notif.time).toLocaleString('tr-TR')}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (this.notifications.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500">Bildirim bulunmuyor</p>';
                }
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => lucide.createIcons(), 100);
        },
        // Comparison functionality
        runComparison() {
            const comparisonType = document.getElementById('comparisonType').value;
            const resultsContainer = document.getElementById('comparisonResults');
            
            if (!resultsContainer) return;
            
            let comparisonData = null;
            
            switch(comparisonType) {
                case 'apartments':
                    comparisonData = this.compareApartments();
                    break;
                case 'periods':
                    comparisonData = this.comparePeriods();
                    break;
                case 'systems':
                    comparisonData = this.compareSystems();
                    break;
                case 'mixed':
                    comparisonData = this.mixedComparison();
                    break;
            }
            
            if (comparisonData) {
                resultsContainer.innerHTML = this.renderComparisonResults(comparisonData);
                resultsContainer.classList.remove('hidden');
                this.createComparisonCharts(comparisonData);
                setTimeout(() => lucide.createIcons(), 100);
            }
        },
        
        // Compare apartments
        compareApartments() {
            const firstApartments = Array.from(document.getElementById('firstApartments').selectedOptions)
                .map(opt => opt.value);
            const secondApartments = Array.from(document.getElementById('secondApartments').selectedOptions)
                .map(opt => opt.value);
            
            if (firstApartments.length === 0 || secondApartments.length === 0) {
                this.showToast('Lütfen karşılaştırılacak daireleri seçin', 'warning');
                return null;
            }
            
            const firstMetrics = this.calculateGroupMetrics(firstApartments);
            const secondMetrics = this.calculateGroupMetrics(secondApartments);
            
            return {
                type: 'apartments',
                first: {
                    label: `Grup 1 (${firstApartments.length} daire)`,
                    metrics: firstMetrics
                },
                second: {
                    label: `Grup 2 (${secondApartments.length} daire)`,
                    metrics: secondMetrics
                },
                comparison: this.calculateMetricComparison(firstMetrics, secondMetrics)
            };
        },
        
        // Compare periods
        comparePeriods() {
            const firstStart = document.getElementById('firstPeriodStart').value;
            const firstEnd = document.getElementById('firstPeriodEnd').value;
            const secondStart = document.getElementById('secondPeriodStart').value;
            const secondEnd = document.getElementById('secondPeriodEnd').value;
            
            if (!firstStart || !firstEnd || !secondStart || !secondEnd) {
                this.showToast('Lütfen tüm dönemleri seçin', 'warning');
                return null;
            }
            
            const firstMetrics = this.calculatePeriodMetrics(new Date(firstStart), new Date(firstEnd));
            const secondMetrics = this.calculatePeriodMetrics(new Date(secondStart), new Date(secondEnd));
            
            return {
                type: 'periods',
                first: {
                    label: `${firstStart} - ${firstEnd}`,
                    metrics: firstMetrics
                },
                second: {
                    label: `${secondStart} - ${secondEnd}`,
                    metrics: secondMetrics
                },
                comparison: this.calculateMetricComparison(firstMetrics, secondMetrics)
            };
        },
        
        // Calculate group metrics
        calculateGroupMetrics(apartmentIds) {
            const metrics = {
                totalRevenue: 0,
                totalOwnerShare: 0,
                totalExpenses: 0,
                avgOccupancy: 0,
                reservationCount: 0,
                avgNightlyRate: 0,
                platformDistribution: {},
                expenseCategories: {}
            };
            
            apartmentIds.forEach(apartmentId => {
                const apartment = this.data.apartments?.find(a => a.id === apartmentId);
                if (!apartment) return;
                
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartmentId) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartmentId) || [];
                
                metrics.totalRevenue += this.calculateLagirioRevenue(apartment, reservations, expenses);
                metrics.totalOwnerShare += this.calculateOwnerShare(apartment, reservations, expenses);
                metrics.totalExpenses += expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                metrics.avgOccupancy += this.calculateOccupancyRate(apartmentId);
                metrics.reservationCount += reservations.length;
                metrics.avgNightlyRate += this.calculateAvgNightlyRate(reservations);
                
                // Platform distribution
                reservations.forEach(res => {
                    const platform = res.platform || 'Direkt';
                    metrics.platformDistribution[platform] = (metrics.platformDistribution[platform] || 0) + 1;
                });
                
                // Expense categories
                expenses.forEach(exp => {
                    const amount = this.convertToEUR(exp.amount, exp.currency);
                    metrics.expenseCategories[exp.category] = (metrics.expenseCategories[exp.category] || 0) + amount;
                });
            });
            
            // Calculate averages
            const count = apartmentIds.length;
            if (count > 0) {
                metrics.avgOccupancy = metrics.avgOccupancy / count;
                metrics.avgNightlyRate = metrics.avgNightlyRate / count;
            }
            
            return metrics;
        },
        
        // Calculate period metrics
        calculatePeriodMetrics(startDate, endDate) {
            const metrics = {
                totalRevenue: 0,
                totalOwnerShare: 0,
                totalExpenses: 0,
                avgOccupancy: 0,
                reservationCount: 0,
                avgNightlyRate: 0,
                platformDistribution: {},
                expenseCategories: {}
            };
            
            this.data.apartments?.forEach(apartment => {
                const reservations = this.data.reservations?.filter(res => {
                    const date = new Date(res.checkIn);
                    return res.apartmentId === apartment.id &&
                           date >= startDate && date <= endDate;
                }) || [];
                
                const expenses = this.data.expenses?.filter(exp => {
                    const date = new Date(exp.date);
                    return exp.apartmentId === apartment.id &&
                           date >= startDate && date <= endDate;
                }) || [];
                
                metrics.totalRevenue += this.calculateLagirioRevenue(apartment, reservations, expenses);
                metrics.totalOwnerShare += this.calculateOwnerShare(apartment, reservations, expenses);
                metrics.totalExpenses += expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                metrics.reservationCount += reservations.length;
                metrics.avgNightlyRate += this.calculateAvgNightlyRate(reservations);
                
                // Occupancy for period
                const occupancy = this.calculateOccupancyRate(apartment.id, startDate, endDate);
                metrics.avgOccupancy += occupancy;
                
                // Platform distribution
                reservations.forEach(res => {
                    const platform = res.platform || 'Direkt';
                    metrics.platformDistribution[platform] = (metrics.platformDistribution[platform] || 0) + 1;
                });
                
                // Expense categories
                expenses.forEach(exp => {
                    const amount = this.convertToEUR(exp.amount, exp.currency);
                    metrics.expenseCategories[exp.category] = (metrics.expenseCategories[exp.category] || 0) + amount;
                });
            });
            
            // Calculate averages
            const count = this.data.apartments?.length || 1;
            metrics.avgOccupancy = metrics.avgOccupancy / count;
            metrics.avgNightlyRate = metrics.avgNightlyRate / count;
            
            return metrics;
        },
        
        // Calculate metric comparison
        calculateMetricComparison(first, second) {
            return {
                revenue: {
                    diff: first.totalRevenue - second.totalRevenue,
                    percent: second.totalRevenue > 0 ? 
                        ((first.totalRevenue - second.totalRevenue) / second.totalRevenue * 100) : 0
                },
                expenses: {
                    diff: first.totalExpenses - second.totalExpenses,
                    percent: second.totalExpenses > 0 ? 
                        ((first.totalExpenses - second.totalExpenses) / second.totalExpenses * 100) : 0
                },
                occupancy: {
                    diff: first.avgOccupancy - second.avgOccupancy,
                    percent: second.avgOccupancy > 0 ? 
                        ((first.avgOccupancy - second.avgOccupancy) / second.avgOccupancy * 100) : 0
                },
                reservations: {
                    diff: first.reservationCount - second.reservationCount,
                    percent: second.reservationCount > 0 ? 
                        ((first.reservationCount - second.reservationCount) / second.reservationCount * 100) : 0
                }
            };
        },
        
        // Render comparison results
        renderComparisonResults(data) {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- First Group/Period -->
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h4 class="font-semibold text-blue-900 mb-4">${data.first.label}</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam Kazanç:</span>
                                <span class="font-semibold">€${data.first.metrics.totalRevenue.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam Gider:</span>
                                <span class="font-semibold">€${data.first.metrics.totalExpenses.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ortalama Doluluk:</span>
                                <span class="font-semibold">${data.first.metrics.avgOccupancy.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Rezervasyon Sayısı:</span>
                                <span class="font-semibold">${data.first.metrics.reservationCount}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ort. Gecelik Ücret:</span>
                                <span class="font-semibold">€${data.first.metrics.avgNightlyRate.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second Group/Period -->
                    <div class="bg-green-50 rounded-lg p-6">
                        <h4 class="font-semibold text-green-900 mb-4">${data.second.label}</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam Kazanç:</span>
                                <span class="font-semibold">€${data.second.metrics.totalRevenue.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Toplam Gider:</span>
                                <span class="font-semibold">€${data.second.metrics.totalExpenses.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ortalama Doluluk:</span>
                                <span class="font-semibold">${data.second.metrics.avgOccupancy.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Rezervasyon Sayısı:</span>
                                <span class="font-semibold">${data.second.metrics.reservationCount}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Ort. Gecelik Ücret:</span>
                                <span class="font-semibold">€${data.second.metrics.avgNightlyRate.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h4 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-indigo-600"></i>
                        <span>Karşılaştırma Özeti</span>
                    </h4>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Kazanç Farkı</p>
                            <p class="text-xl font-bold ${data.comparison.revenue.diff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.revenue.diff >= 0 ? '+' : ''}€${data.comparison.revenue.diff.toFixed(0)}
                            </p>
                            <p class="text-sm ${data.comparison.revenue.percent >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.revenue.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.comparison.revenue.percent).toFixed(1)}%
                            </p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Gider Farkı</p>
                            <p class="text-xl font-bold ${data.comparison.expenses.diff <= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.expenses.diff >= 0 ? '+' : ''}€${data.comparison.expenses.diff.toFixed(0)}
                            </p>
                            <p class="text-sm ${data.comparison.expenses.percent <= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.expenses.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.comparison.expenses.percent).toFixed(1)}%
                            </p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Doluluk Farkı</p>
                            <p class="text-xl font-bold ${data.comparison.occupancy.diff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.occupancy.diff >= 0 ? '+' : ''}${data.comparison.occupancy.diff.toFixed(1)}%
                            </p>
                            <p class="text-sm ${data.comparison.occupancy.percent >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.occupancy.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.comparison.occupancy.percent).toFixed(1)}%
                            </p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500 mb-1">Rezervasyon Farkı</p>
                            <p class="text-xl font-bold ${data.comparison.reservations.diff >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.comparison.reservations.diff >= 0 ? '+' : ''}${data.comparison.reservations.diff}
                            </p>
                            <p class="text-sm ${data.comparison.reservations.percent >= 0 ? 'text-green-500' : 'text-red-500'}">
                                ${data.comparison.reservations.percent >= 0 ? '↑' : '↓'} ${Math.abs(data.comparison.reservations.percent).toFixed(1)}%
                            </p>
                        </div>
                    </div>
                    
                    <!-- Comparison Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="chart-container-sm" id="comparisonBarChart"></div>
                        <div class="chart-container-sm" id="comparisonRadarChart"></div>
                    </div>
                </div>
            `;
        },
        
        // Create comparison charts
        createComparisonCharts(data) {
            // Bar chart
            const barContainer = document.getElementById('comparisonBarChart');
            if (barContainer) {
                const chart = echarts.init(barContainer);
                
                chart.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: {
                        data: [data.first.label, data.second.label]
                    },
                    xAxis: {
                        type: 'category',
                        data: ['Kazanç', 'Gider', 'Doluluk', 'Rezervasyon']
                    },
                    yAxis: { type: 'value' },
                    series: [
                        {
                            name: data.first.label,
                            type: 'bar',
                            data: [
                                data.first.metrics.totalRevenue,
                                data.first.metrics.totalExpenses,
                                data.first.metrics.avgOccupancy * 100,
                                data.first.metrics.reservationCount
                            ],
                            itemStyle: { color: '#3b82f6' }
                        },
                        {
                            name: data.second.label,
                            type: 'bar',
                            data: [
                                data.second.metrics.totalRevenue,
                                data.second.metrics.totalExpenses,
                                data.second.metrics.avgOccupancy * 100,
                                data.second.metrics.reservationCount
                            ],
                            itemStyle: { color: '#10b981' }
                        }
                    ]
                });
            }
        },
        
        // Report generation
        generateReport(type) {
            const reportPreview = document.getElementById('reportPreview');
            if (!reportPreview) return;
            
            let reportContent = '';
            
            switch(type) {
                case 'summary':
                    reportContent = this.generateSummaryReport();
                    break;
                case 'detailed':
                    reportContent = this.generateDetailedReport();
                    break;
                case 'comparison':
                    reportContent = this.generateComparisonReport();
                    break;
                case 'financial':
                    reportContent = this.generateFinancialReport();
                    break;
                case 'performance':
                    reportContent = this.generatePerformanceReport();
                    break;
                case 'custom':
                    this.showModal('customReportModal');
                    return;
            }
            
            reportPreview.innerHTML = reportContent;
            reportPreview.classList.remove('hidden');
            
            // Scroll to preview
            reportPreview.scrollIntoView({ behavior: 'smooth' });
            
            // Re-create icons
            setTimeout(() => lucide.createIcons(), 100);
        },
        
        // Generate summary report
        generateSummaryReport() {
            const stats = this.calculateQuickStats();
            const metrics = this.calculatePerformanceMetrics();
            const systemData = this.getSystemComparisonData();
            
            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Yönetici Özet Raporu</h2>
                        <p class="text-gray-500">Oluşturulma: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-emerald-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Toplam Portföy</p>
                            <p class="text-2xl font-bold text-emerald-600">€${stats.totalPortfolio.toLocaleString()}</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Aylık Kazanç</p>
                            <p class="text-2xl font-bold text-blue-600">€${stats.monthlyRevenue.toLocaleString()}</p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Ortalama Doluluk</p>
                            <p class="text-2xl font-bold text-orange-600">${stats.avgOccupancy.toFixed(1)}%</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Aktif Daire</p>
                            <p class="text-2xl font-bold text-purple-600">${stats.activeProperties}/${stats.totalProperties}</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Sistem Performansı</h3>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm">Sistem</th>
                                    <th class="px-4 py-2 text-right text-sm">Kazanç</th>
                                    <th class="px-4 py-2 text-right text-sm">Doluluk</th>
                                    <th class="px-4 py-2 text-right text-sm">Verimlilik</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${systemData.systems.map((system, index) => `
                                    <tr class="border-b">
                                        <td class="px-4 py-2">${system}</td>
                                        <td class="px-4 py-2 text-right">€${systemData.revenues[index].toLocaleString()}</td>
                                        <td class="px-4 py-2 text-right">${systemData.occupancies[index].toFixed(1)}%</td>
                                        <td class="px-4 py-2 text-right">${systemData.efficiencies[index].toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Yazdır
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF İndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },
        
        // Helper methods
        getPlatformColor(platform) {
            const colors = {
                'Booking.com': 'bg-blue-500',
                'Airbnb': 'bg-red-500',
                'Direkt': 'bg-green-500'
            };
            return colors[platform] || 'bg-gray-500';
        },
        
        getPlatformIcon(platform) {
            const icons = {
                'Booking.com': 'globe',
                'Airbnb': 'home',
                'Direkt': 'mail'
            };
            return icons[platform] || 'circle';
        },
        
        getRankColor(index) {
            const colors = [
                'from-yellow-400 to-yellow-500',
                'from-gray-300 to-gray-400',
                'from-orange-400 to-orange-500',
                'from-blue-400 to-blue-500',
                'from-purple-400 to-purple-500'
            ];
            return colors[index] || 'from-gray-400 to-gray-500';
        },
        
        getNotificationBgColor(type) {
            const colors = {
                success: 'bg-green-50',
                warning: 'bg-orange-50',
                error: 'bg-red-50',
                info: 'bg-blue-50'
            };
            return colors[type] || 'bg-gray-50';
        },
        
        getNotificationColor(type) {
            const colors = {
                success: 'text-green-600',
                warning: 'text-orange-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            return colors[type] || 'text-gray-600';
        },
        
        getNotificationIcon(type) {
            const icons = {
                success: 'check-circle',
                warning: 'alert-triangle',
                error: 'x-circle',
                info: 'info'
            };
            return icons[type] || 'bell';
        },
        
        // UI Helper methods
        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => lucide.createIcons(), 100);
            }
        },
        
        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        },
        
        closeAllModals() {
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.classList.add('hidden');
            });
        },
        
        showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        },
        
        hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        },
        
        showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toastId = Date.now();
            const toast = document.createElement('div');
            toast.className = `toast-${toastId} animate-slide-up flex items-center space-x-3 px-4 py-3 ${this.getNotificationBgColor(type)} rounded-lg shadow-lg min-w-[300px]`;
            
            toast.innerHTML = `
                <i data-lucide="${this.getNotificationIcon(type)}" class="w-5 h-5 ${this.getNotificationColor(type)}"></i>
                <p class="flex-1 text-gray-800">${message}</p>
                <button onclick="Analytics.removeToast('toast-${toastId}')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                this.removeToast(`toast-${toastId}`);
            }, 5000);
        },
        
        removeToast(toastClass) {
            const toast = document.querySelector(`.${toastClass}`);
            if (toast) {
                toast.classList.add('opacity-0', 'transition');
                setTimeout(() => toast.remove(), 300);
            }
        },
        
        // Quick actions
        toggleQuickActions() {
            const menu = document.getElementById('quickActionsMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        },
        
        quickExport() {
            this.exportExcel();
            this.toggleQuickActions();
        },
        
        quickCompare() {
            this.switchMainTab('comparison');
            this.toggleQuickActions();
        },
        
        quickReport() {
            this.generateReport('summary');
            this.switchMainTab('reports');
            this.toggleQuickActions();
        },
        
        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
            this.toggleQuickActions();
        },
        
        // Export functions
        exportPDF() {
            window.print();
        },
        
        exportExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            csvContent += "Daire Kodu,Sahip,Sistem,Toplam Gelir (EUR),Lagirio Komisyonu (EUR),Ev Sahibi Payı (EUR),Giderler (EUR),Doluluk (%),Rezervasyon Sayısı,Platform\n";
            
            // Data rows
            this.data.apartments?.forEach(apartment => {
                const reservations = this.filteredData.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.filteredData.expenses?.filter(e => e.apartmentId === apartment.id) || [];
                
                const totalIncome = reservations.reduce((sum, res) => 
                    sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
                
                const totalExpenses = expenses.reduce((sum, exp) => 
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);
                
                const lagirioRevenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
                const ownerShare = this.calculateOwnerShare(apartment, reservations, expenses);
                const occupancy = this.calculateOccupancyRate(apartment.id);
                
                // Platform distribution
                const platforms = {};
                reservations.forEach(res => {
                    platforms[res.platform || 'Direkt'] = (platforms[res.platform || 'Direkt'] || 0) + 1;
                });
                const platformStr = Object.entries(platforms)
                    .map(([p, c]) => `${p}:${c}`)
                    .join(';');
                
                csvContent += `${apartment.code},${apartment.ownerName},Sistem ${apartment.systemType},`;
                csvContent += `${totalIncome.toFixed(2)},${lagirioRevenue.toFixed(2)},${ownerShare.toFixed(2)},`;
                csvContent += `${totalExpenses.toFixed(2)},${occupancy.toFixed(1)},${reservations.length},"${platformStr}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `lagirio_analytics_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            this.showToast('Excel dosyası indiriliyor...', 'success');
        },
        
        // Settings
        showSettings() {
            // Admin durumunu göster
            const adminStatus = document.getElementById('adminStatusText');
            if (adminStatus) {
                adminStatus.textContent = Projection.adminAuthenticated ? 'Admin oturumu aktif' : 'Admin girişi yapılmadı';
                adminStatus.className = 'text-xs ' + (Projection.adminAuthenticated ? 'text-emerald-600 font-semibold' : 'text-gray-400');
            }
            this.showModal('settingsModal');
        },
        
        loadSettings() {
            const saved = localStorage.getItem('lagirioSettings');
            if (saved) {
                this.settings = { ...this.settings, ...JSON.parse(saved) };
                this.applySettings();
            }
        },
        
        saveSettings() {
            // Get values from form
            this.settings.darkMode = document.getElementById('darkMode').checked;
            this.settings.animations = document.getElementById('animations').checked;
            this.settings.compactView = document.getElementById('compactView').checked;
            this.settings.defaultCurrency = document.getElementById('defaultCurrency').value;
            this.settings.dateFormat = document.getElementById('dateFormat').value;
            this.settings.lowOccupancyThreshold = parseInt(document.getElementById('lowOccupancyThreshold').value);
            this.settings.highExpenseThreshold = parseInt(document.getElementById('highExpenseThreshold').value);
            
            // Save to localStorage
            localStorage.setItem('lagirioSettings', JSON.stringify(this.settings));
            
            // Apply settings
            this.applySettings();
            
            // Close modal
            this.closeModal('settingsModal');
            this.showToast('Ayarlar kaydedildi', 'success');
            
            // Refresh data if needed
            if (this.data) {
                this.refreshData();
            }
        },
        
        applySettings() {
            // Apply dark mode
            if (this.settings.darkMode) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            // Apply animations
            if (!this.settings.animations) {
                document.querySelectorAll('[class*="animate-"]').forEach(el => {
                    el.style.animation = 'none';
                });
            }
            
            // Apply compact view
            if (this.settings.compactView) {
                document.body.classList.add('compact');
            } else {
                document.body.classList.remove('compact');
            }
        },
        
        switchMainTab(tab) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.classList.add('hidden');
            });

            // Sekme geçişinde dinamik sonuç panellerini gizle
            const compRes = document.getElementById('comparisonResults');
            if (compRes) { compRes.classList.add('hidden'); compRes.innerHTML = ''; }
            const reportPrev = document.getElementById('reportPreview');
            if (reportPrev) { reportPrev.classList.add('hidden'); reportPrev.innerHTML = ''; }

            // Show selected tab content
            const selectedContent = document.getElementById(`${tab}-content`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                selectedContent.classList.add('active');
            }
            
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(btn => {
                const isActive = btn.dataset.tab === tab;
                if (isActive) {
                    btn.classList.add('active', 'bg-white/20', 'text-white');
                    btn.classList.remove('text-white/80', 'hover:text-white');
                } else {
                    btn.classList.remove('active', 'bg-white/20', 'text-white');
                    btn.classList.add('text-white/80', 'hover:text-white');
                }
            });
            
            this.currentMainTab = tab;

            // Initialize specific tab content if needed
            if (tab === 'analysis' && !this.charts.systemComparison) {
                setTimeout(() => this.createSystemAnalysisCharts(), 100);
            }

            if (tab === 'trends' && !this.charts.revenueTrendAnalysis) {
                setTimeout(() => this.createTrendAnalysisCharts(), 100);
            }

            if (tab === 'efficiency' && !this.charts.costEfficiency) {
                setTimeout(() => this.createEfficiencyCharts(), 100);
            }

            if (tab === 'projection') {
                setTimeout(() => {
                    Projection.init();
                    if (Projection.reservations.length > 0) Projection.calculate();
                }, 100);
            }
        },
        
        switchAnalysisTab(tab) {
            // Hide all analysis contents
            document.querySelectorAll('.analysis-content').forEach(content => {
                content.classList.remove('active');  // ← DEĞİŞTİ
            });
            
            // Show selected analysis content
            const selectedContent = document.getElementById(`${tab}-analysis`);
            if (selectedContent) {
                selectedContent.classList.add('active');  // ← DEĞİŞTİ
            }
            
            // Update analysis tab buttons
            document.querySelectorAll('.analysis-tab').forEach(btn => {
                const isActive = btn.dataset.analysis === tab;
                if (isActive) {
                    btn.classList.add('active', 'bg-white', 'shadow-sm');
                    btn.classList.remove('text-gray-600', 'hover:text-gray-900');
                } else {
                    btn.classList.remove('active', 'bg-white', 'shadow-sm');
                    btn.classList.add('text-gray-600', 'hover:text-gray-900');
                }
            });
            
            this.currentAnalysisTab = tab;
        },
        
        // Populate selectors
        populateSelectors() {
            // Apartment selectors
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            ['firstApartments', 'secondApartments', 'reportApartments'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = apartmentOptions;
                }
            });
        },
        
        // Date filter methods
        applyDatePreset(preset) {
            const now = new Date();
            let startDate, endDate;
            
            switch(preset) {
                case 'this-month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'last-3-months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    endDate = now;
                    break;
                case 'last-6-months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    endDate = now;
                    break;
                case 'this-year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = now;
                    break;
                case 'last-year':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                case 'all':
                    this.dateFilter = { start: null, end: null };
                    this.filteredData = this.data;
                    this.refreshData();
                    return;
            }
            
            this.dateFilter = { start: startDate, end: endDate };
            this.applyDateFilter();
        },
        
        applyDateFilter() {
            const startInput = document.getElementById('startDate')?.value;
            const endInput = document.getElementById('endDate')?.value;
            
            if (startInput && endInput) {
                this.dateFilter.start = new Date(startInput);
                this.dateFilter.end = new Date(endInput);
            }
            
            if (!this.dateFilter.start && !this.dateFilter.end) {
                this.filteredData = this.data;
            } else {
                this.filteredData = {
                    ...this.data,
                    reservations: this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return (!this.dateFilter.start || date >= this.dateFilter.start) &&
                               (!this.dateFilter.end || date <= this.dateFilter.end);
                    }) || [],
                    expenses: this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return (!this.dateFilter.start || date >= this.dateFilter.start) &&
                               (!this.dateFilter.end || date <= this.dateFilter.end);
                    }) || []
                };
            }
            
            this.refreshData();
        },
        
        refreshData() {
            this.cache.calculations.clear();
            this.updateAllMetrics();
            
            // Grafikleri yeniden oluştur
            setTimeout(() => {
                this.initializeCharts();
            }, 100);
            
            this.showToast('Veriler güncellendi', 'success');
        },
        resizeAllCharts() {
            Object.values(this.charts).forEach(chart => {
                if (chart && chart.resize) {
                    chart.resize();
                }
            });
        },
        
        // Initialize tooltips
        initializeTooltips() {
            // Simple tooltip implementation
            document.addEventListener('mouseover', (e) => {
                if (e.target.hasAttribute('title')) {
                    const title = e.target.getAttribute('title');
                    e.target.removeAttribute('title');
                    e.target.setAttribute('data-tooltip', title);
                    
                    // Create tooltip element
                    const tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    tooltip.textContent = title;
                    document.body.appendChild(tooltip);
                    
                    // Position tooltip
                    const rect = e.target.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.bottom + 5) + 'px';
                    tooltip.classList.add('show');
                    
                    e.target.addEventListener('mouseleave', () => {
                        tooltip.remove();
                        e.target.setAttribute('title', title);
                    }, { once: true });
                }
            });
        },
        
        // Check for notifications on load
        checkNotifications() {
            // Check for any important notifications
            setTimeout(() => {
                if (this.notifications.length > 0) {
                    const badge = document.getElementById('notificationCount');
                    if (badge) {
                        badge.classList.add('animate-pulse-soft');
                    }
                }
            }, 1000);
        },
        
        // Handle comparison type change
        handleComparisonTypeChange(type) {
            const periodControls = document.getElementById('periodComparisonControls');
            const firstSelect = document.getElementById('firstComparisonSelect');
            const secondSelect = document.getElementById('secondComparisonSelect');
            
            if (type === 'periods') {
                periodControls?.classList.remove('hidden');
                firstSelect?.classList.add('hidden');
                secondSelect?.classList.add('hidden');
            } else {
                periodControls?.classList.add('hidden');
                firstSelect?.classList.remove('hidden');
                secondSelect?.classList.remove('hidden');
            }
            
            this.comparisonType = type;
        },

        // ===========================================
        // ADVANCED COMPARISON METHODS
        // ===========================================

        // Set comparison mode
        setComparisonMode(mode) {
            this.comparisonMode = mode;
            
            // Update UI buttons
            document.querySelectorAll('.comparison-mode-btn').forEach(btn => {
                btn.classList.remove('active', 'border-emerald-500', 'border-blue-500', 'border-purple-500', 'border-orange-500');
                btn.classList.add('border-gray-300');
            });
            
            event.target.closest('.comparison-mode-btn').classList.add('active');
            
            // Set active color based on mode
            const colorMap = {
                'apartment-apartment': 'border-emerald-500',
                'apartment-period': 'border-blue-500',
                'group-group': 'border-purple-500',
                'system-system': 'border-orange-500'
            };
            event.target.closest('.comparison-mode-btn').classList.add(colorMap[mode]);
            
            // Render appropriate panels
            this.renderComparisonPanels();
        },

        // Render comparison panels based on mode
        renderComparisonPanels() {
            const container = document.getElementById('comparisonPanels');
            if (!container) return;
            
            let html = '';
            
            switch(this.comparisonMode) {
                case 'apartment-apartment':
                    html = this.renderApartmentVsApartmentPanel();
                    break;
                case 'apartment-period':
                    html = this.renderApartmentVsPeriodPanel();
                    break;
                case 'group-group':
                    html = this.renderGroupVsGroupPanel();
                    break;
                case 'system-system':
                    html = this.renderSystemVsSystemPanel();
                    break;
            }
            
            container.innerHTML = html;
            setTimeout(() => lucide.createIcons(), 100);
        },

        // Render: Daire vs Daire (aynı dönem)
        renderApartmentVsApartmentPanel() {
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Period Selection -->
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dönem Seçimi</label>
                        <div class="flex items-center space-x-2">
                            <input type="month" id="compPeriod" value="${new Date().toISOString().slice(0,7)}" 
                                class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            <span class="text-gray-500 text-sm">veya</span>
                            <select id="compPeriodPreset" onchange="Analytics.applyComparisonPeriodPreset()" 
                                    class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                                <option value="">Özel Seçim</option>
                                <option value="this-month">Bu Ay</option>
                                <option value="last-month">Geçen Ay</option>
                                <option value="last-3-months">Son 3 Ay</option>
                                <option value="all">Tüm Zamanlar</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Apartment A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Daire
                        </label>
                        <select id="compApartmentA" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Daire Seçin</option>
                            ${apartmentOptions}
                        </select>
                    </div>
                    
                    <!-- VS Icon -->
                    <div class="flex items-end justify-center pb-2">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-gray-600">VS</span>
                        </div>
                    </div>
                    
                    <!-- Apartment B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            İkinci Daire
                        </label>
                        <select id="compApartmentB" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Daire Seçin</option>
                            ${apartmentOptions}
                        </select>
                    </div>
                </div>
            `;
        },

        // Render: Daire vs Dönem (bir daire, farklı aylar)
        renderApartmentVsPeriodPanel() {
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Apartment Selection -->
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Daire Seçimi</label>
                        <select id="compSingleApartment" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Daire Seçin</option>
                            ${apartmentOptions}
                        </select>
                    </div>
                    
                    <!-- Period A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Dönem
                        </label>
                        <input type="month" id="compPeriodA" 
                            value="${new Date(new Date().setMonth(new Date().getMonth()-1)).toISOString().slice(0,7)}"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                    
                    <!-- VS Icon -->
                    <div class="flex items-end justify-center pb-2">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-gray-600">VS</span>
                        </div>
                    </div>
                    
                    <!-- Period B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            İkinci Dönem
                        </label>
                        <input type="month" id="compPeriodB" 
                            value="${new Date().toISOString().slice(0,7)}"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                </div>
            `;
        },

        // Render: Grup vs Grup (çoklu daire)
        renderGroupVsGroupPanel() {
            const apartmentOptions = this.data.apartments?.map(apt => 
                `<option value="${apt.id}">${apt.code} - ${apt.ownerName}</option>`
            ).join('') || '';
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Period Selection -->
                    <div class="lg:col-span-2 mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dönem Seçimi</label>
                        <input type="month" id="compGroupPeriod" value="${new Date().toISOString().slice(0,7)}" 
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                    
                    <!-- Group A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Grup
                        </label>
                        <select id="compGroupA" multiple size="8" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            ${apartmentOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd ile çoklu seçim yapabilirsiniz</p>
                    </div>
                    
                    <!-- Group B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            İkinci Grup
                        </label>
                        <select id="compGroupB" multiple size="8" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            ${apartmentOptions}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd ile çoklu seçim yapabilirsiniz</p>
                    </div>
                </div>
            `;
        },

        // Render: Sistem vs Sistem
        renderSystemVsSystemPanel() {
            const systemNames = {
                '1': 'Sistem 1 - Kira',
                '2': 'Sistem 2 - Kişi Şirketi',
                '3': 'Sistem 3 - Komisyon',
                '4': 'Sistem 4 - Özel Komisyon',
                '5': 'Sistem 5 - Stopajlı',
                '6': 'Sistem 6 - Platform Ayrımlı',
                '7': 'Sistem 7 - Karma Platform',
                '8': 'Sistem 8 - Kâr Bazlı'
            };
            
            const systemOptions = Object.entries(systemNames).map(([id, name]) => 
                `<option value="${id}">${name}</option>`
            ).join('');
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Period Selection -->
                    <div class="lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dönem Seçimi</label>
                        <input type="month" id="compSystemPeriod" value="${new Date().toISOString().slice(0,7)}" 
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                    </div>
                    
                    <!-- System A -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-xs mr-2">A</span>
                            Birinci Sistem
                        </label>
                        <select id="compSystemA" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Sistem Seçin</option>
                            ${systemOptions}
                        </select>
                    </div>
                    
                    <!-- VS Icon -->
                    <div class="flex items-end justify-center pb-2">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-gray-600">VS</span>
                        </div>
                    </div>
                    
                    <!-- System B -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-xs mr-2">B</span>
                            İkinci Sistem
                        </label>
                        <select id="compSystemB" class="w-full px-3 py-2 border border-gray-200 rounded-lg">
                            <option value="">Sistem Seçin</option>
                            ${systemOptions}
                        </select>
                    </div>
                </div>
            `;
        },

        // Apply comparison period preset
        applyComparisonPeriodPreset() {
            const preset = document.getElementById('compPeriodPreset')?.value;
            const periodInput = document.getElementById('compPeriod');
            
            if (!preset || !periodInput) return;
            
            const now = new Date();
            let targetDate;
            
            switch(preset) {
                case 'this-month':
                    targetDate = now;
                    break;
                case 'last-month':
                    targetDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    break;
                case 'last-3-months':
                    targetDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    break;
                case 'all':
                    periodInput.value = '';
                    return;
            }
            
            periodInput.value = targetDate.toISOString().slice(0, 7);
        },

        // Run advanced comparison
        runAdvancedComparison() {
            let comparisonData = null;
            
            switch(this.comparisonMode) {
                case 'apartment-apartment':
                    comparisonData = this.compareApartmentVsApartment();
                    break;
                case 'apartment-period':
                    comparisonData = this.compareApartmentVsPeriod();
                    break;
                case 'group-group':
                    comparisonData = this.compareGroupVsGroup();
                    break;
                case 'system-system':
                    comparisonData = this.compareSystemVsSystem();
                    break;
            }
            
            if (comparisonData) {
                this.displayComparisonResults(comparisonData);
            }
        },

        // Compare: Apartment vs Apartment (same period)
        compareApartmentVsApartment() {
            const apartmentAId = document.getElementById('compApartmentA')?.value;
            const apartmentBId = document.getElementById('compApartmentB')?.value;
            const period = document.getElementById('compPeriod')?.value;
            
            if (!apartmentAId || !apartmentBId) {
                this.showToast('Lütfen iki daire seçin', 'warning');
                return null;
            }
            
            const apartmentA = this.data.apartments?.find(a => a.id === apartmentAId);
            const apartmentB = this.data.apartments?.find(a => a.id === apartmentBId);
            
            if (!apartmentA || !apartmentB) {
                this.showToast('Daireler bulunamadı', 'error');
                return null;
            }
            
            // Calculate metrics for both apartments
            let periodStart, periodEnd;
            
            if (period) {
                const [year, month] = period.split('-').map(Number);
                periodStart = new Date(year, month - 1, 1);
                periodEnd = new Date(year, month, 0);
            } else {
                // All time
                periodStart = new Date(2000, 0, 1);
                periodEnd = new Date();
            }
            
            const metricsA = this.calculateApartmentMetrics(apartmentA, periodStart, periodEnd);
            const metricsB = this.calculateApartmentMetrics(apartmentB, periodStart, periodEnd);
            
            return {
                mode: 'apartment-apartment',
                title: `${apartmentA.code} vs ${apartmentB.code}`,
                subtitle: period ? `Dönem: ${this.formatMonthYear(periodStart)}` : 'Tüm Zamanlar',
                groupA: {
                    label: apartmentA.code,
                    sublabel: apartmentA.ownerName,
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: apartmentB.code,
                    sublabel: apartmentB.ownerName,
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Compare: Apartment vs Period
        compareApartmentVsPeriod() {
            const apartmentId = document.getElementById('compSingleApartment')?.value;
            const periodA = document.getElementById('compPeriodA')?.value;
            const periodB = document.getElementById('compPeriodB')?.value;
            
            if (!apartmentId || !periodA || !periodB) {
                this.showToast('Lütfen daire ve iki dönem seçin', 'warning');
                return null;
            }
            
            const apartment = this.data.apartments?.find(a => a.id === apartmentId);
            
            if (!apartment) {
                this.showToast('Daire bulunamadı', 'error');
                return null;
            }
            
            // Parse periods
            const [yearA, monthA] = periodA.split('-').map(Number);
            const [yearB, monthB] = periodB.split('-').map(Number);
            
            const periodStartA = new Date(yearA, monthA - 1, 1);
            const periodEndA = new Date(yearA, monthA, 0);
            
            const periodStartB = new Date(yearB, monthB - 1, 1);
            const periodEndB = new Date(yearB, monthB, 0);
            
            const metricsA = this.calculateApartmentMetrics(apartment, periodStartA, periodEndA);
            const metricsB = this.calculateApartmentMetrics(apartment, periodStartB, periodEndB);
            
            return {
                mode: 'apartment-period',
                title: `${apartment.code} - Dönem Karşılaştırması`,
                subtitle: apartment.ownerName,
                groupA: {
                    label: this.formatMonthYear(periodStartA),
                    sublabel: 'Dönem A',
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: this.formatMonthYear(periodStartB),
                    sublabel: 'Dönem B',
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Compare: Group vs Group
        compareGroupVsGroup() {
            const groupAIds = Array.from(document.getElementById('compGroupA')?.selectedOptions || [])
                .map(opt => opt.value);
            const groupBIds = Array.from(document.getElementById('compGroupB')?.selectedOptions || [])
                .map(opt => opt.value);
            const period = document.getElementById('compGroupPeriod')?.value;
            
            if (groupAIds.length === 0 || groupBIds.length === 0) {
                this.showToast('Lütfen her iki grup için daire seçin', 'warning');
                return null;
            }
            
            // Parse period
            let periodStart, periodEnd;
            
            if (period) {
                const [year, month] = period.split('-').map(Number);
                periodStart = new Date(year, month - 1, 1);
                periodEnd = new Date(year, month, 0);
            } else {
                periodStart = new Date(2000, 0, 1);
                periodEnd = new Date();
            }
            
            const metricsA = this.calculateGroupMetrics(groupAIds, periodStart, periodEnd);
            const metricsB = this.calculateGroupMetrics(groupBIds, periodStart, periodEnd);
            
            return {
                mode: 'group-group',
                title: 'Grup Karşılaştırması',
                subtitle: period ? `Dönem: ${this.formatMonthYear(periodStart)}` : 'Tüm Zamanlar',
                groupA: {
                    label: `Grup A (${groupAIds.length} daire)`,
                    sublabel: 'Toplam Performans',
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: `Grup B (${groupBIds.length} daire)`,
                    sublabel: 'Toplam Performans',
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Compare: System vs System
        compareSystemVsSystem() {
            const systemA = document.getElementById('compSystemA')?.value;
            const systemB = document.getElementById('compSystemB')?.value;
            const period = document.getElementById('compSystemPeriod')?.value;
            
            if (!systemA || !systemB) {
                this.showToast('Lütfen iki sistem seçin', 'warning');
                return null;
            }
            
            const systemNames = {
                '1': 'Sistem 1 - Kira',
                '2': 'Sistem 2 - Kişi Şirketi',
                '3': 'Sistem 3 - Komisyon',
                '4': 'Sistem 4 - Özel Komisyon',
                '5': 'Sistem 5 - Stopajlı',
                '6': 'Sistem 6 - Platform Ayrımlı',
                '7': 'Sistem 7 - Karma Platform',
                '8': 'Sistem 8 - Kâr Bazlı'
            };
            
            // Parse period
            let periodStart, periodEnd;
            
            if (period) {
                const [year, month] = period.split('-').map(Number);
                periodStart = new Date(year, month - 1, 1);
                periodEnd = new Date(year, month, 0);
            } else {
                periodStart = new Date(2000, 0, 1);
                periodEnd = new Date();
            }
            
            const metricsA = this.calculateSystemMetrics(systemA, periodStart, periodEnd);
            const metricsB = this.calculateSystemMetrics(systemB, periodStart, periodEnd);
            
            return {
                mode: 'system-system',
                title: 'Sistem Karşılaştırması',
                subtitle: period ? `Dönem: ${this.formatMonthYear(periodStart)}` : 'Tüm Zamanlar',
                groupA: {
                    label: systemNames[systemA],
                    sublabel: `${metricsA.apartmentCount} daire`,
                    metrics: metricsA,
                    color: 'emerald'
                },
                groupB: {
                    label: systemNames[systemB],
                    sublabel: `${metricsB.apartmentCount} daire`,
                    metrics: metricsB,
                    color: 'blue'
                }
            };
        },

        // Helper: Calculate apartment metrics
        calculateApartmentMetrics(apartment, startDate, endDate) {
            // DEBUG: Sadece Sistem 2 (Kişi Şirketi) için
            if (apartment.systemType === '2') {
                console.log(`\n🔎 calculateApartmentMetrics: ${apartment.code} (${apartment.id})`);
                console.log(`   Dönem: ${startDate.toISOString()} → ${endDate.toISOString()}`);
                console.log(`   startDate local: ${startDate.toString()}`);
                console.log(`   endDate local: ${endDate.toString()}`);

                const allAptExpenses = this.data.expenses?.filter(exp => exp.apartmentId === apartment.id) || [];
                console.log(`   Bu daireye ait TOPLAM gider sayısı (filtersiz): ${allAptExpenses.length}`);

                allAptExpenses.forEach(exp => {
                    const date = new Date(exp.date);
                    const inRange = date >= startDate && date <= endDate;
                    console.log(`   ${inRange ? '✅' : '❌'} exp.date="${exp.date}" → parsed=${date.toISOString()} (${date.toString()}) | ${exp.amount} ${exp.currency} | >= start: ${date >= startDate}, <= end: ${date <= endDate}`);
                });
            }

            const reservations = this.data.reservations?.filter(res => {
                const checkIn = new Date(res.checkIn);
                return res.apartmentId === apartment.id &&
                    checkIn >= startDate && checkIn <= endDate;
            }) || [];

            const expenses = this.data.expenses?.filter(exp => {
                const date = new Date(exp.date);
                return exp.apartmentId === apartment.id &&
                    date >= startDate && date <= endDate;
            }) || [];

            console.log(`   Filtrelenmiş gider sayısı: ${expenses.length}`);
            
            const lagirioRevenue = this.calculateLagirioRevenue(apartment, reservations, expenses);
            const ownerShare = this.calculateOwnerShare(apartment, reservations, expenses);
            
            const totalIncome = reservations.reduce((sum, res) => 
                sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);
            
            const totalExpenses = expenses.reduce((sum, exp) => 
                sum + this.convertToEUR(exp.amount, exp.currency), 0);
            
            const occupancy = this.calculateOccupancyRate(apartment.id, startDate, endDate);
            const avgNightlyRate = this.calculateAvgNightlyRate(reservations);
            
            // Calculate total nights
            const totalNights = reservations.reduce((sum, res) => {
                const nights = Math.ceil((new Date(res.checkOut) - new Date(res.checkIn)) / (1000 * 60 * 60 * 24));
                return sum + nights;
            }, 0);
            
            return {
                lagirioRevenue,
                ownerShare,
                totalIncome,
                totalExpenses,
                occupancy,
                avgNightlyRate,
                reservationCount: reservations.length,
                totalNights,
                profitMargin: totalIncome > 0 ? (lagirioRevenue / totalIncome * 100) : 0,
                expenseRatio: totalIncome > 0 ? (totalExpenses / totalIncome * 100) : 0
            };
        },

        // Helper: Calculate group metrics
        calculateGroupMetrics(apartmentIds, startDate, endDate) {
            let metrics = {
                lagirioRevenue: 0,
                ownerShare: 0,
                totalIncome: 0,
                totalExpenses: 0,
                occupancy: 0,
                avgNightlyRate: 0,
                reservationCount: 0,
                totalNights: 0,
                apartmentCount: apartmentIds.length
            };
            
            apartmentIds.forEach(apartmentId => {
                const apartment = this.data.apartments?.find(a => a.id === apartmentId);
                if (!apartment) return;
                
                const apartmentMetrics = this.calculateApartmentMetrics(apartment, startDate, endDate);
                
                metrics.lagirioRevenue += apartmentMetrics.lagirioRevenue;
                metrics.ownerShare += apartmentMetrics.ownerShare;
                metrics.totalIncome += apartmentMetrics.totalIncome;
                metrics.totalExpenses += apartmentMetrics.totalExpenses;
                metrics.occupancy += apartmentMetrics.occupancy;
                metrics.avgNightlyRate += apartmentMetrics.avgNightlyRate;
                metrics.reservationCount += apartmentMetrics.reservationCount;
                metrics.totalNights += apartmentMetrics.totalNights;
            });
            
            // Calculate averages
            if (apartmentIds.length > 0) {
                metrics.occupancy = metrics.occupancy / apartmentIds.length;
                metrics.avgNightlyRate = metrics.avgNightlyRate / apartmentIds.length;
            }
            
            metrics.profitMargin = metrics.totalIncome > 0 ? (metrics.lagirioRevenue / metrics.totalIncome * 100) : 0;
            metrics.expenseRatio = metrics.totalIncome > 0 ? (metrics.totalExpenses / metrics.totalIncome * 100) : 0;
            
            return metrics;
        },

        // Helper: Calculate system metrics
        calculateSystemMetrics(systemType, startDate, endDate) {
            const systemApartments = this.data.apartments?.filter(a => a.systemType === systemType) || [];
            const apartmentIds = systemApartments.map(a => a.id);
            
            const metrics = this.calculateGroupMetrics(apartmentIds, startDate, endDate);
            
            // Add commission average
            const commissions = systemApartments.map(a => a.lagirioCommission);
            metrics.avgCommission = commissions.length > 0 ? 
                commissions.reduce((a, b) => a + b, 0) / commissions.length : 0;
            
            return metrics;
        },

        // Helper: Format month/year
        formatMonthYear(date) {
            const months = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        },

        // Display comparison results
        displayComparisonResults(data) {
            const container = document.getElementById('comparisonResults');
            if (!container) return;
            
            const colorA = data.groupA.color;
            const colorB = data.groupB.color;
            
            // Calculate differences
            const diff = {
                revenue: data.groupA.metrics.lagirioRevenue - data.groupB.metrics.lagirioRevenue,
                revenuePercent: data.groupB.metrics.lagirioRevenue > 0 ? 
                    ((data.groupA.metrics.lagirioRevenue - data.groupB.metrics.lagirioRevenue) / data.groupB.metrics.lagirioRevenue * 100) : 0,
                
                income: data.groupA.metrics.totalIncome - data.groupB.metrics.totalIncome,
                incomePercent: data.groupB.metrics.totalIncome > 0 ? 
                    ((data.groupA.metrics.totalIncome - data.groupB.metrics.totalIncome) / data.groupB.metrics.totalIncome * 100) : 0,
                
                expenses: data.groupA.metrics.totalExpenses - data.groupB.metrics.totalExpenses,
                expensesPercent: data.groupB.metrics.totalExpenses > 0 ? 
                    ((data.groupA.metrics.totalExpenses - data.groupB.metrics.totalExpenses) / data.groupB.metrics.totalExpenses * 100) : 0,
                
                occupancy: data.groupA.metrics.occupancy - data.groupB.metrics.occupancy,
                occupancyPercent: data.groupB.metrics.occupancy > 0 ? 
                    ((data.groupA.metrics.occupancy - data.groupB.metrics.occupancy) / data.groupB.metrics.occupancy * 100) : 0,
                
                reservations: data.groupA.metrics.reservationCount - data.groupB.metrics.reservationCount,
                reservationsPercent: data.groupB.metrics.reservationCount > 0 ? 
                    ((data.groupA.metrics.reservationCount - data.groupB.metrics.reservationCount) / data.groupB.metrics.reservationCount * 100) : 0,
                
                nightlyRate: data.groupA.metrics.avgNightlyRate - data.groupB.metrics.avgNightlyRate,
                nightlyRatePercent: data.groupB.metrics.avgNightlyRate > 0 ? 
                    ((data.groupA.metrics.avgNightlyRate - data.groupB.metrics.avgNightlyRate) / data.groupB.metrics.avgNightlyRate * 100) : 0
            };
            
            container.innerHTML = `
                <!-- Comparison Header -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 animate-fade-in">
                    <div class="text-center mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${data.title}</h3>
                        <p class="text-gray-500">${data.subtitle}</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <!-- Group A -->
                        <div class="text-center p-6 bg-${colorA}-50 rounded-lg">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-${colorA}-500 text-white rounded-full mb-3">
                                <span class="text-2xl font-bold">A</span>
                            </div>
                            <h4 class="font-bold text-lg text-gray-800">${data.groupA.label}</h4>
                            <p class="text-sm text-gray-600">${data.groupA.sublabel}</p>
                        </div>
                        
                        <!-- VS -->
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 rounded-full">
                                <span class="text-3xl font-bold text-gray-600">VS</span>
                            </div>
                        </div>
                        
                        <!-- Group B -->
                        <div class="text-center p-6 bg-${colorB}-50 rounded-lg">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-${colorB}-500 text-white rounded-full mb-3">
                                <span class="text-2xl font-bold">B</span>
                            </div>
                            <h4 class="font-bold text-lg text-gray-800">${data.groupB.label}</h4>
                            <p class="text-sm text-gray-600">${data.groupB.sublabel}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Comparison Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Group A Metrics -->
                    <div class="bg-${colorA}-50 rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-${colorA}-900 mb-4 flex items-center space-x-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-${colorA}-500 text-white rounded-full text-xs">A</span>
                            <span>${data.groupA.label} - Detaylar</span>
                        </h4>
                        <div class="space-y-3">
                            ${this.renderMetricRow('Lagirio Kazancı', data.groupA.metrics.lagirioRevenue, 'EUR')}
                            ${this.renderMetricRow('Toplam Gelir', data.groupA.metrics.totalIncome, 'EUR')}
                            ${this.renderMetricRow('Toplam Gider', data.groupA.metrics.totalExpenses, 'EUR')}
                            ${this.renderMetricRow('Ev Sahibi Payı', data.groupA.metrics.ownerShare, 'EUR')}
                            ${this.renderMetricRow('Doluluk Oranı', data.groupA.metrics.occupancy, '%')}
                            ${this.renderMetricRow('Rezervasyon Sayısı', data.groupA.metrics.reservationCount, '')}
                            ${this.renderMetricRow('Toplam Gece', data.groupA.metrics.totalNights, '')}
                            ${this.renderMetricRow('Ort. Gecelik Ücret', data.groupA.metrics.avgNightlyRate, 'EUR')}
                            ${this.renderMetricRow('Kâr Marjı', data.groupA.metrics.profitMargin, '%')}
                            ${this.renderMetricRow('Gider/Gelir Oranı', data.groupA.metrics.expenseRatio, '%')}
                        </div>
                    </div>
                    
                    <!-- Group B Metrics -->
                    <div class="bg-${colorB}-50 rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-${colorB}-900 mb-4 flex items-center space-x-2">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-${colorB}-500 text-white rounded-full text-xs">B</span>
                            <span>${data.groupB.label} - Detaylar</span>
                        </h4>
                        <div class="space-y-3">
                            ${this.renderMetricRow('Lagirio Kazancı', data.groupB.metrics.lagirioRevenue, 'EUR')}
                            ${this.renderMetricRow('Toplam Gelir', data.groupB.metrics.totalIncome, 'EUR')}
                            ${this.renderMetricRow('Toplam Gider', data.groupB.metrics.totalExpenses, 'EUR')}
                            ${this.renderMetricRow('Ev Sahibi Payı', data.groupB.metrics.ownerShare, 'EUR')}
                            ${this.renderMetricRow('Doluluk Oranı', data.groupB.metrics.occupancy, '%')}
                            ${this.renderMetricRow('Rezervasyon Sayısı', data.groupB.metrics.reservationCount, '')}
                            ${this.renderMetricRow('Toplam Gece', data.groupB.metrics.totalNights, '')}
                            ${this.renderMetricRow('Ort. Gecelik Ücret', data.groupB.metrics.avgNightlyRate, 'EUR')}
                            ${this.renderMetricRow('Kâr Marjı', data.groupB.metrics.profitMargin, '%')}
                            ${this.renderMetricRow('Gider/Gelir Oranı', data.groupB.metrics.expenseRatio, '%')}
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Summary -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h4 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i>
                        <span>Karşılaştırma Özeti (A - B)</span>
                    </h4>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        ${this.renderDiffCard('Lagirio Kazancı', diff.revenue, diff.revenuePercent, 'EUR', true)}
                        ${this.renderDiffCard('Toplam Gelir', diff.income, diff.incomePercent, 'EUR', true)}
                        ${this.renderDiffCard('Toplam Gider', diff.expenses, diff.expensesPercent, 'EUR', false)}
                        ${this.renderDiffCard('Doluluk Oranı', diff.occupancy, diff.occupancyPercent, '%', true)}
                        ${this.renderDiffCard('Rezervasyon', diff.reservations, diff.reservationsPercent, '', true)}
                        ${this.renderDiffCard('Gecelik Ücret', diff.nightlyRate, diff.nightlyRatePercent, 'EUR', true)}
                    </div>
                </div>
                
                <!-- Comparison Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">Gelir Karşılaştırması</h4>
                        <div class="chart-container-sm" id="comparisonRevenueChart"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-semibold text-gray-800 mb-4">Performans Radarı</h4>
                        <div class="chart-container-sm" id="comparisonRadarChart"></div>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
            
            // Create charts
            setTimeout(() => {
                this.createComparisonCharts(data);
                lucide.createIcons();
            }, 100);
            
            // Scroll to results
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            this.showToast('Karşılaştırma tamamlandı!', 'success');
        },

        // Helper: Render metric row
        renderMetricRow(label, value, unit) {
            let formattedValue;
            
            if (unit === 'EUR') {
                formattedValue = `€${value.toFixed(2)}`;
            } else if (unit === '%') {
                formattedValue = `${value.toFixed(1)}%`;
            } else {
                formattedValue = value.toFixed(2);
            }
            
            return `
                <div class="flex justify-between items-center py-2 border-b border-white/50">
                    <span class="text-gray-700 text-sm">${label}:</span>
                    <span class="font-semibold text-gray-900">${formattedValue}</span>
                </div>
            `;
        },

        // Helper: Render difference card
        renderDiffCard(label, diffValue, diffPercent, unit, higherIsBetter) {
            let formattedDiff;
            let icon, colorClass;
            
            if (unit === 'EUR') {
                formattedDiff = `€${Math.abs(diffValue).toFixed(2)}`;
            } else if (unit === '%') {
                formattedDiff = `${Math.abs(diffValue).toFixed(1)}%`;
            } else {
                formattedDiff = Math.abs(diffValue).toFixed(2);
            }
            
            // Determine color and icon
            if (diffValue > 0) {
                icon = higherIsBetter ? '↑' : '↓';
                colorClass = higherIsBetter ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
            } else if (diffValue < 0) {
                icon = higherIsBetter ? '↓' : '↑';
                colorClass = higherIsBetter ? 'text-red-600 bg-red-50' : 'text-green-600 bg-green-50';
            } else {
                icon = '→';
                colorClass = 'text-gray-600 bg-gray-50';
            }
            
            return `
                <div class="text-center p-4 ${colorClass} rounded-lg">
                    <p class="text-xs text-gray-600 mb-1">${label}</p>
                    <p class="text-2xl font-bold ${colorClass.includes('green') ? 'text-green-600' : colorClass.includes('red') ? 'text-red-600' : 'text-gray-600'}">
                        ${diffValue > 0 ? '+' : diffValue < 0 ? '-' : ''}${formattedDiff}
                    </p>
                    <p class="text-sm mt-1 ${colorClass.includes('green') ? 'text-green-600' : colorClass.includes('red') ? 'text-red-600' : 'text-gray-600'}">
                        ${icon} ${Math.abs(diffPercent).toFixed(1)}%
                    </p>
                </div>
            `;
        },

        // Create comparison charts
        createComparisonCharts(data) {
            this.createComparisonRevenueChart(data);
            this.createComparisonRadarChart(data);
        },

        // Create comparison revenue chart
        createComparisonRevenueChart(data) {
            const container = document.getElementById('comparisonRevenueChart');
            if (!container) return;
            
            const chart = echarts.init(container);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: [data.groupA.label, data.groupB.label],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['Lagirio\nKazancı', 'Toplam\nGelir', 'Toplam\nGider', 'Ev Sahibi\nPayı']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: value => `€${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [
                    {
                        name: data.groupA.label,
                        type: 'bar',
                        data: [
                            data.groupA.metrics.lagirioRevenue,
                            data.groupA.metrics.totalIncome,
                            data.groupA.metrics.totalExpenses,
                            data.groupA.metrics.ownerShare
                        ],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: data.groupA.color === 'emerald' ? '#10b981' : '#3b82f6' },
                                { offset: 1, color: data.groupA.color === 'emerald' ? '#059669' : '#2563eb' }
                            ]),
                            borderRadius: [4, 4, 0, 0]
                        }
                    },
                    {
                        name: data.groupB.label,
                        type: 'bar',
                        data: [
                            data.groupB.metrics.lagirioRevenue,
                            data.groupB.metrics.totalIncome,
                            data.groupB.metrics.totalExpenses,
                            data.groupB.metrics.ownerShare
                        ],
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: data.groupB.color === 'blue' ? '#3b82f6' : '#10b981' },
                                { offset: 1, color: data.groupB.color === 'blue' ? '#2563eb' : '#059669' }
                            ]),
                            borderRadius: [4, 4, 0, 0]
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            this.charts.comparisonRevenue = chart;
        },

        // Create comparison radar chart
        createComparisonRadarChart(data) {
            const container = document.getElementById('comparisonRadarChart');
            if (!container) return;
            
            const chart = echarts.init(container);
            
            // Normalize values for radar (0-100 scale)
            const maxRevenue = Math.max(data.groupA.metrics.lagirioRevenue, data.groupB.metrics.lagirioRevenue);
            const maxReservations = Math.max(data.groupA.metrics.reservationCount, data.groupB.metrics.reservationCount);
            const maxNightlyRate = Math.max(data.groupA.metrics.avgNightlyRate, data.groupB.metrics.avgNightlyRate);
            
            const option = {
                tooltip: {},
                legend: {
                    data: [data.groupA.label, data.groupB.label],
                    bottom: 0
                },
                radar: {
                    indicator: [
                        { name: 'Kazanç', max: 100 },
                        { name: 'Doluluk', max: 100 },
                        { name: 'Rezervasyon', max: 100 },
                        { name: 'Gecelik Ücret', max: 100 },
                        { name: 'Kâr Marjı', max: 100 }
                    ],
                    radius: '60%'
                },
                series: [{
                    type: 'radar',
                    data: [
                        {
                            value: [
                                maxRevenue > 0 ? (data.groupA.metrics.lagirioRevenue / maxRevenue * 100) : 0,
                                data.groupA.metrics.occupancy,
                                maxReservations > 0 ? (data.groupA.metrics.reservationCount / maxReservations * 100) : 0,
                                maxNightlyRate > 0 ? (data.groupA.metrics.avgNightlyRate / maxNightlyRate * 100) : 0,
                                data.groupA.metrics.profitMargin
                            ],
                            name: data.groupA.label,
                            areaStyle: {
                                color: data.groupA.color === 'emerald' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(59, 130, 246, 0.3)'
                            },
                            lineStyle: {
                                color: data.groupA.color === 'emerald' ? '#10b981' : '#3b82f6'
                            }
                        },
                        {
                            value: [
                                maxRevenue > 0 ? (data.groupB.metrics.lagirioRevenue / maxRevenue * 100) : 0,
                                data.groupB.metrics.occupancy,
                                maxReservations > 0 ? (data.groupB.metrics.reservationCount / maxReservations * 100) : 0,
                                maxNightlyRate > 0 ? (data.groupB.metrics.avgNightlyRate / maxNightlyRate * 100) : 0,
                                data.groupB.metrics.profitMargin
                            ],
                            name: data.groupB.label,
                            areaStyle: {
                                color: data.groupB.color === 'blue' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)'
                            },
                            lineStyle: {
                                color: data.groupB.color === 'blue' ? '#3b82f6' : '#10b981'
                            }
                        }
                    ]
                }]
            };
            
            chart.setOption(option);
            this.charts.comparisonRadar = chart;
        },
        
        // ==================== TREND ANALYSIS CHARTS ====================

        createTrendAnalysisCharts() {
            this.createRevenueTrendAnalysisChart();
            this.createOccupancyTrendChart();
            this.createSeasonalAnalysisChart();
            this.createGrowthAnalysisChart();
            this.updateForecastCards();
        },

        createRevenueTrendAnalysisChart() {
            const container = document.getElementById('revenueTrendAnalysisChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.revenueTrendAnalysis = chart;

            // Son 12 aylık veri
            const data = { months: [], revenues: [], expenses: [], profit: [] };
            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = targetDate.toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' });

                let monthRevenue = 0;
                let monthExpenses = 0;

                this.data.apartments?.forEach(apartment => {
                    const monthReservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    const monthExpensesList = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    monthRevenue += this.calculateLagirioRevenue(apartment, monthReservations, monthExpensesList);
                    monthExpenses += monthExpensesList.reduce((sum, exp) =>
                        sum + this.convertToEUR(exp.amount, exp.currency), 0);
                });

                data.months.push(monthName);
                data.revenues.push(monthRevenue);
                data.expenses.push(monthExpenses);
                data.profit.push(monthRevenue - monthExpenses);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'transparent'
                },
                legend: {
                    data: ['Gelir', 'Gider', 'Net Kâr'],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.months,
                    axisLabel: { rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: value => `€${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [
                    {
                        name: 'Gelir',
                        type: 'line',
                        data: data.revenues,
                        smooth: true,
                        itemStyle: { color: '#10b981' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                                { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'Gider',
                        type: 'line',
                        data: data.expenses,
                        smooth: true,
                        itemStyle: { color: '#ef4444' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                                { offset: 1, color: 'rgba(239, 68, 68, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'Net Kâr',
                        type: 'bar',
                        data: data.profit,
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#3b82f6' },
                                { offset: 1, color: '#2563eb' }
                            ])
                        }
                    }
                ]
            };

            chart.setOption(option);
        },

        createOccupancyTrendChart() {
            const container = document.getElementById('occupancyTrendChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.occupancyTrend = chart;

            // Son 12 aylık doluluk oranı
            const data = { months: [], occupancy: [] };
            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = targetDate.toLocaleDateString('tr-TR', { month: 'short', year: 'numeric' });

                let totalOccupancy = 0;
                let activeCount = 0;

                this.data.apartments?.forEach(apartment => {
                    const monthStart = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
                    const monthEnd = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);

                    const hasReservations = this.data.reservations?.some(res => {
                        const checkIn = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            checkIn >= monthStart && checkIn <= monthEnd;
                    });

                    if (hasReservations) {
                        const occupancy = this.calculateOccupancyRate(apartment.id, monthStart, monthEnd);
                        totalOccupancy += occupancy;
                        activeCount++;
                    }
                });

                data.months.push(monthName);
                data.occupancy.push(activeCount > 0 ? totalOccupancy / activeCount : 0);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: params => `${params[0].name}<br/>Doluluk: ${params[0].value.toFixed(1)}%`
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.months,
                    axisLabel: { rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    max: 100,
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'Doluluk',
                    type: 'line',
                    data: data.occupancy,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    itemStyle: { color: '#f59e0b' },
                    lineStyle: { width: 3 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(245, 158, 11, 0.4)' },
                            { offset: 1, color: 'rgba(245, 158, 11, 0.05)' }
                        ])
                    }
                }]
            };

            chart.setOption(option);
        },

        createSeasonalAnalysisChart() {
            const container = document.getElementById('seasonalAnalysisChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.seasonalAnalysis = chart;

            // Aylara göre ortalama kazanç
            const monthlyData = Array(12).fill(0);
            const monthlyCounts = Array(12).fill(0);

            this.data.apartments?.forEach(apartment => {
                this.data.reservations?.filter(res => res.apartmentId === apartment.id).forEach(res => {
                    const month = new Date(res.checkIn).getMonth();
                    const expenses = this.data.expenses?.filter(exp => {
                        const expMonth = new Date(exp.date).getMonth();
                        const expYear = new Date(exp.date).getFullYear();
                        const resYear = new Date(res.checkIn).getFullYear();
                        return exp.apartmentId === apartment.id && expMonth === month && expYear === resYear;
                    }) || [];

                    monthlyData[month] += this.calculateLagirioRevenue(apartment, [res], expenses);
                    monthlyCounts[month]++;
                });
            });

            const avgMonthlyRevenue = monthlyData.map((total, i) =>
                monthlyCounts[i] > 0 ? total / monthlyCounts[i] : 0
            );

            const monthNames = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: params => `${params[0].name}<br/>Ort. Kazanç: €${params[0].value.toLocaleString()}`
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: monthNames
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: value => `€${(value / 1000).toFixed(0)}k`
                    }
                },
                series: [{
                    name: 'Ortalama Kazanç',
                    type: 'bar',
                    data: avgMonthlyRevenue,
                    itemStyle: {
                        color: params => {
                            const colors = [
                                '#3b82f6', '#3b82f6', '#10b981', '#10b981', '#22c55e', '#fbbf24',
                                '#f59e0b', '#ef4444', '#10b981', '#22c55e', '#3b82f6', '#3b82f6'
                            ];
                            return colors[params.dataIndex];
                        },
                        borderRadius: [4, 4, 0, 0]
                    }
                }]
            };

            chart.setOption(option);
        },

        createGrowthAnalysisChart() {
            const container = document.getElementById('growthAnalysisChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.growthAnalysis = chart;

            // Yıllık büyüme analizi
            const yearlyData = {};

            this.data.apartments?.forEach(apartment => {
                this.data.reservations?.filter(res => res.apartmentId === apartment.id).forEach(res => {
                    const year = new Date(res.checkIn).getFullYear();
                    if (!yearlyData[year]) {
                        yearlyData[year] = { revenue: 0, count: 0 };
                    }

                    const expenses = this.data.expenses?.filter(exp => {
                        const expYear = new Date(exp.date).getFullYear();
                        return exp.apartmentId === apartment.id && expYear === year;
                    }) || [];

                    yearlyData[year].revenue += this.calculateLagirioRevenue(apartment, [res], expenses);
                    yearlyData[year].count++;
                });
            });

            const years = Object.keys(yearlyData).sort();
            const revenues = years.map(year => yearlyData[year].revenue);
            const growth = revenues.map((rev, i) => {
                if (i === 0) return 0;
                return ((rev - revenues[i-1]) / revenues[i-1] * 100);
            });

            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['Gelir', 'Büyüme %'],
                    bottom: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: years
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Gelir',
                        position: 'left',
                        axisLabel: {
                            formatter: value => `€${(value / 1000).toFixed(0)}k`
                        }
                    },
                    {
                        type: 'value',
                        name: 'Büyüme %',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    }
                ],
                series: [
                    {
                        name: 'Gelir',
                        type: 'bar',
                        data: revenues,
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#10b981' },
                                { offset: 1, color: '#059669' }
                            ])
                        }
                    },
                    {
                        name: 'Büyüme %',
                        type: 'line',
                        yAxisIndex: 1,
                        data: growth,
                        smooth: true,
                        itemStyle: { color: '#8b5cf6' },
                        lineStyle: { width: 3 }
                    }
                ]
            };

            chart.setOption(option);
        },

        updateForecastCards() {
            // Basit tahmin: son 3 ayın ortalaması
            const revenues = [];
            const now = new Date();

            for (let i = 2; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                let monthRevenue = 0;

                this.data.apartments?.forEach(apartment => {
                    const monthReservations = this.data.reservations?.filter(res => {
                        const date = new Date(res.checkIn);
                        return res.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    const monthExpenses = this.data.expenses?.filter(exp => {
                        const date = new Date(exp.date);
                        return exp.apartmentId === apartment.id &&
                            date.getMonth() === targetDate.getMonth() &&
                            date.getFullYear() === targetDate.getFullYear();
                    }) || [];

                    monthRevenue += this.calculateLagirioRevenue(apartment, monthReservations, monthExpenses);
                });

                revenues.push(monthRevenue);
            }

            const avgRevenue = revenues.reduce((a, b) => a + b, 0) / revenues.length;

            const nextMonthForecast = document.getElementById('nextMonthForecast');
            const quarterForecast = document.getElementById('quarterForecast');
            const yearlyTarget = document.getElementById('yearlyTarget');

            if (nextMonthForecast) nextMonthForecast.textContent = `€${avgRevenue.toFixed(2)}`;
            if (quarterForecast) quarterForecast.textContent = `€${(avgRevenue * 3).toFixed(2)}`;
            if (yearlyTarget) yearlyTarget.textContent = `€${(avgRevenue * 12).toFixed(2)}`;
        },

        // ==================== EFFICIENCY CHARTS ====================

        createEfficiencyCharts() {
            this.createCostEfficiencyChart();
            this.createSystemEfficiencyChart();
            this.updateEfficiencyMetrics();
        },

        createCostEfficiencyChart() {
            const container = document.getElementById('costEfficiencyChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.costEfficiency = chart;

            // Her daire için gider/gelir oranı
            const apartmentData = [];

            this.data.apartments?.forEach(apartment => {
                const reservations = this.data.reservations?.filter(r => r.apartmentId === apartment.id) || [];
                const expenses = this.data.expenses?.filter(e => e.apartmentId === apartment.id) || [];

                const totalIncome = reservations.reduce((sum, res) =>
                    sum + this.convertToEUR(res.totalAmount, res.currency || 'EUR'), 0);

                const totalExpenses = expenses.reduce((sum, exp) =>
                    sum + this.convertToEUR(exp.amount, exp.currency), 0);

                const ratio = totalIncome > 0 ? (totalExpenses / totalIncome * 100) : 0;

                apartmentData.push({
                    name: apartment.code,
                    ratio: ratio,
                    income: totalIncome,
                    expenses: totalExpenses
                });
            });

            // Gider/gelir oranına göre sırala
            apartmentData.sort((a, b) => a.ratio - b.ratio);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: params => {
                        const data = apartmentData[params[0].dataIndex];
                        return `${data.name}<br/>
                                Gider: €${data.expenses.toLocaleString()}<br/>
                                Gelir: €${data.income.toLocaleString()}<br/>
                                Oran: ${data.ratio.toFixed(1)}%`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: apartmentData.map(d => d.name),
                    axisLabel: { rotate: 45, fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    name: 'Gider/Gelir Oranı (%)',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [{
                    name: 'Gider/Gelir',
                    type: 'bar',
                    data: apartmentData.map(d => d.ratio),
                    itemStyle: {
                        color: params => {
                            const ratio = params.value;
                            if (ratio < 20) return '#10b981'; // Yeşil - çok iyi
                            if (ratio < 40) return '#22c55e'; // Açık yeşil - iyi
                            if (ratio < 60) return '#fbbf24'; // Sarı - orta
                            if (ratio < 80) return '#f59e0b'; // Turuncu - kötü
                            return '#ef4444'; // Kırmızı - çok kötü
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    markLine: {
                        data: [
                            { yAxis: 50, label: { formatter: 'Hedef: 50%' }, lineStyle: { color: '#6b7280' } }
                        ]
                    }
                }]
            };

            chart.setOption(option);
        },

        createSystemEfficiencyChart() {
            const container = document.getElementById('systemEfficiencyChart');
            if (!container) return;

            const chart = echarts.init(container);
            this.charts.systemEfficiency = chart;

            const systemData = this.getSystemComparisonData();

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}%'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: systemData.systems
                },
                series: [{
                    name: 'Verimlilik',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {d}%'
                    },
                    data: systemData.systems.map((system, index) => ({
                        value: systemData.efficiencies[index],
                        name: system
                    }))
                }]
            };

            chart.setOption(option);
        },

        updateEfficiencyMetrics() {
            const tbody = document.getElementById('efficiencyMetricsTable');
            if (!tbody) return;

            const metrics = this.calculatePerformanceMetrics();

            tbody.innerHTML = metrics.topApartments.map(apt => {
                // Boş gün maliyeti hesapla
                const daysInPeriod = 30;
                const occupiedDays = (apt.occupancy / 100) * daysInPeriod;
                const emptyDays = daysInPeriod - occupiedDays;
                const emptyCost = emptyDays * apt.avgNightlyRate;

                // Verimlilik skoru (0-100)
                const efficiencyScore = Math.min(100, (apt.occupancy + apt.profitMargin) / 2);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${apt.code}</div>
                            <div class="text-xs text-gray-500">${apt.ownerName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-${apt.expenseRatio < 40 ? 'green' : apt.expenseRatio < 60 ? 'yellow' : 'red'}-500 h-2 rounded-full"
                                        style="width: ${Math.min(100, apt.expenseRatio)}%"></div>
                                </div>
                                <span class="text-sm text-gray-700">${apt.expenseRatio.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-semibold ${apt.profitMargin > 30 ? 'text-green-600' : apt.profitMargin > 15 ? 'text-yellow-600' : 'text-red-600'}">
                                ${apt.profitMargin.toFixed(1)}%
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            €${apt.avgNightlyRate.toFixed(0)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            €${emptyCost.toFixed(0)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full"
                                        style="width: ${efficiencyScore}%"></div>
                                </div>
                                <span class="text-sm font-semibold text-gray-700">${efficiencyScore.toFixed(0)}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        },

        // ==================== REPORT GENERATION ====================

        generateDetailedReport() {
            const stats = this.calculateQuickStats();
            const metrics = this.calculatePerformanceMetrics();

            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Detaylı Analiz Raporu</h2>
                        <p class="text-gray-500">Oluşturulma: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Daire Bazlı Performans</h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm border">Daire</th>
                                    <th class="px-4 py-2 text-right text-sm border">Lagirio Kazancı</th>
                                    <th class="px-4 py-2 text-right text-sm border">Ev Sahibi Payı</th>
                                    <th class="px-4 py-2 text-right text-sm border">Doluluk</th>
                                    <th class="px-4 py-2 text-right text-sm border">Rezervasyon</th>
                                    <th class="px-4 py-2 text-right text-sm border">Ort. Gecelik</th>
                                    <th class="px-4 py-2 text-right text-sm border">Kâr Marjı</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${metrics.topApartments.map(apt => `
                                    <tr class="border-b">
                                        <td class="px-4 py-2 border">${apt.code}<br/><span class="text-xs text-gray-500">${apt.ownerName}</span></td>
                                        <td class="px-4 py-2 text-right border font-semibold">€${apt.revenue.toLocaleString()}</td>
                                        <td class="px-4 py-2 text-right border">€${apt.ownerShare.toLocaleString()}</td>
                                        <td class="px-4 py-2 text-right border">${apt.occupancy.toFixed(1)}%</td>
                                        <td class="px-4 py-2 text-right border">${apt.reservationCount}</td>
                                        <td class="px-4 py-2 text-right border">€${apt.avgNightlyRate.toFixed(0)}</td>
                                        <td class="px-4 py-2 text-right border">${apt.profitMargin.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold">
                                <tr>
                                    <td class="px-4 py-2 border">TOPLAM</td>
                                    <td class="px-4 py-2 text-right border">€${metrics.topApartments.reduce((s, a) => s + a.revenue, 0).toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">€${metrics.topApartments.reduce((s, a) => s + a.ownerShare, 0).toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">${stats.avgOccupancy.toFixed(1)}%</td>
                                    <td class="px-4 py-2 text-right border">${metrics.totalReservations}</td>
                                    <td class="px-4 py-2 text-right border">-</td>
                                    <td class="px-4 py-2 text-right border">${metrics.avgProfitMargin.toFixed(1)}%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Yazdır
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF İndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        generateComparisonReport() {
            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Karşılaştırma Raporu</h2>
                        <p class="text-gray-500">Karşılaştırma modülünü kullanarak detaylı karşılaştırma yapabilirsiniz.</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <p class="text-blue-800">
                            <i data-lucide="info" class="w-5 h-5 inline mr-2"></i>
                            Karşılaştırma yapmak için yukarıdaki menüden "Karşılaştırma" sekmesine gidin.
                        </p>
                    </div>
                </div>
            `;
        },

        generateFinancialReport() {
            const stats = this.calculateQuickStats();

            // Platform bazlı gelir analizi
            const platformRevenue = {};
            this.data.reservations?.forEach(res => {
                const platform = res.platform || 'Direkt';
                if (!platformRevenue[platform]) platformRevenue[platform] = 0;
                platformRevenue[platform] += this.convertToEUR(res.totalAmount, res.currency || 'EUR');
            });

            // Ödeme yöntemi bazlı analiz
            const paymentData = this.getPaymentMethodData();

            // Şirket giderleri (Lagirio'nun kendi giderleri) - kategori bazında
            const companyExpCategories = {};
            let totalCompanyExp = 0;
            (this.data.lagirioExpenses || []).forEach(exp => {
                const category = exp.category || 'Diğer';
                const amount = this.convertToEUR(exp.amount, exp.currency);
                if (!companyExpCategories[category]) companyExpCategories[category] = 0;
                companyExpCategories[category] += amount;
                totalCompanyExp += amount;
            });

            // Daire giderleri toplamı (referans bilgi)
            const totalAptExpenses = (this.data.expenses || [])
                .reduce((s, e) => s + this.convertToEUR(e.amount, e.currency), 0);

            const lagirioBrut = stats.totalPortfolio;
            const netProfit = lagirioBrut - totalCompanyExp;
            const netColor = netProfit >= 0 ? 'text-emerald-600' : 'text-red-600';
            const netBg = netProfit >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200';
            const netLabel = netProfit >= 0 ? 'Net Kar' : 'Net Zarar';

            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Finansal Rapor</h2>
                        <p class="text-gray-500">Oluşturulma: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>

                    <!-- Ana Özet -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <p class="text-sm text-gray-600">Lagirio Brüt Kazanç</p>
                            <p class="text-2xl font-bold text-green-600">\u20ac${lagirioBrut.toFixed(2)}</p>
                            <p class="text-[10px] text-gray-400 mt-1">Dairelerden komisyon/kar payı (giderler zaten düşük)</p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                            <p class="text-sm text-gray-600">Şirket Giderleri</p>
                            <p class="text-2xl font-bold text-orange-600">\u20ac${totalCompanyExp.toFixed(2)}</p>
                            <p class="text-[10px] text-gray-400 mt-1">Ofis, personel, yazılım vb.</p>
                        </div>
                        <div class="${netBg} rounded-lg p-4 border">
                            <p class="text-sm text-gray-600">${netLabel}</p>
                            <p class="text-2xl font-bold ${netColor}">\u20ac${netProfit.toFixed(2)}</p>
                            <p class="text-[10px] text-gray-400 mt-1">Brüt Kazanç - Şirket Giderleri</p>
                        </div>
                    </div>

                    <!-- Referans: Daire Giderleri -->
                    <div class="bg-gray-50 rounded-lg p-3 mb-6 text-xs text-gray-500">
                        <span class="font-semibold">Referans:</span> Daire giderleri toplamı \u20ac${totalAptExpenses.toFixed(2)}
                        (bu tutar zaten sistem bazlı hesaplamada brüt kazançtan düşülmüştür)
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Platform Bazlı Gelir</h3>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm border">Platform</th>
                                <th class="px-4 py-2 text-right text-sm border">Brüt Gelir</th>
                                <th class="px-4 py-2 text-right text-sm border">Oran</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(platformRevenue).map(([platform, revenue]) => `
                                <tr class="border-b">
                                    <td class="px-4 py-2 border">${platform}</td>
                                    <td class="px-4 py-2 text-right border">\u20ac${revenue.toFixed(2)}</td>
                                    <td class="px-4 py-2 text-right border">${stats.totalPortfolio > 0 ? ((revenue / stats.totalPortfolio) * 100).toFixed(1) : 0}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Ödeme Yöntemi Dağılımı</h3>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Banka Transferi</p>
                            <p class="text-xl font-bold text-blue-600">\u20ac${paymentData.bank.toFixed(2)}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">Nakit</p>
                            <p class="text-xl font-bold text-green-600">\u20ac${paymentData.cash.toFixed(2)}</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Şirket Gider Kategorileri</h3>
                    ${Object.keys(companyExpCategories).length > 0 ? `
                    <table class="w-full mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm border">Kategori</th>
                                <th class="px-4 py-2 text-right text-sm border">Tutar</th>
                                <th class="px-4 py-2 text-right text-sm border">Oran</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(companyExpCategories).map(([category, amount]) => `
                                <tr class="border-b">
                                    <td class="px-4 py-2 border">${category}</td>
                                    <td class="px-4 py-2 text-right border">\u20ac${amount.toFixed(2)}</td>
                                    <td class="px-4 py-2 text-right border">${totalCompanyExp > 0 ? ((amount / totalCompanyExp) * 100).toFixed(1) : 0}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : '<p class="text-sm text-gray-400 mb-6">Henüz şirket gideri girilmedi.</p>'}

                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Yazdır
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF İndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        generatePerformanceReport() {
            const metrics = this.calculatePerformanceMetrics();
            const systemData = this.getSystemComparisonData();

            return `
                <div class="print:bg-white">
                    <div class="mb-6 pb-6 border-b">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Performans Raporu</h2>
                        <p class="text-gray-500">KPI ve Metrik Analizi - ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Anahtar Performans Göstergeleri (KPI)</h3>
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
                            <p class="text-xs text-gray-600">Ortalama Doluluk</p>
                            <p class="text-2xl font-bold text-emerald-600">${metrics.topApartments.reduce((s, a) => s + a.occupancy, 0) / metrics.topApartments.length.toFixed(1)}%</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                            <p class="text-xs text-gray-600">Ortalama Kâr Marjı</p>
                            <p class="text-2xl font-bold text-blue-600">${metrics.avgProfitMargin.toFixed(1)}%</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                            <p class="text-xs text-gray-600">Toplam Rezervasyon</p>
                            <p class="text-2xl font-bold text-purple-600">${metrics.totalReservations}</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                            <p class="text-xs text-gray-600">Ort. Gider/Gelir</p>
                            <p class="text-2xl font-bold text-orange-600">${metrics.avgExpenseRatio.toFixed(1)}%</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 5 En İyi Performans</h3>
                    <div class="space-y-3 mb-6">
                        ${metrics.topApartments.slice(0, 5).map((apt, index) => `
                            <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 rounded-full ${index === 0 ? 'bg-yellow-400' : index === 1 ? 'bg-gray-300' : index === 2 ? 'bg-orange-400' : 'bg-blue-400'} flex items-center justify-center text-white font-bold">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">${apt.code}</p>
                                        <p class="text-xs text-gray-500">${apt.ownerName}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-emerald-600">€${apt.revenue.toLocaleString()}</p>
                                    <p class="text-xs text-gray-500">${apt.occupancy.toFixed(1)}% doluluk</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Sistem Performansı</h3>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm border">Sistem</th>
                                <th class="px-4 py-2 text-right text-sm border">Kazanç</th>
                                <th class="px-4 py-2 text-right text-sm border">Doluluk</th>
                                <th class="px-4 py-2 text-right text-sm border">Verimlilik</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${systemData.systems.map((system, index) => `
                                <tr class="border-b">
                                    <td class="px-4 py-2 border">${system}</td>
                                    <td class="px-4 py-2 text-right border font-semibold">€${systemData.revenues[index].toLocaleString()}</td>
                                    <td class="px-4 py-2 text-right border">${systemData.occupancies[index].toFixed(1)}%</td>
                                    <td class="px-4 py-2 text-right border">${systemData.efficiencies[index].toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="mt-6 pt-6 border-t">
                        <div class="flex justify-between">
                            <button onclick="window.print()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Yazdır
                            </button>
                            <button onclick="Analytics.exportReportPDF()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                PDF İndir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // Initialize application when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        if (Auth.checkSession()) {
            Auth.showApp();
        }
    });
    </script>
</body>
</html>